<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מכולות</title>
    <!-- Chosen Palette: Calm Neutrals with Purple Accent -->
    <!-- Application Structure Plan: The SPA is designed as a multi-tab dashboard. The default view is the 'Dashboard' which provides high-level KPIs and a full, filterable list of all container operations. Additional tabs allow the user to focus on specific tasks: 'Container Inventory' for tracking the status of each physical container, and 'Treatment Board' for a Kanban-style view of overdue orders that require action. This task-oriented structure, guided by the specification, allows the manager to quickly assess the overall status and then drill down into specific management areas (inventory, overdue accounts) for efficient workflow. Modals are used for detailed views (e.g., customer history) to avoid cluttering the main interface. -->
    <!-- Visualization & Content Choices: 
        - KPIs (Total containers, overdue, etc.): Goal=Inform -> Method=Dynamic text in Cards -> Interaction=None -> Justification=Quick, scannable overview.
        - All Operations List: Goal=Organize/Compare -> Method=Interactive HTML Table -> Interaction=Search, Filter, Sort -> Justification=Allows deep-diving into the full dataset.
        - Overdue Orders: Goal=Inform/Act -> Method=Kanban Board & Highlighted Table -> Interaction=Visual grouping, direct links to customer details -> Justification=Focuses attention on urgent tasks.
        - Operations per Agent: Goal=Inform/Compare -> Method=Bar Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Clear visual comparison of agent performance.
        - Operations over Time: Goal=Change -> Method=Line Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Shows trends and business activity patterns.
        - Container Status: Goal=Organize -> Method=Two distinct HTML tables (In Use/Available) -> Interaction=Click for history -> Justification=Clear separation of inventory status for operational planning.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        .kanban-column {
            min-height: 200px;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }

        /* Custom styles for larger and bolder table text */
        .table-large-text td { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        /* Typing effect cursor */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em; /* Adjust to match font size */
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">מערכת ניהול מכולות</h1>
            <p class="text-lg text-gray-600">לוח בקרה מרכזי לניהול, מעקב וניתוח פעילות</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b border-gray-200 mb-8">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>לוח בקרה
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>מלאי מכולות
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>לוח טיפול בחריגות
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">סקירה כללית</h2>
                    <button onclick="openNewOrderModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>הזמנה חדשה
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פעילות באתרים</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">לקוחות בחריגה <span class="text-xs">(מעל 10 ימים)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פנויות במלאי</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">סה"כ פעולות (כל הזמנים)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעילות לפי סוכן</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעולות לאורך זמן</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">כלל הפעולות</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="חפש לפי שם לקוח, תעודה, שם סוכן...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">תאריך</th>
                                    <th class="py-3 px-4 text-right font-bold">תעודה</th>
                                    <th class="py-3 px-4 text-right font-bold">שם לקוח</th>
                                    <th class="py-3 px-4 text-right font-bold">שם סוכן</th>
                                    <th class="py-3 px-4 text-right font-bold">סוג פעולה</th>
                                    <th class="py-3 px-4 text-right font-bold">ימים בשכירות</th>
                                    <th class="py-3 px-4 text-right font-bold">סטטוס</th>
                                    <th class="py-3 px-4 text-right font-bold">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות בשימוש פעיל</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">מספר מכולה</th>
                                    <th class="py-3 px-4 text-right font-bold">לקוח נוכחי</th>
                                    <th class="py-3 px-4 text-right font-bold">תאריך הצבה</th>
                                    <th class="py-3 px-4 text-right font-bold">ימים באתר</th>
                                    <th class="py-3 px-4 text-right font-bold">היסטוריה</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות פנויות</h2>
                     <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">מספר מכולה</th>
                                    <th class="py-3 px-4 text-right font-bold">תאריך חזרה למלאי</th>
                                    <th class="py-3 px-4 text-right font-bold">לקוח אחרון</th>
                                    <th class="py-3 px-4 text-right font-bold">היסטוריה</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">לוח טיפול בלקוחות חורגים</h2>
                 <p class="text-gray-600 mb-6">כאן מרוכזות כל המכולות שנמצאות אצל לקוחות מעל 10 ימי עבודה ודורשות טיפול (החלפה או הוצאה).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
            </section>
        </main>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold" id="modal-customer-name"></h2>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2">סיכום פעילות</h3>
                <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6"></div>
                <h3 class="text-lg font-semibold mb-2">היסטוריית פעולות</h3>
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-3 text-right">תאריך</th>
                                <th class="py-2 px-3 text-right">תעודה</th>
                                <th class="py-2 px-3 text-right">פעולה</th>
                                <th class="py-2 px-3 text-right">סטטוס</th>
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="table-large-text"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">סגור</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">שליחת הודעת WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">מספר טלפון:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center">
                        <span>בחר הודעה מובנית</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200" placeholder="חפש הודעה..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">תוכן ההודעה:</label>
                     <div class="border border-gray-300 rounded-md p-2 min-h-[100px] bg-gray-50 mb-2">
                        <span id="typing-effect-display" class="whitespace-pre-wrap"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md" rows="5"></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">שלח הודעה</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">הוספת הזמנה חדשה</h2>
                <button onclick="closeNewOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label for="new-order-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך הזמנה</label>
                        <input type="date" id="new-order-date" name="תאריך הזמנה" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">תעודה</label>
                        <input type="text" id="new-order-docid" name="תעודה" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">שם סוכן</label>
                        <input type="text" id="new-order-agent" name="שם סוכן" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">שם לקוח</label>
                        <input type="text" id="new-order-customer-name" name="שם לקוח" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-address" class="block text-sm font-semibold text-gray-700 mb-1">כתובת</label>
                        <input type="text" id="new-order-address" name="כתובת" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">סוג פעולה</label>
                        <select id="new-order-action-type" name="סוג פעולה" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">בחר פעולה</option>
                            <option value="הצבה">הצבה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="הורדה">הורדה</option>
                            <option value="הוצאה">הוצאה</option>
                            <option value="הזזה">הזזה</option>
                            <option value="פינוי במקום">פינוי במקום</option>
                            <option value="גישה ללא פעולה">גישה ללא פעולה</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-status" class="block text-sm font-semibold text-gray-700 mb-1">סטטוס</label>
                        <select id="new-order-status" name="סטטוס" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="new-order-container-dropped" name="מספר מכולה ירדה" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="new-order-container-lifted" name="מספר מכולה עלתה" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סיום צפוי</label>
                        <input type="date" id="new-order-expected-end-date" name="תאריך סיום צפוי" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">טלפון לקוח</label>
                        <input type="tel" id="new-order-phone" name="טלפון לקוח" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות</label>
                        <textarea id="new-order-notes" name="הערות" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2">
                <button onclick="closeNewOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">ביטול</button>
                <button onclick="submitNewOrder()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">הוסף הזמנה</button>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        // Global state
        let allOperations = [];
        let charts = {};
        let isLoadingData = false; // Added loading state

        // Utility functions
        const parseFullTrackingCSV = (data) => {
            // This function is now mostly for historical name, as data is expected to be JSON array
            return data;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            // Handle both YYYY-MM-DD and DD/MM/YYYY formats
            if (dateStr.includes('-') && dateStr.split('-').length === 3) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            if (dateStr.includes('/') && dateStr.split('/').length === 3) {
                const parts = dateStr.split('/');
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const diff = new Date() - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        // Global functions for HTML onclick attributes (MUST BE GLOBAL)
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');
        };

        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "תל אביב", "ירושלים", "חיפה", "ראשון לציון", "פתח תקווה", "אשדוד", "באר שבע",
                "נתניה", "בני ברק", "חולון", "רמת גן", "רחובות", "אשקלון", "בת ים", "הרצליה",
                "כפר סבא", "חדרה", "בית שמש", "מודיעין-מכבים-רעות", "לוד", "רמלה", "רעננה",
                "נהריה", "קריית גת", "אילת", "עכו", "צפת", "טבריה", "נצרת", "אום אל-פאחם",
                "בני ציון", "אבן יהודה", "אור יהודה", "אור עקיבא", "אריאל", "אשקלון", "באקה אל-גרבייה",
                "גבעתיים", "דימונה", "הוד השרון", "זכרון יעקב", "יבנה", "יהוד-מונוסון", "יוקנעם עילית",
                "כוכב יאיר", "כפר יונה", "כפר קאסם", "כרמיאל", "מגדל העמק", "מכבים", "מעלה אדומים",
                "מצפה רמון", "נהריה", "נס ציונה", "נשר", "עפולה", "ערד", "פרדס חנה-כרכור",
                "קריית אונו", "קריית ביאליק", "קריית ים", "קריית מוצקין", "קריית שמונה",
                "שוהם", "שדרות", "רמת השרון"
            ].sort((a,b) => b.length - a.length);

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        const whatsappMessages = [
            { id: 'new_customer_welcome', text: 'שלום **[שם לקוח]**,\nתודה שבחרת להתחיל שכירות מכולה אצלנו! 🥳 לכל פניה, בקשת החלפה או הוצאה של המכולה, אתה מוזמן ליצור קשר.\n\n📞 מספר ווטסאפ להזמנות: **[מספר טלפון חברה]**\n☎️ טלפון מחלקת הזמנות: **[טלפון חברה]**', category: 'כללי', placeholders: ['שם לקוח', 'מספר טלפון חברה', 'טלפון חברה'], emoji: '👋' },
            { id: 'approaching_due_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להזכיר לך כי תקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת בעוד **7 ימים** 🗓️. זה הזמן לנקוט פעולה!\n\nהאם תרצה להאריך את תקופת השכירות, להחליף את המכולה, או להזמין איסוף? ♻️', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏰' },
            { id: 'approaching_due_3_days', text: 'שלום **[שם לקוח]**,\n\nתקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת ממש בקרוב, בעוד **3 ימים** ⚠️. אנא טפל בנושא כדי למנוע חריגות.\n\nאנו לרשותך לכל עזרה! 🙏', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏳' },
            { id: 'overdue_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להודיע לך על חריגה בימי שכירות של המכולה ([**מספר מכולה**]) ב-**[ימים שעברו] ימים** 🚨. נא ליצור קשר עם מחלקת הזמנות **[טלפון חברה]** או להשיב להודעה זו מה תרצה שנבצע (החלפה/הוצאה).', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '❗️' },
            { id: 'overdue_30_days', text: '**התראה חמורה, [שם לקוח]:**\n\nהמכולה ([**מספר מכולה**]) שבשימושך חורגת ב-**[ימים שעברו] ימים**! יש לטפל בנושא בדחיפות כדי למנוע חיובים נוספים וסיבוכים משפטיים. ⚖️\n\n**צור קשר מיידית: [טלפון חברה].**', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '🔴' },
            { id: 'overdue_long', text: '**לכבוד: [שם לקוח]**\n\n**הנדון: חוב בגין שכירות מכולה חורגת**\n\nאנו פונים אליך בהתייחס לחשבונך, הנמצא בחריגה משמעותית של [**ימים שעברו**] ימים עבור מכולה ([**מספר מכולה**]).\n\nבהיעדר הסדרה מיידית, אנו נאלצים לנקוט בצעדים משפטיים לגבייה. אנו קוראים לך ליצור קשר דחוף להסדר: **[טלפון חברה]**.', category: 'משפטי', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '' },
            { id: 'general_inquiry', text: 'שלום **[שם לקוח]**,\n\nאיך אנחנו יכולים לעזור לך היום? 🤔 אם יש לך שאלות, בקשות או תזכורות, אל תהסס לפנות אלינו. אנחנו כאן בשבילך! ✨', category: 'כללי', placeholders: ['שם לקוח'], emoji: '💬' },
            { id: 'payment_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת ידידותית לגבי תשלום חשבונית מספר **[תעודה]** 💰. אנו מודים לך על תשומת הלב המהירה ועל המשך שיתוף הפעולה.', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '💲' },
            { id: 'service_feedback', text: 'שלום **[שם לקוח]**,\n\nאנו מקווים ששירותינו עונים על ציפיותיך. נשמח לקבל משוב על החוויה שלך עם מכולה מספר **[מספר מכולה]** כדי שנוכל להשתפר ולהעניק לך שירות טוב יותר. ⭐', category: 'משוב', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '📝' },
            { id: 'holiday_greetings', text: 'חג שמח, **[שם לקוח]**! 🎉\n\nצוות [שם החברה] מאחל לך ולמשפחתך חג שמח, מלא שלווה, בריאות והמון שמחה! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎁' },
            { id: 'special_offer', text: 'שלום **[שם לקוח]**,\n\nיש לנו חדשות מרגשות! 🎁 מבצע מיוחד למכולות חדשות/נוספות עבורך. אל תחמיץ! לפרטים נוספים, השב להודעה זו או התקשר: **[טלפון חברה]**.', category: 'שיווק', placeholders: ['שם לקוח', 'טלפון חברה'], emoji: '✨' },
            { id: 'follow_up_issue', text: 'שלום **[שם לקוח]**,\n\nאנחנו חוזרים אליך לגבי הנושא שדיווחת עליו בתעודה **[תעודה]** 🛠️. האם הבעיה נפתרה לשביעות רצונך? אם לא, אנא הודע לנו כדי שנוכל להמשיך לטפל.', category: 'תמיכה', placeholders: ['שם לקוח', 'תעודה'], emoji: '✅' },
            { id: 'document_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת לשליחת המסמכים החסרים עבור הזמנה **[תעודה]** 📄. אנא שלח אותם בהקדם כדי שנוכל להשלים את הטיפול בהזמנה.\n\nתודה על שיתוף הפעולה!', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '📌' },
            { id: 'service_confirmation', text: 'שלום **[שם לקוח]**,\n\nהשירות שהוזמן (תעודה **[תעודה]**) אושר ויתבצע ב-**[תאריך סיום צפוי]** ✅. תודה שבחרת בנו ושיהיה יום נפלא!', category: 'אישור', placeholders: ['שם לקוח', 'תעודה', 'תאריך סיום צפוי'], emoji: '👍' },
            { id: 'service_delay', text: 'שלום **[שם לקוח]**,\n\nעקב נסיבות בלתי צפויות, ייתכן שיהיה עיכוב קל בטיפול בהזמנה **[תעודה]** ⏱️. אנו מתנצלים על אי הנוחות ונפעל לפתור זאת במהירות האפשרית.\n\nנודיע לך על כל עדכון! 🔜', category: 'מידע', placeholders: ['שם לקוח', 'תעודה'], emoji: '🚧' },
            { id: 'location_update_request', text: 'שלום **[שם לקוח]**,\n\nכדי שנוכל לתאם את השירות בצורה הטובה ביותר, אנא וודא שמיקום המכולה ([**מספר מכולה**]) מעודכן ומדויק 📍. זה חשוב להגעה יעילה!', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🗺️' },
            { id: 'happy_birthday', text: 'יום הולדת שמח, **[שם לקוח]**! 🎉🎂\n\nצוות [שם החברה] מאחל לך יום מלא בשמחה, בריאות, הגשמה והרבה רגעים מתוקים! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎈' },
            { id: 'review_invitation', text: 'שלום **[שם לקוח]**,\n\nנהנית מהשירות שלנו? ✨ נשמח אם תוכל להקדיש רגע ולכתוב לנו ביקורת קצרה כאן: [**לינק לביקורת**]. תודה מראש על עזרתך להשתפר! 🙏', category: 'משוב', placeholders: ['שם לקוח', 'לינק לביקורת'], emoji: '🌟' },
            { id: 'tech_support_contact', text: 'שלום **[שם לקוח]**,\n\nלכל בעיה טכנית או תפעולית עם המכולה ([**מספר מכולה**]), מחלקת התמיכה שלנו זמינה עבורך 🧑‍🔧.\n\n**צור קשר: [טלפון חברה].**', category: 'תמיכה', placeholders: ['שם לקוח', 'מספר מכולה', 'טלפון חברה'], emoji: '🔧' },
            { id: 'general_thanks', text: 'תודה רבה לך, **[שם לקוח]**, על שיתוף הפעולה והאמון ב[שם החברה]! 🙏\n\nאנו מעריכים את בחירתך בנו ומקווים להמשיך לשרת אותך נאמנה. 💖', category: 'כללי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '😊' },
            { id: 'multi_container_reminder', text: 'שלום **[שם לקוח]**,\n\nשמנו לב שברשותך **מספר מכולות פעילות** 🏗️. אנו כאן כדי לוודא שכל הצרכים שלך מסופקים.\n\nהאם יש משהו שנוכל לעזור בו בנוגע למכולות שלך? אל תהסס לפנות! 🤝', category: 'תזכורות', placeholders: ['שם לקוח'], emoji: '📦' },
            { id: 'container_mismatch', text: 'שלום **[שם לקוח]**,\n\n**התראה:** מכולה מספר **[מספר מכולה]** ירדה אצל לקוח **[שם לקוח]** בתעודה **[תעודה]** לפני **[ימים שעברו]** ימים וטרם הוחזרה/נסגרה! 🚨', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'תעודה', 'ימים שעברו'], emoji: '🚨' },
            { id: 'pending_order_reminder', text: 'שלום **[שם לקוח]**,\n\n**בטיפול:** הזמנה **[תעודה]** של לקוח **[שם לקוח]** מסומנת "בטיפול" ולא עודכנה **[ימים שעברו]** ימים. דורש בדיקה! ⚠️', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה', 'ימים שעברו'], emoji: '⚠️' }
        ];

        const cityGuidelines = {
            'הרצליה': {
                id: 'herzliya_permit',
                text: 'הנחיה חשובה לתושבי הרצליה:\nכדי להציב מכולת פסולת בניין ברחוב בהרצליה, יש להגיש בקשה מראש לאגף הפיקוח העירוני. הבקשה כרוכה בתשלום אגרה ונדרש אישור בכתב. מומלץ לוודא את כל הפרטים באתר העירייה או בטלפון.\n\nקישור למידע: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '📝'
            },
            'רעננה': {
                id: 'raanana_permit',
                text: 'הנחיה חשובה לתושבי רעננה:\nברעננה, חל איסור מוחלט להשאיר מכולות פסולת בניין במקום ציבורי (ברחוב) בסופי שבוע ובחגים. יש לדאוג להזמין פינוי לפני כניסת השבת/חג. קנסות יינתנו למפרים. אנא הקפד על הנחיות אלו.\n\nמידע נוסף: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🚫'
            },
            'תל אביב': {
                id: 'telaviv_permit',
                text: 'הנחיה חשובה לתושבי תל אביב:\nבתל אביב, הצבת מכולות פסולת ברחוב מחייבת קבלת היתר מהעירייה. יש להגיש בקשה מקוונת ולצרף את כל המסמכים הנדרשים. שימו לב להנחיות המדויקות לגבי סימון המכולה ומשך ההצבה.\n\nלמידע והגשת בקשה: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🏛️'
            }
        };

        const companyInfo = {
            phoneNumber: '972508860896', 
            companyPhone: '097602010', 
            companyName: 'ח.סבן' 
        };

        // This is your Google Apps Script Web App URL. Make sure it's deployed correctly.
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk03pVBEBzHIWkFj1OzqM0T5buH5cfNjD8njGza8AoKWulO1sPtiBrOpUZZItOd_gi/exec'; 

        let typingInterval;
        let currentMessageFullText = '';
        let typingIndex = 0;

        // Function to fetch data from Google Sheet
        const fetchDataFromGoogleSheet = async () => {
            isLoadingData = true;
            // Optionally, show a loading indicator here
            // document.getElementById('loader').classList.remove('hidden'); 

            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=getData`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json(); // Parse the entire JSON response

                // Check if the response indicates success and contains data
                if (result.success && Array.isArray(result.data)) {
                    allOperations = result.data
                        .map(op => ({
                            ...op,
                            'תאריך הזמנה': formatDate(op['תאריך הזמנה']),
                            'תאריך סיום צפוי': formatDate(op['תאריך סיום צפוי']),
                            'תאריך סגירה': formatDate(op['תאריך סגירה']),
                        }))
                        .sort((a, b) => (b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0) - (a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0));
                } else {
                    console.error("Received data is not an array or success is false:", result);
                    showStatusMessage("שגיאה: הנתונים שהתקבלו מגיליון גוגל אינם בפורמט צפוי או שהייתה שגיאה בשרת: " + (result.message || 'אין הודעה ספציפית'), 'error');
                    allOperations = []; // Initialize as empty array to prevent further errors
                }

                renderDashboard();
                renderInventory();
                renderTreatmentBoard();

            } catch (error) {
                console.error("Error fetching data from Google Sheet:", error);
                // Using a non-blocking message box instead of alert
                showStatusMessage("שגיאה בטעינת הנתונים מגיליון גוגל: " + error.message, 'error');
            } finally {
                isLoadingData = false;
                // Optionally, hide loading indicator
                // document.getElementById('loader').classList.add('hidden');
            }
        };

        // Function to add new order to Google Sheet
        const addNewOrderToSheet = async (orderData) => {
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=addOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Send as JSON
                    },
                    body: JSON.stringify(orderData) // Send as JSON object directly
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('ההזמנה נוספה בהצלחה לגיליון!', 'success');
                    fetchDataFromGoogleSheet(); // Reload data after adding
                } else {
                    showStatusMessage('שגיאה בהוספת ההזמנה: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding order to sheet:', error);
                showStatusMessage('שגיאה בתקשורת עם השרת בעת הוספת הזמנה.', 'error');
            }
        };

        // Custom status message display (instead of alert)
        const showStatusMessage = (message, type) => {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50`;
            if (type === 'success') {
                statusDiv.classList.add('bg-green-600');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-600');
            } else {
                statusDiv.classList.add('bg-gray-700');
            }
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.remove();
            }, 5000); // Message disappears after 5 seconds
        };


        document.addEventListener('DOMContentLoaded', () => {
            fetchDataFromGoogleSheet(); // Call fetch function to load initial data
            document.getElementById('main-search').addEventListener('input', renderAllOperationsTable);
        });

        const getKPIs = () => {
            let activeContainerLocations = {}; 
            let totalOverdueCustomerIds = new Set(); 

            const detailedContainerStatus = {}; 
            allOperations.slice().sort((a,b) => (a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0) - (b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0)).forEach(op => {
                const opDate = op['תאריך הזמנה'];
                if (!opDate) return;

                const containersTaken = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

                containersTaken.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'in_use',
                        customerId: op['לקוח'],
                        customerName: op['שם לקוח'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });

                containersBrought.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'available',
                        lastCustomerName: op['שם לקוח'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });
            });

            let currentActiveContainersCount = 0;
            let currentAvailableContainersCount = 0;

            for (const containerNum in detailedContainerStatus) {
                const info = detailedContainerStatus[containerNum];
                if (info.status === 'in_use') {
                    currentActiveContainersCount++;
                    if (info.latestOperation && info.latestOperation['סטטוס'] === 'חורג') {
                        totalOverdueCustomerIds.add(info.customerId);
                    }
                } else if (info.status === 'available') {
                    currentAvailableContainersCount++;
                }
            }
            
            return {
                activeContainers: currentActiveContainersCount,
                overdueCustomers: totalOverdueCustomerIds.size,
                availableContainers: currentAvailableContainersCount,
                totalOperations: allOperations.length,
            };
        };

        const renderDashboard = () => {
            const { activeContainers, overdueCustomers, availableContainers, totalOperations } = getKPIs();
            document.getElementById('kpi-active-containers').textContent = activeContainers;
            document.getElementById('kpi-overdue-customers').textContent = overdueCustomers;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-total-operations').textContent = totalOperations;
            
            renderAllOperationsTable();
            renderCharts();
        };

        const renderAllOperationsTable = () => {
            const searchTerm = document.getElementById('main-search').value.toLowerCase();
            const tableBody = document.getElementById('all-operations-table');
            tableBody.innerHTML = '';
            
            const filteredOps = allOperations.filter(op => 
                (op['שם לקוח'] && op['שם לקוח'].toLowerCase().includes(searchTerm)) ||
                (op['תעודה'] && String(op['תעודה']).toLowerCase().includes(searchTerm)) || // Ensure תעודה is string
                (op['שם סוכן'] && op['שם סוכן'].toLowerCase().includes(searchTerm))
            );

            filteredOps.slice(0, 100).forEach(op => { 
                const days = (op['סטטוס'] === 'פתוח' || op['סטטוס'] === 'חריג') && op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : '-';
                let statusText, statusClass;

                if (op['סטטוס'] === 'חריג') {
                    statusText = 'חריגה';
                    statusClass = 'status-red';
                } else if (op['סטטוס'] === 'סגור') {
                    statusText = 'סגור';
                    statusClass = 'status-gray';
                } else { 
                    statusText = 'פעיל';
                    statusClass = 'status-green';
                }

                const row = `
                    <tr class="hover:bg-gray-50 cursor-pointer">
                        <td class="py-3 px-4">${op['תאריך הזמנה'] ? op['תאריך הזמנה'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-3 px-4">${op['תעודה']}</td>
                        <td class="py-3 px-4 font-semibold text-gray-700">${op['שם לקוח']}</td>
                        <td class="py-3 px-4">${op['שם סוכן']}</td>
                        <td class="py-3 px-4">${op['סוג פעולה']}</td>
                        <td class="py-3 px-4">${days}</td>
                        <td class="py-3 px-4"><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="py-3 px-4">
                            <button onclick="openWhatsAppModal(event, '${op['טלפון לקוח']}', '${op['שם לקוח']}', '${op['תעודה']}', ${days}, '${op['מספר מכולה ירדה'] || op['מספר מכולה עלתה'] || ''}', '${op['תאריך סיום צפוי'] ? op['תאריך סיום צפוי'].toLocaleDateString('he-IL') : ''}', '${op['כתובת']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                            <button onclick="openModal('${op['לקוח']}')" class="text-blue-600 hover:text-blue-700 ml-2 focus:outline-none">
                                <i class="fas fa-eye text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };

        const renderCharts = () => {
            const agentCounts = allOperations.reduce((acc, op) => {
                const agent = op['שם סוכן'] || 'לא ידוע';
                acc[agent] = (acc[agent] || 0) + 1;
                return acc;
            }, {});
            if (charts.agent) charts.agent.destroy();
            charts.agent = new Chart(document.getElementById('agentActivityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agentCounts).map(label => {
                        if (label.length > 16) {
                            return label.match(/.{1,8}/g).join('\n'); 
                        }
                        return label;
                    }),
                    datasets: [{
                        label: 'מספר פעולות',
                        data: Object.values(agentCounts),
                        backgroundColor: '#8b5cf6',
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                     plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label.replace(/\n/g, ' '); 
                                }
                            }
                        }
                    }
                }
            });

            const timelineCounts = allOperations.reduce((acc, op) => {
                if (op['תאריך הזמנה'] && !isNaN(op['תאריך הזמנה'].getTime())) {
                    const month = op['תאריך הזמנה'].toISOString().slice(0, 7);
                    acc[month] = (acc[month] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedTimeline = Object.entries(timelineCounts).sort((a, b) => a[0].localeCompare(b[0]));
             if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(document.getElementById('operationsTimelineChart'), {
                type: 'line',
                data: {
                    labels: sortedTimeline.map(e => e[0]),
                    datasets: [{
                        label: 'כמות פעולות חודשית',
                        data: sortedTimeline.map(e => e[1]),
                        borderColor: '#6d28d9',
                        tension: 0.1
                    }]
                },
                 options: { responsive: true, maintainAspectRatio: false }
            });
        };
        
        const renderInventory = () => {
            const inUseBody = document.getElementById('in-use-containers-table');
            const availableBody = document.getElementById('available-containers-table');
            inUseBody.innerHTML = '';
            availableBody.innerHTML = '';

            const containerHistory = {}; 

            allOperations.forEach(op => {
                const containersTaken = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const allRelatedContainers = [...new Set([...containersTaken, ...containersBrought])];

                allRelatedContainers.forEach(containerNum => {
                    if (!containerHistory[containerNum]) {
                        containerHistory[containerNum] = [];
                    }
                    containerHistory[containerNum].push(op);
                });
            });

            const containerCurrentStatus = {}; 

            for (const containerNum in containerHistory) {
                const history = containerHistory[containerNum].sort((a,b) => (a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0) - (b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0));
                let currentStatus = { status: 'unknown', lastActionDate: null, customerId: null, customerName: null, latestOperation: null };

                history.forEach(op => {
                    const opDate = op['תאריך הזמנה'];
                    if (!opDate) return;

                    const containersTaken = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                    const containersBrought = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

                    if (opDate && (!currentStatus.lastActionDate || opDate >= currentStatus.lastActionDate)) {
                        if (containersTaken.includes(containerNum)) {
                            currentStatus = {
                                status: 'in_use',
                                customerId: op['לקוח'],
                                customerName: op['שם לקוח'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        } else if (containersBrought.includes(containerNum)) {
                            currentStatus = {
                                status: 'available',
                                lastCustomerName: op['שם לקוח'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        }
                    }
                });
                containerCurrentStatus[containerNum] = currentStatus;
            }
            
            const uniqueContainersSorted = Object.keys(containerCurrentStatus).sort((a,b) => parseInt(a) - parseInt(b));

            uniqueContainersSorted.forEach(containerNum => {
                const statusData = containerCurrentStatus[containerNum];
                if (statusData.status === 'in_use') {
                    const days = daysSince(statusData.lastActionDate);
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4 font-semibold">${statusData.customerName}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4 ${days > 10 ? 'text-red-600 font-bold' : ''}">${days}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.customerId}')">צפה</button></td>
                        </tr>`;
                    inUseBody.innerHTML += row;
                } else if (statusData.status === 'available') {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4">${statusData.lastCustomerName || 'לא ידוע'}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.latestOperation['לקוח']}')">צפה</button></td>
                        </tr>`;
                    availableBody.innerHTML += row;
                }
            });

            document.getElementById('kpi-active-containers').textContent = inUseBody.rows.length;
            document.getElementById('kpi-available-containers').textContent = availableBody.rows.length;
        };

        const renderTreatmentBoard = () => {
            const board = document.getElementById('treatment-board');
            board.innerHTML = '';
            
            const overdueOperations = allOperations.filter(op => op['סטטוס'] === 'חורג');
            
            if (overdueOperations.length === 0) {
                board.innerHTML = `<p class="text-center text-gray-600 col-span-full">אין לקוחות בחריגה כרגע. כל הכבוד! 🎉</p>`;
                return;
            }

            overdueOperations.forEach(op => {
                const days = op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : '-';
                const containerNumbersTaken = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerNumbersBrought = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerDisplay = containerNumbersTaken.length > 0 ? `ירדה: ${containerNumbersTaken.join(', ')}` : '';
                if (containerNumbersBrought.length > 0) {
                    containerDisplay += (containerDisplay ? ', ' : '') + `עלתה: ${containerNumbersBrought.join(', ')}`;
                }
                const containerNumbersForMsg = [...containerNumbersTaken, ...containersBrought].filter(Boolean).join(', ');


                const card = `
                    <div class="kpi-card bg-white border-l-4 border-red-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${op['שם לקוח']}</h4>
                                <p class="text-sm text-gray-500">תעודה: ${op['תעודה']}</p>
                                <p class="text-sm text-gray-500">מכולה: ${containerDisplay || 'לא צוין'}</p>
                            </div>
                            <span class="font-bold text-xl text-red-600">${days} ימים חריגה</span>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button class="px-3 py-1 bg-violet-600 text-white rounded-lg hover:bg-violet-700 text-sm" onclick="openModal('${op['לקוח']}')">פרטי לקוח</button>
                            <button onclick="openWhatsAppModal(event, '${op['טלפון לקוח']}', '${op['שם לקוח']}', '${op['תעודה']}', ${days}, '${containerNumbersForMsg}', '${op['תאריך סיום צפוי'] ? op['תאריך סיום צפוי'].toLocaleDateString('he-IL') : ''}', '${op['כתובת']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-2xl"></i>
                            </button>
                        </div>
                    </div>
                `;
                board.innerHTML += card;
            });
        };
        
        const openModalByCustomerName = (customerName) => {
            const customerOp = allOperations.find(op => op['שם לקוח'] === customerName && (op['סטטוס'] === 'פתוח' || op['סטטוס'] === 'חורג'));
            if (customerOp) {
                openModal(customerOp['לקוח']);
            }
        };

        const openModal = (customerId) => {
            const customerOps = allOperations.filter(op => op['לקוח'] === customerId);
            if (customerOps.length === 0) return;

            const customerName = customerOps[0]['שם לקוח'];
            document.getElementById('modal-customer-name').textContent = customerName;

            const totalOps = customerOps.length;
            const totalPlacements = customerOps.filter(op => op['סוג פעולה'] === 'הצבה').length;
            const totalRemovals = customerOps.filter(op => op['סוג פעולה'] === 'הוצאה').length;
            
            document.getElementById('modal-customer-summary').innerHTML = `
                <div class="text-center"><p class="text-2xl font-bold">${totalOps}</p><p class="text-sm text-gray-500">סה"כ פעולות</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalPlacements}</p><p class="text-sm text-gray-500">הצבות</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalRemovals}</p><p class="text-sm text-gray-500">הוצאות</p></div>
            `;

            const historyTable = document.getElementById('modal-customer-history-table');
            historyTable.innerHTML = '';
            customerOps.forEach(op => {
                 const days = (op['סטטוס'] === 'פתוח' || op['סטטוס'] === 'חורג') && op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : '-';
                 let statusText, statusClass;
                 if (op['סטטוס'] === 'חורג') {
                    statusText = 'חריגה'; statusClass = 'status-red';
                 } else if (op['סטטוס'] === 'סגור') {
                    statusText = 'סגור'; statusClass = 'status-gray';
                 } else { 
                    statusText = 'פעיל'; statusClass = 'status-green';
                 }
                const row = `
                    <tr>
                        <td class="py-2 px-3">${op['תאריך הזמנה'] ? op['תאריך הזמנה'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-2 px-3">${op['תעודה']}</td>
                        <td class="py-2 px-3">${op['סוג פעולה']}</td>
                        <td class="py-2 px-3"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                historyTable.innerHTML += row;
            });

            document.getElementById('customer-history-modal').classList.remove('hidden');
            document.getElementById('customer-history-modal').classList.add('flex');
        };

        const closeModal = () => {
            document.getElementById('customer-history-modal').classList.add('hidden');
            document.getElementById('customer-history-modal').classList.remove('flex');
        };

        const getSuggestedMessageIdForOrder = (order) => {
            const daysOverdue = order['תאריך הזמנה'] ? daysSince(order['תאריך הזמנה']) : 0;
            const orderDate = order['תאריך הזמנה'];
            const today = new Date();
            const daysSinceOrder = orderDate ? Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)) : 0;

            if (order['סטטוס'] === 'חריג') {
                if (daysOverdue <= 7) return 'overdue_7_days';
                if (daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long';
            }
            
            if (order['סטטוס'] === 'פתוח' && order['תאריך סיום צפוי'] && !isNaN(order['תאריך סיום צפוי'].getTime())) {
                const expectedEndDate = order['תאריך סיום צפוי'];
                const daysUntilDue = Math.floor((expectedEndDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 3 && daysUntilDue >= 0) return 'approaching_due_3_days';
                if (daysUntilDue <= 7 && daysUntilDue > 3) return 'approaching_due_7_days';
            }

            if (order['סוג פעולה'] === 'הצבה' && orderDate && daysSinceOrder <= 30) {
                 const customerId = allOperations.find(op => op['טלפון לקוח'] === order['טלפון לקוח'])?.['לקוח'];
                 if (customerId) {
                     const customerOperations = allOperations.filter(op => op['לקוח'] === customerId);
                     if (customerOperations.length === 1 && String(customerOperations[0]['תעודה']) === String(order['תעודה'])) { // Ensure comparison is string to string
                         return 'new_customer_welcome';
                     }
                 }
            }
            
            const customerCity = getCityFromAddress(order['כתובת']);
            if (customerCity && cityGuidelines[customerCity]) {
                return `city_guideline_${customerCity}`;
            }

            return 'general_inquiry';
        };

        const openWhatsAppModal = (event, phoneNumber, customerName, docId, daysOverdue, containerNum, expectedEndDateFormatted, customerAddress) => {
            event.stopPropagation();
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageOptionsListDiv = document.getElementById('message-options-list');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');
            const whatsappDocIdInput = document.getElementById('whatsapp-doc-id');

            phoneInput.value = phoneNumber.startsWith('972') ? phoneNumber : `972${phoneNumber.substring(1)}`;
            whatsappDocIdInput.value = docId;

            const dummyOrderForSuggestion = {
                'סטטוס': (daysOverdue > 10 ? 'חורג' : 'פתוח'), 
                'תאריך הזמנה': new Date(new Date().getTime() - daysOverdue * 24 * 60 * 60 * 1000), 
                'תאריך סיום צפוי': expectedEndDateFormatted ? formatDate(expectedEndDateFormatted) : null,
                'סוג פעולה': 'הצבה',
                'טלפון לקוח': phoneNumber,
                'כתובת': customerAddress,
                'תעודה': docId
            };
            const suggestedMessageId = getSuggestedMessageIdForOrder(dummyOrderForSuggestion);


            messageOptionsListDiv.innerHTML = '';
            
            const allMsgs = [...whatsappMessages];
            const customerCity = getCityFromAddress(customerAddress);
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                allMsgs.unshift({
                    id: `city_guideline_${customerCity}`,
                    text: `**הנחיית עיריית ${customerCity}:**\n${guideline.text}\n\nלמידע וטפסים נוספים: ${guideline.link}`,
                    category: 'היתרים עירוניים',
                    placeholders: [],
                    emoji: guideline.emoji
                });
            }

            allMsgs.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item p-3 rounded-md cursor-pointer hover:bg-gray-100`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                }
                const displayEmoji = msg.category === 'משפטי' ? '' : (msg.emoji || '');
                optionDiv.innerHTML = `<strong>${displayEmoji} ${msg.category}:</strong> ${msg.text.replace(/\[.*?\]/g, '...').substring(0, 70)}...`;
                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('bg-blue-100', 'text-blue-800'));
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                    const placeholders = {
                        'שם לקוח': customerName,
                        'ימים שעברו': daysOverdue,
                        'מספר מכולה': containerNum,
                        'תעודה': docId,
                        'תאריך סיום צפוי': expectedEndDateFormatted,
                        'מספר טלפון חברה': companyInfo.phoneNumber,
                        'טלפון חברה': companyInfo.companyPhone,
                        'שם החברה': companyInfo.companyName,
                        'לינק לביקורת': 'https://example.com/review'
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            const defaultSelection = messageOptionsListDiv.querySelector('.message-option-item.bg-blue-100');
            if (defaultSelection) {
                defaultSelection.click();
            } else if (allMsgs.length > 0) {
                messageOptionsListDiv.children[0].click();
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModalWhatsApp = () => {
            document.getElementById('whatsapp-modal').classList.add('hidden');
            document.getElementById('whatsapp-modal').classList.remove('flex');
            clearInterval(typingInterval);
        };

        const selectAndTypeMessage = (messageId, placeholders = {}) => {
            clearInterval(typingInterval);
            const allMessagesWithGuidelines = [
                ...whatsappMessages,
                ...Object.values(cityGuidelines).map(g => ({
                    id: `city_guideline_${g.id.split('_')[0]}`,
                    text: g.text,
                    category: g.category,
                    placeholders: g.placeholders,
                    emoji: g.emoji
                }))
            ];
            const message = allMessagesWithGuidelines.find(msg => msg.id === messageId);
            const typingDisplay = document.getElementById('typing-effect-display');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');

            if (message) {
                currentMessageFullText = message.text;
                for (const key in placeholders) {
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[\\*\\*${key}\\*\\*\\]|\\[${key}\\]`, 'g'), placeholders[key]);
                }
                
                typingIndex = 0;
                typingDisplay.textContent = '';
                whatsappMessageTextarea.value = '';

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        whatsappMessageTextarea.value = currentMessageFullText;
                        typingDisplay.textContent = '';
                    }
                }, 30);
            }
        };

        const sendWhatsAppMessage = async () => {
            const phoneNumber = document.getElementById('whatsapp-phone-input').value.trim().replace(/\D/g, '');
            const message = document.getElementById('whatsapp-message-textarea').value.trim();
            const docId = document.getElementById('whatsapp-doc-id').value;

            if (!phoneNumber) {
                showStatusMessage('אנא הזן מספר טלפון תקין.', 'error');
                return;
            }
            if (!message) {
                showStatusMessage('תוכן ההודעה לא יכול להיות ריק.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            closeModalWhatsApp();

            if (docId) {
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=logWhatsAppMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`);
                        const data = await response.json();
                        if (data.success) {
                            showStatusMessage('ההודעה נשלחה ותועדה בהצלחה!', 'success');
                            return;
                        } else if (data.message && data.message.includes('Service invoked too many times')) {
                            const delay = baseDelay * Math.pow(2, retries);
                            console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else {
                            showStatusMessage('שגיאה בתיעוד ההודעה: ' + data.message, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        showStatusMessage('שגיאה בתקשורת עם השרת: ' + error.message, 'error');
                        return;
                    }
                }
                showStatusMessage('נכשל תיעוד ההודעה לאחר מספר ניסיונות חוזרים.', 'error');
            } else {
                showStatusMessage('ההודעה נשלחה, אך לא שויכה למסמך (חסר מספר תעודה).', 'warning');
            }
        };

        const filterMessageOptions = () => {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        };

        const toggleMessageOptions = () => {
            const container = document.getElementById('whatsapp-message-options-container');
            container.classList.toggle('hidden');
        };

        // New Order Modal Functions
        const openNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.remove('hidden');
            document.getElementById('new-order-modal').classList.add('flex');
            // Pre-fill some fields if desired, e.g., current date
            document.getElementById('new-order-date').valueAsDate = new Date();
            document.getElementById('new-order-status').value = 'פתוח'; // Default status
        };

        const closeNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.add('hidden');
            document.getElementById('new-order-modal').classList.remove('flex');
            document.getElementById('new-order-form').reset(); // Clear form inputs
        };

        const submitNewOrder = async () => {
            const form = document.getElementById('new-order-form');
            const formData = new FormData(form);
            const order = {};
            // Collect all form data
            formData.forEach((value, key) => {
                order[key] = value;
            });

            // Calculate 'ימים שעברו' if 'תאריך הזמנה' is provided
            const orderDateObj = order['תאריך הזמנה'] ? new Date(order['תאריך הזמנה']) : null;
            order['ימים שעברו'] = orderDateObj && !isNaN(orderDateObj.getTime()) ? daysSince(orderDateObj) : '';

            // Combine container numbers for 'מספרי מכולות' if not explicitly provided
            order['מספרי מכולות'] = order['מספרי מכולות'] || 
                                     `${order['מספר מכולה ירדה'] || ''},${order['מספר מכולה עלתה'] || ''}`
                                     .replace(/^,|,$/g, '')
                                     .replace(/,,/g, ',');

            // Ensure all headers expected by the Google Sheet are present, even if empty
            const sheetHeaders = [
                "תאריך הזמנה", "תעודה", "שם סוכן", "שם לקוח", "כתובת", "סוג פעולה", 
                "ימים שעברו", "מספר מכולה ירדה", "מספר מכולה עלתה", "מספרי מכולות", 
                "סטטוס", "הערות", "תאריך סיום צפוי", "הערות סיום", "תאריך סגירה", 
                "ימים שעברו (עלתה)", "טלפון לקוח"
            ];
            const completeOrder = {};
            sheetHeaders.forEach(header => {
                completeOrder[header] = order[header] !== undefined ? order[header] : '';
            });
            
            // Convert date objects back to YYYY-MM-DD string format for the sheet
            if (completeOrder['תאריך הזמנה'] instanceof Date) {
                completeOrder['תאריך הזמנה'] = completeOrder['תאריך הזמנה'].toISOString().split('T')[0];
            }
            if (completeOrder['תאריך סיום צפוי'] instanceof Date) {
                completeOrder['תאריך סיום צפוי'] = completeOrder['תאריך סיום צפוי'].toISOString().split('T')[0];
            }
            if (completeOrder['תאריך סגירה'] instanceof Date) {
                completeOrder['תאריך סגירה'] = completeOrder['תאריך סגירה'].toISOString().split('T')[0];
            }
            
            await addNewOrderToSheet(completeOrder);
            closeNewOrderModal();
        };

    </script>
</body>
</html>
