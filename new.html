<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</title>
    <!-- Chosen Palette: Calm Neutrals with Purple Accent -->
    <!-- Application Structure Plan: The SPA is designed as a multi-tab dashboard. The default view is the 'Dashboard' which provides high-level KPIs and a full, filterable list of all container operations. Additional tabs allow the user to focus on specific tasks: 'Container Inventory' for tracking the status of each physical container, and 'Treatment Board' for a Kanban-style view of overdue orders that require action. This task-oriented structure, guided by the specification, allows the manager to quickly assess the overall status and then drill down into specific management areas (inventory, overdue accounts) for efficient workflow. Modals are used for detailed views (e.g., customer history) to avoid cluttering the main interface. -->
    <!-- Visualization & Content Choices: 
        - KPIs (Total containers, overdue, etc.): Goal=Inform -> Method=Dynamic text in Cards -> Interaction=None -> Justification=Quick, scannable overview.
        - All Operations List: Goal=Organize/Compare -> Method=Interactive HTML Table -> Interaction=Search, Filter, Sort -> Justification=Allows deep-diving into the full dataset.
        - Overdue Orders: Goal=Inform/Act -> Method=Kanban Board & Highlighted Table -> Interaction=Visual grouping, direct links to customer details -> Justification=Focuses attention on urgent tasks.
        - Operations per Agent: Goal=Inform/Compare -> Method=Bar Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Clear visual comparison of agent performance.
        - Operations over Time: Goal=Change -> Method=Line Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Shows trends and business activity patterns.
        - Container Status: Goal=Organize -> Method=Two distinct HTML tables (In Use/Available) -> Interaction=Click for history -> Justification=Clear separation of inventory status for operational planning.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        .kanban-column {
            min-height: 200px;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }

        /* Custom styles for larger and bolder table text */
        .table-large-text td { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        /* Typing effect cursor */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em; /* Adjust to match font size */
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</h1>
            <p class="text-lg text-gray-600">×œ×•×— ×‘×§×¨×” ××¨×›×–×™ ×œ× ×™×”×•×œ, ××¢×§×‘ ×•× ×™×ª×•×— ×¤×¢×™×œ×•×ª</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b border-gray-200 mb-8">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>×œ×•×— ×‘×§×¨×”
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>×œ×•×— ×˜×™×¤×•×œ ×‘×—×¨×™×’×•×ª
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
                    <button onclick="openNewOrderModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>×”×–×× ×” ×—×“×©×”
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª ×‘××ª×¨×™×</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">×œ×§×•×—×•×ª ×‘×—×¨×™×’×” <span class="text-xs">(××¢×œ 10 ×™××™×)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤× ×•×™×•×ª ×‘××œ××™</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">×¡×”"×› ×¤×¢×•×œ×•×ª (×›×œ ×”×–×× ×™×)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×™×œ×•×ª ×œ×¤×™ ×¡×•×›×Ÿ</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª ×œ××•×¨×š ×–××Ÿ</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">×›×œ×œ ×”×¤×¢×•×œ×•×ª</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="×—×¤×© ×œ×¤×™ ×©× ×œ×§×•×—, ×ª×¢×•×“×”, ×©× ×¡×•×›×Ÿ...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª×¢×•×“×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×©× ×œ×§×•×—</th>
                                    <th class="py-3 px-4 text-right font-bold">×©× ×¡×•×›×Ÿ</th>
                                    <th class="py-3 px-4 text-right font-bold">×¡×•×’ ×¤×¢×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×™××™× ×‘×©×›×™×¨×•×ª</th>
                                    <th class="py-3 px-4 text-right font-bold">×¡×˜×˜×•×¡</th>
                                    <th class="py-3 px-4 text-right font-bold">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×‘×©×™××•×© ×¤×¢×™×œ</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">××¡×¤×¨ ××›×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×œ×§×•×— × ×•×›×—×™</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š ×”×¦×‘×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×™××™× ×‘××ª×¨</th>
                                    <th class="py-3 px-4 text-right font-bold">×”×™×¡×˜×•×¨×™×”</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h2>
                     <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">××¡×¤×¨ ××›×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š ×—×–×¨×” ×œ××œ××™</th>
                                    <th class="py-3 px-4 text-right font-bold">×œ×§×•×— ××—×¨×•×Ÿ</th>
                                    <th class="py-3 px-4 text-right font-bold">×”×™×¡×˜×•×¨×™×”</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">×œ×•×— ×˜×™×¤×•×œ ×‘×œ×§×•×—×•×ª ×—×•×¨×’×™×</h2>
                 <p class="text-gray-600 mb-6">×›××Ÿ ××¨×•×›×–×•×ª ×›×œ ×”××›×•×œ×•×ª ×©× ××¦××•×ª ××¦×œ ×œ×§×•×—×•×ª ××¢×œ 10 ×™××™ ×¢×‘×•×“×” ×•×“×•×¨×©×•×ª ×˜×™×¤×•×œ (×”×—×œ×¤×” ××• ×”×•×¦××”).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
            </section>
        </main>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold" id="modal-customer-name"></h2>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2">×¡×™×›×•× ×¤×¢×™×œ×•×ª</h3>
                <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6"></div>
                <h3 class="text-lg font-semibold mb-2">×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª</h3>
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-3 text-right">×ª××¨×™×š</th>
                                <th class="py-2 px-3 text-right">×ª×¢×•×“×”</th>
                                <th class="py-2 px-3 text-right">×¤×¢×•×œ×”</th>
                                <th class="py-2 px-3 text-right">×¡×˜×˜×•×¡</th>
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="table-large-text"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center">
                        <span>×‘×—×¨ ×”×•×“×¢×” ××•×‘× ×™×ª</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200" placeholder="×—×¤×© ×”×•×“×¢×”..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">×ª×•×›×Ÿ ×”×”×•×“×¢×”:</label>
                     <div class="border border-gray-300 rounded-md p-2 min-h-[100px] bg-gray-50 mb-2">
                        <span id="typing-effect-display" class="whitespace-pre-wrap"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md" rows="5"></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">×©×œ×— ×”×•×“×¢×”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”</h2>
                <button onclick="closeNewOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label for="new-order-date" class="block text-sm font-semibold text-gray-700 mb-1">×ª××¨×™×š ×”×–×× ×”</label>
                        <input type="date" id="new-order-date" name="×ª××¨×™×š ×”×–×× ×”" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">×ª×¢×•×“×”</label>
                        <input type="text" id="new-order-docid" name="×ª×¢×•×“×”" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">×©× ×¡×•×›×Ÿ</label>
                        <input type="text" id="new-order-agent" name="×©× ×¡×•×›×Ÿ" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">×©× ×œ×§×•×—</label>
                        <input type="text" id="new-order-customer-name" name="×©× ×œ×§×•×—" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-address" class="block text-sm font-semibold text-gray-700 mb-1">×›×ª×•×‘×ª</label>
                        <input type="text" id="new-order-address" name="×›×ª×•×‘×ª" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">×¡×•×’ ×¤×¢×•×œ×”</label>
                        <select id="new-order-action-type" name="×¡×•×’ ×¤×¢×•×œ×”" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="">×‘×—×¨ ×¤×¢×•×œ×”</option>
                            <option value="×”×¦×‘×”">×”×¦×‘×”</option>
                            <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                            <option value="×”×•×¨×“×”">×”×•×¨×“×”</option>
                            <option value="×”×•×¦××”">×”×•×¦××”</option>
                            <option value="×”×–×–×”">×”×–×–×”</option>
                            <option value="×¤×™× ×•×™ ×‘××§×•×">×¤×™× ×•×™ ×‘××§×•×</option>
                            <option value="×’×™×©×” ×œ×œ× ×¤×¢×•×œ×”">×’×™×©×” ×œ×œ× ×¤×¢×•×œ×”</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-status" class="block text-sm font-semibold text-gray-700 mb-1">×¡×˜×˜×•×¡</label>
                        <select id="new-order-status" name="×¡×˜×˜×•×¡" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="×¤×ª×•×—">×¤×ª×•×—</option>
                            <option value="×—×•×¨×’">×—×•×¨×’</option>
                            <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”</label>
                        <input type="text" id="new-order-container-dropped" name="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”</label>
                        <input type="text" id="new-order-container-lifted" name="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™</label>
                        <input type="date" id="new-order-expected-end-date" name="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">×˜×œ×¤×•×Ÿ ×œ×§×•×—</label>
                        <input type="tel" id="new-order-phone" name="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">×”×¢×¨×•×ª</label>
                        <textarea id="new-order-notes" name="×”×¢×¨×•×ª" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2">
                <button onclick="closeNewOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">×‘×™×˜×•×œ</button>
                <button onclick="submitNewOrder()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">×”×•×¡×£ ×”×–×× ×”</button>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        // Global state
        let allOperations = [];
        let charts = {};
        let isLoadingData = false; // Added loading state

        // Utility functions
        const parseFullTrackingCSV = (data) => {
            // This function is now mostly for historical name, as data is expected to be JSON array
            return data;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            // Handle both YYYY-MM-DD and DD/MM/YYYY formats
            if (dateStr.includes('-') && dateStr.split('-').length === 3) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            if (dateStr.includes('/') && dateStr.split('/').length === 3) {
                const parts = dateStr.split('/');
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const diff = new Date() - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        // Global functions for HTML onclick attributes (MUST BE GLOBAL)
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');
        };

        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "×ª×œ ××‘×™×‘", "×™×¨×•×©×œ×™×", "×—×™×¤×”", "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ", "×¤×ª×— ×ª×§×•×•×”", "××©×“×•×“", "×‘××¨ ×©×‘×¢",
                "× ×ª× ×™×”", "×‘× ×™ ×‘×¨×§", "×—×•×œ×•×Ÿ", "×¨××ª ×’×Ÿ", "×¨×—×•×‘×•×ª", "××©×§×œ×•×Ÿ", "×‘×ª ×™×", "×”×¨×¦×œ×™×”",
                "×›×¤×¨ ×¡×‘×", "×—×“×¨×”", "×‘×™×ª ×©××©", "××•×“×™×¢×™×Ÿ-××›×‘×™×-×¨×¢×•×ª", "×œ×•×“", "×¨××œ×”", "×¨×¢× × ×”",
                "× ×”×¨×™×”", "×§×¨×™×™×ª ×’×ª", "××™×œ×ª", "×¢×›×•", "×¦×¤×ª", "×˜×‘×¨×™×”", "× ×¦×¨×ª", "××•× ××œ-×¤××—×",
                "×‘× ×™ ×¦×™×•×Ÿ", "××‘×Ÿ ×™×”×•×“×”", "××•×¨ ×™×”×•×“×”", "××•×¨ ×¢×§×™×‘×", "××¨×™××œ", "××©×§×œ×•×Ÿ", "×‘××§×” ××œ-×’×¨×‘×™×™×”",
                "×’×‘×¢×ª×™×™×", "×“×™××•× ×”", "×”×•×“ ×”×©×¨×•×Ÿ", "×–×›×¨×•×Ÿ ×™×¢×§×‘", "×™×‘× ×”", "×™×”×•×“-××•× ×•×¡×•×Ÿ", "×™×•×§× ×¢× ×¢×™×œ×™×ª",
                "×›×•×›×‘ ×™××™×¨", "×›×¤×¨ ×™×•× ×”", "×›×¤×¨ ×§××¡×", "×›×¨××™××œ", "××’×“×œ ×”×¢××§", "××›×‘×™×", "××¢×œ×” ××“×•××™×",
                "××¦×¤×” ×¨××•×Ÿ", "× ×”×¨×™×”", "× ×¡ ×¦×™×•× ×”", "× ×©×¨", "×¢×¤×•×œ×”", "×¢×¨×“", "×¤×¨×“×¡ ×—× ×”-×›×¨×›×•×¨",
                "×§×¨×™×™×ª ××•× ×•", "×§×¨×™×™×ª ×‘×™××œ×™×§", "×§×¨×™×™×ª ×™×", "×§×¨×™×™×ª ××•×¦×§×™×Ÿ", "×§×¨×™×™×ª ×©××•× ×”",
                "×©×•×”×", "×©×“×¨×•×ª", "×¨××ª ×”×©×¨×•×Ÿ"
            ].sort((a,b) => b.length - a.length);

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        const whatsappMessages = [
            { id: 'new_customer_welcome', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n×ª×•×“×” ×©×‘×—×¨×ª ×œ×”×ª×—×™×œ ×©×›×™×¨×•×ª ××›×•×œ×” ××¦×œ× ×•! ğŸ¥³ ×œ×›×œ ×¤× ×™×”, ×‘×§×©×ª ×”×—×œ×¤×” ××• ×”×•×¦××” ×©×œ ×”××›×•×œ×”, ××ª×” ××•×–××Ÿ ×œ×™×¦×•×¨ ×§×©×¨.\n\nğŸ“ ××¡×¤×¨ ×•×•×˜×¡××¤ ×œ×”×–×× ×•×ª: **[××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**\nâ˜ï¸ ×˜×œ×¤×•×Ÿ ××—×œ×§×ª ×”×–×× ×•×ª: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ‘‹' },
            { id: 'approaching_due_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×–×›×™×¨ ×œ×š ×›×™ ×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×‘×¢×•×“ **7 ×™××™×** ğŸ—“ï¸. ×–×” ×”×–××Ÿ ×œ× ×§×•×˜ ×¤×¢×•×œ×”!\n\n×”×× ×ª×¨×¦×” ×œ×”××¨×™×š ××ª ×ª×§×•×¤×ª ×”×©×›×™×¨×•×ª, ×œ×”×—×œ×™×£ ××ª ×”××›×•×œ×”, ××• ×œ×”×–××™×Ÿ ××™×¡×•×£? â™»ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â°' },
            { id: 'approaching_due_3_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×××© ×‘×§×¨×•×‘, ×‘×¢×•×“ **3 ×™××™×** âš ï¸. ×× × ×˜×¤×œ ×‘× ×•×©× ×›×“×™ ×œ×× ×•×¢ ×—×¨×™×’×•×ª.\n\n×× ×• ×œ×¨×©×•×ª×š ×œ×›×œ ×¢×–×¨×”! ğŸ™', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â³' },
            { id: 'overdue_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×•×“×™×¢ ×œ×š ×¢×œ ×—×¨×™×’×” ×‘×™××™ ×©×›×™×¨×•×ª ×©×œ ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×** ğŸš¨. × × ×œ×™×¦×•×¨ ×§×©×¨ ×¢× ××—×œ×§×ª ×”×–×× ×•×ª **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]** ××• ×œ×”×©×™×‘ ×œ×”×•×“×¢×” ×–×• ××” ×ª×¨×¦×” ×©× ×‘×¦×¢ (×”×—×œ×¤×”/×”×•×¦××”).', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'â—ï¸' },
            { id: 'overdue_30_days', text: '**×”×ª×¨××” ×—××•×¨×”, [×©× ×œ×§×•×—]:**\n\n×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×©×‘×©×™××•×©×š ×—×•×¨×’×ª ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×**! ×™×© ×œ×˜×¤×œ ×‘× ×•×©× ×‘×“×—×™×¤×•×ª ×›×“×™ ×œ×× ×•×¢ ×—×™×•×‘×™× × ×•×¡×¤×™× ×•×¡×™×‘×•×›×™× ××©×¤×˜×™×™×. âš–ï¸\n\n**×¦×•×¨ ×§×©×¨ ××™×™×“×™×ª: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”´' },
            { id: 'overdue_long', text: '**×œ×›×‘×•×“: [×©× ×œ×§×•×—]**\n\n**×”× ×“×•×Ÿ: ×—×•×‘ ×‘×’×™×Ÿ ×©×›×™×¨×•×ª ××›×•×œ×” ×—×•×¨×’×ª**\n\n×× ×• ×¤×•× ×™× ××œ×™×š ×‘×”×ª×™×™×—×¡ ×œ×—×©×‘×•× ×š, ×”× ××¦× ×‘×—×¨×™×’×” ××©××¢×•×ª×™×ª ×©×œ [**×™××™× ×©×¢×‘×¨×•**] ×™××™× ×¢×‘×•×¨ ××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]).\n\n×‘×”×™×¢×“×¨ ×”×¡×“×¨×” ××™×™×“×™×ª, ×× ×• × ××œ×¦×™× ×œ× ×§×•×˜ ×‘×¦×¢×“×™× ××©×¤×˜×™×™× ×œ×’×‘×™×™×”. ×× ×• ×§×•×¨××™× ×œ×š ×œ×™×¦×•×¨ ×§×©×¨ ×“×—×•×£ ×œ×”×¡×“×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '××©×¤×˜×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: '' },
            { id: 'general_inquiry', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n××™×š ×× ×—× ×• ×™×›×•×œ×™× ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ¤” ×× ×™×© ×œ×š ×©××œ×•×ª, ×‘×§×©×•×ª ××• ×ª×–×›×•×¨×•×ª, ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª ××œ×™× ×•. ×× ×—× ×• ×›××Ÿ ×‘×©×‘×™×œ×š! âœ¨', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ’¬' },
            { id: 'payment_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×™×“×™×“×•×ª×™×ª ×œ×’×‘×™ ×ª×©×œ×•× ×—×©×‘×•× ×™×ª ××¡×¤×¨ **[×ª×¢×•×“×”]** ğŸ’°. ×× ×• ××•×“×™× ×œ×š ×¢×œ ×ª×©×•××ª ×”×œ×‘ ×”××”×™×¨×” ×•×¢×œ ×”××©×š ×©×™×ª×•×£ ×”×¤×¢×•×œ×”.', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ’²' },
            { id: 'service_feedback', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×• ××§×•×•×™× ×©×©×™×¨×•×ª×™× ×• ×¢×•× ×™× ×¢×œ ×¦×™×¤×™×•×ª×™×š. × ×©××— ×œ×§×‘×œ ××©×•×‘ ×¢×œ ×”×—×•×•×™×” ×©×œ×š ×¢× ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×›×“×™ ×©× ×•×›×œ ×œ×”×©×ª×¤×¨ ×•×œ×”×¢× ×™×§ ×œ×š ×©×™×¨×•×ª ×˜×•×‘ ×™×•×ª×¨. â­', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ“' },
            { id: 'holiday_greetings', text: '×—×’ ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×•×œ××©×¤×—×ª×š ×—×’ ×©××—, ××œ× ×©×œ×•×•×”, ×‘×¨×™××•×ª ×•×”××•×Ÿ ×©××—×”! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ' },
            { id: 'special_offer', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×™×© ×œ× ×• ×—×“×©×•×ª ××¨×’×©×•×ª! ğŸ ××‘×¦×¢ ××™×•×—×“ ×œ××›×•×œ×•×ª ×—×“×©×•×ª/× ×•×¡×¤×•×ª ×¢×‘×•×¨×š. ××œ ×ª×—××™×¥! ×œ×¤×¨×˜×™× × ×•×¡×¤×™×, ×”×©×‘ ×œ×”×•×“×¢×” ×–×• ××• ×”×ª×§×©×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '×©×™×•×•×§', placeholders: ['×©× ×œ×§×•×—', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'âœ¨' },
            { id: 'follow_up_issue', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×—× ×• ×—×•×–×¨×™× ××œ×™×š ×œ×’×‘×™ ×”× ×•×©× ×©×“×™×•×•×—×ª ×¢×œ×™×• ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ğŸ› ï¸. ×”×× ×”×‘×¢×™×” × ×¤×ª×¨×” ×œ×©×‘×™×¢×•×ª ×¨×¦×•× ×š? ×× ×œ×, ×× × ×”×•×“×¢ ×œ× ×• ×›×“×™ ×©× ×•×›×œ ×œ×”××©×™×š ×œ×˜×¤×œ.', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'âœ…' },
            { id: 'document_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×œ×©×œ×™×—×ª ×”××¡××›×™× ×”×—×¡×¨×™× ×¢×‘×•×¨ ×”×–×× ×” **[×ª×¢×•×“×”]** ğŸ“„. ×× × ×©×œ×— ××•×ª× ×‘×”×§×“× ×›×“×™ ×©× ×•×›×œ ×œ×”×©×œ×™× ××ª ×”×˜×™×¤×•×œ ×‘×”×–×× ×”.\n\n×ª×•×“×” ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ“Œ' },
            { id: 'service_confirmation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×”×©×™×¨×•×ª ×©×”×•×–××Ÿ (×ª×¢×•×“×” **[×ª×¢×•×“×”]**) ××•×©×¨ ×•×™×ª×‘×¦×¢ ×‘-**[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]** âœ…. ×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×• ×•×©×™×”×™×” ×™×•× × ×¤×œ×!', category: '××™×©×•×¨', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'], emoji: 'ğŸ‘' },
            { id: 'service_delay', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×¢×§×‘ × ×¡×™×‘×•×ª ×‘×œ×ª×™ ×¦×¤×•×™×•×ª, ×™×™×ª×›×Ÿ ×©×™×”×™×” ×¢×™×›×•×‘ ×§×œ ×‘×˜×™×¤×•×œ ×‘×”×–×× ×” **[×ª×¢×•×“×”]** â±ï¸. ×× ×• ××ª× ×¦×œ×™× ×¢×œ ××™ ×”× ×•×—×•×ª ×•× ×¤×¢×œ ×œ×¤×ª×•×¨ ×–××ª ×‘××”×™×¨×•×ª ×”××¤×©×¨×™×ª.\n\n× ×•×“×™×¢ ×œ×š ×¢×œ ×›×œ ×¢×“×›×•×Ÿ! ğŸ”œ', category: '××™×“×¢', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸš§' },
            { id: 'location_update_request', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×›×“×™ ×©× ×•×›×œ ×œ×ª×× ××ª ×”×©×™×¨×•×ª ×‘×¦×•×¨×” ×”×˜×•×‘×” ×‘×™×•×ª×¨, ×× × ×•×•×“× ×©××™×§×•× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¢×•×“×›×Ÿ ×•××“×•×™×§ ğŸ“. ×–×” ×—×©×•×‘ ×œ×”×’×¢×” ×™×¢×™×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ—ºï¸' },
            { id: 'happy_birthday', text: '×™×•× ×”×•×œ×“×ª ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰ğŸ‚\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×™×•× ××œ× ×‘×©××—×”, ×‘×¨×™××•×ª, ×”×’×©××” ×•×”×¨×‘×” ×¨×’×¢×™× ××ª×•×§×™×! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸˆ' },
            { id: 'review_invitation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n× ×”× ×™×ª ××”×©×™×¨×•×ª ×©×œ× ×•? âœ¨ × ×©××— ×× ×ª×•×›×œ ×œ×”×§×“×™×© ×¨×’×¢ ×•×œ×›×ª×•×‘ ×œ× ×• ×‘×™×§×•×¨×ª ×§×¦×¨×” ×›××Ÿ: [**×œ×™× ×§ ×œ×‘×™×§×•×¨×ª**]. ×ª×•×“×” ××¨××© ×¢×œ ×¢×–×¨×ª×š ×œ×”×©×ª×¤×¨! ğŸ™', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª'], emoji: 'ğŸŒŸ' },
            { id: 'tech_support_contact', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×œ×›×œ ×‘×¢×™×” ×˜×›× ×™×ª ××• ×ª×¤×¢×•×œ×™×ª ×¢× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]), ××—×œ×§×ª ×”×ª××™×›×” ×©×œ× ×• ×–××™× ×” ×¢×‘×•×¨×š ğŸ§‘â€ğŸ”§.\n\n**×¦×•×¨ ×§×©×¨: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”§' },
            { id: 'general_thanks', text: '×ª×•×“×” ×¨×‘×” ×œ×š, **[×©× ×œ×§×•×—]**, ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×” ×•×”×××•×Ÿ ×‘[×©× ×”×—×‘×¨×”]! ğŸ™\n\n×× ×• ××¢×¨×™×›×™× ××ª ×‘×—×™×¨×ª×š ×‘× ×• ×•××§×•×•×™× ×œ×”××©×™×š ×œ×©×¨×ª ××•×ª×š × ××× ×”. ğŸ’–', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ˜Š' },
            { id: 'multi_container_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×©×× ×• ×œ×‘ ×©×‘×¨×©×•×ª×š **××¡×¤×¨ ××›×•×œ×•×ª ×¤×¢×™×œ×•×ª** ğŸ—ï¸. ×× ×• ×›××Ÿ ×›×“×™ ×œ×•×•×“× ×©×›×œ ×”×¦×¨×›×™× ×©×œ×š ××¡×•×¤×§×™×.\n\n×”×× ×™×© ××©×”×• ×©× ×•×›×œ ×œ×¢×–×•×¨ ×‘×• ×‘× ×•×’×¢ ×œ××›×•×œ×•×ª ×©×œ×š? ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª! ğŸ¤', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ“¦' },
            { id: 'container_mismatch', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×”×ª×¨××”:** ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×™×¨×“×” ××¦×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ×œ×¤× ×™ **[×™××™× ×©×¢×‘×¨×•]** ×™××™× ×•×˜×¨× ×”×•×—×–×¨×”/× ×¡×’×¨×”! ğŸš¨', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'ğŸš¨' },
            { id: 'pending_order_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×‘×˜×™×¤×•×œ:** ×”×–×× ×” **[×ª×¢×•×“×”]** ×©×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ××¡×•×× ×ª "×‘×˜×™×¤×•×œ" ×•×œ× ×¢×•×“×›× ×” **[×™××™× ×©×¢×‘×¨×•]** ×™××™×. ×“×•×¨×© ×‘×“×™×§×”! âš ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'âš ï¸' }
        ];

        const cityGuidelines = {
            '×”×¨×¦×œ×™×”': {
                id: 'herzliya_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×”×¨×¦×œ×™×”:\n×›×“×™ ×œ×”×¦×™×‘ ××›×•×œ×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘×¨×—×•×‘ ×‘×”×¨×¦×œ×™×”, ×™×© ×œ×”×’×™×© ×‘×§×©×” ××¨××© ×œ××’×£ ×”×¤×™×§×•×— ×”×¢×™×¨×•× ×™. ×”×‘×§×©×” ×›×¨×•×›×” ×‘×ª×©×œ×•× ××’×¨×” ×•× ×“×¨×© ××™×©×•×¨ ×‘×›×ª×‘. ××•××œ×¥ ×œ×•×•×“× ××ª ×›×œ ×”×¤×¨×˜×™× ×‘××ª×¨ ×”×¢×™×¨×™×™×” ××• ×‘×˜×œ×¤×•×Ÿ.\n\n×§×™×©×•×¨ ×œ××™×“×¢: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ“'
            },
            '×¨×¢× × ×”': {
                id: 'raanana_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×¨×¢× × ×”:\n×‘×¨×¢× × ×”, ×—×œ ××™×¡×•×¨ ××•×—×œ×˜ ×œ×”×©××™×¨ ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘××§×•× ×¦×™×‘×•×¨×™ (×‘×¨×—×•×‘) ×‘×¡×•×¤×™ ×©×‘×•×¢ ×•×‘×—×’×™×. ×™×© ×œ×“××•×’ ×œ×”×–××™×Ÿ ×¤×™× ×•×™ ×œ×¤× ×™ ×›× ×™×¡×ª ×”×©×‘×ª/×—×’. ×§× ×¡×•×ª ×™×™× ×ª× ×• ×œ××¤×¨×™×. ×× × ×”×§×¤×“ ×¢×œ ×”× ×—×™×•×ª ××œ×•.\n\n××™×“×¢ × ×•×¡×£: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸš«'
            },
            '×ª×œ ××‘×™×‘': {
                id: 'telaviv_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×ª×œ ××‘×™×‘:\n×‘×ª×œ ××‘×™×‘, ×”×¦×‘×ª ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘×¨×—×•×‘ ××—×™×™×‘×ª ×§×‘×œ×ª ×”×™×ª×¨ ××”×¢×™×¨×™×™×”. ×™×© ×œ×”×’×™×© ×‘×§×©×” ××§×•×•× ×ª ×•×œ×¦×¨×£ ××ª ×›×œ ×”××¡××›×™× ×”× ×“×¨×©×™×. ×©×™××• ×œ×‘ ×œ×”× ×—×™×•×ª ×”××“×•×™×§×•×ª ×œ×’×‘×™ ×¡×™××•×Ÿ ×”××›×•×œ×” ×•××©×š ×”×”×¦×‘×”.\n\n×œ××™×“×¢ ×•×”×’×©×ª ×‘×§×©×”: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ›ï¸'
            }
        };

        const companyInfo = {
            phoneNumber: '972508860896', 
            companyPhone: '097602010', 
            companyName: '×—.×¡×‘×Ÿ' 
        };

        // This is your Google Apps Script Web App URL. Make sure it's deployed correctly.
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk03pVBEBzHIWkFj1OzqM0T5buH5cfNjD8njGza8AoKWulO1sPtiBrOpUZZItOd_gi/exec'; 

        let typingInterval;
        let currentMessageFullText = '';
        let typingIndex = 0;

        // Function to fetch data from Google Sheet
        const fetchDataFromGoogleSheet = async () => {
            isLoadingData = true;
            // Optionally, show a loading indicator here
            // document.getElementById('loader').classList.remove('hidden'); 

            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=getData`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json(); // Parse the entire JSON response

                // Check if the response indicates success and contains data
                if (result.success && Array.isArray(result.data)) {
                    allOperations = result.data
                        .map(op => ({
                            ...op,
                            '×ª××¨×™×š ×”×–×× ×”': formatDate(op['×ª××¨×™×š ×”×–×× ×”']),
                            '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': formatDate(op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']),
                            '×ª××¨×™×š ×¡×’×™×¨×”': formatDate(op['×ª××¨×™×š ×¡×’×™×¨×”']),
                        }))
                        .sort((a, b) => (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0));
                } else {
                    console.error("Received data is not an array or success is false:", result);
                    showStatusMessage("×©×’×™××”: ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××’×™×œ×™×•×Ÿ ×’×•×’×œ ××™× × ×‘×¤×•×¨××˜ ×¦×¤×•×™ ××• ×©×”×™×™×ª×” ×©×’×™××” ×‘×©×¨×ª: " + (result.message || '××™×Ÿ ×”×•×“×¢×” ×¡×¤×¦×™×¤×™×ª'), 'error');
                    allOperations = []; // Initialize as empty array to prevent further errors
                }

                renderDashboard();
                renderInventory();
                renderTreatmentBoard();

            } catch (error) {
                console.error("Error fetching data from Google Sheet:", error);
                // Using a non-blocking message box instead of alert
                showStatusMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××’×™×œ×™×•×Ÿ ×’×•×’×œ: " + error.message, 'error');
            } finally {
                isLoadingData = false;
                // Optionally, hide loading indicator
                // document.getElementById('loader').classList.add('hidden');
            }
        };

        // Function to add new order to Google Sheet
        const addNewOrderToSheet = async (orderData) => {
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=addOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Send as JSON
                    },
                    body: JSON.stringify(orderData) // Send as JSON object directly
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('×”×”×–×× ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×” ×œ×’×™×œ×™×•×Ÿ!', 'success');
                    fetchDataFromGoogleSheet(); // Reload data after adding
                } else {
                    showStatusMessage('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×”×–×× ×”: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding order to sheet:', error);
                showStatusMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª ×‘×¢×ª ×”×•×¡×¤×ª ×”×–×× ×”.', 'error');
            }
        };

        // Custom status message display (instead of alert)
        const showStatusMessage = (message, type) => {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50`;
            if (type === 'success') {
                statusDiv.classList.add('bg-green-600');
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-600');
            } else {
                statusDiv.classList.add('bg-gray-700');
            }
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.remove();
            }, 5000); // Message disappears after 5 seconds
        };


        document.addEventListener('DOMContentLoaded', () => {
            fetchDataFromGoogleSheet(); // Call fetch function to load initial data
            document.getElementById('main-search').addEventListener('input', renderAllOperationsTable);
        });

        const getKPIs = () => {
            let activeContainerLocations = {}; 
            let totalOverdueCustomerIds = new Set(); 

            const detailedContainerStatus = {}; 
            allOperations.slice().sort((a,b) => (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0)).forEach(op => {
                const opDate = op['×ª××¨×™×š ×”×–×× ×”'];
                if (!opDate) return;

                const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                containersTaken.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'in_use',
                        customerId: op['×œ×§×•×—'],
                        customerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });

                containersBrought.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'available',
                        lastCustomerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });
            });

            let currentActiveContainersCount = 0;
            let currentAvailableContainersCount = 0;

            for (const containerNum in detailedContainerStatus) {
                const info = detailedContainerStatus[containerNum];
                if (info.status === 'in_use') {
                    currentActiveContainersCount++;
                    if (info.latestOperation && info.latestOperation['×¡×˜×˜×•×¡'] === '×—×•×¨×’') {
                        totalOverdueCustomerIds.add(info.customerId);
                    }
                } else if (info.status === 'available') {
                    currentAvailableContainersCount++;
                }
            }
            
            return {
                activeContainers: currentActiveContainersCount,
                overdueCustomers: totalOverdueCustomerIds.size,
                availableContainers: currentAvailableContainersCount,
                totalOperations: allOperations.length,
            };
        };

        const renderDashboard = () => {
            const { activeContainers, overdueCustomers, availableContainers, totalOperations } = getKPIs();
            document.getElementById('kpi-active-containers').textContent = activeContainers;
            document.getElementById('kpi-overdue-customers').textContent = overdueCustomers;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-total-operations').textContent = totalOperations;
            
            renderAllOperationsTable();
            renderCharts();
        };

        const renderAllOperationsTable = () => {
            const searchTerm = document.getElementById('main-search').value.toLowerCase();
            const tableBody = document.getElementById('all-operations-table');
            tableBody.innerHTML = '';
            
            const filteredOps = allOperations.filter(op => 
                (op['×©× ×œ×§×•×—'] && op['×©× ×œ×§×•×—'].toLowerCase().includes(searchTerm)) ||
                (op['×ª×¢×•×“×”'] && String(op['×ª×¢×•×“×”']).toLowerCase().includes(searchTerm)) || // Ensure ×ª×¢×•×“×” is string
                (op['×©× ×¡×•×›×Ÿ'] && op['×©× ×¡×•×›×Ÿ'].toLowerCase().includes(searchTerm))
            );

            filteredOps.slice(0, 100).forEach(op => { 
                const days = (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') && op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                let statusText, statusClass;

                if (op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                    statusText = '×—×¨×™×’×”';
                    statusClass = 'status-red';
                } else if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    statusText = '×¡×’×•×¨';
                    statusClass = 'status-gray';
                } else { 
                    statusText = '×¤×¢×™×œ';
                    statusClass = 'status-green';
                }

                const row = `
                    <tr class="hover:bg-gray-50 cursor-pointer">
                        <td class="py-3 px-4">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-3 px-4">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-3 px-4 font-semibold text-gray-700">${op['×©× ×œ×§×•×—']}</td>
                        <td class="py-3 px-4">${op['×©× ×¡×•×›×Ÿ']}</td>
                        <td class="py-3 px-4">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-3 px-4">${days}</td>
                        <td class="py-3 px-4"><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="py-3 px-4">
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                            <button onclick="openModal('${op['×œ×§×•×—']}')" class="text-blue-600 hover:text-blue-700 ml-2 focus:outline-none">
                                <i class="fas fa-eye text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };

        const renderCharts = () => {
            const agentCounts = allOperations.reduce((acc, op) => {
                const agent = op['×©× ×¡×•×›×Ÿ'] || '×œ× ×™×“×•×¢';
                acc[agent] = (acc[agent] || 0) + 1;
                return acc;
            }, {});
            if (charts.agent) charts.agent.destroy();
            charts.agent = new Chart(document.getElementById('agentActivityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agentCounts).map(label => {
                        if (label.length > 16) {
                            return label.match(/.{1,8}/g).join('\n'); 
                        }
                        return label;
                    }),
                    datasets: [{
                        label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                        data: Object.values(agentCounts),
                        backgroundColor: '#8b5cf6',
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                     plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label.replace(/\n/g, ' '); 
                                }
                            }
                        }
                    }
                }
            });

            const timelineCounts = allOperations.reduce((acc, op) => {
                if (op['×ª××¨×™×š ×”×–×× ×”'] && !isNaN(op['×ª××¨×™×š ×”×–×× ×”'].getTime())) {
                    const month = op['×ª××¨×™×š ×”×–×× ×”'].toISOString().slice(0, 7);
                    acc[month] = (acc[month] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedTimeline = Object.entries(timelineCounts).sort((a, b) => a[0].localeCompare(b[0]));
             if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(document.getElementById('operationsTimelineChart'), {
                type: 'line',
                data: {
                    labels: sortedTimeline.map(e => e[0]),
                    datasets: [{
                        label: '×›××•×ª ×¤×¢×•×œ×•×ª ×—×•×“×©×™×ª',
                        data: sortedTimeline.map(e => e[1]),
                        borderColor: '#6d28d9',
                        tension: 0.1
                    }]
                },
                 options: { responsive: true, maintainAspectRatio: false }
            });
        };
        
        const renderInventory = () => {
            const inUseBody = document.getElementById('in-use-containers-table');
            const availableBody = document.getElementById('available-containers-table');
            inUseBody.innerHTML = '';
            availableBody.innerHTML = '';

            const containerHistory = {}; 

            allOperations.forEach(op => {
                const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const allRelatedContainers = [...new Set([...containersTaken, ...containersBrought])];

                allRelatedContainers.forEach(containerNum => {
                    if (!containerHistory[containerNum]) {
                        containerHistory[containerNum] = [];
                    }
                    containerHistory[containerNum].push(op);
                });
            });

            const containerCurrentStatus = {}; 

            for (const containerNum in containerHistory) {
                const history = containerHistory[containerNum].sort((a,b) => (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0));
                let currentStatus = { status: 'unknown', lastActionDate: null, customerId: null, customerName: null, latestOperation: null };

                history.forEach(op => {
                    const opDate = op['×ª××¨×™×š ×”×–×× ×”'];
                    if (!opDate) return;

                    const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                    const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                    if (opDate && (!currentStatus.lastActionDate || opDate >= currentStatus.lastActionDate)) {
                        if (containersTaken.includes(containerNum)) {
                            currentStatus = {
                                status: 'in_use',
                                customerId: op['×œ×§×•×—'],
                                customerName: op['×©× ×œ×§×•×—'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        } else if (containersBrought.includes(containerNum)) {
                            currentStatus = {
                                status: 'available',
                                lastCustomerName: op['×©× ×œ×§×•×—'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        }
                    }
                });
                containerCurrentStatus[containerNum] = currentStatus;
            }
            
            const uniqueContainersSorted = Object.keys(containerCurrentStatus).sort((a,b) => parseInt(a) - parseInt(b));

            uniqueContainersSorted.forEach(containerNum => {
                const statusData = containerCurrentStatus[containerNum];
                if (statusData.status === 'in_use') {
                    const days = daysSince(statusData.lastActionDate);
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4 font-semibold">${statusData.customerName}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4 ${days > 10 ? 'text-red-600 font-bold' : ''}">${days}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.customerId}')">×¦×¤×”</button></td>
                        </tr>`;
                    inUseBody.innerHTML += row;
                } else if (statusData.status === 'available') {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4">${statusData.lastCustomerName || '×œ× ×™×“×•×¢'}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.latestOperation['×œ×§×•×—']}')">×¦×¤×”</button></td>
                        </tr>`;
                    availableBody.innerHTML += row;
                }
            });

            document.getElementById('kpi-active-containers').textContent = inUseBody.rows.length;
            document.getElementById('kpi-available-containers').textContent = availableBody.rows.length;
        };

        const renderTreatmentBoard = () => {
            const board = document.getElementById('treatment-board');
            board.innerHTML = '';
            
            const overdueOperations = allOperations.filter(op => op['×¡×˜×˜×•×¡'] === '×—×•×¨×’');
            
            if (overdueOperations.length === 0) {
                board.innerHTML = `<p class="text-center text-gray-600 col-span-full">××™×Ÿ ×œ×§×•×—×•×ª ×‘×—×¨×™×’×” ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</p>`;
                return;
            }

            overdueOperations.forEach(op => {
                const days = op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                const containerNumbersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerNumbersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerDisplay = containerNumbersTaken.length > 0 ? `×™×¨×“×”: ${containerNumbersTaken.join(', ')}` : '';
                if (containerNumbersBrought.length > 0) {
                    containerDisplay += (containerDisplay ? ', ' : '') + `×¢×œ×ª×”: ${containerNumbersBrought.join(', ')}`;
                }
                const containerNumbersForMsg = [...containerNumbersTaken, ...containersBrought].filter(Boolean).join(', ');


                const card = `
                    <div class="kpi-card bg-white border-l-4 border-red-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${op['×©× ×œ×§×•×—']}</h4>
                                <p class="text-sm text-gray-500">×ª×¢×•×“×”: ${op['×ª×¢×•×“×”']}</p>
                                <p class="text-sm text-gray-500">××›×•×œ×”: ${containerDisplay || '×œ× ×¦×•×™×Ÿ'}</p>
                            </div>
                            <span class="font-bold text-xl text-red-600">${days} ×™××™× ×—×¨×™×’×”</span>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button class="px-3 py-1 bg-violet-600 text-white rounded-lg hover:bg-violet-700 text-sm" onclick="openModal('${op['×œ×§×•×—']}')">×¤×¨×˜×™ ×œ×§×•×—</button>
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${containerNumbersForMsg}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-2xl"></i>
                            </button>
                        </div>
                    </div>
                `;
                board.innerHTML += card;
            });
        };
        
        const openModalByCustomerName = (customerName) => {
            const customerOp = allOperations.find(op => op['×©× ×œ×§×•×—'] === customerName && (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×•×¨×’'));
            if (customerOp) {
                openModal(customerOp['×œ×§×•×—']);
            }
        };

        const openModal = (customerId) => {
            const customerOps = allOperations.filter(op => op['×œ×§×•×—'] === customerId);
            if (customerOps.length === 0) return;

            const customerName = customerOps[0]['×©× ×œ×§×•×—'];
            document.getElementById('modal-customer-name').textContent = customerName;

            const totalOps = customerOps.length;
            const totalPlacements = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”').length;
            const totalRemovals = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¦××”').length;
            
            document.getElementById('modal-customer-summary').innerHTML = `
                <div class="text-center"><p class="text-2xl font-bold">${totalOps}</p><p class="text-sm text-gray-500">×¡×”"×› ×¤×¢×•×œ×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalPlacements}</p><p class="text-sm text-gray-500">×”×¦×‘×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalRemovals}</p><p class="text-sm text-gray-500">×”×•×¦××•×ª</p></div>
            `;

            const historyTable = document.getElementById('modal-customer-history-table');
            historyTable.innerHTML = '';
            customerOps.forEach(op => {
                 const days = (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×•×¨×’') && op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                 let statusText, statusClass;
                 if (op['×¡×˜×˜×•×¡'] === '×—×•×¨×’') {
                    statusText = '×—×¨×™×’×”'; statusClass = 'status-red';
                 } else if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    statusText = '×¡×’×•×¨'; statusClass = 'status-gray';
                 } else { 
                    statusText = '×¤×¢×™×œ'; statusClass = 'status-green';
                 }
                const row = `
                    <tr>
                        <td class="py-2 px-3">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-2 px-3">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-2 px-3">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-2 px-3"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                historyTable.innerHTML += row;
            });

            document.getElementById('customer-history-modal').classList.remove('hidden');
            document.getElementById('customer-history-modal').classList.add('flex');
        };

        const closeModal = () => {
            document.getElementById('customer-history-modal').classList.add('hidden');
            document.getElementById('customer-history-modal').classList.remove('flex');
        };

        const getSuggestedMessageIdForOrder = (order) => {
            const daysOverdue = order['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(order['×ª××¨×™×š ×”×–×× ×”']) : 0;
            const orderDate = order['×ª××¨×™×š ×”×–×× ×”'];
            const today = new Date();
            const daysSinceOrder = orderDate ? Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)) : 0;

            if (order['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                if (daysOverdue <= 7) return 'overdue_7_days';
                if (daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long';
            }
            
            if (order['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' && order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] && !isNaN(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].getTime())) {
                const expectedEndDate = order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'];
                const daysUntilDue = Math.floor((expectedEndDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 3 && daysUntilDue >= 0) return 'approaching_due_3_days';
                if (daysUntilDue <= 7 && daysUntilDue > 3) return 'approaching_due_7_days';
            }

            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”' && orderDate && daysSinceOrder <= 30) {
                 const customerId = allOperations.find(op => op['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] === order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'])?.['×œ×§×•×—'];
                 if (customerId) {
                     const customerOperations = allOperations.filter(op => op['×œ×§×•×—'] === customerId);
                     if (customerOperations.length === 1 && String(customerOperations[0]['×ª×¢×•×“×”']) === String(order['×ª×¢×•×“×”'])) { // Ensure comparison is string to string
                         return 'new_customer_welcome';
                     }
                 }
            }
            
            const customerCity = getCityFromAddress(order['×›×ª×•×‘×ª']);
            if (customerCity && cityGuidelines[customerCity]) {
                return `city_guideline_${customerCity}`;
            }

            return 'general_inquiry';
        };

        const openWhatsAppModal = (event, phoneNumber, customerName, docId, daysOverdue, containerNum, expectedEndDateFormatted, customerAddress) => {
            event.stopPropagation();
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageOptionsListDiv = document.getElementById('message-options-list');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');
            const whatsappDocIdInput = document.getElementById('whatsapp-doc-id');

            phoneInput.value = phoneNumber.startsWith('972') ? phoneNumber : `972${phoneNumber.substring(1)}`;
            whatsappDocIdInput.value = docId;

            const dummyOrderForSuggestion = {
                '×¡×˜×˜×•×¡': (daysOverdue > 10 ? '×—×•×¨×’' : '×¤×ª×•×—'), 
                '×ª××¨×™×š ×”×–×× ×”': new Date(new Date().getTime() - daysOverdue * 24 * 60 * 60 * 1000), 
                '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDateFormatted ? formatDate(expectedEndDateFormatted) : null,
                '×¡×•×’ ×¤×¢×•×œ×”': '×”×¦×‘×”',
                '×˜×œ×¤×•×Ÿ ×œ×§×•×—': phoneNumber,
                '×›×ª×•×‘×ª': customerAddress,
                '×ª×¢×•×“×”': docId
            };
            const suggestedMessageId = getSuggestedMessageIdForOrder(dummyOrderForSuggestion);


            messageOptionsListDiv.innerHTML = '';
            
            const allMsgs = [...whatsappMessages];
            const customerCity = getCityFromAddress(customerAddress);
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                allMsgs.unshift({
                    id: `city_guideline_${customerCity}`,
                    text: `**×”× ×—×™×™×ª ×¢×™×¨×™×™×ª ${customerCity}:**\n${guideline.text}\n\n×œ××™×“×¢ ×•×˜×¤×¡×™× × ×•×¡×¤×™×: ${guideline.link}`,
                    category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                    placeholders: [],
                    emoji: guideline.emoji
                });
            }

            allMsgs.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item p-3 rounded-md cursor-pointer hover:bg-gray-100`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                }
                const displayEmoji = msg.category === '××©×¤×˜×™' ? '' : (msg.emoji || '');
                optionDiv.innerHTML = `<strong>${displayEmoji} ${msg.category}:</strong> ${msg.text.replace(/\[.*?\]/g, '...').substring(0, 70)}...`;
                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('bg-blue-100', 'text-blue-800'));
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                    const placeholders = {
                        '×©× ×œ×§×•×—': customerName,
                        '×™××™× ×©×¢×‘×¨×•': daysOverdue,
                        '××¡×¤×¨ ××›×•×œ×”': containerNum,
                        '×ª×¢×•×“×”': docId,
                        '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDateFormatted,
                        '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.phoneNumber,
                        '×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.companyPhone,
                        '×©× ×”×—×‘×¨×”': companyInfo.companyName,
                        '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª': 'https://example.com/review'
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            const defaultSelection = messageOptionsListDiv.querySelector('.message-option-item.bg-blue-100');
            if (defaultSelection) {
                defaultSelection.click();
            } else if (allMsgs.length > 0) {
                messageOptionsListDiv.children[0].click();
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModalWhatsApp = () => {
            document.getElementById('whatsapp-modal').classList.add('hidden');
            document.getElementById('whatsapp-modal').classList.remove('flex');
            clearInterval(typingInterval);
        };

        const selectAndTypeMessage = (messageId, placeholders = {}) => {
            clearInterval(typingInterval);
            const allMessagesWithGuidelines = [
                ...whatsappMessages,
                ...Object.values(cityGuidelines).map(g => ({
                    id: `city_guideline_${g.id.split('_')[0]}`,
                    text: g.text,
                    category: g.category,
                    placeholders: g.placeholders,
                    emoji: g.emoji
                }))
            ];
            const message = allMessagesWithGuidelines.find(msg => msg.id === messageId);
            const typingDisplay = document.getElementById('typing-effect-display');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');

            if (message) {
                currentMessageFullText = message.text;
                for (const key in placeholders) {
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[\\*\\*${key}\\*\\*\\]|\\[${key}\\]`, 'g'), placeholders[key]);
                }
                
                typingIndex = 0;
                typingDisplay.textContent = '';
                whatsappMessageTextarea.value = '';

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        whatsappMessageTextarea.value = currentMessageFullText;
                        typingDisplay.textContent = '';
                    }
                }, 30);
            }
        };

        const sendWhatsAppMessage = async () => {
            const phoneNumber = document.getElementById('whatsapp-phone-input').value.trim().replace(/\D/g, '');
            const message = document.getElementById('whatsapp-message-textarea').value.trim();
            const docId = document.getElementById('whatsapp-doc-id').value;

            if (!phoneNumber) {
                showStatusMessage('×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ.', 'error');
                return;
            }
            if (!message) {
                showStatusMessage('×ª×•×›×Ÿ ×”×”×•×“×¢×” ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            closeModalWhatsApp();

            if (docId) {
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=logWhatsAppMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`);
                        const data = await response.json();
                        if (data.success) {
                            showStatusMessage('×”×”×•×“×¢×” × ×©×œ×—×” ×•×ª×•×¢×“×” ×‘×”×¦×œ×—×”!', 'success');
                            return;
                        } else if (data.message && data.message.includes('Service invoked too many times')) {
                            const delay = baseDelay * Math.pow(2, retries);
                            console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else {
                            showStatusMessage('×©×’×™××” ×‘×ª×™×¢×•×“ ×”×”×•×“×¢×”: ' + data.message, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        showStatusMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + error.message, 'error');
                        return;
                    }
                }
                showStatusMessage('× ×›×©×œ ×ª×™×¢×•×“ ×”×”×•×“×¢×” ×œ××—×¨ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×.', 'error');
            } else {
                showStatusMessage('×”×”×•×“×¢×” × ×©×œ×—×”, ××š ×œ× ×©×•×™×›×” ×œ××¡××š (×—×¡×¨ ××¡×¤×¨ ×ª×¢×•×“×”).', 'warning');
            }
        };

        const filterMessageOptions = () => {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        };

        const toggleMessageOptions = () => {
            const container = document.getElementById('whatsapp-message-options-container');
            container.classList.toggle('hidden');
        };

        // New Order Modal Functions
        const openNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.remove('hidden');
            document.getElementById('new-order-modal').classList.add('flex');
            // Pre-fill some fields if desired, e.g., current date
            document.getElementById('new-order-date').valueAsDate = new Date();
            document.getElementById('new-order-status').value = '×¤×ª×•×—'; // Default status
        };

        const closeNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.add('hidden');
            document.getElementById('new-order-modal').classList.remove('flex');
            document.getElementById('new-order-form').reset(); // Clear form inputs
        };

        const submitNewOrder = async () => {
            const form = document.getElementById('new-order-form');
            const formData = new FormData(form);
            const order = {};
            // Collect all form data
            formData.forEach((value, key) => {
                order[key] = value;
            });

            // Calculate '×™××™× ×©×¢×‘×¨×•' if '×ª××¨×™×š ×”×–×× ×”' is provided
            const orderDateObj = order['×ª××¨×™×š ×”×–×× ×”'] ? new Date(order['×ª××¨×™×š ×”×–×× ×”']) : null;
            order['×™××™× ×©×¢×‘×¨×•'] = orderDateObj && !isNaN(orderDateObj.getTime()) ? daysSince(orderDateObj) : '';

            // Combine container numbers for '××¡×¤×¨×™ ××›×•×œ×•×ª' if not explicitly provided
            order['××¡×¤×¨×™ ××›×•×œ×•×ª'] = order['××¡×¤×¨×™ ××›×•×œ×•×ª'] || 
                                     `${order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || ''},${order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}`
                                     .replace(/^,|,$/g, '')
                                     .replace(/,,/g, ',');

            // Ensure all headers expected by the Google Sheet are present, even if empty
            const sheetHeaders = [
                "×ª××¨×™×š ×”×–×× ×”", "×ª×¢×•×“×”", "×©× ×¡×•×›×Ÿ", "×©× ×œ×§×•×—", "×›×ª×•×‘×ª", "×¡×•×’ ×¤×¢×•×œ×”", 
                "×™××™× ×©×¢×‘×¨×•", "××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”", "××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”", "××¡×¤×¨×™ ××›×•×œ×•×ª", 
                "×¡×˜×˜×•×¡", "×”×¢×¨×•×ª", "×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™", "×”×¢×¨×•×ª ×¡×™×•×", "×ª××¨×™×š ×¡×’×™×¨×”", 
                "×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)", "×˜×œ×¤×•×Ÿ ×œ×§×•×—"
            ];
            const completeOrder = {};
            sheetHeaders.forEach(header => {
                completeOrder[header] = order[header] !== undefined ? order[header] : '';
            });
            
            // Convert date objects back to YYYY-MM-DD string format for the sheet
            if (completeOrder['×ª××¨×™×š ×”×–×× ×”'] instanceof Date) {
                completeOrder['×ª××¨×™×š ×”×–×× ×”'] = completeOrder['×ª××¨×™×š ×”×–×× ×”'].toISOString().split('T')[0];
            }
            if (completeOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] instanceof Date) {
                completeOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] = completeOrder['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toISOString().split('T')[0];
            }
            if (completeOrder['×ª××¨×™×š ×¡×’×™×¨×”'] instanceof Date) {
                completeOrder['×ª××¨×™×š ×¡×’×™×¨×”'] = completeOrder['×ª××¨×™×š ×¡×’×™×¨×”'].toISOString().split('T')[0];
            }
            
            await addNewOrderToSheet(completeOrder);
            closeNewOrderModal();
        };

    </script>
</body>
</html>
