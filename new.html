<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</title>
    <!-- Chosen Palette: Calm Neutrals with Purple Accent -->
    <!-- Application Structure Plan: The SPA is designed as a multi-tab dashboard. The default view is the 'Dashboard' which provides high-level KPIs and a full, filterable list of all container operations. Additional tabs allow the user to focus on specific tasks: 'Container Inventory' for tracking the status of each physical container, and 'Treatment Board' for a Kanban-style view of overdue orders that require action. This task-oriented structure, guided by the specification, allows the manager to quickly assess the overall status and then drill down into specific management areas (inventory, overdue accounts) for efficient workflow. Modals are used for detailed views (e.g., customer history) to avoid cluttering the main interface. -->
    <!-- Visualization & Content Choices: 
        - KPIs (Total containers, overdue, etc.): Goal=Inform -> Method=Dynamic text in Cards -> Interaction=None -> Justification=Quick, scannable overview.
        - All Operations List: Goal=Organize/Compare -> Method=Interactive HTML Table -> Interaction=Search, Filter, Sort -> Justification=Allows deep-diving into the full dataset.
        - Overdue Orders: Goal=Inform/Act -> Method=Kanban Board & Highlighted Table -> Interaction=Visual grouping, direct links to customer details -> Justification=Focuses attention on urgent tasks.
        - Operations per Agent: Goal=Compare -> Method=Bar Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Clear visual comparison of agent performance.
        - Operations over Time: Goal=Change -> Method=Line Chart (Chart.js Canvas) -> Interaction=Hover for details -> Justification=Shows trends and business activity patterns.
        - Container Status: Goal=Organize -> Method=Two distinct HTML tables (In Use/Available) -> Interaction=Click for history -> Justification=Clear separation of inventory status for operational planning.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        .kanban-column {
            min-height: 200px;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</h1>
            <p class="text-lg text-gray-600">×œ×•×— ×‘×§×¨×” ××¨×›×–×™ ×œ× ×™×”×•×œ, ××¢×§×‘ ×•× ×™×ª×•×— ×¤×¢×™×œ×•×ª</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b border-gray-200 mb-8">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>×œ×•×— ×‘×§×¨×”
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>×œ×•×— ×˜×™×¤×•×œ ×‘×—×¨×™×’×•×ª
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="kpi-card">
                            <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª ×‘××ª×¨×™×</h3>
                            <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="text-gray-500 font-semibold">×œ×§×•×—×•×ª ×‘×—×¨×™×’×” <span class="text-xs">(××¢×œ 10 ×™××™×)</span></h3>
                            <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤× ×•×™×•×ª ×‘××œ××™</h3>
                            <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                        </div>
                        <div class="kpi-card">
                            <h3 class="text-gray-500 font-semibold">×¡×”"×› ×¤×¢×•×œ×•×ª (×›×œ ×”×–×× ×™×)</h3>
                            <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×™×œ×•×ª ×œ×¤×™ ×¡×•×›×Ÿ</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª ×œ××•×¨×š ×–××Ÿ</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">×›×œ×œ ×”×¤×¢×•×œ×•×ª</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="×—×¤×© ×œ×¤×™ ×©× ×œ×§×•×—, ×ª×¢×•×“×”, ×©× ×¡×•×›×Ÿ...">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª×¢×•×“×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×©× ×œ×§×•×—</th>
                                    <th class="py-3 px-4 text-right font-bold">×©× ×¡×•×›×Ÿ</th>
                                    <th class="py-3 px-4 text-right font-bold">×¡×•×’ ×¤×¢×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×™××™× ×‘×©×›×™×¨×•×ª</th>
                                    <th class="py-3 px-4 text-right font-bold">×¡×˜×˜×•×¡</th>
                                    <th class="py-3 px-4 text-right font-bold">×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×‘×©×™××•×© ×¤×¢×™×œ</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">××¡×¤×¨ ××›×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×œ×§×•×— × ×•×›×—×™</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š ×”×¦×‘×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×™××™× ×‘××ª×¨</th>
                                    <th class="py-3 px-4 text-right font-bold">×”×™×¡×˜×•×¨×™×”</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h2>
                     <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold">××¡×¤×¨ ××›×•×œ×”</th>
                                    <th class="py-3 px-4 text-right font-bold">×ª××¨×™×š ×—×–×¨×” ×œ××œ××™</th>
                                    <th class="py-3 px-4 text-right font-bold">×œ×§×•×— ××—×¨×•×Ÿ</th>
                                    <th class="py-3 px-4 text-right font-bold">×”×™×¡×˜×•×¨×™×”</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">×œ×•×— ×˜×™×¤×•×œ ×‘×œ×§×•×—×•×ª ×—×•×¨×’×™×</h2>
                 <p class="text-gray-600 mb-6">×›××Ÿ ××¨×•×›×–×•×ª ×›×œ ×”××›×•×œ×•×ª ×©× ××¦××•×ª ××¦×œ ×œ×§×•×—×•×ª ××¢×œ 10 ×™××™ ×¢×‘×•×“×” ×•×“×•×¨×©×•×ª ×˜×™×¤×•×œ (×”×—×œ×¤×” ××• ×”×•×¦××”).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
            </section>
        </main>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b">
                <h2 class="text-2xl font-bold" id="modal-customer-name"></h2>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2">×¡×™×›×•× ×¤×¢×™×œ×•×ª</h3>
                <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6"></div>
                <h3 class="text-lg font-semibold mb-2">×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª</h3>
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-3 text-right">×ª××¨×™×š</th>
                                <th class="py-2 px-3 text-right">×ª×¢×•×“×”</th>
                                <th class="py-2 px-3 text-right">×¤×¢×•×œ×”</th>
                                <th class="py-2 px-3 text-right">×¡×˜×˜×•×¡</th>
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold">×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center">
                        <span>×‘×—×¨ ×”×•×“×¢×” ××•×‘× ×™×ª</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200" placeholder="×—×¤×© ×”×•×“×¢×”..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">×ª×•×›×Ÿ ×”×”×•×“×¢×”:</label>
                     <div class="border border-gray-300 rounded-md p-2 min-h-[100px] bg-gray-50 mb-2">
                        <span id="typing-effect-display" class="whitespace-pre-wrap"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md" rows="5"></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">×©×œ×— ×”×•×“×¢×”</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        const fullTrackingDataRaw = `×ª××¨×™×š ×”×–×× ×”,×ª×¢×•×“×”,×©× ×¡×•×›×Ÿ,×©× ×œ×§×•×—,×›×ª×•×‘×ª,×¡×•×’ ×¤×¢×•×œ×”,×™××™× ×©×¢×‘×¨×•,××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”,××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”,××¡×¤×¨×™ ××›×•×œ×•×ª,×¡×˜×˜×•×¡,×”×¢×¨×•×ª,×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™,×”×¢×¨×•×ª ×¡×™×•×,×ª××¨×™×š ×¡×’×™×¨×”,×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”),×˜×œ×¤×•×Ÿ ×œ×§×•×—
2025-07-24,6713571,××’×‘××¨×™×”/×©××¨×§,×.×¢×¨×Ÿ ××–×•×œ××™ - ×× ×§×•×¨×™×,×× ×§×•×¨×™× 2 ×¨××ª ×’×Ÿ,×”×—×œ×¤×”,25,209,9,9,×¤×ª×•×—,×¨×•×¦×” ×›××” ×™××™×,07/08/2025,,,,508860896
2025-07-29,6713658,××’×‘××¨×™×”/×©××¨×§,"××•×¨×‘×¨ ×‘× ×™×™×”/×™×¨××™×”×• ×¨""×’",×™×¨××™×”×• 11 ×¨××ª ×’×Ÿ,×”×•×¨×“×”,20,31,,,×¤×ª×•×—,×‘×™×§×© ×›××” ×™××™×,12/08/2025,,,,508860896
2025-07-24,6713566,××’×‘××¨×™×”/×©××¨×§,××™×œ×Ÿ ×™×•×¡×£,×”×¤×¡× ×ª×¨ 1 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,25,60,209,209,×¤×ª×•×—,×”×—×œ×¤×” ×”×™×•×,07/08/2025,,,,508860896
2025-07-29,6713670,××’×‘××¨×™×”/×©××¨×§,×¢.×“×¨×§×•,××‘×Ÿ ×™×”×•×“×”,×”×—×œ×¤×”,20,55,13,13,×¤×ª×•×—,,12/08/2025,,,,508860896
2025-07-22,6713520,××’×‘××¨×™×”/×©××¨×§,×¢××¡×™ ××—××“ ×¢×‘ ×‘× ×™×Ÿ,×”×—×¨××•×Ÿ 15 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,27,14,18,18,×¤×ª×•×—,,05/08/2025,,,,508860896
2025-08-07,6713844,××’×‘××¨×™×”/×©××¨×§,"×¤×™× ×•×™ ×¤×¡×•×œ×ª ×‘×©×¨×•×Ÿ ×‘×¢""×",×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,11,22,20,20,×¤×ª×•×—,,21/08/2025,,,,508860896
2025-07-31,6713705,××•×—××“/×©××¨×§,×¨× ×™ ×©×™×¨××™,×›×¨× 5 ×¨××•×ª ×”×©×‘×™×,×”×•×¨×“×”,18,58,,,×¤×ª×•×—,,14/08/2025,,,,508860896
2025-07-29,6713651,××’×‘××¨×™×”/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×”××•× ×™×‘×¨×¡×™×˜×” ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,20,121,11,11,×¤×ª×•×—,,12/08/2025,,,,508860896
2025-07-28,6713628,××’×‘××¨×™×”/×©××¨×§,×©××¨×§/× ××“×¨,×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,21,11,2,2,×¤×ª×•×—,,11/08/2025,,,,508860896
2025-07-24,6713580,××•×—××“/×©××¨×§,×©××¨×§/×¢×•××¨ ×¦××¤×™×•×Ÿ,×”××—×©×‘ 5 × ×ª× ×™×”,×”×—×œ×¤×”,25,2,25,25,×¤×ª×•×—,,07/08/2025,,,,508860896
2025-07-22,6713532,××•×—××“/×©××¨×§,"××™×™ ×“×¡×§ ×‘×¢""×",××œ×¤×¡×™ 4 ×¨×¢× × ×”,×”×—×œ×¤×”,27,203,7,7,×¤×ª×•×—,,05/08/2025,,,,508860896
2025-07-21,6713515,××’×‘××¨×™×”/×©××¨×§,×–×”×‘×™ ×™×¦×—×§,××¨×“×›×™ ×‘×Ÿ ×—××• 13 ×›×¤×¨ ×™×•× ×”,×”×—×œ×¤×”,28,43,19,19,×¤×ª×•×—,,04/08/2025,,,,508860896
2025-07-20,6713466,××•×—××“/×©××¨×§,×–×”×‘×™ ×™×¦×—×§,××¨×“×›×™ ×‘×Ÿ ×—××• 13 ×›×¤×¨ ×™×•× ×”,×”×¦×‘×”,29,19,,,×¤×ª×•×—,,03/08/2025,,,,508860896
2025-07-20,6713467,××•×—××“/×©××¨×§,×–×”×‘×™ ×™×¦×—×§,××¨×“×›×™ ×‘×Ÿ ×—××• 13 ×›×¤×¨ ×™×•× ×”,×”×¦×‘×”,29,20,,,×¤×ª×•×—,,03/08/2025,,,,508860896
2025-07-16,6713395,××•×—××“/×©××¨×§,×’×™× ×¤×¨×™×’×ª,×©×—×£ 16 ×›×¤×¨ ×•×™×ª×§×™×Ÿ,×”×•×¦××”,33,42,,,×¤×ª×•×—,,30/07/2025,,,,508860896
2025-07-15,6713372,××•×—××“/×©××¨×§,×¤×œ×— ××©×”/×›×œ×œ×™,×”×–×™×ª 29 ×§×“×™××”,×”×•×¨×“×”,34,51,,,×¤×ª×•×—,,29/07/2025,,,,508860896
2025-07-14,6713340,××•×—××“/×©××¨×§,"×‘×Ÿ ×¢× ×‘×¨-×‘×™""×¡ ×œ×™×™×“×™ ×“",×‘×™×ª ×œ×™×“×™ ×“ ×”×•×“ ×”×©×¨×•×Ÿ,×”×¦×‘×”,35,47,,,×¤×ª×•×—,,28/07/2025,,,,508860896
2025-07-13,6713314,××•×—××“/×©××¨×§,××œ× ×‘×™ ×¢×œ ×”×™×/×”××’×“×”,××œ× ×‘×™ 126 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,36,25,50,50,×¤×ª×•×—,×”×—×œ×¤×”,27/07/2025,,,,508860896
2025-07-13,6713313,×¨××™/×©××¨×§,"×.×¦ ×©×—×™×‘×¨ ×‘× ×™×” ×‘×¢""×",×”×—×¨×•×‘ 25 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,36,60,20,20,×¤×ª×•×—,,27/07/2025,,,,508860896
2025-07-13,6713311,××•×—××“/×©××¨×§,"×.×¦ ×©×—×™×‘×¨ ×‘× ×™×” ×‘×¢""×",×”×—×¨×•×‘ 25 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,36,20,60,60,×¤×ª×•×—,,27/07/2025,,,,508860896
2025-07-11,6713304,××•×—××“/×©××¨×§,×‘×Ÿ ×¢× ×‘×¨-×§×¨×™×ª ××•× ×•,×”×¢×œ×™×™×” 120 ×§×¨×™×ª ××•× ×•,×”×—×œ×¤×”,38,18,17,17,×¤×ª×•×—,,25/07/2025,,,,508860896
2025-07-11,6713302,××•×—××“/×©××¨×§,×©×—×¨ ×œ×•×™,×©×¤×™×¨× 17 ×›×¤×¨ ×¡×‘×,×”×•×¨×“×”,38,19,,,×¤×ª×•×—,,25/07/2025,,,,508860896
2025-07-11,6713301,××•×—××“/×©××¨×§,×.×¢×¨×Ÿ ××–×•×œ××™ - ×§×™×“××”,×”×¢×œ×™×™×” 120 ×§×¨×™×ª ××•× ×•,×”×•×¨×“×”,38,17,,,×¤×ª×•×—,,25/07/2025,,,,508860896
2025-07-10,6713297,×¨××™/×©××¨×§,×‘×Ÿ ×¢× ×‘×¨-×§×¨×™×ª ××•× ×•,×©×—×£ 16 ×›×¤×¨ ×•×™×ª×§×™×Ÿ,×”×—×œ×¤×”,39,17,18,18,×¤×ª×•×—,×”×—×œ×¤×” ×”×™×•×,24/07/2025,,,,508860896
2025-07-10,6713293,××•×—××“/×©××¨×§,×¨× ×™ ×©×™×¨××™,×’×¨×•× ×¨ 30 ×›×¤×¨ ×¡×‘×,×”×—×œ×¤×”,39,26,16,16,×¤×ª×•×—,,24/07/2025,,,,508860896
2025-07-10,6713285,××•×—××“/×©××¨×§,"×‘×–×œ×ª ××–×¨ ×‘×¢""×",×”×—×¨×•×‘ 25 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,39,16,26,26,×¤×ª×•×—,×”×—×œ×¤×”,24/07/2025,,,,508860896
2025-07-10,6713282,××•×—××“/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×—×œ×¤×”,39,15,24,24,×¤×ª×•×—,,24/07/2025,,,,508860896
2025-07-10,6713288,××•×—××“/×©××¨×§,×¨× ×™ ×©×™×¨××™,×›×¨× 5 ×¨××•×ª ×”×©×‘×™×,×”×¦×‘×”,39,16,,,×¤×ª×•×—,,24/07/2025,,,,508860896
2025-07-09,6713266,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,40,24,15,15,×¤×ª×•×—,,23/07/2025,,,,508860896
2025-07-07,6713244,××•×—××“/×©××¨×§,×.×›.×¨×™××•× ×™×/××œ×›×™ ×”×¨×¦,××œ×›×™ ×”×¨×¦×œ×™×” 12 ×”×¨×¦×œ×™×”,×”×•×¨×“×”,42,23,,,×¤×ª×•×—,,21/07/2025,,,,508860896
2025-07-07,6713238,×¨××™/×©××¨×§,×§×•×‘×™ ×‘× ×™×©×•,×›×¤×¨ ×¡×‘×,×”×•×¨×“×”,42,22,,,×¤×ª×•×—,,21/07/2025,,,,508860896
2025-07-07,6713237,×¨××™/×©××¨×§,×©×—×¨ ×©××•×œ ×ª×›× ×•×Ÿ/×›×œ×œ×™,×’×œ×’×œ ×”××–×œ×•×ª ×”×•×“ ×”×©×¨×•×Ÿ,×”×¦×‘×”,42,21,,,×¤×ª×•×—,,21/07/2025,,,,508860896
2025-07-07,6713232,××•×—××“/×©××¨×§,×‘×Ÿ ×¢× ×‘×¨-×§×¨×™×ª ××•× ×•,×”×¢×œ×™×™×” 120 ×§×¨×™×ª ××•× ×•,×”×¦×‘×”,42,18,,,×¤×ª×•×—,,21/07/2025,,,,508860896
2025-07-07,6713225,×¨××™/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,42,21,24,24,×¤×ª×•×—,,21/07/2025,,,,508860896
2025-07-06,6713205,××•×—××“/×©××¨×§,××•×¨× ×”× ×“×¡×” ×•× ×™×”×•×œ ×‘×¢,×”×ª××¨ 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,43,20,,,×¤×ª×•×—,,20/07/2025,,,,508860896
2025-07-06,6713201,××•×—××“/×©××¨×§,×™×•× ×ª×Ÿ ×× ×©×”,×™×”×•×“×” ×”× ×©×™× 31 ×ª×œ ××‘×™×‘,×”×¦×‘×”,43,17,,,×¤×ª×•×—,,20/07/2025,,,,508860896
2025-07-06,6713198,×¨××™/×©××¨×§,×©×—×¨ ×©××•×œ ×ª×›× ×•×Ÿ/×›×œ×œ×™,×’×œ×’×œ ×”××–×œ×•×ª ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,43,21,,,×¤×ª×•×—,,20/07/2025,,,,508860896
2025-07-03,6713179,××•×—××“/×©××¨×§,××•×¨× ×”× ×“×¡×” ×•× ×™×”×•×œ ×‘×¢,×”×ª××¨ 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×¦×‘×”,46,20,,,×¤×ª×•×—,,17/07/2025,,,,508860896
2025-07-03,6713166,××•×—××“/×©××¨×§,×¤×™× ×•×™ ×¤×¡×•×œ×ª ×‘×©×¨×•×Ÿ ×‘×¢,×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,46,14,12,12,×¤×ª×•×—,,17/07/2025,,,,508860896
2025-07-02,6713151,××•×—××“/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×•×¨×“×”,47,24,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713150,××•×—××“/×©××¨×§,×.×›.×¨×™××•× ×™×/××œ×›×™ ×”×¨×¦,××œ×›×™ ×”×¨×¦×œ×™×” 12 ×”×¨×¦×œ×™×”,×”×¦×‘×”,47,23,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713146,×¨××™/×©××¨×§,×.×¢×¨×Ÿ ××–×•×œ××™ - ×§×™×“××”,×”×¢×œ×™×™×” 120 ×§×¨×™×ª ××•× ×•,×”×•×¨×“×”,47,17,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713137,××•×—××“/×©××¨×§,"×‘×–×œ×ª ××–×¨ ×‘×¢""×",×”×—×¨×•×‘ 25 ×”×•×“ ×”×©×¨×•×Ÿ,×”×¦×‘×”,47,16,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713132,××•×—××“/×©××¨×§,×¢×•×¤×¨ ×¤×•×‘×™×¦×¨,×‘×¨×§×ª 19 ××‘×Ÿ ×™×”×•×“×”,×”×•×¨×“×”,47,13,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713131,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×¦×‘×”,47,15,,,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-02,6713129,×¨××™/×©××¨×§,×©××¢×•×Ÿ ×”×¨××œ,×ª× ×•×¢×ª ×”××›×‘×™× 15 ××•×“×™×¢×™×Ÿ,×”×—×œ×¤×”,47,19,43,43,×¤×ª×•×—,,16/07/2025,,,,508860896
2025-07-01,6713123,×¨××™/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×—×œ×¤×”,48,24,15,15,×¤×ª×•×—,,15/07/2025,,,,508860896
2025-07-01,6713111,×¨××™/×©××¨×§,× ×“×œ×¡×˜×™×¦'×¨ ××™×ª×™/×œ×•×˜×,×“×•×“ ××œ×¢×–×¨ 10 ×”×¨×¦×œ×™×”,×”×¦×‘×”,48,10,,,×¤×ª×•×—,,15/07/2025,,,,508860896
2025-07-01,6713107,××•×—××“/×©××¨×§,××•×–×¡ ×¡×¨× ×’×”,×”×’×¤×Ÿ 120 ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,48,9,,,×¤×ª×•×—,,15/07/2025,,,,508860896
2025-06-30,6713094,××•×—××“/×©××¨×§,×¢.×“×¨×§×•,××‘×Ÿ ×™×”×•×“×”,×”×—×œ×¤×”,49,13,55,55,×¤×ª×•×—,,14/07/2025,,,,508860896
2025-06-30,6713092,×¨××™/×©××¨×§,"××™×™ ×“×¡×§ ×‘×¢""×",××œ×¤×¡×™ 4 ×¨×¢× × ×”,×”×—×œ×¤×”,49,7,203,203,×¤×ª×•×—,,14/07/2025,,,,508860896
2025-06-30,6713091,×¨××™/×©××¨×§,××™×œ×Ÿ ×™×•×¡×£,×”×¤×¡× ×ª×¨ 1 ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,49,209,,,×¤×ª×•×—,,14/07/2025,,,,508860896
2025-06-30,6713090,×¨××™/×©××¨×§,"×.×¦ ×©×—×™×‘×¨ ×‘× ×™×” ×‘×¢""×",×”×—×¨×•×‘ 25 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,49,20,60,60,×¤×ª×•×—,,14/07/2025,,,,508860896
2025-06-30,6713084,××•×—××“/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×—×œ×¤×”,49,24,15,15,×¤×ª×•×—,,14/07/2025,,,,508860896
2025-06-29,6713064,××•×—××“/×©××¨×§,×œ×™××•×¨ ×™×¦×—×§×™-×§×™×‘×•×¥ ×¢×™,×§×™×‘×•×¥ ×¢×™× ×ª,×”×•×¨×“×”,50,8,,,×¤×ª×•×—,,13/07/2025,,,,508860896
2025-06-29,6713053,××•×—××“/×©××¨×§,×¤×™× ×ª ×‘××–×œ (×™×‘×’× ×™),× ×—×× ×™ 37 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,50,11,,,×¤×ª×•×—,,13/07/2025,,,,508860896
2025-06-27,6713043,×¨×™×™××•× ×“/×©××¨×§,×‘×™×œ×™××•×¨ ×™×¦×—×§×™-×›×œ×œ×™,××œ×¤×¡×™ 4 ×¨×¢× × ×”,×”×•×¨×“×”,52,7,,,×¤×ª×•×—,,11/07/2025,,,,508860896
2025-06-26,6712998,××•×—××“/×©××¨×§,×¤×™× ×ª ×‘××–×œ (×™×‘×’× ×™),× ×—×× ×™ 37 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,53,12,11,11,×¤×ª×•×—,,10/07/2025,,,,508860896
2025-06-25,6712984,××•×—××“/×©××¨×§,×¤×™× ×ª ×‘××–×œ (×™×‘×’× ×™),× ×—×× ×™ 37 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,54,11,12,12,×¤×ª×•×—,,09/07/2025,,,,508860896
2025-06-25,6712979,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,54,15,24,24,×¤×ª×•×—,,09/07/2025,,,,508860896
2025-06-24,6712954,××•×—××“/×©××¨×§,×.×¢×¨×Ÿ ××–×•×œ××™ - ×§×™×“××”,×”×¢×œ×™×™×” 120 ×§×¨×™×ª ××•× ×•,×”×•×¨×“×”,55,17,,,×¤×ª×•×—,,08/07/2025,,,,508860896
2025-06-22,6712906,××•×—××“/×©××¨×§,×¤×™× ×•×™ ×¤×¡×•×œ×ª ×‘×©×¨×•×Ÿ ×‘×¢,×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,57,12,14,14,×¤×ª×•×—,,06/07/2025,,,,508860896
2025-06-20,6712886,××•×—××“/×©××¨×§,×©×—×¨ ×©××•×œ ×ª×›× ×•×Ÿ/×›×œ×œ×™,×’×œ×’×œ ×”××–×œ×•×ª ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,59,21,,,×¤×ª×•×—,,04/07/2025,,,,508860896
2025-06-19,6712877,××•×—××“/×©××¨×§,×¢.×“×¨×§×•,××‘×Ÿ ×™×”×•×“×”,×”×—×œ×¤×”,60,55,13,13,×¤×ª×•×—,,03/07/2025,,,,508860896
2025-06-18,6712849,××•×—××“/×©××¨×§,"××™×™ ×“×¡×§ ×‘×¢""×",××œ×¤×¡×™ 4 ×¨×¢× × ×”,×”×—×œ×¤×”,61,203,7,7,×¤×ª×•×—,,02/07/2025,,,,508860896
2025-06-17,6712834,××•×—××“/×©××¨×§,×§×‘×•×¦×ª ×—×¡×•×Ÿ,×›×¤×¨ ×¡×‘×,×”×•×¨×“×”,62,2,,,×¤×ª×•×—,,01/07/2025,,,,508860896
2025-06-17,6712823,××•×—××“/×©××¨×§,×‘.×¨.×© ×ª×—×–×•×§×ª ××¨×œ×•×’×™×,× ×—×× ×™ 37 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,62,50,,,×¤×ª×•×—,,01/07/2025,,,,508860896
2025-06-12,6712778,××•×—××“/×©××¨×§,×¤×™× ×•×™ ×¤×¡×•×œ×ª ×‘×©×¨×•×Ÿ ×‘×¢,×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,67,14,12,12,×¤×ª×•×—,,26/06/2025,,,,508860896
2025-06-12,6712774,××•×—××“/×©××¨×§,×©×—×¨ ×©××•×œ ×ª×›× ×•×Ÿ/×›×œ×œ×™,×’×œ×’×œ ×”××–×œ×•×ª ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,67,21,10,10,×¤×ª×•×—,,26/06/2025,,,,508860896
2025-06-12,6712766,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×—×œ×¤×”,67,15,24,24,×¤×ª×•×—,,26/06/2025,,,,508860896
2025-06-11,6712760,××•×—××“/×©××¨×§,"×.×¦ ×©×—×™×‘×¨ ×‘× ×™×” ×‘×¢""×",×”×•×¨×“×”,68,60,,,×¤×ª×•×—,,25/06/2025,,,,508860896
2025-06-11,6712755,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,68,24,,,×¤×ª×•×—,,25/06/2025,,,,508860896
2025-06-11,6712750,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,68,15,,,×¤×ª×•×—,,25/06/2025,,,,508860896
2025-06-10,6712744,××•×—××“/×©××¨×§,××•×”×“ ×˜×œ,×”×©×§×“ 15 ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,69,12,25,25,×¤×ª×•×—,,24/06/2025,,,,508860896
2025-06-10,6712739,××•×—××“/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×—×œ×¤×”,69,24,15,15,×¤×ª×•×—,,24/06/2025,,,,508860896
2025-06-05,6712721,××•×—××“/×©××¨×§,××œ× ×‘×™ ×¢×œ ×”×™×/×”××’×“×”,××œ× ×‘×™ 126 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,74,50,,,×¤×ª×•×—,,19/06/2025,,,,508860896
2025-06-05,6712718,××•×—××“/×©××¨×§,×¢××¡×™ ××—××“ ×¢×‘ ×‘× ×™×Ÿ,×”×—×¨××•×Ÿ 15 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,74,18,,,×¤×ª×•×—,,19/06/2025,,,,508860896
2025-06-05,6712713,×¨××™/×©××¨×§,×’×•× ×˜×›× ×™×§×” ×—×‘×¨×” ×œ×™×™×¦,×•×™×¦××Ÿ 104 ×›×¤×¨ ×¡×‘×,×”×—×œ×¤×”,74,43,7,7,×¤×ª×•×—,,19/06/2025,,,,508860896
2025-06-05,6712709,×¨××™/×©××¨×§,×.×¢×¨×Ÿ ××–×•×œ××™ - ×™×”×•×“×”,×™×”×•×“×” ×”××›×‘×™ 17 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,74,17,,,×¤×ª×•×—,,19/06/2025,,,,508860896
2025-06-04,6712705,×¨××™/×©××¨×§,×“×•×“ ×—×™×™× ×•×‘× ×™×• - ×›×œ×œ,×”×’×¤×Ÿ 120 ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,75,9,,,×¤×ª×•×—,,18/06/2025,,,,508860896
2025-06-04,6712691,××•×—××“/×©××¨×§,×”×›×œ ××‘×¨××©×™×ª/××•× ×™×‘×¨×¡×™,×©×¢×¨ 14 ×ª×œ ××‘×™×‘,×”×•×¨×“×”,75,24,,,×¤×ª×•×—,,18/06/2025,,,,508860896
2025-06-03,6712689,×¨××™/×©××¨×§,××•×“×™ ×™×‘×•×/×‘× ×™ ×‘×¨×§,×”×¨×‘ ×§×•×§ 105 ×‘× ×™ ×‘×¨×§,×”×•×¨×“×”,76,15,,,×¤×ª×•×—,,17/06/2025,,,,508860896
2025-06-03,6712685,××•×—××“/×©××¨×§,×¤×œ×— ××©×”/×›×œ×œ×™,×”×–×™×ª 29 ×§×“×™××”,×”×•×¨×“×”,76,51,,,×¤×ª×•×—,,17/06/2025,,,,508860896
2025-06-01,6712661,01/06/2025,×‘×Ÿ ×¢× ×‘×¨-×‘×™""×¡ ×œ×™×™×“×™ ×“,×‘×™×ª ×œ×™×“×™ ×“ ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,78,47,,,×¤×ª×•×—,,15/06/2025,,,,508860896
2025-06-01,6712659,××•×—××“/×©××¨×§,× ×™×¨ ×•××™×¨×™ × ×•×‘×§,×‘×¨×§×ª 19 ××‘×Ÿ ×™×”×•×“×”,×”×•×¨×“×”,78,13,,,×¤×ª×•×—,,15/06/2025,,,,508860896
2025-06-01,6712656,×¨××™/×©××¨×§,×©××¨×§/× ××“×¨,×”×—×¨×© 10 ×”×•×“ ×”×©×¨×•×Ÿ,×”×•×¨×“×”,78,11,,,×¤×ª×•×—,,15/06/2025,,,,508860896
2025-06-01,6712655,×¨××™/×©××¨×§,×©××¢×•×Ÿ ×”×¨××œ,×ª× ×•×¢×ª ×”××›×‘×™× 15 ××•×“×™×¢×™×Ÿ,×”×•×¨×“×”,78,43,,,×¤×ª×•×—,,15/06/2025,,,,508860896
2025-06-01,6712645,×¨××™/×©××¨×§,×‘×Ÿ ×¢× ×‘×¨-×‘×™""×¡ ×œ×™×™×“×™ ×“,×‘×™×ª ×œ×™×“×™ ×“ ×”×•×“ ×”×©×¨×•×Ÿ,×”×—×œ×¤×”,78,47,25,25,×¤×ª×•×—,,15/06/2025,,,,508860896
`;
        
        let allOperations = [];
        let charts = {};

        // Utility functions
        const parseFullTrackingCSV = (raw) => {
            const lines = raw.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = [];
                let inQuote = false;
                let currentVal = '';
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(currentVal.trim().replace(/""/g, '"'));
                        currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
                values.push(currentVal.trim().replace(/""/g, '"')); // Add the last value

                const entry = headers.reduce((obj, header, index) => {
                    obj[header] = values[index] || '';
                    return obj;
                }, {});

                // Clean up string values (remove extra quotes from original CSV parsing)
                for (const key in entry) {
                    if (typeof entry[key] === 'string') {
                        entry[key] = entry[key].replace(/^"|"$/g, '');
                    }
                }

                return entry;
            });
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            // Check for YYYY-MM-DD format first (from '×ª××¨×™×š ×”×–×× ×”' column)
            if (dateStr.includes('-') && parts.length === 1) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            // Assume DD/MM/YYYY if '/' is present
            if (parts.length === 3) {
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const diff = new Date() - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        // Global functions for HTML onclick attributes (MUST BE GLOBAL)
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');
        };

        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "×ª×œ ××‘×™×‘", "×™×¨×•×©×œ×™×", "×—×™×¤×”", "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ", "×¤×ª×— ×ª×§×•×•×”", "××©×“×•×“", "×‘××¨ ×©×‘×¢",
                "× ×ª× ×™×”", "×‘× ×™ ×‘×¨×§", "×—×•×œ×•×Ÿ", "×¨××ª ×’×Ÿ", "×¨×—×•×‘×•×ª", "××©×§×œ×•×Ÿ", "×‘×ª ×™×", "×”×¨×¦×œ×™×”",
                "×›×¤×¨ ×¡×‘×", "×—×“×¨×”", "×‘×™×ª ×©××©", "××•×“×™×¢×™×Ÿ-××›×‘×™×-×¨×¢×•×ª", "×œ×•×“", "×¨××œ×”", "×¨×¢× × ×”",
                "× ×”×¨×™×”", "×§×¨×™×™×ª ×’×ª", "××™×œ×ª", "×¢×›×•", "×¦×¤×ª", "×˜×‘×¨×™×”", "× ×¦×¨×ª", "××•× ××œ-×¤××—×",
                "×‘× ×™ ×¦×™×•×Ÿ", "××‘×Ÿ ×™×”×•×“×”", "××•×¨ ×™×”×•×“×”", "××•×¨ ×¢×§×™×‘×", "××¨×™××œ", "××©×§×œ×•×Ÿ", "×‘××§×” ××œ-×’×¨×‘×™×™×”",
                "×’×‘×¢×ª×™×™×", "×“×™××•× ×”", "×”×•×“ ×”×©×¨×•×Ÿ", "×–×›×¨×•×Ÿ ×™×¢×§×‘", "×™×‘× ×”", "×™×”×•×“-××•× ×•×¡×•×Ÿ", "×™×•×§× ×¢× ×¢×™×œ×™×ª",
                "×›×•×›×‘ ×™××™×¨", "×›×¤×¨ ×™×•× ×”", "×›×¤×¨ ×§××¡×", "×›×¨××™××œ", "××’×“×œ ×”×¢××§", "××›×‘×™×", "××¢×œ×” ××“×•××™×",
                "××¦×¤×” ×¨××•×Ÿ", "× ×”×¨×™×”", "× ×¡ ×¦×™×•× ×”", "× ×©×¨", "×¢×¤×•×œ×”", "×¢×¨×“", "×¤×¨×“×¡ ×—× ×”-×›×¨×›×•×¨",
                "×§×¨×™×™×ª ××•× ×•", "×§×¨×™×™×ª ×‘×™××œ×™×§", "×§×¨×™×™×ª ×™×", "×§×¨×™×™×ª ××•×¦×§×™×Ÿ", "×§×¨×™×™×ª ×©××•× ×”",
                "×©×•×”×", "×©×“×¨×•×ª", "×¨××ª ×”×©×¨×•×Ÿ"
            ].sort((a,b) => b.length - a.length);

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        const whatsappMessages = [
            { id: 'new_customer_welcome', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n×ª×•×“×” ×©×‘×—×¨×ª ×œ×”×ª×—×™×œ ×©×›×™×¨×•×ª ××›×•×œ×” ××¦×œ× ×•! ğŸ¥³ ×œ×›×œ ×¤× ×™×”, ×‘×§×©×ª ×”×—×œ×¤×” ××• ×”×•×¦××” ×©×œ ×”××›×•×œ×”, ××ª×” ××•×–××Ÿ ×œ×™×¦×•×¨ ×§×©×¨.\n\nğŸ“ ××¡×¤×¨ ×•×•×˜×¡××¤ ×œ×”×–×× ×•×ª: **[××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**\nâ˜ï¸ ×˜×œ×¤×•×Ÿ ××—×œ×§×ª ×”×–×× ×•×ª: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ‘‹' },
            { id: 'approaching_due_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×–×›×™×¨ ×œ×š ×›×™ ×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×‘×¢×•×“ **7 ×™××™×** ğŸ—“ï¸. ×–×” ×”×–××Ÿ ×œ× ×§×•×˜ ×¤×¢×•×œ×”!\n\n×”×× ×ª×¨×¦×” ×œ×”××¨×™×š ××ª ×ª×§×•×¤×ª ×”×©×›×™×¨×•×ª, ×œ×”×—×œ×™×£ ××ª ×”××›×•×œ×”, ××• ×œ×”×–××™×Ÿ ××™×¡×•×£? â™»ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â°' },
            { id: 'approaching_due_3_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×××© ×‘×§×¨×•×‘, ×‘×¢×•×“ **3 ×™××™×** âš ï¸. ×× × ×˜×¤×œ ×‘× ×•×©× ×›×“×™ ×œ×× ×•×¢ ×—×¨×™×’×•×ª.\n\n×× ×• ×œ×¨×©×•×ª×š ×œ×›×œ ×¢×–×¨×”! ğŸ™', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â³' },
            { id: 'overdue_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×•×“×™×¢ ×œ×š ×¢×œ ×—×¨×™×’×” ×‘×™××™ ×©×›×™×¨×•×ª ×©×œ ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×** ğŸš¨. × × ×œ×™×¦×•×¨ ×§×©×¨ ×¢× ××—×œ×§×ª ×”×–×× ×•×ª **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]** ××• ×œ×”×©×™×‘ ×œ×”×•×“×¢×” ×–×• ××” ×ª×¨×¦×” ×©× ×‘×¦×¢ (×”×—×œ×¤×”/×”×•×¦××”).', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'â—ï¸' },
            { id: 'overdue_30_days', text: '**×”×ª×¨××” ×—××•×¨×”, [×©× ×œ×§×•×—]:**\n\n×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×©×‘×©×™××•×©×š ×—×•×¨×’×ª ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×**! ×™×© ×œ×˜×¤×œ ×‘× ×•×©× ×‘×“×—×™×¤×•×ª ×›×“×™ ×œ×× ×•×¢ ×—×™×•×‘×™× × ×•×¡×¤×™× ×•×¡×™×‘×•×›×™× ××©×¤×˜×™×™×. âš–ï¸\n\n**×¦×•×¨ ×§×©×¨ ××™×™×“×™×ª: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”´' },
            { id: 'overdue_long', text: '**×œ×›×‘×•×“: [×©× ×œ×§×•×—]**\n\n**×”× ×“×•×Ÿ: ×—×•×‘ ×‘×’×™×Ÿ ×©×›×™×¨×•×ª ××›×•×œ×” ×—×•×¨×’×ª**\n\n×× ×• ×¤×•× ×™× ××œ×™×š ×‘×”×ª×™×™×—×¡ ×œ×—×©×‘×•× ×š, ×”× ××¦× ×‘×—×¨×™×’×” ××©××¢×•×ª×™×ª ×©×œ [**×™××™× ×©×¢×‘×¨×•**] ×™××™× ×¢×‘×•×¨ ××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]).\n\n×‘×”×™×¢×“×¨ ×”×¡×“×¨×” ××™×™×“×™×ª, ×× ×• × ××œ×¦×™× ×œ× ×§×•×˜ ×‘×¦×¢×“×™× ××©×¤×˜×™×™× ×œ×’×‘×™×™×”. ×× ×• ×§×•×¨××™× ×œ×š ×œ×™×¦×•×¨ ×§×©×¨ ×“×—×•×£ ×œ×”×¡×“×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '××©×¤×˜×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: '' },
            { id: 'general_inquiry', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n××™×š ×× ×—× ×• ×™×›×•×œ×™× ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ¤” ×× ×™×© ×œ×š ×©××œ×•×ª, ×‘×§×©×•×ª ××• ×ª×–×›×•×¨×•×ª, ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª ××œ×™× ×•. ×× ×—× ×• ×›××Ÿ ×‘×©×‘×™×œ×š! âœ¨', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ’¬' },
            { id: 'payment_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×™×“×™×“×•×ª×™×ª ×œ×’×‘×™ ×ª×©×œ×•× ×—×©×‘×•× ×™×ª ××¡×¤×¨ **[×ª×¢×•×“×”]** ğŸ’°. ×× ×• ××•×“×™× ×œ×š ×¢×œ ×ª×©×•××ª ×”×œ×‘ ×”××”×™×¨×” ×•×¢×œ ×”××©×š ×©×™×ª×•×£ ×”×¤×¢×•×œ×”.', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ’²' },
            { id: 'service_feedback', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×• ××§×•×•×™× ×©×©×™×¨×•×ª×™× ×• ×¢×•× ×™× ×¢×œ ×¦×™×¤×™×•×ª×™×š. × ×©××— ×œ×§×‘×œ ××©×•×‘ ×¢×œ ×”×—×•×•×™×” ×©×œ×š ×¢× ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×›×“×™ ×©× ×•×›×œ ×œ×”×©×ª×¤×¨ ×•×œ×”×¢× ×™×§ ×œ×š ×©×™×¨×•×ª ×˜×•×‘ ×™×•×ª×¨. â­', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ“' },
            { id: 'holiday_greetings', text: '×—×’ ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×•×œ××©×¤×—×ª×š ×—×’ ×©××—, ××œ× ×©×œ×•×•×”, ×‘×¨×™××•×ª ×•×”××•×Ÿ ×©××—×”! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ' },
            { id: 'special_offer', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×™×© ×œ× ×• ×—×“×©×•×ª ××¨×’×©×•×ª! ğŸ ××‘×¦×¢ ××™×•×—×“ ×œ××›×•×œ×•×ª ×—×“×©×•×ª/× ×•×¡×¤×•×ª ×¢×‘×•×¨×š. ××œ ×ª×—××™×¥! ×œ×¤×¨×˜×™× × ×•×¡×¤×™×, ×”×©×‘ ×œ×”×•×“×¢×” ×–×• ××• ×”×ª×§×©×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '×©×™×•×•×§', placeholders: ['×©× ×œ×§×•×—', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'âœ¨' },
            { id: 'follow_up_issue', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×—× ×• ×—×•×–×¨×™× ××œ×™×š ×œ×’×‘×™ ×”× ×•×©× ×©×“×™×•×•×—×ª ×¢×œ×™×• ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ğŸ› ï¸. ×”×× ×”×‘×¢×™×” × ×¤×ª×¨×” ×œ×©×‘×™×¢×•×ª ×¨×¦×•× ×š? ×× ×œ×, ×× × ×”×•×“×¢ ×œ× ×• ×›×“×™ ×©× ×•×›×œ ×œ×”××©×™×š ×œ×˜×¤×œ.', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'âœ…' },
            { id: 'document_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×œ×©×œ×™×—×ª ×”××¡××›×™× ×”×—×¡×¨×™× ×¢×‘×•×¨ ×”×–×× ×” **[×ª×¢×•×“×”]** ğŸ“„. ×× × ×©×œ×— ××•×ª× ×‘×”×§×“× ×›×“×™ ×©× ×•×›×œ ×œ×”×©×œ×™× ××ª ×”×˜×™×¤×•×œ ×‘×”×–×× ×”.\n\n×ª×•×“×” ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ“Œ' },
            { id: 'service_confirmation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×”×©×™×¨×•×ª ×©×”×•×–××Ÿ (×ª×¢×•×“×” **[×ª×¢×•×“×”]**) ××•×©×¨ ×•×™×ª×‘×¦×¢ ×‘-**[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]** âœ…. ×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×• ×•×©×™×”×™×” ×™×•× × ×¤×œ×!', category: '××™×©×•×¨', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'], emoji: 'ğŸ‘' },
            { id: 'service_delay', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×¢×§×‘ × ×¡×™×‘×•×ª ×‘×œ×ª×™ ×¦×¤×•×™×•×ª, ×™×™×ª×›×Ÿ ×©×™×”×™×” ×¢×™×›×•×‘ ×§×œ ×‘×˜×™×¤×•×œ ×‘×”×–×× ×” **[×ª×¢×•×“×”]** â±ï¸. ×× ×• ××ª× ×¦×œ×™× ×¢×œ ××™ ×”× ×•×—×•×ª ×•× ×¤×¢×œ ×œ×¤×ª×•×¨ ×–××ª ×‘××”×™×¨×•×ª ×”××¤×©×¨×™×ª.\n\n× ×•×“×™×¢ ×œ×š ×¢×œ ×›×œ ×¢×“×›×•×Ÿ! ğŸ”œ', category: '××™×“×¢', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸš§' },
            { id: 'location_update_request', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×›×“×™ ×©× ×•×›×œ ×œ×ª×× ××ª ×”×©×™×¨×•×ª ×‘×¦×•×¨×” ×”×˜×•×‘×” ×‘×™×•×ª×¨, ×× × ×•×•×“× ×©××™×§×•× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¢×•×“×›×Ÿ ×•××“×•×™×§ ğŸ“. ×–×” ×—×©×•×‘ ×œ×”×’×¢×” ×™×¢×™×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ—ºï¸' },
            { id: 'happy_birthday', text: '×™×•× ×”×•×œ×“×ª ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰ğŸ‚\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×™×•× ××œ× ×‘×©××—×”, ×‘×¨×™××•×ª, ×”×’×©××” ×•×”×¨×‘×” ×¨×’×¢×™× ××ª×•×§×™×! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸˆ' },
            { id: 'review_invitation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n× ×”× ×™×ª ××”×©×™×¨×•×ª ×©×œ× ×•? âœ¨ × ×©××— ×× ×ª×•×›×œ ×œ×”×§×“×™×© ×¨×’×¢ ×•×œ×›×ª×•×‘ ×œ× ×• ×‘×™×§×•×¨×ª ×§×¦×¨×” ×›××Ÿ: [**×œ×™× ×§ ×œ×‘×™×§×•×¨×ª**]. ×ª×•×“×” ××¨××© ×¢×œ ×¢×–×¨×ª×š ×œ×”×©×ª×¤×¨! ğŸ™', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª'], emoji: 'ğŸŒŸ' },
            { id: 'tech_support_contact', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×œ×›×œ ×‘×¢×™×” ×˜×›× ×™×ª ××• ×ª×¤×¢×•×œ×™×ª ×¢× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]), ××—×œ×§×ª ×”×ª××™×›×” ×©×œ× ×• ×–××™× ×” ×¢×‘×•×¨×š ğŸ§‘â€ğŸ”§.\n\n**×¦×•×¨ ×§×©×¨: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”§' },
            { id: 'general_thanks', text: '×ª×•×“×” ×¨×‘×” ×œ×š, **[×©× ×œ×§×•×—]**, ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×” ×•×”×××•×Ÿ ×‘[×©× ×”×—×‘×¨×”]! ğŸ™\n\n×× ×• ××¢×¨×™×›×™× ××ª ×‘×—×™×¨×ª×š ×‘× ×• ×•××§×•×•×™× ×œ×”××©×™×š ×œ×©×¨×ª ××•×ª×š × ××× ×”. ğŸ’–', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ˜Š' },
            { id: 'multi_container_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×©×× ×• ×œ×‘ ×©×‘×¨×©×•×ª×š **××¡×¤×¨ ××›×•×œ×•×ª ×¤×¢×™×œ×•×ª** ğŸ—ï¸. ×× ×• ×›××Ÿ ×›×“×™ ×œ×•×•×“× ×©×›×œ ×”×¦×¨×›×™× ×©×œ×š ××¡×•×¤×§×™×.\n\n×”×× ×™×© ××©×”×• ×©× ×•×›×œ ×œ×¢×–×•×¨ ×‘×• ×‘× ×•×’×¢ ×œ××›×•×œ×•×ª ×©×œ×š? ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª! ğŸ¤', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ“¦' },
            { id: 'container_mismatch', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×”×ª×¨××”:** ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×™×¨×“×” ××¦×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ×œ×¤× ×™ **[×™××™× ×©×¢×‘×¨×•]** ×™××™× ×•×˜×¨× ×”×•×—×–×¨×”/× ×¡×’×¨×”! ğŸš¨', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'ğŸš¨' },
            { id: 'pending_order_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×‘×˜×™×¤×•×œ:** ×”×–×× ×” **[×ª×¢×•×“×”]** ×©×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ××¡×•×× ×ª "×‘×˜×™×¤×•×œ" ×•×œ× ×¢×•×“×›× ×” **[×™××™× ×©×¢×‘×¨×•]** ×™××™×. ×“×•×¨×© ×‘×“×™×§×”! âš ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'âš ï¸' }
        ];

        const cityGuidelines = {
            '×”×¨×¦×œ×™×”': {
                id: 'herzliya_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×”×¨×¦×œ×™×”:\n×›×“×™ ×œ×”×¦×™×‘ ××›×•×œ×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘×¨×—×•×‘ ×‘×”×¨×¦×œ×™×”, ×™×© ×œ×”×’×™×© ×‘×§×©×” ××¨××© ×œ××’×£ ×”×¤×™×§×•×— ×”×¢×™×¨×•× ×™. ×”×‘×§×©×” ×›×¨×•×›×” ×‘×ª×©×œ×•× ××’×¨×” ×•× ×“×¨×© ××™×©×•×¨ ×‘×›×ª×‘. ××•××œ×¥ ×œ×•×•×“× ××ª ×›×œ ×”×¤×¨×˜×™× ×‘××ª×¨ ×”×¢×™×¨×™×™×” ××• ×‘×˜×œ×¤×•×Ÿ.\n\n×§×™×©×•×¨ ×œ××™×“×¢: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ“'
            },
            '×¨×¢× × ×”': {
                id: 'raanana_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×¨×¢× × ×”:\n×‘×¨×¢× × ×”, ×—×œ ××™×¡×•×¨ ××•×—×œ×˜ ×œ×”×©××™×¨ ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘××§×•× ×¦×™×‘×•×¨×™ (×‘×¨×—×•×‘) ×‘×¡×•×¤×™ ×©×‘×•×¢ ×•×‘×—×’×™×. ×™×© ×œ×“××•×’ ×œ×”×–××™×Ÿ ×¤×™× ×•×™ ×œ×¤× ×™ ×›× ×™×¡×ª ×”×©×‘×ª/×—×’. ×§× ×¡×•×ª ×™×™× ×ª× ×• ×œ××¤×¨×™×. ×× × ×”×§×¤×“ ×¢×œ ×”× ×—×™×•×ª ××œ×•.\n\n××™×“×¢ × ×•×¡×£: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸš«'
            },
            '×ª×œ ××‘×™×‘': {
                id: 'telaviv_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×ª×œ ××‘×™×‘:\n×‘×ª×œ ××‘×™×‘, ×”×¦×‘×ª ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘×¨×—×•×‘ ××—×™×™×‘×ª ×§×‘×œ×ª ×”×™×ª×¨ ××”×¢×™×¨×™×™×”. ×™×© ×œ×”×’×™×© ×‘×§×©×” ××§×•×•× ×ª ×•×œ×¦×¨×£ ××ª ×›×œ ×”××¡××›×™× ×”× ×“×¨×©×™×. ×©×™××• ×œ×‘ ×œ×”× ×—×™×•×ª ×”××“×•×™×§×•×ª ×œ×’×‘×™ ×¡×™××•×Ÿ ×”××›×•×œ×” ×•××©×š ×”×”×¦×‘×”.\n\n×œ××™×“×¢ ×•×”×’×©×ª ×‘×§×©×”: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ›ï¸'
            }
        };

        const companyInfo = {
            phoneNumber: '972508860896', 
            companyPhone: '097602010', 
            companyName: '×—.×¡×‘×Ÿ' 
        };

        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec'; 

        let typingInterval;
        let currentMessageFullText = '';
        let typingIndex = 0;

        document.addEventListener('DOMContentLoaded', () => {
            allOperations = parseFullTrackingCSV(fullTrackingDataRaw)
                .map(op => ({
                    ...op,
                    '×ª××¨×™×š ×”×–×× ×”': formatDate(op['×ª××¨×™×š ×”×–×× ×”']), 
                    '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': formatDate(op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']),
                    '×ª××¨×™×š ×¡×’×™×¨×”': formatDate(op['×ª××¨×™×š ×¡×’×™×¨×”']),
                }))
                .sort((a, b) => (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0));

            renderDashboard();
            renderInventory();
            renderTreatmentBoard();

            document.getElementById('main-search').addEventListener('input', renderAllOperationsTable);
        });

        const getKPIs = () => {
            let activeContainerLocations = {}; 
            let totalOverdueCustomerIds = new Set(); 

            const detailedContainerStatus = {}; 
            allOperations.slice().sort((a,b) => (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0)).forEach(op => {
                const opDate = op['×ª××¨×™×š ×”×–×× ×”'];
                if (!opDate) return;

                const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                containersTaken.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'in_use',
                        customerId: op['×œ×§×•×—'],
                        customerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });

                containersBrought.forEach(containerNum => {
                    detailedContainerStatus[containerNum] = {
                        status: 'available',
                        lastCustomerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: opDate,
                        latestOperation: op
                    };
                });
            });

            let currentActiveContainersCount = 0;
            let currentAvailableContainersCount = 0;

            for (const containerNum in detailedContainerStatus) {
                const info = detailedContainerStatus[containerNum];
                if (info.status === 'in_use') {
                    currentActiveContainersCount++;
                    const daysSincePlacement = daysSince(info.lastActionDate);
                    if (info.latestOperation && info.latestOperation['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                        totalOverdueCustomerIds.add(info.customerId);
                    }
                } else if (info.status === 'available') {
                    currentAvailableContainersCount++;
                }
            }
            
            return {
                activeContainers: currentActiveContainersCount,
                overdueCustomers: totalOverdueCustomerIds.size,
                availableContainers: currentAvailableContainersCount,
                totalOperations: allOperations.length,
            };
        };

        const renderDashboard = () => {
            const { activeContainers, overdueCustomers, availableContainers, totalOperations } = getKPIs();
            document.getElementById('kpi-active-containers').textContent = activeContainers;
            document.getElementById('kpi-overdue-customers').textContent = overdueCustomers;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-total-operations').textContent = totalOperations;
            
            renderAllOperationsTable();
            renderCharts();
        };

        const renderAllOperationsTable = () => {
            const searchTerm = document.getElementById('main-search').value.toLowerCase();
            const tableBody = document.getElementById('all-operations-table');
            tableBody.innerHTML = '';
            
            const filteredOps = allOperations.filter(op => 
                (op['×©× ×œ×§×•×—'] && op['×©× ×œ×§×•×—'].toLowerCase().includes(searchTerm)) ||
                (op['×ª×¢×•×“×”'] && op['×ª×¢×•×“×”'].toLowerCase().includes(searchTerm)) ||
                (op['×©× ×¡×•×›×Ÿ'] && op['×©× ×¡×•×›×Ÿ'].toLowerCase().includes(searchTerm))
            );

            filteredOps.slice(0, 100).forEach(op => { 
                const days = (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') && op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                let statusText, statusClass;

                if (op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                    statusText = '×—×¨×™×’×”';
                    statusClass = 'status-red';
                } else if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    statusText = '×¡×’×•×¨';
                    statusClass = 'status-gray';
                } else { 
                    statusText = '×¤×¢×™×œ';
                    statusClass = 'status-green';
                }

                const row = `
                    <tr class="hover:bg-gray-50 cursor-pointer">
                        <td class="py-3 px-4">${op['××ª××¨×™×š']}</td>
                        <td class="py-3 px-4">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-3 px-4 font-semibold text-gray-700">${op['×©× ×œ×§×•×—']}</td>
                        <td class="py-3 px-4">${op['×©× ×¡×•×›×Ÿ']}</td>
                        <td class="py-3 px-4">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-3 px-4">${days}</td>
                        <td class="py-3 px-4"><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="py-3 px-4">
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                            <button onclick="openModal('${op['×œ×§×•×—']}')" class="text-blue-600 hover:text-blue-700 ml-2 focus:outline-none">
                                <i class="fas fa-eye text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };

        const renderCharts = () => {
            const agentCounts = allOperations.reduce((acc, op) => {
                const agent = op['×©× ×¡×•×›×Ÿ'] || '×œ× ×™×“×•×¢';
                acc[agent] = (acc[agent] || 0) + 1;
                return acc;
            }, {});
            if (charts.agent) charts.agent.destroy();
            charts.agent = new Chart(document.getElementById('agentActivityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agentCounts).map(label => {
                        if (label.length > 16) {
                            return label.match(/.{1,8}/g).join('\n'); 
                        }
                        return label;
                    }),
                    datasets: [{
                        label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                        data: Object.values(agentCounts),
                        backgroundColor: '#8b5cf6',
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                     plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label.replace(/\n/g, ' '); 
                                }
                            }
                        }
                    }
                }
            });

            const timelineCounts = allOperations.reduce((acc, op) => {
                if (op['×ª××¨×™×š ×”×–×× ×”'] && !isNaN(op['×ª××¨×™×š ×”×–×× ×”'].getTime())) {
                    const month = op['×ª××¨×™×š ×”×–×× ×”'].toISOString().slice(0, 7);
                    acc[month] = (acc[month] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedTimeline = Object.entries(timelineCounts).sort((a, b) => a[0].localeCompare(b[0]));
             if (charts.timeline) charts.timeline.destroy();
            charts.timeline = new Chart(document.getElementById('operationsTimelineChart'), {
                type: 'line',
                data: {
                    labels: sortedTimeline.map(e => e[0]),
                    datasets: [{
                        label: '×›××•×ª ×¤×¢×•×œ×•×ª ×—×•×“×©×™×ª',
                        data: sortedTimeline.map(e => e[1]),
                        borderColor: '#6d28d9',
                        tension: 0.1
                    }]
                },
                 options: { responsive: true, maintainAspectRatio: false }
            });
        };
        
        const renderInventory = () => {
            const inUseBody = document.getElementById('in-use-containers-table');
            const availableBody = document.getElementById('available-containers-table');
            inUseBody.innerHTML = '';
            availableBody.innerHTML = '';

            const containerHistory = {}; 

            allOperations.forEach(op => {
                const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const allRelatedContainers = [...new Set([...containersTaken, ...containersBrought])];

                allRelatedContainers.forEach(containerNum => {
                    if (!containerHistory[containerNum]) {
                        containerHistory[containerNum] = [];
                    }
                    containerHistory[containerNum].push(op);
                });
            });

            const containerCurrentStatus = {}; 

            for (const containerNum in containerHistory) {
                const history = containerHistory[containerNum].sort((a,b) => (a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0) - (b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0));
                let currentStatus = { status: 'unknown', lastActionDate: null, customerId: null, customerName: null, latestOperation: null };

                history.forEach(op => {
                    const opDate = op['×ª××¨×™×š ×”×–×× ×”'];
                    if (!opDate) return;

                    const containersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                    const containersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                    if (opDate && (!currentStatus.lastActionDate || opDate >= currentStatus.lastActionDate)) {
                        if (containersTaken.includes(containerNum)) {
                            currentStatus = {
                                status: 'in_use',
                                customerId: op['×œ×§×•×—'],
                                customerName: op['×©× ×œ×§×•×—'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        } else if (containersBrought.includes(containerNum)) {
                            currentStatus = {
                                status: 'available',
                                lastCustomerName: op['×©× ×œ×§×•×—'],
                                lastActionDate: opDate,
                                latestOperation: op
                            };
                        }
                    }
                });
                containerCurrentStatus[containerNum] = currentStatus;
            }
            
            const uniqueContainersSorted = Object.keys(containerCurrentStatus).sort((a,b) => parseInt(a) - parseInt(b));

            uniqueContainersSorted.forEach(containerNum => {
                const statusData = containerCurrentStatus[containerNum];
                if (statusData.status === 'in_use') {
                    const days = daysSince(statusData.lastActionDate);
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4 font-semibold">${statusData.customerName}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4 ${days > 10 ? 'text-red-600 font-bold' : ''}">${days}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.customerId}')">×¦×¤×”</button></td>
                        </tr>`;
                    inUseBody.innerHTML += row;
                } else if (statusData.status === 'available') {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4">${statusData.lastCustomerName || '×œ× ×™×“×•×¢'}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline" onclick="openModal('${statusData.latestOperation['×œ×§×•×—']}')">×¦×¤×”</button></td>
                        </tr>`;
                    availableBody.innerHTML += row;
                }
            });

            document.getElementById('kpi-active-containers').textContent = inUseBody.rows.length;
            document.getElementById('kpi-available-containers').textContent = availableBody.rows.length;
        };

        const renderTreatmentBoard = () => {
            const board = document.getElementById('treatment-board');
            board.innerHTML = '';
            
            const overdueOperations = allOperations.filter(op => op['×¡×˜×˜×•×¡'] === '×—×¨×™×’');
            
            if (overdueOperations.length === 0) {
                board.innerHTML = `<p class="text-center text-gray-600 col-span-full">××™×Ÿ ×œ×§×•×—×•×ª ×‘×—×¨×™×’×” ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</p>`;
                return;
            }

            overdueOperations.forEach(op => {
                const days = op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                const containerNumbersTaken = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerNumbersBrought = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containerDisplay = containerNumbersTaken.length > 0 ? `×™×¨×“×”: ${containerNumbersTaken.join(', ')}` : '';
                if (containerNumbersBrought.length > 0) {
                    containerDisplay += (containerDisplay ? ', ' : '') + `×¢×œ×ª×”: ${containerNumbersBrought.join(', ')}`;
                }
                const containerNumbersForMsg = [...containerNumbersTaken, ...containerNumbersBrought].filter(Boolean).join(', ');


                const card = `
                    <div class="kpi-card bg-white border-l-4 border-red-500">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${op['×©× ×œ×§×•×—']}</h4>
                                <p class="text-sm text-gray-500">×ª×¢×•×“×”: ${op['×ª×¢×•×“×”']}</p>
                                <p class="text-sm text-gray-500">××›×•×œ×”: ${containerDisplay || '×œ× ×¦×•×™×Ÿ'}</p>
                            </div>
                            <span class="font-bold text-xl text-red-600">${days} ×™××™× ×—×¨×™×’×”</span>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button class="px-3 py-1 bg-violet-600 text-white rounded-lg hover:bg-violet-700 text-sm" onclick="openModal('${op['×œ×§×•×—']}')">×¤×¨×˜×™ ×œ×§×•×—</button>
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${containerNumbersForMsg}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none">
                                <i class="fab fa-whatsapp text-2xl"></i>
                            </button>
                        </div>
                    </div>
                `;
                board.innerHTML += card;
            });
        };
        
        const openModalByCustomerName = (customerName) => {
            const customerOp = allOperations.find(op => op['×©× ×œ×§×•×—'] === customerName && (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×¨×™×’'));
            if (customerOp) {
                openModal(customerOp['×œ×§×•×—']);
            }
        };

        const openModal = (customerId) => {
            const customerOps = allOperations.filter(op => op['×œ×§×•×—'] === customerId);
            if (customerOps.length === 0) return;

            const customerName = customerOps[0]['×©× ×œ×§×•×—'];
            document.getElementById('modal-customer-name').textContent = customerName;

            const totalOps = customerOps.length;
            const totalPlacements = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”').length;
            const totalRemovals = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¦××”').length;
            
            document.getElementById('modal-customer-summary').innerHTML = `
                <div class="text-center"><p class="text-2xl font-bold">${totalOps}</p><p class="text-sm text-gray-500">×¡×”"×› ×¤×¢×•×œ×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalPlacements}</p><p class="text-sm text-gray-500">×”×¦×‘×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalRemovals}</p><p class="text-sm text-gray-500">×”×•×¦××•×ª</p></div>
            `;

            const historyTable = document.getElementById('modal-customer-history-table');
            historyTable.innerHTML = '';
            customerOps.forEach(op => {
                 const days = (op['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' || op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') && op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : '-';
                 let statusText, statusClass;
                 if (op['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                    statusText = '×—×¨×™×’×”'; statusClass = 'status-red';
                 } else if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    statusText = '×¡×’×•×¨'; statusClass = 'status-gray';
                 } else { 
                    statusText = '×¤×¢×™×œ'; statusClass = 'status-green';
                 }
                const row = `
                    <tr>
                        <td class="py-2 px-3">${op['××ª××¨×™×š']}</td>
                        <td class="py-2 px-3">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-2 px-3">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-2 px-3"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>`;
                historyTable.innerHTML += row;
            });

            document.getElementById('customer-history-modal').classList.remove('hidden');
            document.getElementById('customer-history-modal').classList.add('flex');
        };

        const closeModal = () => {
            document.getElementById('customer-history-modal').classList.add('hidden');
            document.getElementById('customer-history-modal').classList.remove('flex');
        };

        const getSuggestedMessageIdForOrder = (order) => {
            const daysOverdue = order['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(order['×ª××¨×™×š ×”×–×× ×”']) : 0;
            const orderDate = order['×ª××¨×™×š ×”×–×× ×”'];
            const today = new Date();
            const daysSinceOrder = orderDate ? Math.floor((today - orderDate) / (1000 * 60 * 60 * 24)) : 0;

            if (order['×¡×˜×˜×•×¡'] === '×—×¨×™×’') {
                if (daysOverdue <= 7) return 'overdue_7_days';
                if (daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long';
            }
            
            if (order['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' && order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] && !isNaN(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].getTime())) {
                const expectedEndDate = order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'];
                const daysUntilDue = Math.floor((expectedEndDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 3 && daysUntilDue >= 0) return 'approaching_due_3_days';
                if (daysUntilDue <= 7 && daysUntilDue > 3) return 'approaching_due_7_days';
            }

            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”' && orderDate && daysSinceOrder <= 30) {
                 const customerId = allOperations.find(op => op['×˜×œ×¤×•×Ÿ ×œ×§×•×—'] === order['×˜×œ×¤×•×Ÿ ×œ×§×•×—'])?.['×œ×§×•×—'];
                 if (customerId) {
                     const customerOperations = allOperations.filter(op => op['×œ×§×•×—'] === customerId);
                     if (customerOperations.length === 1 && customerOperations[0]['×ª×¢×•×“×”'] === order['×ª×¢×•×“×”']) {
                         return 'new_customer_welcome';
                     }
                 }
            }
            
            const customerCity = getCityFromAddress(order['×›×ª×•×‘×ª']);
            if (customerCity && cityGuidelines[customerCity]) {
                return `city_guideline_${customerCity}`;
            }

            return 'general_inquiry';
        };

        const openWhatsAppModal = (event, phoneNumber, customerName, docId, daysOverdue, containerNum, expectedEndDateFormatted, customerAddress) => {
            event.stopPropagation();
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageOptionsListDiv = document.getElementById('message-options-list');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');
            const whatsappDocIdInput = document.getElementById('whatsapp-doc-id');

            phoneInput.value = phoneNumber.startsWith('972') ? phoneNumber : `972${phoneNumber.substring(1)}`;
            whatsappDocIdInput.value = docId;

            const dummyOrderForSuggestion = {
                '×¡×˜×˜×•×¡': (daysOverdue > 10 ? '×—×¨×™×’' : '×¤×ª×•×—'), 
                '×ª××¨×™×š ×”×–×× ×”': new Date(new Date().getTime() - daysOverdue * 24 * 60 * 60 * 1000), 
                '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDateFormatted ? formatDate(expectedEndDateFormatted) : null,
                '×¡×•×’ ×¤×¢×•×œ×”': '×”×¦×‘×”',
                '×˜×œ×¤×•×Ÿ ×œ×§×•×—': phoneNumber,
                '×›×ª×•×‘×ª': customerAddress,
                '×ª×¢×•×“×”': docId
            };
            const suggestedMessageId = getSuggestedMessageIdForOrder(dummyOrderForSuggestion);


            messageOptionsListDiv.innerHTML = '';
            
            const allMsgs = [...whatsappMessages];
            const customerCity = getCityFromAddress(customerAddress);
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                allMsgs.unshift({
                    id: `city_guideline_${customerCity}`,
                    text: `**×”× ×—×™×™×ª ×¢×™×¨×™×™×ª ${customerCity}:**\n${guideline.text}\n\n×œ××™×“×¢ ×•×˜×¤×¡×™× × ×•×¡×¤×™×: ${guideline.link}`,
                    category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                    placeholders: [],
                    emoji: guideline.emoji
                });
            }

            allMsgs.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item p-3 rounded-md cursor-pointer hover:bg-gray-100`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                }
                const displayEmoji = msg.category === '××©×¤×˜×™' ? '' : (msg.emoji || '');
                optionDiv.innerHTML = `<strong>${displayEmoji} ${msg.category}:</strong> ${msg.text.replace(/\[.*?\]/g, '...').substring(0, 70)}...`;
                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('bg-blue-100', 'text-blue-800'));
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800');
                    const placeholders = {
                        '×©× ×œ×§×•×—': customerName,
                        '×™××™× ×©×¢×‘×¨×•': daysOverdue,
                        '××¡×¤×¨ ××›×•×œ×”': containerNum,
                        '×ª×¢×•×“×”': docId,
                        '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDateFormatted,
                        '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.phoneNumber,
                        '×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.companyPhone,
                        '×©× ×”×—×‘×¨×”': companyInfo.companyName,
                        '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª': 'https://example.com/review'
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            const defaultSelection = messageOptionsListDiv.querySelector('.message-option-item.bg-blue-100');
            if (defaultSelection) {
                defaultSelection.click();
            } else if (allMsgs.length > 0) {
                messageOptionsListDiv.children[0].click();
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        const closeModalWhatsApp = () => {
            document.getElementById('whatsapp-modal').classList.add('hidden');
            document.getElementById('whatsapp-modal').classList.remove('flex');
            clearInterval(typingInterval);
        };

        const selectAndTypeMessage = (messageId, placeholders = {}) => {
            clearInterval(typingInterval);
            const allMessagesWithGuidelines = [
                ...whatsappMessages,
                ...Object.values(cityGuidelines).map(g => ({
                    id: `city_guideline_${g.id.split('_')[0]}`,
                    text: g.text,
                    category: g.category,
                    placeholders: g.placeholders,
                    emoji: g.emoji
                }))
            ];
            const message = allMessagesWithGuidelines.find(msg => msg.id === messageId);
            const typingDisplay = document.getElementById('typing-effect-display');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');

            if (message) {
                currentMessageFullText = message.text;
                for (const key in placeholders) {
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[\\*\\*${key}\\*\\*\\]|\\[${key}\\]`, 'g'), placeholders[key]);
                }
                
                typingIndex = 0;
                typingDisplay.textContent = '';
                whatsappMessageTextarea.value = '';

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        whatsappMessageTextarea.value = currentMessageFullText;
                        typingDisplay.textContent = '';
                    }
                }, 30);
            }
        };

        const sendWhatsAppMessage = async () => {
            const phoneNumber = document.getElementById('whatsapp-phone-input').value.trim().replace(/\D/g, '');
            const message = document.getElementById('whatsapp-message-textarea').value.trim();
            const docId = document.getElementById('whatsapp-doc-id').value;

            if (!phoneNumber) {
                alert('×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ.');
                return;
            }
            if (!message) {
                alert('×ª×•×›×Ÿ ×”×”×•×“×¢×” ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§.');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            closeModalWhatsApp();

            if (docId) {
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=logWhatsAppMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}}`);
                        const data = await response.json();
                        if (data.success) {
                            alert('×”×”×•×“×¢×” × ×©×œ×—×” ×•×ª×•×¢×“×” ×‘×”×¦×œ×—×”!');
                            return;
                        } else if (data.message && data.message.includes('Service invoked too many times')) {
                            const delay = baseDelay * Math.pow(2, retries);
                            console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else {
                            alert('×©×’×™××” ×‘×ª×™×¢×•×“ ×”×”×•×“×¢×”: ' + data.message);
                            return;
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        alert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + error.message);
                        return;
                    }
                }
                alert('× ×›×©×œ ×ª×™×¢×•×“ ×”×”×•×“×¢×” ×œ××—×¨ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×.');
            } else {
                alert('×”×”×•×“×¢×” × ×©×œ×—×”, ××š ×œ× ×©×•×™×›×” ×œ××¡××š (×—×¡×¨ ××¡×¤×¨ ×ª×¢×•×“×”).');
            }
        };

        const filterMessageOptions = () => {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        };

        const toggleMessageOptions = () => {
            const container = document.getElementById('whatsapp-message-options-container');
            container.classList.toggle('hidden');
        };

    </script>
</body>
</html>
