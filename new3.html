<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מכולות - משודרג</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Assistant for a clean Hebrew font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        /* Navigation tab button styling */
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            position: relative;
            overflow: hidden;
            flex-grow: 1; /* Make buttons take equal width */
            text-align: center;
        }
        /* Active navigation tab button styling */
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        /* Hover effect for inactive navigation tab buttons */
        .nav-tab-btn:not(.active):hover {
            color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            background-color: rgba(139, 92, 246, 0.05);
            border-radius: 0.5rem;
        }

        /* KPI card styling */
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Hover effect for KPI cards */
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            backdrop-filter: blur(5px); /* Blurred background for modal */
            animation: fadeIn 0.3s ease-out;
        }
        /* Modal content styling */
        .modal-content {
            max-height: 90vh;
            animation: slideInFromTop 0.3s ease-out;
            transform-origin: top;
        }
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        /* Kanban column styling */
        .kanban-column {
            min-height: 200px;
        }
        /* Status badge styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        /* Specific status badge colors */
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }
        .status-blue { background-color: #e0f2fe; color: #075985; } /* For 'in_transit' */

        /* Custom styles for larger and bolder table text */
        .table-large-text td { 
            font-size: 1.1rem; 
            font-weight: 700;
        }
        /* Typing effect cursor styling */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        /* Keyframe animation for blinking cursor */
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }

        /* Animations for modals */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading spinner styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #6d28d9; /* Violet */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New blink-subtle animation for overdue KPI */
        @keyframes blink-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .blink-subtle {
            animation: blink-subtle 1.5s ease-in-out infinite;
        }
        /* Style for clickable container numbers */
        .container-link {
            text-decoration: underline;
            color: #3b82f6; /* blue-500 */
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        .container-link:hover {
            opacity: 0.8;
        }
        /* Styling for the note input within KPI card */
        .kpi-note-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .kpi-note-input:focus {
            outline: none;
            border-color: #8b5cf6; /* violet-500 */
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25); /* ring-violet-300 */
        }
        /* Styling for scrollable notes */
        .scrollable-notes {
            max-height: 3.5rem; /* ~2-3 lines of text */
            overflow-y: auto;
            word-wrap: break-word; /* Ensure long words break */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #d1d5db #f3f4f6; /* Thumb and track color */
        }
        /* Webkit scrollbar (Chrome, Safari) */
        .scrollable-notes::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-notes::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }
        .scrollable-notes::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">מערכת ניהול מכולות</h1>
            <p class="text-lg text-gray-600">לוח בקרה מרכזי לניהול, מעקב וניתוח פעילות</p>
        </header>

        <!-- Top 3 Overdue Customers KPI Cards -->
        <section id="overdue-kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></section>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-gray-200 mb-8 rounded-lg shadow-sm">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>לוח בקרה
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>מלאי מכולות
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>לוח טיפול בחריגות
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">סקירה כללית</h2>
                    <button onclick="openNewOrderModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>הזמנה חדשה
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פעילות באתרים</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">לקוחות בחריגה <span class="text-xs">(מעל 10 ימים)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פנויות במלאי</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">סה"כ פעולות (כל הזמנים)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעילות לפי סוכן</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעולות לאורך זמן</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">כלל הפעולות</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" placeholder="חפש לפי שם לקוח, תעודה, שם סוכן, מספר מכולה...">
                    </div>
                    <!-- New filter for closed orders -->
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="show-closed-orders" class="ml-2 h-5 w-5 text-violet-600 focus:ring-violet-500 border-gray-300 rounded">
                        <label for="show-closed-orders" class="text-gray-700 font-medium">הצג הזמנות סגורות</label>
                    </div>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך 📅</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תעודה 📄</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">שם לקוח 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">שם סוכן 👷</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סוג פעולה 📦</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">ימים בשכירות ⏳</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס ✅</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות בשימוש פעיל</h2>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מספר מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס מכולה 🚧</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">לקוח נוכחי 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך הצבה 🗓️</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">ימים באתר ⏳</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות פנויות / בתהליך</h2>
                     <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מספר מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס מכולה 🚧</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך פעולה אחרונה 🗓️</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">לקוח/יעד אחרון 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">לוח טיפול בלקוחות חורגים</h2>
                 <p class="text-gray-600 mb-6">כאן מרוכזות כל המכולות שנמצאות אצל לקוחות מעל 10 ימי עבודה ודורשות טיפול (החלפה או הוצאה).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
                 <div id="no-overdue-message" class="text-center text-gray-600 col-span-full hidden mt-8 p-4 bg-white rounded-lg shadow-md">
                     <p class="text-xl font-semibold mb-2">אין לקוחות בחריגה כרגע. כל הכבוד! 🎉</p>
                     <p>הצוות עובד נהדר!</p>
                 </div>
            </section>
        </main>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="loader"></div>
        <p class="text-gray-700 text-lg mt-4 mr-4">טוען נתונים...</p>
    </div>

    <!-- Unified History Modal (for Customer and Container) -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold" id="modal-history-title"></h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div id="modal-customer-specific-details">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">סיכום פעילות</h3>
                    <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-md text-blue-800 font-medium"></div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">מכולות ששויכו ללקוח</h3>
                    <div id="modal-customer-containers" class="mb-6 p-3 bg-gray-50 rounded-md text-gray-700">
                        <p id="customer-container-list" class="font-mono text-sm"></p>
                    </div>
                </div>
                <h3 class="text-lg font-semibold mb-2 text-gray-700" id="history-table-title">היסטוריית פעולות</h3>
                <div class="overflow-y-auto max-h-96 rounded-md border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr id="history-table-header-row" class="border-b border-gray-200">
                                <!-- Headers will be dynamically populated -->
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="table-large-text divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left rounded-b-lg">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">סגור</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">שליחת הודעת WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">מספר טלפון:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" placeholder="9725XXXXXXXX">
                    <p id="phone-error" class="text-red-500 text-sm mt-1 hidden">מספר טלפון אינו תקין.</p>
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center hover:bg-gray-200 transition-colors">
                        <span>בחר הודעה מובנית</span>
                        <i id="message-options-toggle-icon" class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white shadow-inner">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200 sticky top-0 bg-white" placeholder="חפש הודעה..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">תוכן ההודעה:</label>
                     <div class="border border-gray-300 rounded-md p-3 min-h-[100px] bg-gray-50 mb-2 overflow-y-auto max-h-48 relative">
                        <span id="typing-effect-display" class="whitespace-pre-wrap text-gray-800"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" rows="5" placeholder="כתוב כאן הודעה אישית..."></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <input type="hidden" id="whatsapp-customer-id"> <!-- Added for note updates -->
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors flex items-center">
                        <i class="fab fa-whatsapp mr-2"></i>שלח הודעה
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">הוספת הזמנה חדשה</h2>
                <button onclick="closeNewOrderModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label for="new-order-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך הזמנה <span class="text-red-500">*</span></label>
                        <input type="date" id="new-order-date" name="תאריך הזמנה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">תעודה <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-docid" name="תעודה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                        <p id="docid-error" class="text-red-500 text-sm mt-1 hidden">מספר תעודה זה כבר קיים.</p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">שם סוכן</label>
                        <input type="text" id="new-order-agent" name="שם סוכן" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">שם לקוח <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-customer-name" name="שם לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-address" class="block text-sm font-semibold text-gray-700 mb-1">כתובת</label>
                        <input type="text" id="new-order-address" name="כתובת" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">סוג פעולה <span class="text-red-500">*</span></label>
                        <select id="new-order-action-type" name="סוג פעולה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="">בחר פעולה</option>
                            <option value="הצבה">הצבה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="הוצאה">הוצאה</option>
                            <option value="הזזה">הזזה</option>
                            <option value="פינוי במקום">פינוי במקום</option>
                            <option value="גישה ללא פעולה">גישה ללא פעולה</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-status" class="block text-sm font-semibold text-gray-700 mb-1">סטטוס <span class="text-red-500">*</span></label>
                        <select id="new-order-status" name="סטטוס" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="new-order-container-dropped" name="מספר מכולה ירדה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="container-dropped-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="new-order-container-lifted" name="מספר מכולה עלתה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="container-lifted-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סיום צפוי</label>
                        <input type="date" id="new-order-expected-end-date" name="תאריך סיום צפוי" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">טלפון לקוח</label>
                        <input type="tel" id="new-order-phone" name="טלפון לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות</label>
                        <textarea id="new-order-notes" name="הערות" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2 rounded-b-lg">
                <button onclick="closeNewOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                <button onclick="submitNewOrder()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors">הוסף הזמנה</button>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal (New) -->
    <div id="edit-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">עריכת הזמנה</h2>
                <button onclick="closeEditOrderModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="edit-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="edit-order-original-docid">
                    <div class="col-span-1">
                        <label for="edit-order-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך הזמנה <span class="text-red-500">*</span></label>
                        <input type="date" id="edit-order-date" name="תאריך הזמנה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">תעודה <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-order-docid" name="תעודה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                        <p id="edit-docid-error" class="text-red-500 text-sm mt-1 hidden">מספר תעודה זה כבר קיים.</p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">שם סוכן</label>
                        <input type="text" id="edit-order-agent" name="שם סוכן" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">שם לקוח <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-order-customer-name" name="שם לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-address" class="block text-sm font-semibold text-gray-700 mb-1">כתובת</label>
                        <input type="text" id="edit-order-address" name="כתובת" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">סוג פעולה <span class="text-red-500">*</span></label>
                        <select id="edit-order-action-type" name="סוג פעולה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="">בחר פעולה</option>
                            <option value="הצבה">הצבה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="הוצאה">הוצאה</option>
                            <option value="הזזה">הזזה</option>
                            <option value="פינוי במקום">פינוי במקום</option>
                            <option value="גישה ללא פעולה">גישה ללא פעולה</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-status" class="block text-sm font-semibold text-gray-700 mb-1">סטטוס <span class="text-red-500">*</span></label>
                        <select id="edit-order-status" name="סטטוס" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="edit-order-container-dropped" name="מספר מכולה ירדה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="edit-container-dropped-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="edit-order-container-lifted" name="מספר מכולה עלתה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="edit-container-lifted-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סיום צפוי</label>
                        <input type="date" id="edit-order-expected-end-date" name="תאריך סיום צפוי" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">טלפון לקוח</label>
                        <input type="tel" id="edit-order-phone" name="טלפון לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות</label>
                        <textarea id="edit-order-notes" name="הערות" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-closure-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות סיום</label>
                        <textarea id="edit-order-closure-notes" name="הערות סיום" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                     <div class="col-span-1">
                        <label for="edit-order-closure-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סגירה</label>
                        <input type="date" id="edit-order-closure-date" name="תאריך סגירה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2 rounded-b-lg">
                <button onclick="closeEditOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                <button onclick="submitEditOrder()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">שמור שינויים</button>
            </div>
        </div>
    </div>


    <!-- JavaScript code -->
    <script>
        // Global state variables
        let allOperations = []; // Stores all operations, with dates parsed as Date objects
        let charts = {}; // Stores Chart.js instances
        let isLoadingData = false; // Flag to indicate data loading state
        let typingInterval; // Interval for typing effect
        let currentMessageFullText = ''; // Full text for typing effect
        let typingIndex = 0; // Current index for typing effect
        let containerLedger = {}; // Stores detailed history and current status for each container
        let customerNotes = {}; // Stores latest notes for customers for the KPI cards

        // Utility functions
        /**
         * Parses a date string into a Date object. Handles 'YYYY-MM-DD' and 'DD/MM/YYYY'.
         * @param {string} dateStr - The date string to parse.
         * @returns {Date|null} A Date object if successful, otherwise null.
         */
        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            // Handle YYYY-MM-DD format
            if (dateStr.includes('-') && dateStr.split('-').length === 3) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            // Handle DD/MM/YYYY format
            if (dateStr.includes('/') && dateStr.split('/').length === 3) {
                const parts = dateStr.split('/');
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // Assumes DD/MM/YYYY
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        /**
         * Formats a Date object into a 'YYYY-MM-DD' string.
         * @param {Date|null} dateObj - The Date object to format.
         * @returns {string} The formatted date string, or empty string if invalid.
         */
        const formatISODate = (dateObj) => {
            if (!dateObj || isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        };

        /**
         * Calculates the number of days between a given date and today.
         * @param {Date|null} date - The reference Date object.
         * @returns {number} The number of full days passed, or 0 if date is invalid.
         */
        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to start of day
            const opDate = new Date(date);
            opDate.setHours(0, 0, 0, 0); // Normalize opDate to start of day

            const diff = today.getTime() - opDate.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

         /**
         * Calculates the number of days between two dates.
         * @param {Date|null} startDate - The start Date object.
         * @param {Date|null} endDate - The end Date object.
         * @returns {number} The number of full days between the dates, or 0 if dates are invalid.
         */
        const daysBetween = (startDate, endDate) => {
            if (!startDate || isNaN(startDate.getTime()) || !endDate || isNaN(endDate.getTime())) return 0;
            const sDate = new Date(startDate);
            sDate.setHours(0, 0, 0, 0);
            const eDate = new Date(endDate);
            eDate.setHours(0, 0, 0, 0);

            const diff = eDate.getTime() - sDate.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        /**
         * Debounces a function call.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // Global functions for HTML onclick attributes
        /**
         * Shows the specified page (tab) and updates navigation button active state.
         * @param {string} pageId - The ID of the page to show ('dashboard', 'inventory', 'treatment').
         */
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');

            // Hide the 'no overdue' message if not on the treatment page
            if (pageId !== 'treatment') {
                document.getElementById('no-overdue-message').classList.add('hidden');
            }
        };

        /**
         * Attempts to extract an Israeli city name from an address string.
         * @param {string} address - The address string.
         * @returns {string|null} The city name if found, otherwise null.
         */
        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "תל אביב", "ירושלים", "חיפה", "ראשון לציון", "פתח תקווה", "אשדוד", "באר שבע",
                "נתניה", "בני ברק", "חולון", "רמת גן", "רחובות", "אשקלון", "בת ים", "הרצליה",
                "כפר סבא", "חדרה", "בית שמש", "מודיעין-מכבים-רעות", "לוד", "רמלה", "רעננה",
                "נהריה", "קריית גת", "אילת", "עכו", "צפת", "טבריה", "נצרת", "אום אל-פאחם",
                "בני ציון", "אבן יהודה", "אור יהודה", "אור עקיבא", "אריאל", "אשקלון", "באקה אל-גרבייה",
                "גבעתיים", "דימונה", "הוד השרון", "זכרון יעקב", "יבנה", "יהוד-מונוסון", "יוקנעם עילית",
                "כוכב יאיר", "כפר יונה", "כפר קאסם", "כרמיאל", "מגדל העמק", "מכבים", "מעלה אדומים",
                "מצפה רמון", "נהריה", "נס ציונה", "נשר", "עפולה", "ערד", "פרדס חנה-כרכור",
                "קריית אונו", "קריית ביאליק", "קריית ים", "קריית מוצקין", "קריית שמונה",
                "שוהם", "שדרות", "רמת השרון"
            ].sort((a,b) => b.length - a.length); // Sort by length descending for better matching

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        // Predefined WhatsApp messages and city guidelines
        const whatsappMessages = [
            { id: 'new_customer_welcome', text: 'שלום **[שם לקוח]**,\nתודה שבחרת להתחיל שכירות מכולה אצלנו! 👋 לכל פניה, בקשת החלפה או הוצאה של המכולה, אתה מוזמן ליצור קשר.\n\n📞 מספר ווטסאפ להזמנות: **[מספר טלפון חברה]**\n☎️ טלפון מחלקת הזמנות: **[טלפון חברה]**', category: 'כללי', placeholders: ['שם לקוח', 'מספר טלפון חברה', 'טלפון חברה'], emoji: '👋' },
            { id: 'approaching_due_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להזכיר לך כי תקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת בעוד **7 ימים** 🗓️. זה הזמן לנקוט פעולה!\n\nהאם תרצה להאריך את תקופת השכירות, להחליף את המכולה, או להזמין איסוף? ♻️', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏰' },
            { id: 'approaching_due_3_days', text: 'שלום **[שם לקוח]**,\n\nתקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת ממש בקרוב, בעוד **3 ימים** ⚠️. אנא טפל בנושא כדי למנוע חריגות.\n\nאנו לרשותך לכל עזרה! 🙏', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏳' },
            { id: 'overdue_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להודיע לך על חריגה בימי שכירות של המכולה ([**מספר מכולה**]) ב-**[ימים שעברו] ימים** 🚨. נא ליצור קשר עם מחלקת הזמנות **[טלפון חברה]** או להשיב להודעה זו מה תרצה שנבצע (החלפה/הוצאה).', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '❗️' },
            { id: 'overdue_30_days', text: '**התראה חמורה, [שם לקוח]:**\n\nהמכולה ([**מספר מכולה**]) שבשימושך חורגת ב-**[ימים שעברו] ימים**! יש לטפל בנושא בדחיפות כדי למנוע חיובים נוספים וסיבוכים משפטיים. ⚖️\n\n**צור קשר מיידית: [טלפון חברה].**', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '🔴' },
            { id: 'overdue_long', text: '**לכבוד: [שם לקוח]**\n\n**הנדון: חוב בגין שכירות מכולה חורגת**\n\nאנו פונים אליך בהתייחס לחשבונך, הנמצא בחריגה משמעותית של [**ימים שעברו**] ימים עבור מכולה ([**מספר מכולה**]).\n\nבהיעדר הסדרה מיידית, אנו נאלצים לנקוט בצעדים משפטיים לגבייה. אנו קוראים לך ליצור קשר דחוף להסדר: **[טלפון חברה]**.', category: 'משפטי', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '' },
            { id: 'general_inquiry', text: 'שלום **[שם לקוח]**,\n\nאיך אנחנו יכולים לעזור לך היום? 🤔 אם יש לך שאלות, בקשות או תזכורות, אל תהסס לפנות אלינו. אנחנו כאן בשבילך! ✨', category: 'כללי', placeholders: ['שם לקוח'], emoji: '💬' },
            { id: 'payment_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת ידידותית לגבי תשלום חשבונית מספר **[תעודה]** 💰. אנו מודים לך על תשומת הלב המהירה ועל המשך שיתוף הפעולה.', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '💲' },
            { id: 'service_feedback', text: 'שלום **[שם לקוח]**,\n\nאנו מקווים ששירותינו עונים על ציפיותיך. נשמח לקבל משוב על החוויה שלך עם מכולה מספר **[מספר מכולה]** כדי שנוכל להשתפר ולהעניק לך שירות טוב יותר. ⭐', category: 'משוב', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '📝' },
            { id: 'holiday_greetings', text: 'חג שמח, **[שם לקוח]**! 🎉\n\nצוות [שם החברה] מאחל לך ולמשפחתך חג שמח, מלא שלווה, בריאות והמון שמחה! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎁' },
            { id: 'special_offer', text: 'שלום **[שם לקוח]**,\n\nיש לנו חדשות מרגשות! 🎁 מבצע מיוחד למכולות חדשות/נוספות עבורך. אל תחמיץ! לפרטים נוספים, השב להודעה זו או התקשר: **[טלפון חברה]**.', category: 'שיווק', placeholders: ['שם לקוח', 'טלפון חברה'], emoji: '✨' },
            { id: 'follow_up_issue', text: 'שלום **[שם לקוח]**,\n\nאנחנו חוזרים אליך לגבי הנושא שדיווחת עליו בתעודה **[תעודה]** 🛠️. האם הבעיה נפתרה לשביעות רצונך? אם לא, אנא הודע לנו כדי שנוכל להמשיך לטפל.', category: 'תמיכה', placeholders: ['שם לקוח', 'תעודה'], emoji: '✅' },
            { id: 'document_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת לשליחת המסמכים החסרים עבור הזמנה **[תעודה]** 📄. אנא שלח אותם בהקדם כדי שנוכל להשלים את הטיפול בהזמנה.\n\nתודה על שיתוף הפעולה!', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '📌' },
            { id: 'service_confirmation', text: 'שלום **[שם לקוח]**,\n\nהשירות שהוזמן (תעודה **[תעודה]**) אושר ויתבצע ב-**[תאריך סיום צפוי]** ✅. תודה שבחרת בנו ושיהיה יום נפלא!', category: 'אישור', placeholders: ['שם לקוח', 'תעודה', 'תאריך סיום צפוי'], emoji: '👍' },
            { id: 'service_delay', text: 'שלום **[שם לקוח]**,\n\nעקב נסיבות בלתי צפויות, ייתכן שיהיה עיכוב קל בטיפול בהזמנה **[תעודה]** ⏱️. אנו מתנצלים על אי הנוחות ונפעל לפתור זאת במהירות האפשרית.\n\nנודיע לך על כל עדכון! 🔜', category: 'מידע', placeholders: ['שם לקוח', 'תעודה'], emoji: '🚧' },
            { id: 'location_update_request', text: 'שלום **[שם לקוח]**,\n\nכדי שנוכל לתאם את השירות בצורה הטובה ביותר, אנא וודא שמיקום המכולה ([**מספר מכולה**]) מעודכן ומדויק 📍. זה חשוב להגעה יעילה!', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🗺️' },
            { id: 'happy_birthday', text: 'יום הולדת שמח, **[שם לקוח]**! 🎉🎂\n\nצוות [שם החברה] מאחל לך יום מלא בשמחה, בריאות, הגשמה והרבה רגעים מתוקים! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎈' },
            { id: 'review_invitation', text: 'שלום **[שם לקוח]**,\n\nנהנית מהשירות שלנו? ✨ נשמח אם תוכל להקדיש רגע ולכתוב לנו ביקורת קצרה כאן: [**לינק לביקורת**]. תודה מראש על עזרתך להשתפר! 🙏', category: 'משוב', placeholders: ['שם לקוח', 'לינק לביקורת'], emoji: '🌟' },
            { id: 'tech_support_contact', text: 'שלום **[שם לקוח]**,\n\nלכל בעיה טכנית או תפעולית עם המכולה ([**מספר מכולה**]), מחלקת התמיכה שלנו זמינה עבורך 🧑‍🔧.\n\n**צור קשר: [טלפון חברה].**', category: 'תמיכה', placeholders: ['שם לקוח', 'מספר מכולה', 'טלפון חברה'], emoji: '🔧' },
            { id: 'general_thanks', text: 'תודה רבה לך, **[שם לקוח]**, על שיתוף הפעולה והאמון ב[שם החברה]! 🙏\n\nאנו מעריכים את בחירתך בנו ומקווים להמשיך לשרת אותך נאמנה. 💖', category: 'כללי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '😊' },
            { id: 'multi_container_reminder', text: 'שלום **[שם לקוח]**,\n\nשמנו לב שברשותך **מספר מכולות פעילות** 🏗️. אנו כאן כדי לוודא שכל הצרכים שלך מסופקים.\n\nהאם יש משהו שנוכל לעזור בו בנוגע למכולות שלך? אל תהסס לפנות! 🤝', category: 'תזכורות', placeholders: ['שם לקוח'], emoji: '📦' },
            { id: 'container_mismatch', text: 'שלום **[שם לקוח]**,\n\n**התראה:** מכולה מספר **[מספר מכולה]** ירדה אצל לקוח **[שם לקוח]** בתעודה **[תעודה]** לפני **[ימים שעברו]** ימים וטרם הוחזרה/נסגרה! 🚨', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'תעודה', 'ימים שעברו'], emoji: '🚨' },
            { id: 'pending_order_reminder', text: 'שלום **[שם לקוח]**,\n\n**בטיפול:** הזמנה **[תעודה]** של לקוח **[שם לקוח]** מסומנת "בטיפול" ולא עודכנה **[ימים שעברו]** ימים. דורש בדיקה! ⚠️', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה', 'ימים שעברו'], emoji: '⚠️' }
        ];

        // City-specific guidelines for WhatsApp messages
        const cityGuidelines = {
            'הרצליה': {
                id: 'herzliya_permit',
                text: 'הנחיה חשובה לתושבי הרצליה:\nכדי להציב מכולת פסולת בניין ברחוב בהרצליה, יש להגיש בקשה מראש לאגף הפיקוח העירוני. הבקשה כרוכה בתשלום אגרה ונדרש אישור בכתב. מומלץ לוודא את כל הפרטים באתר העירייה או בטלפון.\n\nקישור למידע: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '📝'
            },
            'רעננה': {
                id: 'raanana_permit',
                text: 'הנחיה חשובה לתושבי רעננה:\nברעננה, חל איסור מוחלט להשאיר מכולות פסולת בניין במקום ציבורי (ברחוב) בסופי שבוע ובחגים. יש לדאוג להזמין פינוי לפני כניסת השבת/חג. קנסות יינתנו למפרים. אנא הקפד על הנחיות אלו.\n\nמידע נוסף: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🚫'
            },
            'תל אביב': {
                id: 'telaviv_permit',
                text: 'הנחיה חשובה לתושבי תל אביב:\nבתל אביב, הצבת מכולות פסולת ברחוב מחייבת קבלת היתר מהעירייה. יש להגיש בקשה מקוונת ולצרף את כל המסמכים הנדרשים. שימו לב להנחיות המדויקות לגבי סימון המכולה ומשך ההצבה.\n\nלמידע והגשת בקשה: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🏗️' // Changed from original to a more fitting emoji
            }
        };

        // Company information for placeholders
        const companyInfo = {
            phoneNumber: '972508860896', // Example WhatsApp number
            companyPhone: '097602010', // Example company phone
            companyName: 'ח.סבן' // Example company name
        };

        // Google Apps Script Web App URL for data interaction
        // IMPORTANT: Replace this with your actual Google Apps Script Web App URL.
        // The Apps Script should be configured to handle 'getData', 'addOrder', 'updateOrder', 'deleteOrder', and 'updateCustomerNote' actions.
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk03pVBEBzHIWkFj1OzM0T5buH5cfNjD8njGza8AoKWulO1sPtiBrOpUZZItOd_gi/exec'; // Updated URL

        /**
         * Merges live data fetched from Google Sheet.
         * Converts date strings from live data to Date objects.
         * @param {Array<Object>} liveOps - Array of live operation objects from Google Sheet.
         * @returns {Array<Object>} Processed and sorted array of operations.
         */
        const mergeData = (liveOps) => {
            return liveOps.map(op => {
                // Apply the user's mapping for live data from sheet and parse dates
                let normalizedActionType = op['סוג פעולה'] ? op['סוג פעולה'].trim() : '';
                if (normalizedActionType === 'הורדה') {
                    normalizedActionType = 'הצבה';
                } else if (normalizedActionType === 'העלאה') {
                    normalizedActionType = 'הוצאה';
                }
                op['סוג פעולה'] = normalizedActionType; // Update the operation object

                // Parse dates into Date objects
                op['תאריך הזמנה'] = formatDate(op['תאריך הזמנה']);
                op['תאריך סיום צפוי'] = formatDate(op['תאריך סיום צפוי']);
                op['תאריך סגירה'] = formatDate(op['תאריך סגירה']);

                // Calculate derived fields (daysInRental, isOverdue)
                op['ימים שעברו'] = op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : 0;
                op['isOverdue'] = op['סטטוס'] !== 'סגור' && op['ימים שעברו'] >= 10;

                return op;
            }).sort((a, b) => {
                const dateA = a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0;
                const dateB = b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0;
                return dateB - dateA; // Sort descending by date
            });
        };


        /**
         * Builds a comprehensive ledger for each container, determining its current status
         * and full historical movement.
         */
        const buildContainerLedger = () => {
            containerLedger = {}; // Reset for fresh build

            // 1. First pass: Populate raw history for each container
            // Sort all operations by date (ascending) to correctly build history
            const sortedOperations = allOperations.slice().sort((a, b) => {
                const dateA = a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0;
                const dateB = b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0;
                return dateA - dateB;
            });

            sortedOperations.forEach(op => {
                const docId = String(op['תעודה']);
                const customerName = op['שם לקוח'];
                const address = op['כתובת'];
                const opDate = op['תאריך הזמנה'];
                const actionType = op['סוג פעולה'];

                // Split by comma for multiple containers
                const containersDropped = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersLifted = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

                containersDropped.forEach(containerNum => {
                    if (!containerLedger[containerNum]) {
                        containerLedger[containerNum] = { history: [], currentStatus: 'unknown', currentCustomer: null, currentAddress: null, lastDroppedDate: null, lastLiftedDate: null, nextDropDate: null, latestOperationDocId: null };
                    }
                    containerLedger[containerNum].history.push({
                        type: 'dropped',
                        customer: customerName,
                        date: opDate,
                        docId: docId,
                        address: address,
                        actionType: actionType // Store action type for history display
                    });
                });

                containersLifted.forEach(containerNum => {
                    if (!containerLedger[containerNum]) {
                        containerLedger[containerNum] = { history: [], currentStatus: 'unknown', currentCustomer: null, currentAddress: null, lastDroppedDate: null, lastLiftedDate: null, nextDropDate: null, latestOperationDocId: null };
                    }
                    containerLedger[containerNum].history.push({
                        type: 'lifted',
                        customer: customerName, // Customer it was lifted FROM
                        date: opDate,
                        docId: docId,
                        address: address,
                        actionType: actionType // Store action type for history display
                    });
                });
            });

            // 2. Second pass: Determine current status and enrich container info
            for (const containerNum in containerLedger) {
                const container = containerLedger[containerNum];
                container.history.sort((a, b) => a.date.getTime() - b.date.getTime()); // Ensure history is sorted chronologically

                const lastEvent = container.history[container.history.length - 1];

                if (lastEvent) {
                    container.latestOperationDocId = lastEvent.docId; // Keep track of the operation that caused the current state

                    if (lastEvent.type === 'dropped') {
                        container.currentStatus = 'in_use';
                        container.currentCustomer = lastEvent.customer;
                        container.currentAddress = lastEvent.address;
                        container.lastDroppedDate = lastEvent.date;
                        container.lastLiftedDate = null; // Reset if dropped
                        container.nextDropDate = null; // Reset if dropped (it's currently in use)
                        container.nextDropCustomer = null;
                        container.nextDropAddress = null;
                    } else if (lastEvent.type === 'lifted') {
                        container.lastLiftedDate = lastEvent.date;
                        container.lastDroppedDate = null; // Reset if lifted

                        // Check for a future 'dropped' event after the last 'lifted' event
                        const indexOfLastLifted = container.history.indexOf(lastEvent);
                        const futureDrop = container.history.slice(indexOfLastLifted + 1).find(event => event.type === 'dropped');

                        if (futureDrop) {
                            container.currentStatus = 'in_transit'; // lifted but will be dropped elsewhere soon
                            container.currentCustomer = lastEvent.customer; // Last customer it was with
                            container.currentAddress = lastEvent.address; // Last address it was at
                            container.nextDropDate = futureDrop.date;
                            container.nextDropCustomer = futureDrop.customer;
                            container.nextDropAddress = futureDrop.address;
                        } else {
                            container.currentStatus = 'available'; // lifted and no future drops
                            container.currentCustomer = null; // No current customer
                            container.currentAddress = null;
                            container.nextDropDate = null;
                            container.nextDropCustomer = null;
                            container.nextDropAddress = null;
                        }
                    }
                } else {
                    container.currentStatus = 'unknown'; // Fallback if no events found for container (shouldn't happen with current data)
                }
            }
            console.log("Built container ledger:", containerLedger);
        };


        /**
         * Fetches data from the Google Sheet with exponential backoff for retries.
         * @async
         */
        const fetchDataFromGoogleSheet = async () => {
            isLoadingData = true;
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader

            let liveData = [];
            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=getData`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();

                    if (result.success && Array.isArray(result.data)) {
                        liveData = result.data;
                        console.log("Fetched live data from Google Sheet:", liveData);
                        break; // Exit retry loop on success
                    } else {
                        console.error("Received data is not an array or success is false:", result);
                        showStatusMessage("שגיאה: הנתונים שהתקבלו מגיליון גוגל אינם בפורמט צפוי או שהייתה שגיאה בשרת: " + (result.message || 'אין הודעה ספציפית'), 'error');
                        // No break here, allow retry for server errors potentially
                    }
                } catch (error) {
                    console.error("Error fetching data from Google Sheet:", error);
                    showStatusMessage("שגיאה בטעינת הנתונים מגיליון גוגל: " + error.message, 'error');
                }

                if (retries < maxRetries - 1) { // Don't delay after the last retry attempt
                    const delay = baseDelay * Math.pow(2, retries);
                    // console.warn(`API rate limit hit or network error. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                retries++;
            }

            // Process live data (no merge with static data needed anymore)
            allOperations = mergeData(liveData);
            console.log("Processed operations data:", allOperations);

            // Build the container ledger after all operations are processed
            buildContainerLedger();

            renderDashboard();
            renderInventory();
            renderTreatmentBoard();
            renderTopOverdueCustomers(); // Render new KPI cards

            isLoadingData = false;
            document.getElementById('global-loader').classList.add('hidden'); // Hide loader
        };

        /**
         * Adds a new order to the Google Sheet via Apps Script.
         * @param {Object} orderData - The order data to send.
         * @async
         */
        const addNewOrderToSheet = async (orderData) => {
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=addOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('ההזמנה נוספה בהצלחה לגיליון!', 'success');
                    await fetchDataFromGoogleSheet(); // Re-fetch all data to ensure local state is updated
                } else {
                    showStatusMessage('שגיאה בהוספת ההזמנה: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding order to sheet:', error);
                showStatusMessage('שגיאה בתקשורת עם השרת בעת הוספת הזמנה.', 'error');
            } finally {
                document.getElementById('global-loader').classList.add('hidden'); // Hide loader
            }
        };

        /**
         * Updates an existing order in the Google Sheet via Apps Script.
         * @param {string} originalDocId - The original document ID of the order to update.
         * @param {Object} updatedOrderData - The updated order data.
         * @async
         */
        const updateOrderInSheet = async (originalDocId, updatedOrderData) => {
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=updateOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ originalDocId, updatedOrderData })
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('ההזמנה עודכנה בהצלחה בגיליון!', 'success');
                    await fetchDataFromGoogleSheet(); // Re-fetch all data to ensure local state is updated
                } else {
                    showStatusMessage('שגיאה בעדכון ההזמנה: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error updating order in sheet:', error);
                showStatusMessage('שגיאה בתקשורת עם השרת בעת עדכון הזמנה.', 'error');
            } finally {
                document.getElementById('global-loader').classList.add('hidden'); // Hide loader
            }
        };

        /**
         * Deletes an order from the Google Sheet via Apps Script.
         * @param {string} docId - The document ID of the order to delete.
         * @async
         */
        const deleteOrderFromSheet = async (docId) => {
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=deleteOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ docId })
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('ההזמנה נמחקה בהצלחה מהגיליון!', 'success');
                    await fetchDataFromGoogleSheet(); // Re-fetch all data to ensure local state is updated
                } else {
                    showStatusMessage('שגיאה במחיקת ההזמנה: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting order from sheet:', error);
                showStatusMessage('שגיאה בתקשורת עם השרת בעת מחיקת הזמנה.', 'error');
            } finally {
                document.getElementById('global-loader').classList.add('hidden'); // Hide loader
            }
        };

        /**
         * Shows a confirmation dialog before deleting an order.
         * @param {string} docId - The document ID of the order to delete.
         */
        const confirmAndDeleteOrder = (docId) => {
            if (window.confirm(`האם אתה בטוח שברצונך למחוק את הזמנה מספר ${docId}? פעולה זו בלתי הפיכה.`)) {
                deleteOrderFromSheet(docId);
            }
        };

        /**
         * Updates a customer's note in the Google Sheet via Apps Script.
         * @param {string} customerName - The name of the customer.
         * @param {string} note - The note to update/add.
         * @async
         */
        const updateCustomerNoteInSheet = async (customerName, note) => {
            try {
                // No loader needed for subtle note updates
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=updateCustomerNote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ customerName, note })
                });
                const result = await response.json();
                if (result.success) {
                    console.log(`Note for ${customerName} updated successfully.`);
                    customerNotes[customerName] = note; // Update local cache
                    // No status message needed for this subtle update
                } else {
                    console.error('Error updating customer note:', result.message);
                    // No status message needed for this subtle update
                }
            } catch (error) {
                console.error('Error communicating with server for note update:', error);
            }
        };

        // Debounced version of updateCustomerNoteInSheet
        const debouncedUpdateCustomerNote = debounce(updateCustomerNoteInSheet, 500);

        /**
         * Displays a status message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' to determine styling.
         */
        const showStatusMessage = (message, type) => {
            const messageContainer = document.getElementById('status-message-container');
            if (!messageContainer) {
                // If container doesn't exist, create it dynamically
                const div = document.createElement('div');
                div.id = 'status-message-container';
                div.className = 'fixed top-4 right-4 z-[1000] p-4 rounded-lg shadow-lg text-white text-right transition-transform transform translate-x-full opacity-0';
                document.body.appendChild(div);
            }

            const currentMessageContainer = document.getElementById('status-message-container');
            currentMessageContainer.textContent = message;
            currentMessageContainer.classList.remove('bg-green-500', 'bg-red-500', 'translate-x-full', 'opacity-0');

            if (type === 'success') {
                currentMessageContainer.classList.add('bg-green-500');
            } else if (type === 'error') {
                currentMessageContainer.classList.add('bg-red-500');
            }

            // Animate in
            setTimeout(() => {
                currentMessageContainer.classList.add('translate-x-0', 'opacity-100');
            }, 50);

            // Animate out after 5 seconds
            setTimeout(() => {
                currentMessageContainer.classList.remove('translate-x-0', 'opacity-100');
                currentMessageContainer.classList.add('translate-x-full', 'opacity-0');
            }, 5000);
        };

        /**
         * Opens the new order modal and initializes form fields.
         */
        const openNewOrderModal = () => {
            document.getElementById('new-order-form').reset();
            // Set default date to today
            const today = formatISODate(new Date());
            document.getElementById('new-order-date').value = today;
            document.getElementById('new-order-expected-end-date').value = ''; // Clear expected end date
            document.getElementById('new-order-status').value = 'פתוח'; // Default status
            document.getElementById('docid-error').classList.add('hidden');
            document.getElementById('container-dropped-error').classList.add('hidden');
            document.getElementById('container-lifted-error').classList.add('hidden');
            document.getElementById('new-order-modal').classList.remove('hidden');
            document.getElementById('new-order-modal').classList.add('flex');
        };

        /**
         * Closes the new order modal.
         */
        const closeNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.add('hidden');
            document.getElementById('new-order-modal').classList.remove('flex');
        };

        /**
         * Handles submission of the new order form.
         * @async
         */
        const submitNewOrder = async () => {
            const form = document.getElementById('new-order-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newDocId = document.getElementById('new-order-docid').value.trim();

            // Check for duplicate docId
            const isDuplicateDocId = allOperations.some(op => String(op['תעודה']) === newDocId);
            if (isDuplicateDocId) {
                document.getElementById('docid-error').textContent = 'מספר תעודה זה כבר קיים. אנא בחר מספר אחר.';
                document.getElementById('docid-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('docid-error').classList.add('hidden');
            }

            const actionType = document.getElementById('new-order-action-type').value;
            const containerDropped = document.getElementById('new-order-container-dropped').value.trim();
            const containerLifted = document.getElementById('new-order-container-lifted').value.trim();

            // Validate container numbers based on action type
            let isValid = true;
            if (actionType === 'הצבה' && !containerDropped) {
                document.getElementById('container-dropped-error').textContent = 'בפעולת "הצבה" חובה לציין מספר מכולה יורדת.';
                document.getElementById('container-dropped-error').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('container-dropped-error').classList.add('hidden');
            }

            if ((actionType === 'הוצאה' || actionType === 'פינוי במקום') && !containerLifted) {
                document.getElementById('container-lifted-error').textContent = 'בפעולת "הוצאה" או "פינוי במקום" חובה לציין מספר מכולה עולה.';
                document.getElementById('container-lifted-error').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('container-lifted-error').classList.add('hidden');
            }

            if (actionType === 'החלפה' && (!containerDropped || !containerLifted)) {
                document.getElementById('container-dropped-error').textContent = 'בפעולת "החלפה" חובה לציין מכולה יורדת ועולה.';
                document.getElementById('container-dropped-error').classList.remove('hidden');
                document.getElementById('container-lifted-error').classList.remove('hidden');
                isValid = false;
            } else if (actionType === 'החלפה') { // If both filled, hide errors
                document.getElementById('container-dropped-error').classList.add('hidden');
                document.getElementById('container-lifted-error').classList.add('hidden');
            }

            if (!isValid) return;

            // Prepare data in the structure expected by the Google Sheet (matching headers)
            const orderData = {
                'תאריך הזמנה': document.getElementById('new-order-date').value,
                'תעודה': newDocId,
                'שם סוכן': document.getElementById('new-order-agent').value || '',
                'שם לקוח': document.getElementById('new-order-customer-name').value,
                'כתובת': document.getElementById('new-order-address').value || '',
                'סוג פעולה': actionType,
                'ימים שעברו': '', // Will be calculated by Apps Script
                'מספר מכולה ירדה': containerDropped,
                'מספר מכולה עלתה': containerLifted,
                'מספרי מכולות': `${containerDropped}${containerDropped && containerLifted ? ',' : ''}${containerLifted}`, // Combined field
                'סטטוס': document.getElementById('new-order-status').value,
                'הערות': document.getElementById('new-order-notes').value || '',
                'תאריך סיום צפוי': document.getElementById('new-order-expected-end-date').value || '',
                'הערות סיום': '',
                'תאריך סגירה': document.getElementById('new-order-status').value === 'סגור' ? document.getElementById('new-order-date').value : '',
                'ימים שעברו (עלתה)': '', // Will be calculated by Apps Script
                'טלפון לקוח': document.getElementById('new-order-phone').value || '',
            };

            await addNewOrderToSheet(orderData);
            closeNewOrderModal();
        };

        /**
         * Opens the edit order modal and populates it with existing order data.
         * @param {string} docId - The document ID of the order to edit.
         */
        const openEditOrderModal = (docId) => {
            const orderToEdit = allOperations.find(op => String(op['תעודה']) === docId);
            if (!orderToEdit) {
                showStatusMessage('הזמנה לא נמצאה לעריכה.', 'error');
                return;
            }

            document.getElementById('edit-order-original-docid').value = docId;
            document.getElementById('edit-order-date').value = formatISODate(orderToEdit['תאריך הזמנה']);
            document.getElementById('edit-order-docid').value = orderToEdit['תעודה'];
            document.getElementById('edit-order-agent').value = orderToEdit['שם סוכן'] || '';
            document.getElementById('edit-order-customer-name').value = orderToEdit['שם לקוח'] || '';
            document.getElementById('edit-order-address').value = orderToEdit['כתובת'] || '';
            document.getElementById('edit-order-action-type').value = orderToEdit['סוג פעולה'] || '';
            document.getElementById('edit-order-status').value = orderToEdit['סטטוס'] || 'פתוח';
            document.getElementById('edit-order-container-dropped').value = orderToEdit['מספר מכולה ירדה'] || '';
            document.getElementById('edit-order-container-lifted').value = orderToEdit['מספר מכולה עלתה'] || '';
            document.getElementById('edit-order-expected-end-date').value = formatISODate(orderToEdit['תאריך סיום צפוי']);
            document.getElementById('edit-order-phone').value = orderToEdit['טלפון לקוח'] || '';
            document.getElementById('edit-order-notes').value = orderToEdit['הערות'] || '';
            document.getElementById('edit-order-closure-notes').value = orderToEdit['הערות סיום'] || '';
            document.getElementById('edit-order-closure-date').value = formatISODate(orderToEdit['תאריך סגירה']);

            document.getElementById('edit-docid-error').classList.add('hidden');
            document.getElementById('edit-container-dropped-error').classList.add('hidden');
            document.getElementById('edit-container-lifted-error').classList.add('hidden');

            document.getElementById('edit-order-modal').classList.remove('hidden');
            document.getElementById('edit-order-modal').classList.add('flex');
        };

        /**
         * Closes the edit order modal.
         */
        const closeEditOrderModal = () => {
            document.getElementById('edit-order-modal').classList.add('hidden');
            document.getElementById('edit-order-modal').classList.remove('flex');
        };

        /**
         * Handles submission of the edited order form.
         * @async
         */
        const submitEditOrder = async () => {
            const form = document.getElementById('edit-order-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const originalDocId = document.getElementById('edit-order-original-docid').value;
            const newDocId = document.getElementById('edit-order-docid').value.trim();

            // Check for duplicate docId if it's changed and exists for another record
            if (newDocId !== originalDocId && allOperations.some(op => String(op['תעודה']) === newDocId)) {
                document.getElementById('edit-docid-error').textContent = 'מספר תעודה זה כבר קיים עבור הזמנה אחרת. אנא בחר מספר אחר.';
                document.getElementById('edit-docid-error').classList.remove('hidden');
                return;
            } else {
                document.getElementById('edit-docid-error').classList.add('hidden');
            }

            const actionType = document.getElementById('edit-order-action-type').value;
            const containerDropped = document.getElementById('edit-order-container-dropped').value.trim();
            const containerLifted = document.getElementById('edit-order-container-lifted').value.trim();

            // Validate container numbers based on action type for edit modal
            let isValid = true;
            if (actionType === 'הצבה' && !containerDropped) {
                document.getElementById('edit-container-dropped-error').textContent = 'בפעולת "הצבה" חובה לציין מספר מכולה יורדת.';
                document.getElementById('edit-container-dropped-error').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('edit-container-dropped-error').classList.add('hidden');
            }

            if ((actionType === 'הוצאה' || actionType === 'פינוי במקום') && !containerLifted) {
                document.getElementById('edit-container-lifted-error').textContent = 'בפעולת "הוצאה" או "פינוי במקום" חובה לציין מספר מכולה עולה.';
                document.getElementById('edit-container-lifted-error').classList.remove('hidden');
                isValid = false;
            } else {
                document.getElementById('edit-container-lifted-error').classList.add('hidden');
            }

            if (actionType === 'החלפה' && (!containerDropped || !containerLifted)) {
                document.getElementById('edit-container-dropped-error').textContent = 'בפעולת "החלפה" חובה לציין מכולה יורדת ועולה.';
                document.getElementById('edit-container-dropped-error').classList.remove('hidden');
                document.getElementById('edit-container-lifted-error').classList.remove('hidden');
                isValid = false;
            } else if (actionType === 'החלפה') { // If both filled, hide errors
                document.getElementById('edit-container-dropped-error').classList.add('hidden');
                document.getElementById('edit-container-lifted-error').classList.add('hidden');
            }

            if (!isValid) return;

            const updatedOrderData = {
                'תאריך הזמנה': document.getElementById('edit-order-date').value,
                'תעודה': newDocId,
                'שם סוכן': document.getElementById('edit-order-agent').value || '',
                'שם לקוח': document.getElementById('edit-order-customer-name').value,
                'כתובת': document.getElementById('edit-order-address').value || '',
                'סוג פעולה': actionType,
                'מספר מכולה ירדה': containerDropped,
                'מספר מכולה עלתה': containerLifted,
                'מספרי מכולות': `${containerDropped}${containerDropped && containerLifted ? ',' : ''}${containerLifted}`, // Combined field
                'סטטוס': document.getElementById('edit-order-status').value,
                'הערות': document.getElementById('edit-order-notes').value || '',
                'תאריך סיום צפוי': document.getElementById('edit-order-expected-end-date').value || '',
                'הערות סיום': document.getElementById('edit-order-closure-notes').value || '',
                'תאריך סגירה': document.getElementById('edit-order-status').value === 'סגור' ? document.getElementById('edit-order-closure-date').value : '',
                'טלפון לקוח': document.getElementById('edit-order-phone').value || '',
            };

            await updateOrderInSheet(originalDocId, updatedOrderData);
            closeEditOrderModal();
        };

        /**
         * Opens the WhatsApp modal and pre-fills phone number and message based on the customer/operation.
         * @param {string} customerName - The name of the customer.
         * @param {string} docId - The document ID related to the operation.
         * @param {string} phoneNumber - The customer's phone number.
         * @param {string} address - The customer's address (for city guidelines).
         * @param {string} containerNum - Optional: The container number related to the message.
         */
        const openWhatsAppModal = (customerName, docId, phoneNumber, address, containerNum = '') => {
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageTextarea = document.getElementById('whatsapp-message-textarea');
            const whatsappDocId = document.getElementById('whatsapp-doc-id');
            const whatsappCustomerId = document.getElementById('whatsapp-customer-id');

            phoneInput.value = phoneNumber || '';
            messageTextarea.value = ''; // Clear custom message area
            whatsappDocId.value = docId;
            whatsappCustomerId.value = customerName; // Store customer name for note updates

            // Populate message options
            populateMessageOptions(customerName, docId, containerNum, address);

            // Display typing effect for chosen message
            document.getElementById('typing-effect-display').textContent = '';
            typingIndex = 0;
            currentMessageFullText = '';

            // Show WhatsApp modal
            document.getElementById('whatsapp-modal').classList.remove('hidden');
            document.getElementById('whatsapp-modal').classList.add('flex');
        };


        /**
         * Populates the WhatsApp message options list.
         * @param {string} customerName - The name of the customer.
         * @param {string} docId - The document ID related to the operation.
         * @param {string} containerNum - Optional: The container number related to the message.
         * @param {string} address - The customer's address (for city guidelines).
         */
        const populateMessageOptions = (customerName, docId, containerNum, address) => {
            const messageListDiv = document.getElementById('message-options-list');
            messageListDiv.innerHTML = ''; // Clear previous options

            // Filter out specific messages for calculation:
            // For overdue, find the actual days overdue.
            const operation = allOperations.find(op => String(op['תעודה']) === docId);
            const daysOverdue = operation && operation.isOverdue ? daysSince(operation['תאריך הזמנה']) : 0;
            const expectedEndDate = operation ? formatISODate(operation['תאריך סיום צפוי']) : '';

            // Determine relevant city guideline
            const city = getCityFromAddress(address);
            let relevantCityGuideline = null;
            if (city && cityGuidelines[city]) {
                relevantCityGuideline = cityGuidelines[city];
            }

            // Create a temporary object to hold all possible replacements
            const replacements = {
                '[שם לקוח]': customerName,
                '[מספר טלפון חברה]': companyInfo.phoneNumber,
                '[טלפון חברה]': companyInfo.companyPhone,
                '[שם החברה]': companyInfo.companyName,
                '[מספר מכולה]': containerNum || 'לא צוין',
                '[ימים שעברו]': daysOverdue.toString(),
                '[תעודה]': docId,
                '[לינק לביקורת]': 'https://example.com/review', // Placeholder
                '[תאריך סיום צפוי]': expectedEndDate || 'לא צוין'
            };

            // Combine all messages and potentially add the relevant city guideline
            let allAvailableMessages = [...whatsappMessages];
            if (relevantCityGuideline) {
                // Add the city guideline to the top
                allAvailableMessages.unshift(relevantCityGuideline);
            }

            allAvailableMessages.forEach(msg => {
                let displayMsg = msg.text;
                // Replace placeholders in the display message
                for (const placeholder in replacements) {
                    displayMsg = displayMsg.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacements[placeholder]);
                }

                const button = document.createElement('button');
                button.className = 'block w-full text-right p-3 hover:bg-violet-50 text-gray-800 border-b border-gray-100 last:border-b-0 transition-colors rounded-md';
                button.innerHTML = `<span class="text-sm text-gray-500">${msg.category}</span><br>${msg.emoji ? msg.emoji + ' ' : ''}<strong>${displayMsg.split('\n')[0]}</strong><p class="text-sm text-gray-600 line-clamp-2">${displayMsg.split('\n').slice(1).join('\n')}</p>`;
                button.onclick = () => selectWhatsAppMessage(msg.id, replacements);
                messageListDiv.appendChild(button);
            });
        };

        /**
         * Selects a predefined WhatsApp message and starts the typing effect.
         * @param {string} messageId - The ID of the selected message.
         * @param {Object} replacements - Object with placeholder replacements.
         */
        const selectWhatsAppMessage = (messageId, replacements) => {
            const selectedMessageObj = whatsappMessages.find(msg => msg.id === messageId) || cityGuidelines[messageId];
            if (selectedMessageObj) {
                let fullText = selectedMessageObj.text;
                for (const placeholder in replacements) {
                    fullText = fullText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacements[placeholder]);
                }
                currentMessageFullText = fullText;
                document.getElementById('whatsapp-message-textarea').value = fullText; // Set full text immediately for copy/send
                startTypingEffect(currentMessageFullText);
                toggleMessageOptions(); // Close options after selection
            }
        };

        /**
         * Starts the typing effect for the WhatsApp message display.
         * @param {string} text - The text to type.
         */
        const startTypingEffect = (text) => {
            clearInterval(typingInterval);
            typingIndex = 0;
            const displayElement = document.getElementById('typing-effect-display');
            displayElement.textContent = ''; // Clear previous text
            displayElement.nextElementSibling.classList.remove('hidden'); // Show cursor

            typingInterval = setInterval(() => {
                if (typingIndex < text.length) {
                    displayElement.textContent += text.charAt(typingIndex);
                    typingIndex++;
                    displayElement.scrollTop = displayElement.scrollHeight; // Scroll to bottom
                } else {
                    clearInterval(typingInterval);
                    displayElement.nextElementSibling.classList.add('hidden'); // Hide cursor
                }
            }, 30); // Adjust typing speed here
        };

        /**
         * Toggles the visibility of the WhatsApp message options container.
         */
        const toggleMessageOptions = () => {
            const container = document.getElementById('whatsapp-message-options-container');
            const icon = document.getElementById('message-options-toggle-icon');
            container.classList.toggle('hidden');
            icon.classList.toggle('rotate-180'); // Rotate arrow icon
        };

        /**
         * Filters the WhatsApp message options based on user input.
         */
        const filterMessageOptions = () => {
            const input = document.getElementById('message-filter-input').value.toLowerCase();
            const messageButtons = document.querySelectorAll('#message-options-list button');

            messageButtons.forEach(button => {
                const text = button.textContent.toLowerCase();
                if (text.includes(input)) {
                    button.style.display = 'block';
                } else {
                    button.style.display = 'none';
                }
            });
        };

        /**
         * Sends a WhatsApp message using the WhatsApp Web API.
         */
        const sendWhatsAppMessage = () => {
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageTextarea = document.getElementById('whatsapp-message-textarea');
            const phoneError = document.getElementById('phone-error');
            const whatsappDocId = document.getElementById('whatsapp-doc-id').value;
            const whatsappCustomerId = document.getElementById('whatsapp-customer-id').value; // Get customer ID for note

            let phoneNumber = phoneInput.value.trim();
            const message = messageTextarea.value.trim();

            // Basic validation for Israeli phone numbers (972 followed by 9 digits)
            if (!/^9725\d{8}$/.test(phoneNumber)) {
                phoneError.classList.remove('hidden');
                return;
            } else {
                phoneError.classList.add('hidden');
            }

            // Remove leading '972' if present for the WhatsApp API which prefers without it for direct links sometimes,
            // but for full international format, it should be present.
            // If the number is already just 10 digits and starts with 05, then convert.
            if (phoneNumber.startsWith('05') && phoneNumber.length === 10) {
                phoneNumber = `972${phoneNumber.substring(1)}`;
            }


            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Add a note to the customer's record that a WhatsApp message was sent.
            // This is a simple append for demonstration. You might want more sophisticated logging.
            const existingNote = customerNotes[whatsappCustomerId] || '';
            const newNote = `${existingNote}${existingNote ? '\n' : ''}[${new Date().toLocaleDateString('he-IL')}] נשלחה הודעת ווטסאפ לתעודה ${whatsappDocId}.`;
            debouncedUpdateCustomerNote(whatsappCustomerId, newNote); // Use debounced update

            closeModalWhatsApp();
        };

        /**
         * Closes the WhatsApp modal.
         */
        const closeModalWhatsApp = () => {
            document.getElementById('whatsapp-modal').classList.add('hidden');
            document.getElementById('whatsapp-modal').classList.remove('flex');
            clearInterval(typingInterval); // Clear typing effect interval
            document.getElementById('message-filter-input').value = ''; // Clear filter
            document.getElementById('message-options-toggle-icon').classList.remove('rotate-180'); // Reset icon
            document.getElementById('whatsapp-message-options-container').classList.add('hidden'); // Hide options
        };

        /**
         * Opens the unified history modal for a customer or container.
         * @param {string} type - 'customer' or 'container'.
         * @param {string} identifier - The name of the customer or the container number.
         */
        const openHistoryModal = (type, identifier) => {
            const modalTitle = document.getElementById('modal-history-title');
            const modalCustomerSpecificDetails = document.getElementById('modal-customer-specific-details');
            const modalCustomerSummary = document.getElementById('modal-customer-summary');
            const modalCustomerContainers = document.getElementById('modal-customer-containers');
            const customerContainerList = document.getElementById('customer-container-list');
            const historyTableTitle = document.getElementById('history-table-title');
            const historyTableBody = document.getElementById('modal-customer-history-table');
            const historyTableHeaderRow = document.getElementById('history-table-header-row');

            historyTableBody.innerHTML = ''; // Clear previous data
            historyTableHeaderRow.innerHTML = ''; // Clear previous headers
            modalCustomerSpecificDetails.classList.add('hidden'); // Hide by default

            let filteredOperations = [];

            if (type === 'customer') {
                modalTitle.textContent = `היסטוריית פעולות עבור לקוח: ${identifier}`;
                historyTableTitle.textContent = 'היסטוריית פעולות הלקוח';
                modalCustomerSpecificDetails.classList.remove('hidden');

                filteredOperations = allOperations.filter(op => op['שם לקוח'] === identifier);

                // Populate customer summary (active containers, total operations, overdue)
                const customerActiveContainers = filteredOperations.filter(op => op['סטטוס'] === 'פתוח' && ['הצבה', 'החלפה'].includes(op['סוג פעולה'])).length;
                const customerTotalOperations = filteredOperations.length;
                const customerOverdueCount = filteredOperations.filter(op => op.isOverdue).length;

                modalCustomerSummary.innerHTML = `
                    <div class="text-center">
                        <p class="text-sm">מכולות פעילות</p>
                        <p class="text-2xl font-bold">${customerActiveContainers}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm">סה"כ פעולות</p>
                        <p class="text-2xl font-bold">${customerTotalOperations}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm">חריגות</p>
                        <p class="text-2xl font-bold ${customerOverdueCount > 0 ? 'text-red-600' : 'text-green-600'}">${customerOverdueCount}</p>
                    </div>
                `;

                // Populate containers associated with the customer
                const uniqueContainers = new Set();
                filteredOperations.forEach(op => {
                    const dropped = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                    const lifted = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                    [...dropped, ...lifted].forEach(c => uniqueContainers.add(c));
                });
                customerContainerList.textContent = uniqueContainers.size > 0 ? Array.from(uniqueContainers).join(', ') : 'אין מכולות משויכות.';

                // Define headers for customer history
                const headers = ['תאריך', 'תעודה', 'סוג פעולה', 'מכולה ירדה', 'מכולה עלתה', 'סטטוס', 'ימים בשכירות', 'הערות'];
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'py-3 px-4 text-right font-bold text-gray-600';
                    th.textContent = header;
                    historyTableHeaderRow.appendChild(th);
                });

                filteredOperations.forEach(op => {
                    const row = historyTableBody.insertRow();
                    row.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap">${op['תאריך הזמנה'] ? formatISODate(op['תאריך הזמנה']) : ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${op['תעודה']}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${op['סוג פעולה']}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${op['מספר מכולה ירדה'] || ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${op['מספר מכולה עלתה'] || ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="status-badge ${getStatusBadgeClass(op['סטטוס'], op.isOverdue)}">${op['סטטוס']}</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">${op['ימים שעברו']}</td>
                        <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-500">${op['הערות'] || ''}</td>
                    `;
                });

            } else if (type === 'container') {
                modalTitle.textContent = `היסטוריית מכולה: ${identifier}`;
                historyTableTitle.textContent = 'היסטוריית תנועות מכולה';
                modalCustomerSpecificDetails.classList.add('hidden'); // No customer summary for container history

                // Define headers for container history
                const headers = ['תאריך', 'סוג אירוע', 'לקוח', 'תעודה', 'כתובת', 'סוג פעולה מקורית'];
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'py-3 px-4 text-right font-bold text-gray-600';
                    th.textContent = header;
                    historyTableHeaderRow.appendChild(th);
                });

                const containerHist = containerLedger[identifier]?.history || [];
                containerHist.forEach(event => {
                    const row = historyTableBody.insertRow();
                    row.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap">${event.date ? formatISODate(event.date) : ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${event.type === 'dropped' ? 'הצבה' : 'הוצאה'}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${event.customer || ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${event.docId || ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${event.address || ''}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${event.actionType || ''}</td>
                    `;
                });
            }

            document.getElementById('customer-history-modal').classList.remove('hidden');
            document.getElementById('customer-history-modal').classList.add('flex');
        };

        /**
         * Closes the unified history modal.
         */
        const closeModal = () => {
            document.getElementById('customer-history-modal').classList.add('hidden');
            document.getElementById('customer-history-modal').classList.remove('flex');
        };

        // Render functions
        /**
         * Renders the dashboard page with KPIs and charts.
         */
        const renderDashboard = () => {
            if (allOperations.length === 0) {
                document.getElementById('kpi-active-containers').textContent = '0';
                document.getElementById('kpi-overdue-customers').textContent = '0';
                document.getElementById('kpi-available-containers').textContent = '0';
                document.getElementById('kpi-total-operations').textContent = '0';
                updateChart('agentActivityChart', [], []);
                updateChart('operationsTimelineChart', [], []);
                document.getElementById('all-operations-table').innerHTML = '';
                return;
            }

            const activeContainers = new Set();
            const customersInOverdue = new Set();
            const totalOperationsCount = allOperations.length;

            allOperations.forEach(op => {
                if (op['סטטוס'] === 'פתוח' && ['הצבה', 'החלפה'].includes(op['סוג פעולה'])) {
                    if (op['מספר מכולה ירדה']) {
                        activeContainers.add(op['מספר מכולה ירדה']);
                    }
                }
                if (op.isOverdue) {
                    customersInOverdue.add(op['שם לקוח']);
                }
            });

            // Calculate available containers from the ledger
            const availableContainers = Object.values(containerLedger).filter(c => c.currentStatus === 'available').length;
            const inUseContainersCount = Object.values(containerLedger).filter(c => c.currentStatus === 'in_use').length;

            document.getElementById('kpi-active-containers').textContent = inUseContainersCount;
            document.getElementById('kpi-overdue-customers').textContent = customersInOverdue.size;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-total-operations').textContent = totalOperationsCount;

            // Agent Activity Chart
            const agentActivity = {};
            allOperations.forEach(op => {
                const agent = op['שם סוכן'] || 'לא ידוע';
                agentActivity[agent] = (agentActivity[agent] || 0) + 1;
            });
            updateChart('agentActivityChart', Object.keys(agentActivity), Object.values(agentActivity));

            // Operations Timeline Chart
            const operationsByMonth = {};
            allOperations.forEach(op => {
                if (op['תאריך הזמנה']) {
                    const monthYear = op['תאריך הזמנה'].toLocaleString('he-IL', { year: 'numeric', month: 'short' });
                    operationsByMonth[monthYear] = (operationsByMonth[monthYear] || 0) + 1;
                }
            });
            // Sort months chronologically
            const sortedMonths = Object.keys(operationsByMonth).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const dateA = new Date(`1 ${monthA} ${yearA}`);
                const dateB = new Date(`1 ${monthB} ${yearB}`);
                return dateA - dateB;
            });
            const operationsData = sortedMonths.map(month => operationsByMonth[month]);
            updateChart('operationsTimelineChart', sortedMonths, operationsData);

            // Render all operations table
            renderAllOperationsTable(allOperations);
        };

        /**
         * Renders the 'All Operations' table based on the provided data.
         * @param {Array<Object>} data - The operations data to display.
         */
        const renderAllOperationsTable = (data) => {
            const tableBody = document.getElementById('all-operations-table');
            tableBody.innerHTML = ''; // Clear existing rows

            // Apply search filter
            const searchTerm = document.getElementById('main-search').value.toLowerCase();
            const showClosedOrders = document.getElementById('show-closed-orders').checked;

            const filteredData = data.filter(op => {
                const matchesSearch = (op['שם לקוח'] || '').toLowerCase().includes(searchTerm) ||
                                      (op['תעודה'] || '').toLowerCase().includes(searchTerm) ||
                                      (op['שם סוכן'] || '').toLowerCase().includes(searchTerm) ||
                                      (op['מספר מכולה ירדה'] || '').toLowerCase().includes(searchTerm) ||
                                      (op['מספר מכולה עלתה'] || '').toLowerCase().includes(searchTerm);
                const matchesClosedFilter = showClosedOrders || op['סטטוס'] !== 'סגור';
                return matchesSearch && matchesClosedFilter;
            });

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">אין נתונים להצגה</td></tr>`;
                return;
            }

            filteredData.forEach(op => {
                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50'; // Add hover effect

                const daysInRental = op['ימים שעברו'] !== undefined ? op['ימים שעברו'] : (op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : 0);
                const isOverdue = op['סטטוס'] !== 'סגור' && daysInRental >= 10;
                const statusClass = getStatusBadgeClass(op['סטטוס'], isOverdue);

                const containerNumberCell = op['מספר מכולה ירדה'] ? `<span class="container-link" onclick="openHistoryModal('container', '${op['מספר מכולה ירדה']}')">${op['מספר מכולה ירדה']}</span>` : (op['מספר מכולה עלתה'] || '');

                row.innerHTML = `
                    <td class="py-2 px-4 whitespace-nowrap">${op['תאריך הזמנה'] ? formatISODate(op['תאריך הזמנה']) : ''}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['תעודה']}</td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <span class="container-link" onclick="openHistoryModal('customer', '${op['שם לקוח']}')">${op['שם לקוח']}</span>
                    </td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['שם סוכן'] || ''}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['סוג פעולה']}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${daysInRental}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${containerNumberCell}</td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <span class="status-badge ${statusClass}">${op['סטטוס']}</span>
                    </td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <button onclick="openEditOrderModal('${op['תעודה']}')" class="text-blue-600 hover:text-blue-800 transition-colors mr-2" title="ערוך הזמנה">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="openWhatsAppModal('${op['שם לקוח']}', '${op['תעודה']}', '${op['טלפון לקוח'] || ''}', '${op['כתובת'] || ''}', '${op['מספר מכולה ירדה'] || op['מספר מכולה עלתה'] || ''}')" class="text-green-600 hover:text-green-800 transition-colors mr-2" title="שלח WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button onclick="confirmAndDeleteOrder('${op['תעודה']}')" class="text-red-600 hover:text-red-800 transition-colors" title="מחק הזמנה">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        };

        /**
         * Renders the inventory page tables (in-use and available containers).
         */
        const renderInventory = () => {
            const inUseTableBody = document.getElementById('in-use-containers-table');
            const availableTableBody = document.getElementById('available-containers-table');
            inUseTableBody.innerHTML = '';
            availableTableBody.innerHTML = '';

            const inUseContainers = Object.entries(containerLedger).filter(([num, data]) => data.currentStatus === 'in_use');
            const availableContainers = Object.entries(containerLedger).filter(([num, data]) => data.currentStatus === 'available' || data.currentStatus === 'in_transit');

            if (inUseContainers.length === 0) {
                inUseTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">אין מכולות בשימוש פעיל כרגע.</td></tr>`;
            } else {
                inUseContainers.forEach(([containerNum, data]) => {
                    const latestOp = allOperations.find(op => String(op['תעודה']) === data.latestOperationDocId);
                    const placementDate = data.lastDroppedDate ? formatISODate(data.lastDroppedDate) : 'N/A';
                    const daysOnSite = data.lastDroppedDate ? daysSince(data.lastDroppedDate) : 0;
                    const row = inUseTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="container-link" onclick="openHistoryModal('container', '${containerNum}')">${containerNum}</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="status-badge status-blue">בשימוש</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="container-link" onclick="openHistoryModal('customer', '${data.currentCustomer}')">${data.currentCustomer || 'N/A'}</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">${placementDate}</td>
                        <td class="py-2 px-4 whitespace-nowrap">${daysOnSite}</td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <button onclick="openHistoryModal('container', '${containerNum}')" class="text-gray-600 hover:text-gray-800 transition-colors" title="הצג היסטוריה">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>
                    `;
                });
            }

            if (availableContainers.length === 0) {
                availableTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">אין מכולות פנויות/בתהליך כרגע.</td></tr>`;
            } else {
                availableContainers.forEach(([containerNum, data]) => {
                    const lastOperationDate = data.lastLiftedDate ? formatISODate(data.lastLiftedDate) : (data.nextDropDate ? formatISODate(data.nextDropDate) : 'N/A');
                    const lastCustomerOrTarget = data.nextDropCustomer || data.currentCustomer || 'מלאי';
                    const statusClass = data.currentStatus === 'available' ? 'status-green' : 'status-yellow'; // Green for available, Yellow for in_transit
                    const statusText = data.currentStatus === 'available' ? 'פנויה' : 'במעבר';

                    const row = availableTableBody.insertRow();
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="container-link" onclick="openHistoryModal('container', '${containerNum}')">${containerNum}</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">${lastOperationDate}</td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            ${lastCustomerOrTarget !== 'מלאי' ? `<span class="container-link" onclick="openHistoryModal('customer', '${lastCustomerOrTarget}')">${lastCustomerOrTarget}</span>` : lastCustomerOrTarget}
                        </td>
                        <td class="py-2 px-4 whitespace-nowrap">
                            <button onclick="openHistoryModal('container', '${containerNum}')" class="text-gray-600 hover:text-gray-800 transition-colors" title="הצג היסטוריה">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>
                    `;
                });
            }
        };


        /**
         * Renders the treatment board with Kanban-style columns for overdue customers.
         */
        const renderTreatmentBoard = () => {
            const treatmentBoard = document.getElementById('treatment-board');
            treatmentBoard.innerHTML = ''; // Clear existing columns
            const noOverdueMessage = document.getElementById('no-overdue-message');

            const overdueOperations = allOperations.filter(op => op.isOverdue);

            if (overdueOperations.length === 0) {
                noOverdueMessage.classList.remove('hidden');
                return;
            } else {
                noOverdueMessage.classList.add('hidden');
            }

            // Group overdue operations by customer
            const customersMap = new Map();
            overdueOperations.forEach(op => {
                const customerName = op['שם לקוח'];
                if (!customersMap.has(customerName)) {
                    customersMap.set(customerName, {
                        customer: customerName,
                        address: op['כתובת'],
                        phone: op['טלפון לקוח'],
                        overdueContainers: []
                    });
                }
                customersMap.get(customerName).overdueContainers.push({
                    docId: op['תעודה'],
                    containerNum: op['מספר מכולה ירדה'], // Assuming 'מספר מכולה ירדה' is the relevant one for overdue
                    daysOverdue: op['ימים שעברו'],
                    notes: op['הערות'] // Initial notes from operation
                });
            });

            // Ensure order of customers is somewhat consistent (e.g., by oldest overdue first)
            const sortedCustomers = Array.from(customersMap.values()).sort((a, b) => {
                const minDaysA = Math.min(...a.overdueContainers.map(c => c.daysOverdue));
                const minDaysB = Math.min(...b.overdueContainers.map(c => c.daysOverdue));
                return minDaysB - minDaysA; // Longest overdue first
            });

            sortedCustomers.forEach(customerData => {
                const customerName = customerData.customer;
                const customerPhone = customerData.phone;
                const customerAddress = customerData.address;

                const column = document.createElement('div');
                column.className = 'kanban-column bg-white p-4 rounded-lg shadow-md border border-red-200';
                column.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 mb-3">${customerName} <span class="text-red-600">(${customerData.overdueContainers.length} מכולות חורגות)</span></h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>כתובת:</strong> ${customerAddress || 'לא צוין'}</p>
                    <p class="text-sm text-gray-600 mb-3"><strong>טלפון:</strong> ${customerPhone || 'לא צוין'}</p>
                    <div class="space-y-3 mb-4">
                        ${customerData.overdueContainers.map(container => `
                            <div class="bg-red-50 p-3 rounded-md border border-red-200">
                                <p class="font-semibold text-red-700">מכולה: <span class="container-link" onclick="openHistoryModal('container', '${container.containerNum}')">${container.containerNum || 'N/A'}</span></p>
                                <p class="text-sm text-red-600">תעודה: <span class="container-link" onclick="openHistoryModal('customer', '${customerName}')">${container.docId}</span></p>
                                <p class="text-sm text-red-600">ימים בחריגה: ${container.daysOverdue}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mb-4">
                        <label for="note-${customerName}" class="block text-sm font-semibold text-gray-700 mb-1">הערות טיפול:</label>
                        <textarea id="note-${customerName}" class="kpi-note-input scrollable-notes" rows="2" placeholder="הוסף הערות טיפול כאן..."></textarea>
                    </div>
                    <div class="flex justify-between items-center mt-auto">
                        <button onclick="openWhatsAppModal('${customerName}', '${customerData.overdueContainers[0].docId}', '${customerPhone || ''}', '${customerAddress || ''}', '${customerData.overdueContainers[0].containerNum || ''}')" class="px-3 py-2 bg-green-500 text-white rounded-md shadow-sm hover:bg-green-600 transition-colors flex items-center text-sm">
                            <i class="fab fa-whatsapp mr-1"></i>וואטסאפ
                        </button>
                        <button onclick="openHistoryModal('customer', '${customerName}')" class="px-3 py-2 bg-blue-500 text-white rounded-md shadow-sm hover:bg-blue-600 transition-colors flex items-center text-sm">
                            <i class="fas fa-history mr-1"></i>היסטוריה
                        </button>
                    </div>
                `;
                treatmentBoard.appendChild(column);

                // Set initial note value and add event listener
                const noteTextarea = document.getElementById(`note-${customerName}`);
                noteTextarea.value = customerNotes[customerName] || '';
                noteTextarea.addEventListener('input', (event) => {
                    debouncedUpdateCustomerNote(customerName, event.target.value);
                });
            });
        };

        /**
         * Renders the top 3 overdue customers as KPI cards.
         */
        const renderTopOverdueCustomers = () => {
            const overdueKpisSection = document.getElementById('overdue-kpis');
            overdueKpisSection.innerHTML = ''; // Clear existing cards

            const overdueCustomers = {};
            allOperations.forEach(op => {
                if (op.isOverdue) {
                    const customerName = op['שם לקוח'];
                    if (!overdueCustomers[customerName]) {
                        overdueCustomers[customerName] = {
                            name: customerName,
                            address: op['כתובת'] || '',
                            phone: op['טלפון לקוח'] || '',
                            totalDaysOverdue: 0,
                            containerCount: 0,
                            latestDocId: op['תעודה'], // Store latest docId for WhatsApp link
                            latestContainerNum: op['מספר מכולה ירדה'] || op['מספר מכולה עלתה'] || ''
                        };
                    }
                    overdueCustomers[customerName].totalDaysOverdue += op['ימים שעברו'];
                    overdueCustomers[customerName].containerCount++;
                }
            });

            const sortedOverdueCustomers = Object.values(overdueCustomers).sort((a, b) => b.totalDaysOverdue - a.totalDaysOverdue);
            const top3Overdue = sortedOverdueCustomers.slice(0, 3);

            if (top3Overdue.length === 0) {
                overdueKpisSection.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 p-4 bg-white rounded-lg shadow-md">
                        <p class="text-xl font-semibold mb-2">אין לקוחות בחריגה כרגע. כל הכבוד! 🎉</p>
                        <p>המערכת נקייה ופועלת כשורה.</p>
                    </div>
                `;
                return;
            }

            top3Overdue.forEach(customer => {
                const kpiCard = document.createElement('div');
                kpiCard.className = 'kpi-card flex flex-col justify-between h-full'; // Added h-full
                kpiCard.innerHTML = `
                    <div>
                        <h3 class="text-gray-500 font-semibold mb-1">לקוח בחריגה:</h3>
                        <p class="text-2xl font-bold text-red-600 blink-subtle">
                            <span class="container-link" onclick="openHistoryModal('customer', '${customer.name}')">${customer.name}</span>
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            <i class="fas fa-boxes"></i> ${customer.containerCount} מכולות חורגות
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-calendar-times"></i> סה"כ ${customer.totalDaysOverdue} ימי חריגה
                        </p>
                        <p class="text-sm text-gray-600 mb-2">
                             <i class="fas fa-map-marker-alt"></i> ${customer.address || 'כתובת לא ידועה'}
                        </p>
                        <div class="mb-3">
                            <label for="kpi-note-${customer.name}" class="block text-xs font-semibold text-gray-700">הערות:</label>
                            <textarea id="kpi-note-${customer.name}" class="kpi-note-input scrollable-notes" rows="2" placeholder="הוסף הערות טיפול כאן..."></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="openWhatsAppModal('${customer.name}', '${customer.latestDocId}', '${customer.phone}', '${customer.address}', '${customer.latestContainerNum}')" class="px-3 py-2 bg-green-500 text-white rounded-md shadow-sm hover:bg-green-600 transition-colors flex items-center text-sm">
                            <i class="fab fa-whatsapp mr-1"></i>וואטסאפ
                        </button>
                        <button onclick="showPage('treatment')" class="px-3 py-2 bg-red-500 text-white rounded-md shadow-sm hover:bg-red-600 transition-colors flex items-center text-sm">
                            <i class="fas fa-clipboard-check mr-1"></i>טפל בחריגה
                        </button>
                    </div>
                `;
                overdueKpisSection.appendChild(kpiCard);

                // Set initial note value and add event listener
                const noteTextarea = document.getElementById(`kpi-note-${customer.name}`);
                noteTextarea.value = customerNotes[customer.name] || '';
                noteTextarea.addEventListener('input', (event) => {
                    debouncedUpdateCustomerNote(customer.name, event.target.value);
                });
            });
        };

        /**
         * Returns the appropriate Tailwind CSS class for a status badge.
         * @param {string} status - The status string.
         * @param {boolean} isOverdue - Whether the operation is overdue.
         * @returns {string} The CSS class string.
         */
        const getStatusBadgeClass = (status, isOverdue) => {
            if (isOverdue) return 'status-red';
            switch (status) {
                case 'פתוח': return 'status-yellow';
                case 'סגור': return 'status-green';
                case 'חורג': return 'status-red'; // Explicitly 'חורג' status
                default: return 'status-gray';
            }
        };

        /**
         * Updates a Chart.js instance or creates a new one if it doesn't exist.
         * @param {string} chartId - The ID of the canvas element.
         * @param {Array<string>} labels - Labels for the chart.
         * @param {Array<number>} data - Data for the chart.
         * @param {string} type - Chart type ('bar' or 'line').
         */
        const updateChart = (chartId, labels, data, type = 'bar') => {
            const ctx = document.getElementById(chartId);
            if (!ctx) {
                console.error(`Canvas element with ID '${chartId}' not found.`);
                return;
            }

            if (charts[chartId]) {
                charts[chartId].data.labels = labels;
                charts[chartId].data.datasets[0].data = data;
                charts[chartId].update();
            } else {
                charts[chartId] = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: chartId === 'agentActivityChart' ? 'מספר פעולות' : 'סה"כ פעולות',
                            data: data,
                            backgroundColor: chartId === 'agentActivityChart' ? '#8b5cf6' : '#3b82f6', // Violet for agent, blue for timeline
                            borderColor: chartId === 'agentActivityChart' ? '#6d28d9' : '#2563eb',
                            borderWidth: 1,
                            borderRadius: 5,
                            barThickness: 20 // Adjust bar thickness for better appearance
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0 // Ensure integer ticks for counts
                                }
                            }
                        }
                    }
                });
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchDataFromGoogleSheet(); // Initial data load

            // Search functionality for the main operations table
            document.getElementById('main-search').addEventListener('input', debounce(() => {
                renderAllOperationsTable(allOperations);
            }, 300)); // Debounce to prevent excessive re-renders

            // Filter for closed orders
            document.getElementById('show-closed-orders').addEventListener('change', () => {
                renderAllOperationsTable(allOperations);
            });
        });
    </script>
    <!-- Dynamic status message container - will be created if not exists -->
    <div id="status-message-container"></div>
</body>
</html>
