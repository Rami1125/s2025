<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מכולות - משודרג</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Assistant for a clean Hebrew font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        /* Navigation tab button styling */
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            position: relative;
            overflow: hidden;
            flex-grow: 1; /* Make buttons take equal width */
            text-align: center;
        }
        /* Active navigation tab button styling */
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        /* Hover effect for inactive navigation tab buttons */
        .nav-tab-btn:not(.active):hover {
            color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            background-color: rgba(139, 92, 246, 0.05);
            border-radius: 0.5rem;
        }

        /* KPI card styling */
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Hover effect for KPI cards */
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            backdrop-filter: blur(5px); /* Blurred background for modal */
            animation: fadeIn 0.3s ease-out;
        }
        /* Modal content styling */
        .modal-content {
            max-height: 90vh;
            animation: slideInFromTop 0.3s ease-out;
            transform-origin: top;
        }
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        /* Kanban column styling */
        .kanban-column {
            min-height: 200px;
        }
        /* Status badge styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        /* Specific status badge colors */
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }
        .status-blue { background-color: #e0f2fe; color: #075985; } /* For 'in_transit' */

        /* Custom styles for larger and bolder table text */
        .table-large-text td { 
            font-size: 1.1rem; 
            font-weight: 700;
        }
        /* Typing effect cursor styling */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        /* Keyframe animation for blinking cursor */
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }

        /* Animations for modals */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading spinner styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #6d28d9; /* Violet */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* New blink-subtle animation for overdue KPI */
        @keyframes blink-subtle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .blink-subtle {
            animation: blink-subtle 1.5s ease-in-out infinite;
        }
        /* Style for clickable container numbers */
        .container-link {
            text-decoration: underline;
            color: #3b82f6; /* blue-500 */
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        .container-link:hover {
            opacity: 0.8;
        }
        /* Styling for the note input within KPI card */
        .kpi-note-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .kpi-note-input:focus {
            outline: none;
            border-color: #8b5cf6; /* violet-500 */
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25); /* ring-violet-300 */
        }
        /* Styling for scrollable notes */
        .scrollable-notes {
            max-height: 3.5rem; /* ~2-3 lines of text */
            overflow-y: auto;
            word-wrap: break-word; /* Ensure long words break */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #d1d5db #f3f4f6; /* Thumb and track color */
        }
        /* Webkit scrollbar (Chrome, Safari) */
        .scrollable-notes::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-notes::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }
        .scrollable-notes::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">מערכת ניהול מכולות</h1>
            <p class="text-lg text-gray-600">לוח בקרה מרכזי לניהול, מעקב וניתוח פעילות</p>
        </header>

        <!-- Top 3 Overdue Customers KPI Cards -->
        <section id="overdue-kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></section>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-gray-200 mb-8 rounded-lg shadow-sm">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>לוח בקרה
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>מלאי מכולות
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>לוח טיפול בחריגות
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">סקירה כללית</h2>
                    <button onclick="openNewOrderModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>הזמנה חדשה
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פעילות באתרים</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">לקוחות בחריגה <span class="text-xs">(מעל 10 ימים)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">מכולות פנויות במלאי</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">סה"כ פעולות (כל הזמנים)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעילות לפי סוכן</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">פעולות לאורך זמן</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">כלל הפעולות</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" placeholder="חפש לפי שם לקוח, תעודה, שם סוכן, מספר מכולה...">
                    </div>
                    <!-- New filter for closed orders -->
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="show-closed-orders" class="ml-2 h-5 w-5 text-violet-600 focus:ring-violet-500 border-gray-300 rounded">
                        <label for="show-closed-orders" class="text-gray-700 font-medium">הצג הזמנות סגורות</label>
                    </div>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך 📅</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תעודה 📄</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">שם לקוח 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">שם סוכן 👷</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סוג פעולה 📦</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">ימים בשכירות ⏳</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס ✅</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות בשימוש פעיל</h2>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מספר מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס מכולה 🚧</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">לקוח נוכחי 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך הצבה 🗓️</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">ימים באתר ⏳</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">מכולות פנויות / בתהליך</h2>
                     <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr class="border-b border-gray-200">
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">מספר מכולה 🔢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">סטטוס מכולה 🚧</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">תאריך פעולה אחרונה 🗓️</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">לקוח/יעד אחרון 👤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">פעולות 🛠️</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">לוח טיפול בלקוחות חורגים</h2>
                 <p class="text-gray-600 mb-6">כאן מרוכזות כל המכולות שנמצאות אצל לקוחות מעל 10 ימי עבודה ודורשות טיפול (החלפה או הוצאה).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
                 <div id="no-overdue-message" class="text-center text-gray-600 col-span-full hidden mt-8 p-4 bg-white rounded-lg shadow-md">
                     <p class="text-xl font-semibold mb-2">אין לקוחות בחריגה כרגע. כל הכבוד! 🎉</p>
                     <p>הצוות עובד נהדר!</p>
                 </div>
            </section>
        </main>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="loader"></div>
        <p class="text-gray-700 text-lg mt-4 mr-4">טוען נתונים...</p>
    </div>

    <!-- Unified History Modal (for Customer and Container) -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold" id="modal-history-title"></h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div id="modal-customer-specific-details">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">סיכום פעילות</h3>
                    <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-md text-blue-800 font-medium"></div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">מכולות ששויכו ללקוח</h3>
                    <div id="modal-customer-containers" class="mb-6 p-3 bg-gray-50 rounded-md text-gray-700">
                        <p id="customer-container-list" class="font-mono text-sm"></p>
                    </div>
                </div>
                <h3 class="text-lg font-semibold mb-2 text-gray-700" id="history-table-title">היסטוריית פעולות</h3>
                <div class="overflow-y-auto max-h-96 rounded-md border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr id="history-table-header-row" class="border-b border-gray-200">
                                <!-- Headers will be dynamically populated -->
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="table-large-text divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left rounded-b-lg">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">סגור</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">שליחת הודעת WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">מספר טלפון:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" placeholder="9725XXXXXXXX">
                    <p id="phone-error" class="text-red-500 text-sm mt-1 hidden">מספר טלפון אינו תקין.</p>
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center hover:bg-gray-200 transition-colors">
                        <span>בחר הודעה מובנית</span>
                        <i id="message-options-toggle-icon" class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white shadow-inner">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200 sticky top-0 bg-white" placeholder="חפש הודעה..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">תוכן ההודעה:</label>
                     <div class="border border-gray-300 rounded-md p-3 min-h-[100px] bg-gray-50 mb-2 overflow-y-auto max-h-48 relative">
                        <span id="typing-effect-display" class="whitespace-pre-wrap text-gray-800"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" rows="5" placeholder="כתוב כאן הודעה אישית..."></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <input type="hidden" id="whatsapp-customer-id"> <!-- Added for note updates -->
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors flex items-center">
                        <i class="fab fa-whatsapp mr-2"></i>שלח הודעה
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">הוספת הזמנה חדשה</h2>
                <button onclick="closeNewOrderModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label for="new-order-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך הזמנה <span class="text-red-500">*</span></label>
                        <input type="date" id="new-order-date" name="תאריך הזמנה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">תעודה <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-docid" name="תעודה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                        <p id="docid-error" class="text-red-500 text-sm mt-1 hidden">מספר תעודה זה כבר קיים.</p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">שם סוכן</label>
                        <input type="text" id="new-order-agent" name="שם סוכן" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">שם לקוח <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-customer-name" name="שם לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-address" class="block text-sm font-semibold text-gray-700 mb-1">כתובת</label>
                        <input type="text" id="new-order-address" name="כתובת" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">סוג פעולה <span class="text-red-500">*</span></label>
                        <select id="new-order-action-type" name="סוג פעולה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="">בחר פעולה</option>
                            <option value="הצבה">הצבה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="הוצאה">הוצאה</option>
                            <option value="הזזה">הזזה</option>
                            <option value="פינוי במקום">פינוי במקום</option>
                            <option value="גישה ללא פעולה">גישה ללא פעולה</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-status" class="block text-sm font-semibold text-gray-700 mb-1">סטטוס <span class="text-red-500">*</span></label>
                        <select id="new-order-status" name="סטטוס" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="new-order-container-dropped" name="מספר מכולה ירדה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="container-dropped-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="new-order-container-lifted" name="מספר מכולה עלתה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="container-lifted-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סיום צפוי</label>
                        <input type="date" id="new-order-expected-end-date" name="תאריך סיום צפוי" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">טלפון לקוח</label>
                        <input type="tel" id="new-order-phone" name="טלפון לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות</label>
                        <textarea id="new-order-notes" name="הערות" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2 rounded-b-lg">
                <button onclick="closeNewOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                <button onclick="submitNewOrder()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors">הוסף הזמנה</button>
            </div>
        </div>
    </div>

    <!-- Edit Order Modal (New) -->
    <div id="edit-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">עריכת הזמנה</h2>
                <button onclick="closeEditOrderModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="edit-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="edit-order-original-docid">
                    <div class="col-span-1">
                        <label for="edit-order-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך הזמנה <span class="text-red-500">*</span></label>
                        <input type="date" id="edit-order-date" name="תאריך הזמנה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">תעודה <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-order-docid" name="תעודה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                        <p id="edit-docid-error" class="text-red-500 text-sm mt-1 hidden">מספר תעודה זה כבר קיים.</p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">שם סוכן</label>
                        <input type="text" id="edit-order-agent" name="שם סוכן" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">שם לקוח <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-order-customer-name" name="שם לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-address" class="block text-sm font-semibold text-gray-700 mb-1">כתובת</label>
                        <input type="text" id="edit-order-address" name="כתובת" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">סוג פעולה <span class="text-red-500">*</span></label>
                        <select id="edit-order-action-type" name="סוג פעולה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="">בחר פעולה</option>
                            <option value="הצבה">הצבה</option>
                            <option value="החלפה">החלפה</option>
                            <option value="הוצאה">הוצאה</option>
                            <option value="הזזה">הזזה</option>
                            <option value="פינוי במקום">פינוי במקום</option>
                            <option value="גישה ללא פעולה">גישה ללא פעולה</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-status" class="block text-sm font-semibold text-gray-700 mb-1">סטטוס <span class="text-red-500">*</span></label>
                        <select id="edit-order-status" name="סטטוס" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="פתוח">פתוח</option>
                            <option value="חורג">חורג</option>
                            <option value="סגור">סגור</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה ירדה</label>
                        <input type="text" id="edit-order-container-dropped" name="מספר מכולה ירדה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="edit-container-dropped-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">מספר מכולה עלתה</label>
                        <input type="text" id="edit-order-container-lifted" name="מספר מכולה עלתה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                        <p id="edit-container-lifted-error" class="text-red-500 text-sm mt-1 hidden"></p>
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סיום צפוי</label>
                        <input type="date" id="edit-order-expected-end-date" name="תאריך סיום צפוי" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="edit-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">טלפון לקוח</label>
                        <input type="tel" id="edit-order-phone" name="טלפון לקוח" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות</label>
                        <textarea id="edit-order-notes" name="הערות" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label for="edit-order-closure-notes" class="block text-sm font-semibold text-gray-700 mb-1">הערות סיום</label>
                        <textarea id="edit-order-closure-notes" name="הערות סיום" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                     <div class="col-span-1">
                        <label for="edit-order-closure-date" class="block text-sm font-semibold text-gray-700 mb-1">תאריך סגירה</label>
                        <input type="date" id="edit-order-closure-date" name="תאריך סגירה" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2 rounded-b-lg">
                <button onclick="closeEditOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                <button onclick="submitEditOrder()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors">שמור שינויים</button>
            </div>
        </div>
    </div>


    <!-- JavaScript code -->
    <script>
        // Global state variables
        let allOperations = []; // Stores all operations, with dates parsed as Date objects
        let historicalOperations = []; // Static historical data (from rawDataString)
        let charts = {}; // Stores Chart.js instances
        let isLoadingData = false; // Flag to indicate data loading state
        let typingInterval; // Interval for typing effect
        let currentMessageFullText = ''; // Full text for typing effect
        let typingIndex = 0; // Current index for typing effect
        let containerLedger = {}; // Stores detailed history and current status for each container
        let customerNotes = {}; // Stores latest notes for customers for the KPI cards

        // Utility functions
        /**
         * Parses a date string into a Date object. Handles 'YYYY-MM-DD' and 'DD/MM/YYYY'.
         * @param {string} dateStr - The date string to parse.
         * @returns {Date|null} A Date object if successful, otherwise null.
         */
        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            // Handle YYYY-MM-DD format
            if (dateStr.includes('-') && dateStr.split('-').length === 3) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            // Handle DD/MM/YYYY format
            if (dateStr.includes('/') && dateStr.split('/').length === 3) {
                const parts = dateStr.split('/');
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // Assumes DD/MM/YYYY
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        /**
         * Formats a Date object into a 'YYYY-MM-DD' string.
         * @param {Date|null} dateObj - The Date object to format.
         * @returns {string} The formatted date string, or empty string if invalid.
         */
        const formatISODate = (dateObj) => {
            if (!dateObj || isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        };

        /**
         * Calculates the number of days between a given date and today.
         * @param {Date|null} date - The reference Date object.
         * @returns {number} The number of full days passed, or 0 if date is invalid.
         */
        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to start of day
            const opDate = new Date(date);
            opDate.setHours(0, 0, 0, 0); // Normalize opDate to start of day

            const diff = today.getTime() - opDate.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

         /**
         * Calculates the number of days between two dates.
         * @param {Date|null} startDate - The start Date object.
         * @param {Date|null} endDate - The end Date object.
         * @returns {number} The number of full days between the dates, or 0 if dates are invalid.
         */
        const daysBetween = (startDate, endDate) => {
            if (!startDate || isNaN(startDate.getTime()) || !endDate || isNaN(endDate.getTime())) return 0;
            const sDate = new Date(startDate);
            sDate.setHours(0, 0, 0, 0);
            const eDate = new Date(endDate);
            eDate.setHours(0, 0, 0, 0);

            const diff = eDate.getTime() - sDate.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        /**
         * Debounces a function call.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // Global functions for HTML onclick attributes
        /**
         * Shows the specified page (tab) and updates navigation button active state.
         * @param {string} pageId - The ID of the page to show ('dashboard', 'inventory', 'treatment').
         */
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');

            // Hide the 'no overdue' message if not on the treatment page
            if (pageId !== 'treatment') {
                document.getElementById('no-overdue-message').classList.add('hidden');
            }
        };

        /**
         * Attempts to extract an Israeli city name from an address string.
         * @param {string} address - The address string.
         * @returns {string|null} The city name if found, otherwise null.
         */
        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "תל אביב", "ירושלים", "חיפה", "ראשון לציון", "פתח תקווה", "אשדוד", "באר שבע",
                "נתניה", "בני ברק", "חולון", "רמת גן", "רחובות", "אשקלון", "בת ים", "הרצליה",
                "כפר סבא", "חדרה", "בית שמש", "מודיעין-מכבים-רעות", "לוד", "רמלה", "רעננה",
                "נהריה", "קריית גת", "אילת", "עכו", "צפת", "טבריה", "נצרת", "אום אל-פאחם",
                "בני ציון", "אבן יהודה", "אור יהודה", "אור עקיבא", "אריאל", "אשקלון", "באקה אל-גרבייה",
                "גבעתיים", "דימונה", "הוד השרון", "זכרון יעקב", "יבנה", "יהוד-מונוסון", "יוקנעם עילית",
                "כוכב יאיר", "כפר יונה", "כפר קאסם", "כרמיאל", "מגדל העמק", "מכבים", "מעלה אדומים",
                "מצפה רמון", "נהריה", "נס ציונה", "נשר", "עפולה", "ערד", "פרדס חנה-כרכור",
                "קריית אונו", "קריית ביאליק", "קריית ים", "קריית מוצקין", "קריית שמונה",
                "שוהם", "שדרות", "רמת השרון"
            ].sort((a,b) => b.length - a.length); // Sort by length descending for better matching

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        // Predefined WhatsApp messages and city guidelines
        const whatsappMessages = [
            { id: 'new_customer_welcome', text: 'שלום **[שם לקוח]**,\nתודה שבחרת להתחיל שכירות מכולה אצלנו! 👋 לכל פניה, בקשת החלפה או הוצאה של המכולה, אתה מוזמן ליצור קשר.\n\n📞 מספר ווטסאפ להזמנות: **[מספר טלפון חברה]**\n☎️ טלפון מחלקת הזמנות: **[טלפון חברה]**', category: 'כללי', placeholders: ['שם לקוח', 'מספר טלפון חברה', 'טלפון חברה'], emoji: '👋' },
            { id: 'approaching_due_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להזכיר לך כי תקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת בעוד **7 ימים** 🗓️. זה הזמן לנקוט פעולה!\n\nהאם תרצה להאריך את תקופת השכירות, להחליף את המכולה, או להזמין איסוף? ♻️', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏰' },
            { id: 'approaching_due_3_days', text: 'שלום **[שם לקוח]**,\n\nתקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת ממש בקרוב, בעוד **3 ימים** ⚠️. אנא טפל בנושא כדי למנוע חריגות.\n\nאנו לרשותך לכל עזרה! 🙏', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏳' },
            { id: 'overdue_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להודיע לך על חריגה בימי שכירות של המכולה ([**מספר מכולה**]) ב-**[ימים שעברו] ימים** 🚨. נא ליצור קשר עם מחלקת הזמנות **[טלפון חברה]** או להשיב להודעה זו מה תרצה שנבצע (החלפה/הוצאה).', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '❗️' },
            { id: 'overdue_30_days', text: '**התראה חמורה, [שם לקוח]:**\n\nהמכולה ([**מספר מכולה**]) שבשימושך חורגת ב-**[ימים שעברו] ימים**! יש לטפל בנושא בדחיפות כדי למנוע חיובים נוספים וסיבוכים משפטיים. ⚖️\n\n**צור קשר מיידית: [טלפון חברה].**', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '🔴' },
            { id: 'overdue_long', text: '**לכבוד: [שם לקוח]**\n\n**הנדון: חוב בגין שכירות מכולה חורגת**\n\nאנו פונים אליך בהתייחס לחשבונך, הנמצא בחריגה משמעותית של [**ימים שעברו**] ימים עבור מכולה ([**מספר מכולה**]).\n\nבהיעדר הסדרה מיידית, אנו נאלצים לנקוט בצעדים משפטיים לגבייה. אנו קוראים לך ליצור קשר דחוף להסדר: **[טלפון חברה]**.', category: 'משפטי', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו', 'טלפון חברה'], emoji: '' },
            { id: 'general_inquiry', text: 'שלום **[שם לקוח]**,\n\nאיך אנחנו יכולים לעזור לך היום? 🤔 אם יש לך שאלות, בקשות או תזכורות, אל תהסס לפנות אלינו. אנחנו כאן בשבילך! ✨', category: 'כללי', placeholders: ['שם לקוח'], emoji: '💬' },
            { id: 'payment_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת ידידותית לגבי תשלום חשבונית מספר **[תעודה]** 💰. אנו מודים לך על תשומת הלב המהירה ועל המשך שיתוף הפעולה.', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '💲' },
            { id: 'service_feedback', text: 'שלום **[שם לקוח]**,\n\nאנו מקווים ששירותינו עונים על ציפיותיך. נשמח לקבל משוב על החוויה שלך עם מכולה מספר **[מספר מכולה]** כדי שנוכל להשתפר ולהעניק לך שירות טוב יותר. ⭐', category: 'משוב', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '📝' },
            { id: 'holiday_greetings', text: 'חג שמח, **[שם לקוח]**! 🎉\n\nצוות [שם החברה] מאחל לך ולמשפחתך חג שמח, מלא שלווה, בריאות והמון שמחה! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎁' },
            { id: 'special_offer', text: 'שלום **[שם לקוח]**,\n\nיש לנו חדשות מרגשות! 🎁 מבצע מיוחד למכולות חדשות/נוספות עבורך. אל תחמיץ! לפרטים נוספים, השב להודעה זו או התקשר: **[טלפון חברה]**.', category: 'שיווק', placeholders: ['שם לקוח', 'טלפון חברה'], emoji: '✨' },
            { id: 'follow_up_issue', text: 'שלום **[שם לקוח]**,\n\nאנחנו חוזרים אליך לגבי הנושא שדיווחת עליו בתעודה **[תעודה]** 🛠️. האם הבעיה נפתרה לשביעות רצונך? אם לא, אנא הודע לנו כדי שנוכל להמשיך לטפל.', category: 'תמיכה', placeholders: ['שם לקוח', 'תעודה'], emoji: '✅' },
            { id: 'document_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת לשליחת המסמכים החסרים עבור הזמנה **[תעודה]** 📄. אנא שלח אותם בהקדם כדי שנוכל להשלים את הטיפול בהזמנה.\n\nתודה על שיתוף הפעולה!', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '📌' },
            { id: 'service_confirmation', text: 'שלום **[שם לקוח]**,\n\nהשירות שהוזמן (תעודה **[תעודה]**) אושר ויתבצע ב-**[תאריך סיום צפוי]** ✅. תודה שבחרת בנו ושיהיה יום נפלא!', category: 'אישור', placeholders: ['שם לקוח', 'תעודה', 'תאריך סיום צפוי'], emoji: '👍' },
            { id: 'service_delay', text: 'שלום **[שם לקוח]**,\n\nעקב נסיבות בלתי צפויות, ייתכן שיהיה עיכוב קל בטיפול בהזמנה **[תעודה]** ⏱️. אנו מתנצלים על אי הנוחות ונפעל לפתור זאת במהירות האפשרית.\n\nנודיע לך על כל עדכון! 🔜', category: 'מידע', placeholders: ['שם לקוח', 'תעודה'], emoji: '🚧' },
            { id: 'location_update_request', text: 'שלום **[שם לקוח]**,\n\nכדי שנוכל לתאם את השירות בצורה הטובה ביותר, אנא וודא שמיקום המכולה ([**מספר מכולה**]) מעודכן ומדויק 📍. זה חשוב להגעה יעילה!', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🗺️' },
            { id: 'happy_birthday', text: 'יום הולדת שמח, **[שם לקוח]**! 🎉🎂\n\nצוות [שם החברה] מאחל לך יום מלא בשמחה, בריאות, הגשמה והרבה רגעים מתוקים! 🥳', category: 'עונתי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '🎈' },
            { id: 'review_invitation', text: 'שלום **[שם לקוח]**,\n\nנהנית מהשירות שלנו? ✨ נשמח אם תוכל להקדיש רגע ולכתוב לנו ביקורת קצרה כאן: [**לינק לביקורת**]. תודה מראש על עזרתך להשתפר! 🙏', category: 'משוב', placeholders: ['שם לקוח', 'לינק לביקורת'], emoji: '🌟' },
            { id: 'tech_support_contact', text: 'שלום **[שם לקוח]**,\n\nלכל בעיה טכנית או תפעולית עם המכולה ([**מספר מכולה**]), מחלקת התמיכה שלנו זמינה עבורך 🧑‍🔧.\n\n**צור קשר: [טלפון חברה].**', category: 'תמיכה', placeholders: ['שם לקוח', 'מספר מכולה', 'טלפון חברה'], emoji: '🔧' },
            { id: 'general_thanks', text: 'תודה רבה לך, **[שם לקוח]**, על שיתוף הפעולה והאמון ב[שם החברה]! 🙏\n\nאנו מעריכים את בחירתך בנו ומקווים להמשיך לשרת אותך נאמנה. 💖', category: 'כללי', placeholders: ['שם לקוח', 'שם החברה'], emoji: '😊' },
            { id: 'multi_container_reminder', text: 'שלום **[שם לקוח]**,\n\nשמנו לב שברשותך **מספר מכולות פעילות** 🏗️. אנו כאן כדי לוודא שכל הצרכים שלך מסופקים.\n\nהאם יש משהו שנוכל לעזור בו בנוגע למכולות שלך? אל תהסס לפנות! 🤝', category: 'תזכורות', placeholders: ['שם לקוח'], emoji: '📦' },
            { id: 'container_mismatch', text: 'שלום **[שם לקוח]**,\n\n**התראה:** מכולה מספר **[מספר מכולה]** ירדה אצל לקוח **[שם לקוח]** בתעודה **[תעודה]** לפני **[ימים שעברו]** ימים וטרם הוחזרה/נסגרה! 🚨', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'תעודה', 'ימים שעברו'], emoji: '🚨' },
            { id: 'pending_order_reminder', text: 'שלום **[שם לקוח]**,\n\n**בטיפול:** הזמנה **[תעודה]** של לקוח **[שם לקוח]** מסומנת "בטיפול" ולא עודכנה **[ימים שעברו]** ימים. דורש בדיקה! ⚠️', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה', 'ימים שעברו'], emoji: '⚠️' }
        ];

        // City-specific guidelines for WhatsApp messages
        const cityGuidelines = {
            'הרצליה': {
                id: 'herzliya_permit',
                text: 'הנחיה חשובה לתושבי הרצליה:\nכדי להציב מכולת פסולת בניין ברחוב בהרצליה, יש להגיש בקשה מראש לאגף הפיקוח העירוני. הבקשה כרוכה בתשלום אגרה ונדרש אישור בכתב. מומלץ לוודא את כל הפרטים באתר העירייה או בטלפון.\n\nקישור למידע: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '📝'
            },
            'רעננה': {
                id: 'raanana_permit',
                text: 'הנחיה חשובה לתושבי רעננה:\nברעננה, חל איסור מוחלט להשאיר מכולות פסולת בניין במקום ציבורי (ברחוב) בסופי שבוע ובחגים. יש לדאוג להזמין פינוי לפני כניסת השבת/חג. קנסות יינתנו למפרים. אנא הקפד על הנחיות אלו.\n\nמידע נוסף: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🚫'
            },
            'תל אביב': {
                id: 'telaviv_permit',
                text: 'הנחיה חשובה לתושבי תל אביב:\nבתל אביב, הצבת מכולות פסולת ברחוב מחייבת קבלת היתר מהעירייה. יש להגיש בקשה מקוונת ולצרף את כל המסמכים הנדרשים. שימו לב להנחיות המדויקות לגבי סימון המכולה ומשך ההצבה.\n\nלמידע והגשת בקשה: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '�️'
            }
        };

        // Company information for placeholders
        const companyInfo = {
            phoneNumber: '972508860896', // Example WhatsApp number
            companyPhone: '097602010', // Example company phone
            companyName: 'ח.סבן' // Example company name
        };

        // Google Apps Script Web App URL for data interaction
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk03pVBEBzHIWkFj1OzM0T5buH5cfNjD8njGza8AoKWulO1sPtiBrOpUZZItOd_gi/exec'; // Updated URL

        // Helper to generate consistent phone numbers for customers for static data
        const customerPhones = {};
        let nextPhoneNumber = 972501000000;
        const getCustomerPhone = (customerName) => {
            if (!customerPhones[customerName]) {
                customerPhones[customerName] = `97250${nextPhoneNumber++}`;
            }
            return customerPhones[customerName];
        };

        // Raw data from the provided "טבלת פעולות מאוחדת" (CSV format parsed to array of objects)
        const rawDataString = `
תאריך,תעודה,שם לקוח,שם סוכן,סוג פעולה,כתובת
2025-06-01,6712645,בן ענבר-בי"ס ליידי ד,רמי/שארק,החלפה,רחוב שקד 15, כפר סבא
2025-06-01,6712655,שמעון הראל,רמי/שארק,החלפה,רחוב הגליל 10, הרצליה
2025-06-01,6712656,שארק/נאדר,רמי/שארק,החלפה,רחוב הארז 3, רעננה
2025-06-01,6712659,ניר ומירי נובק,מוחמד/שארק,הוצאה,רחוב הנשיאים 7, תל אביב
2025-06-01,6712661,בן ענבר-בי"ס ליידי ד,מוחמד/שארק,הוצאה,רחוב שקד 15, כפר סבא
2025-06-03,6712685,פלח משה/כללי,מוחמד/שארק,החלפה,רחוב הים 22, אשדוד
2025-06-03,6712689,מודי יבוא/בני ברק,רמי/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-06-04,6712691,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-06-04,6712705,דוד חיים ובניו - כלל,רמי/שארק,הוצאה,רחוב הנרקיס 8, ראשון לציון
2025-06-05,6712709,א.ערן אזולאי - יהודה,רמי/שארק,הוצאה,רחוב בן גוריון 3, פתח תקווה
2025-06-05,6712713,גום טכניקה חברה לייצ,רמי/שארק,החלפה,רחוב הרצל 1, חיפה
2025-06-05,6712713,גום טכניקה חברה לייצ,רמי/שארק,החלפה,רחוב הרצל 1, חיפה
2025-06-05,6712718,עאסי אחמד עב בנין,מוחמד/שארק,הוצאה,רחוב אלון 12, נצרת
2025-06-05,6712721,אלנבי על הים/האגדה,מוחמד/שארק,הוצאה,רחוב דיזנגוף 90, תל אביב
2025-06-10,6712739,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-06-10,6712744,אוהד טל,מוחמד/שארק,החלפה,רחוב הדקל 5, באר שבע
2025-06-11,6712750,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-06-11,6712755,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-06-11,6712760,מ.צ שחיבר בניה בע"מ,מוחמד/שארק,הוצאה,רחוב המייסדים 2, חולון
2025-06-12,6712766,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-06-12,6712774,שחר שאול תכנון/כללי,מוחמד/שארק,החלפה,רחוב האורן 1, רמת גן
2025-06-13,6712778,פינוי פסולת בשרון בע,מוחמד/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-06-17,6712823,ב.ר.ש תחזוקת מרלוגים,מוחמד/שארק,הוצאה,רחוב התעשייה 1, לוד
2025-06-17,6712834,קבוצת חסון,מוחמד/שארק,הוצאה,רחוב הגלבוע 5, עפולה
2025-06-18,6712849,מיי דסק בע"מ,מוחמד/שארק,החלפה,רחוב האלונים 7, רחובות
2025-06-19,6712877,ע.דרקו,מוחמד/שארק,החלפה,רחוב המלאכה 14, רמלה
2025-06-20,6712886,שחר שאול תכנון/כללי,מוחמד/שארק,הוצאה,רחוב האורן 1, רמת גן
2025-06-22,6712906,פינוי פסולת בשרון בע,מוחמד/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-06-24,6712954,א.ערן אזולאי - קידמה,מוחמד/שארק,החלפה,רחוב הגיבורים 2, חדרה
2025-06-25,6712979,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-06-25,6713984,פינת במזל (יבגני),מוחמד/שארק,החלפה,רחוב התאנה 3, באר שבע
2025-06-26,6713998,פינת במזל (יבגני),מוחמד/שארק,החלפה,רחוב התאנה 3, באר שבע
2025-06-27,6713043,ביליאור יצחקי-כללי,ריימונד/שארק,הוצאה,רחוב החבצלת 9, קריית אונו
2025-06-29,6713053,פינת במזל (יבגני),מוחמד/שארק,הוצאה,רחוב התאנה 3, באר שבע
2025-06-29,6713064,ליאור יצחקי-קיבוץ עי,מוחמד/שארק,הוצאה,קיבוץ עינת, כפר סבא
2025-06-30,6713084,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-06-30,6713090,מ.צ שחיבר בניה בע"מ,רמי/שארק,החלפה,רחוב המייסדים 2, חולון
2025-06-30,6713091,אילן יוסף,רמי/שארק,הוצאה,רחוב האלה 4, נתניה
2025-06-30,6713092,מיי דסק בע"מ,רמי/שארק,החלפה,רחוב האלונים 7, רחובות
2025-06-30,6713094,ע.דרקו,מוחמד/שארק,החלפה,רחוב המלאכה 14, רמלה
2025-07-01,6713107,מוזס סרנגה,מוחמד/שארק,הוצאה,רחוב התקומה 1, אילת
2025-07-01,6713111,נדלסטיצ'ר איתי/לוטם,רמי/שארק,הצבה,רחוב הנגב 20, דימונה
2025-07-01,6713123,מודי יבוא/בני ברק,רמי/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-07-02,6713131,הכל מבראשית/אוניברסי,מוחמד/שארק,הצבה,רחוב העצמאות 1, ירושלים
2025-07-02,6713132,עופר פוביצר,מוחמד/שארק,הוצאה,רחוב השלום 1, באר שבע
2025-07-02,6713137,בזלת מזר בע"מ,מוחמד/שארק,הצבה,רחוב הציונות 5, נס ציונה
2025-07-02,6713146,א.ערן אזולאי - קידמה,רמי/שארק,הוצאה,רחוב הגיבורים 2, חדרה
2025-07-02,6713150,א.כ.רימונים/מלכי הרצ,מוחמד/שארק,הצבה,רחוב המלכים 1, הרצליה
2025-07-02,6713151,מודי יבוא/בני ברק,מוחמד/שארק,הוצאה,רחוב קק"ל 50, בני ברק
2025-07-02,6713129,שמעון הראל,רמי/שארק,החלפה,רחוב הגליל 10, הרצליה
2025-07-02,6713129,שמעון הראל,רמי/שארק,החלפה,רחוב הגליל 10, הרצליה
2025-07-03,6713166,פינוי פסולת בשרון בע,מוחמד/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-07-03,6713179,אורם הנדסה וניהול בע,מוחמד/שארק,הצבה,רחוב הנדסה 1, כפר סבא
2025-07-06,6713195,בן ענבר-קרית אונו,מוחמד/שארק,הצבה,רחוב החבצלת 9, קריית אונו
2025-07-06,6713198,שחר שאול תכנון/כללי,רמי/שארק,הוצאה,רחוב האורן 1, רמת גן
2025-07-06,6713201,יונתן מנשה,מוחמד/שארק,הצבה,רחוב הגפן 3, הוד השרון
2025-07-06,6713205,אורם הנדסה וניהול בע,מוחמד/שארק,הוצאה,רחוב הנדסה 1, כפר סבא
2025-07-07,6713225,הכל מבראשית/אוניברסי,רמי/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-07-07,6713232,בן ענבר-קרית אונו,מוחמד/שארק,הצבה,רחוב החבצלת 9, קריית אונו
2025-07-07,6713237,שחר שאול תכנון/כללי,רמי/שארק,הצבה,רחוב האורן 1, רמת גן
2025-07-07,6713238,קובי בנישו,רמי/שארק,הוצאה,רחוב השקד 1, באר שבע
2025-07-07,6713243,א.ערן אזולאי - קידמה,מוחמד/שארק,הצבה,רחוב הגיבורים 2, חדרה
2025-07-07,6713244,א.כ.רימונים/מלכי הרצ,מוחמד/שארק,הוצאה,רחוב המלכים 1, הרצליה
2025-07-09,6713266,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-07-10,6713282,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-07-10,6713285,בזלת מזר בע"מ,מוחמד/שארק,החלפה,רחוב הציונות 5, נס ציונה
2025-07-10,6713288,רני שיראי,מוחמד/שארק,הצבה,רחוב הדולב 1, מודיעין
2025-07-10,6713293,רני שיראי,מוחמד/שארק,החלפה,רחוב הדולב 1, מודיעין
2025-07-10,6713296,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-07-10,6713297,בן ענבר-קרית אונו,רמי/שארק,החלפה,רחוב החבצלת 9, קריית אונו
2025-07-10,6713297,בן ענבר-קרית אונו,רמי/שארק,החלפה,רחוב החבצלת 9, קריית אונו
2025-07-11,6713301,א.ערן אזולאי - קידמה,מוחמד/שארק,הוצאה,רחוב הגיבורים 2, חדרה
2025-07-11,6713302,שחר לוי,מוחמד/שארק,הוצאה,רחוב הנדיב 10, רעננה
2025-07-11,6713304,בן ענבר-קרית אונו,מוחמד/שארק,החלפה,רחוב החבצלת 9, קריית אונו
2025-07-11,6713306,רני שיראי,מוחמד/שארק,הוצאה,רחוב הדולב 1, מודיעין
2025-07-13,6713311,מ.צ שחיבר בניה בע"מ,מוחמד/שארק,החלפה,רחוב המייסדים 2, חולון
2025-07-13,6713311,מ.צ שחיבר בניה בע"מ,רמי/שארק,החלפה,רחוב המייסדים 2, חולון
2025-07-13,6713313,מ.צ שחיבר בניה בע"מ,רמי/שארק,החלפה,רחוב המייסדים 2, חולון
2025-07-13,6713314,אלנבי על הים/האגדה,מוחמד/שארק,החלפה,רחוב דיזנגוף 90, תל אביב
2025-07-13,6713322,אוהד טל,מוחמד/שארק,החלפה,רחוב הדקל 5, באר שבע
2025-07-14,6713340,בן ענבר-בי"ס ליידי ד,מוחמד/שארק,הצבה,רחוב שקד 15, כפר סבא
2025-07-14,6713356,אורניל-אשר לוי,רמי/שארק,הוצאה,רחוב התאנה 1, חדרה
2025-07-15,6713365,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-07-15,6713368,בן ענבר-בי"ס ליידי ד,רמי/שארק,הוצאה,רחוב שקד 15, כפר סבא
2025-07-15,6713370,שחר שאול תכנון/כללי,מוחמד/שארק,הצבה,רחוב האורן 1, רמת גן
2025-07-15,6713372,פלח משה/כללי,מוחמד/שארק,הוצאה,רחוב הים 22, אשדוד
2025-07-15,6713386,מוזס סרנגה,מוחמד/שארק,הצבה,רחוב התקומה 1, אילת
2025-07-15,6713388,בהר אהוד-אבן יהודה,רמי/שארק,הוצאה,רחוב האלון 1, אבן יהודה
2025-07-16,671339,בזלת מזר בע"מ,מוחמד/שארק,החלפה,רחוב הציונות 5, נס ציונה
2025-07-16,6713395,גיא פריגת,מוחמד/שארק,הוצאה,רחוב השזיף 7, קריית גת
2025-07-16,6713411,פינוי פסולת בשרון בע,רמי/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-07-20,6713466,זהבי יצחק,מוחמד/שארק,הצבה,רחוב הזהב 1, נהריה
2025-07-20,6713467,זהבי יצחק,מוחמד/שארק,הצבה,רחוב הזהב 1, נהריה
2025-07-20,6713475,גום טכניקה חברה לייצור בע"מ,מוחמד/שארק,החלפה,רחוב הרצל 1, חיפה
2025-07-20,6713475,גום טכניקה חברה לייצ,מוחמד/שארק,החלפה,רחוב הרצל 1, חיפה
2025-07-21,6713496,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-07-21,6713515,זהבי יצחק,אגבאריה/שא,החלפה,רחוב הזהב 1, נהריה
2025-07-21,6713518,זהבי יצחק,אגבאריה/שא,החלפה,רחוב הזהב 1, נהריה
2025-07-21,6713519,שמעון הראל,מוחמד/שארק,הוצאה,רחוב הגליל 10, הרצליה
2025-07-21,6713519,שמעון הראל,מוחמד/שארק,הוצאה,רחוב הגליל 10, הרצליה
2025-07-22,6713520,עאסי אחמד עב בנין,אגבאריה/שא,החלפה,רחוב אלון 12, נצרת
2025-07-22,6713523,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-07-22,6713524,זהבי יצחק,מוחמד/שארק,החלפה,רחוב הזהב 1, נהריה
2025-07-22,6713526,בוקטוס אילן-כללי,אגבאריה/שארק,הוצאה,רחוב הסביון 6, עכו
2025-07-22,6713527,זהבי יצחק,אגבאריה/שארק,הצבה,רחוב הזהב 1, נהריה
2025-07-22,6713527,זהבי יצחק,אגבאריה/שא,הוצאה,רחוב הזהב 1, נהריה
2025-07-22,6713532,מיי דסק בע"מ,מוחמד/שארק,החלפה,רחוב האלונים 7, רחובות
2025-07-22,6713533,בן ענבר-קרית אונו,אגבאריה/שא,הוצאה,רחוב החבצלת 9, קריית אונו
2025-07-24,6713566,אילן יוסף,אגבאריה/שארק,החלפה,רחוב האלה 4, נתניה
2025-07-24,6713571,א.ערן אזולאי - אנקור,אגבאריה/שארק,החלפה,רחוב העוגן 1, אשדוד
2025-07-24,6713578,שמעון הראל,אגבאריה/שארק,הוצאה,רחוב הגליל 10, הרצליה
2025-07-24,6713580,שארק/עומר צמפיון,מוחמד/שארק,החלפה,רחוב הספורט 2, נתניה
2025-07-25,6713586,ליאור יצחקי-קיבוץ עי,אגבאריה/שא,החלפה,קיבוץ עינת, כפר סבא
2025-07-25,6713588,ליאור יצחקי-קיבוץ עי,אגבאריה/שא,החלפה,קיבוץ עינת, כפר סבא
2025-07-27,6713599,אילן ששון,אגבאריה/שארק,הוצאה,רחוב התפוז 8, הוד השרון
2025-07-27,6713600,פינוי פסולת בשרון בע,אגבאריה/שא,הוצאה,רחוב הפרחים 10, נתניה
2025-07-28,6713622,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-07-28,6713628,שארק/נאדר,אגבאריה/שא,החלפה,רחוב הארז 3, רעננה
2025-07-28,6713628,שארק/נאדר,אגבאריה/שא,החלפה,רחוב הארז 3, רעננה
2025-07-28,6713640,אלנבי על הים/האגדה,מוחמד/שארק,החלפה,רחוב דיזנגוף 90, תל אביב
2025-07-29,6713651,הכל מבראשית/אוניברסי,אגבאריה/שא,החלפה,רחוב העצמאות 1, ירושלים
2025-07-29,6713658,אורבר בנייה/ירמיהו ר"ג,אגבאריה/שארק,הוצאה,רחוב ירמיהו 1, רמת גן
2025-07-29,6713661,מוזס סרנגה,אגבאריה/שא,הוצאה,רחוב התקומה 1, אילת
2025-07-29,6713670,ע.דרקו,אגבאריה/שא,החלפה,רחוב המלאכה 14, רמלה
2025-07-30,6713678,שארק/עומר צמפיון,אגבאריה/שא,החלפה,רחוב הספורט 2, נתניה
2025-07-30,6713683,יונתן מנשה,אגבאריה/שא,הוצאה,רחוב הגפן 3, הוד השרון
2025-07-30,671369,שחר שאול תכנון/כללי,אגבאריה/שא,הוצאה,רחוב האורן 1, רמת גן
2025-07-31,6713705,רני שיראי,מוחמד/שארק,הוצאה,רחוב הדולב 1, מודיעין
2025-07-31,6713722,ליאור יצחקי-קיבוץ עי,אגבאריה/שא,הוצאה,קיבוץ עינת, כפר סבא
2025-08-01,6713730,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-08-01,6713732,נדלסטיצ'ר איתי/לוטם,מוחמד/שארק,הוצאה,רחוב הנגב 20, דימונה
2025-08-01,6713736,פינוי פסולת בשרון בע,מוחמד/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-08-03,6713742,אמיר קין,מוחמד/שארק,הוצאה,רחוב התמר 7, חדרה
2025-08-03,6713744,אלקאר לבניה בע"מ,מוחמד/שארק,הוצאה,רחוב הבונים 5, פתח תקווה
2025-08-03,6713745,בזלת מזר בע"מ,אגבאריה/שא,הוצאה,רחוב הציונות 5, נס ציונה
2025-08-03,6713755,כחילה צחי-כללי,מוחמד/שארק,הצבה,רחוב הזית 1, חיפה
2025-08-04,6713767,מודי יבוא/בני ברק,אגבאריה/שא,החלפה,רחוב קק"ל 50, בני ברק
2025-08-04,6713769,בזלת מזר בע"מ,אגבאריה/שארק,הוצאה,רחוב הציונות 5, נס ציונה
2025-08-04,6713771,שחר שאול תכנון/כללי,מוחמד/שארק,החלפה,רחוב האורן 1, רמת גן
2025-08-04,6713771,שחר שאול תכנון/כללי,מוחמד/שארק,החלפה,רחוב האורן 1, רמת גן
2025-08-05,6713801,רני שיראי,אגבאריה/שא,הוצאה,רחוב הדולב 1, מודיעין
2025-08-06,6713827,הכל מבראשית/אוניברסי,מוחמד/שארק,הוצאה,רחוב העצמאות 1, ירושלים
2025-08-06,6713831,שארק/אורן,אגבאריה/שא,החלפה,רחוב האקליפטוס 9, רעננה
2025-08-07,6713844,פינוי פסולת בשרון בע,אגבאריה/שארק,החלפה,רחוב הפרחים 10, נתניה
2025-08-07,6713851,י.א. ניס בע"מ,מוחמד/שארק,הצבה,רחוב ניסן 1, קריית גת
2025-08-07,6713853,אילן ששון,אגבאריה/שארק,הצבה,רחוב התפוז 8, הוד השרון
2025-08-08,6713881,שני אילתי/כללי,מוחמד/שארק,הצבה,רחוב האגוז 3, רמת השרון
2025-08-09,6713891,מיי דסק בע"מ,אגבאריה/שא,החלפה,רחוב האלונים 7, רחובות
2025-08-10,6713895,ג.ד אחים כהן בעמ,אגבאריה/שארק,הוצאה,רחוב האחים 2, באר שבע
2025-08-10,6713938,הכל מבראשית/אוניברסי,מוחמד/שארק,החלפה,רחוב העצמאות 1, ירושלים
2025-08-11,6713917,בן ענבר-קרית אונו,אגבאריה/שא,הוצאה,רחוב החבצלת 9, קריית אונו
2025-08-11,6713934,בן ענבר-קרית אונו,אגבאריה/שא,הוצאה,רחוב החבצלת 9, קריית אונו
2025-08-12,6713941,שני אילתי/כללי,אגבאריה/שא,החלפה,רחוב האגוז 3, רמת השרון
2025-08-12,6713947,י.א. ניס בע"מ,אגבאריה/שארק,החלפה,רחוב ניסן 1, קריית גת
2025-08-13,6713971,כחילה צחי-כללי,אגבאריה/שא,החלפה,רחוב הזית 1, חיפה
2025-08-13,6713975,שחר שאול תכנון/כללי,מוחמד/שארק,החלפה,רחוב האורן 1, רמת גן
2025-08-13,6713980,שני אילתי/כללי,אגבאריה/שא,הצבה,רחוב האגוז 3, רמת השרון
2025-08-13,6713988,אמיר קין,מוחמד/שארק,הוצאה,רחוב התמר 7, חדרה
2025-08-13,6713991,כחילה צחי-כללי,מוחמד/שארק,הוצאה,רחוב הזית 1, חיפה
2025-08-14,6714012,שני אילתי/כללי,מוחמד/שארק,החלפה,רחוב האגוז 3, רמת השרון
2025-08-14,6714018,שני אילתי/כללי,מוחמד/שארק,החלפה,רחוב האגוז 3, רמת השרון
2025-08-14,6714022,שני אילתי/כללי,מוחמד/שארק,החלפה,רחוב האגוז 3, רמת השרון
2025-08-15,6714030,מודי יבוא/בני ברק,מוחמד/שארק,החלפה,רחוב קק"ל 50, בני ברק
2025-08-15,6714032,שני אילתי/כללי,אגבאריה/שא,החלפה,רחוב האגוז 3, רמת השרון
2025-08-15,6714037,בזלת מזר בע"מ,אגבאריה/שארק,החלפה,רחוב הציונות 5, נס ציונה
2025-08-17,6714041,שני אילתי/כללי,מוחמד/שארק,הצבה,רחוב האגוז 3, רמת השרון
2025-08-17,6714051,אוהד טל,אגבאריה/שא,החלפה,רחוב הדקל 5, באר שבע
2025-08-17,6714058,מ.צ שחיבר בניה/הוד ה,אגבאריה/שא,הוצאה,רחוב המייסדים 2, חולון
2025-08-17,6714059,יונתן מנשה,אגבאריה/שא,הצבה,רחוב הגפן 3, הוד השרון
2025-08-17,6714063,מ.צ שחיבר בניה/הוד ה,אגבאריה/שא,הוצאה,רחוב המייסדים 2, חולון
2025-08-18,6713988,בוקטוס אילן-כללי,אגבאריה/שארק,הצבה,רחוב הסביון 6, עכו
2025-08-18,6714067,בוקטוס אילן-כללי,מוחמד/שארק,הוצאה,רחוב הסביון 6, עכו
`.trim();

        /**
         * Parses a CSV string into an array of objects.
         * @param {string} csvString - The CSV data as a string.
         * @returns {Array<Object>} An array of objects representing the CSV data.
         */
        const parseCSVString = (csvString) => {
            const lines = csvString.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let inQuote = false;
                let currentValue = '';
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim()); // Push the last value

                const rowObject = {};
                for (let k = 0; k < headers.length; k++) {
                    rowObject[headers[k]] = values[k] !== undefined ? values[k] : '';
                }
                data.push(rowObject);
            }
            return data;
        };

        const rawParsedData = parseCSVString(rawDataString);

        // Process raw static data into the desired structured format for historical operations
        historicalOperations = rawParsedData.map(row => {
            let actionType = row['סוג פעולה'].trim();
            // Normalize action types
            if (actionType === 'הורדה') {
                actionType = 'הצבה';
            } else if (actionType === 'העלאה') {
                actionType = 'הוצאה';
            } else if (actionType === 'החalפה') { // Handle possible typo in static data
                actionType = 'החלפה';
            }

            // For static data, container numbers are not in the raw CSV, so leave them empty.
            // They will be populated from live sheet data or new manual entries.
            const containerDropped = '';
            const containerLifted = '';
            const containerAll = '';

            const customerPhone = getCustomerPhone(row['שם לקוח']); // Simulated phone numbers
            const orderDate = formatDate(row['תאריך']); // Parse date immediately

            let status = 'פתוח';
            if (actionType === 'הוצאה' || actionType === 'פינוי במקום') {
                status = 'סגור';
            }

            // Calculate daysInRental and isOverdue for pre-computation
            const daysInRental = orderDate ? daysSince(orderDate) : 0;
            const isOverdue = status === 'פתוח' && daysInRental >= 10;

            // Generate expected end date for open orders (e.g., 14 days from order date)
            const expectedEndDate = orderDate ? new Date(orderDate.getTime() + 14 * 24 * 60 * 60 * 1000) : null;
            const expectedEndDateFormatted = expectedEndDate ? formatISODate(expectedEndDate) : '';

            // Ensure all headers expected by the Google Sheet are present, even if empty
            // This structure mirrors the `sheetHeaders` in submitNewOrder for consistency.
            const completeOrder = {
                'תאריך הזמנה': orderDate,
                'תעודה': row['תעודה'],
                'שם סוכן': row['שם סוכן'],
                'שם לקוח': row['שם לקוח'],
                'כתובת': row['כתובת'] || '', // Use provided address, or empty string
                'סוג פעולה': actionType,
                'ימים שעברו': daysInRental, // Pre-calculated
                'מספר מכולה ירדה': containerDropped,
                'מספר מכולה עלתה': containerLifted,
                'מספרי מכולות': containerAll,
                'סטטוס': status,
                'הערות': '',
                'תאריך סיום צפוי': expectedEndDate,
                'הערות סיום': '',
                'תאריך סגירה': status === 'סגור' ? orderDate : null, // Set closing date if status is closed
                'ימים שעברו (עלתה)': '', // Not calculated for static data without explicit lifted dates
                'טלפון לקוח': customerPhone,
                'isOverdue': isOverdue // Pre-calculated
            };
            return completeOrder;
        });
        console.log("Loaded static historical data (without simulated container numbers):", historicalOperations);

        /**
         * Builds a comprehensive ledger for each container, determining its current status
         * and full historical movement.
         */
        const buildContainerLedger = () => {
            containerLedger = {}; // Reset for fresh build

            // 1. First pass: Populate raw history for each container
            // Sort all operations by date (ascending) to correctly build history
            const sortedOperations = allOperations.slice().sort((a, b) => {
                const dateA = a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0;
                const dateB = b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0;
                return dateA - dateB;
            });

            sortedOperations.forEach(op => {
                const docId = String(op['תעודה']);
                const customerName = op['שם לקוח'];
                const address = op['כתובת'];
                const opDate = op['תאריך הזמנה'];
                const actionType = op['סוג פעולה'];

                // Split by comma for multiple containers
                const containersDropped = String(op['מספר מכולה ירדה'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersLifted = String(op['מספר מכולה עלתה'] || '').split(',').map(c => c.trim()).filter(Boolean);

                containersDropped.forEach(containerNum => {
                    if (!containerLedger[containerNum]) {
                        containerLedger[containerNum] = { history: [], currentStatus: 'unknown', currentCustomer: null, currentAddress: null, lastDroppedDate: null, lastLiftedDate: null, nextDropDate: null, latestOperationDocId: null };
                    }
                    containerLedger[containerNum].history.push({
                        type: 'dropped',
                        customer: customerName,
                        date: opDate,
                        docId: docId,
                        address: address,
                        actionType: actionType // Store action type for history display
                    });
                });

                containersLifted.forEach(containerNum => {
                    if (!containerLedger[containerNum]) {
                        containerLedger[containerNum] = { history: [], currentStatus: 'unknown', currentCustomer: null, currentAddress: null, lastDroppedDate: null, lastLiftedDate: null, nextDropDate: null, latestOperationDocId: null };
                    }
                    containerLedger[containerNum].history.push({
                        type: 'lifted',
                        customer: customerName, // Customer it was lifted FROM
                        date: opDate,
                        docId: docId,
                        address: address,
                        actionType: actionType // Store action type for history display
                    });
                });
            });

            // 2. Second pass: Determine current status and enrich container info
            for (const containerNum in containerLedger) {
                const container = containerLedger[containerNum];
                container.history.sort((a, b) => a.date.getTime() - b.date.getTime()); // Ensure history is sorted chronologically

                const lastEvent = container.history[container.history.length - 1];

                if (lastEvent) {
                    container.latestOperationDocId = lastEvent.docId; // Keep track of the operation that caused the current state

                    if (lastEvent.type === 'dropped') {
                        container.currentStatus = 'in_use';
                        container.currentCustomer = lastEvent.customer;
                        container.currentAddress = lastEvent.address;
                        container.lastDroppedDate = lastEvent.date;
                        container.lastLiftedDate = null; // Reset if dropped
                        container.nextDropDate = null; // Reset if dropped (it's currently in use)
                        container.nextDropCustomer = null;
                        container.nextDropAddress = null;
                    } else if (lastEvent.type === 'lifted') {
                        container.lastLiftedDate = lastEvent.date;
                        container.lastDroppedDate = null; // Reset if lifted

                        // Check for a future 'dropped' event after the last 'lifted' event
                        const indexOfLastLifted = container.history.indexOf(lastEvent);
                        const futureDrop = container.history.slice(indexOfLastLifted + 1).find(event => event.type === 'dropped');

                        if (futureDrop) {
                            container.currentStatus = 'in_transit'; // lifted but will be dropped elsewhere soon
                            container.currentCustomer = lastEvent.customer; // Last customer it was with
                            container.currentAddress = lastEvent.address; // Last address it was at
                            container.nextDropDate = futureDrop.date;
                            container.nextDropCustomer = futureDrop.customer;
                            container.nextDropAddress = futureDrop.address;
                        } else {
                            container.currentStatus = 'available'; // lifted and no future drops
                            container.currentCustomer = null; // No current customer
                            container.currentAddress = null;
                            container.nextDropDate = null;
                            container.nextDropCustomer = null;
                            container.nextDropAddress = null;
                        }
                    }
                } else {
                    container.currentStatus = 'unknown'; // Fallback if no events found for container (shouldn't happen with current data)
                }
            }
            console.log("Built container ledger:", containerLedger);
        };


        /**
         * Merges historical static data with live data fetched from Google Sheet.
         * Prioritizes live data for documents with matching 'תעודה'.
         * Converts date strings from live data to Date objects.
         * @param {Array<Object>} staticOps - Array of historical operation objects.
         * @param {Array<Object>} liveOps - Array of live operation objects from Google Sheet.
         * @returns {Array<Object>} Merged and sorted array of operations.
         */
        const mergeData = (staticOps, liveOps) => {
            const mergedMap = new Map();

            // Add live data, prioritizing it
            liveOps.forEach(op => {
                const docId = String(op['תעודה']);
                // Apply the user's mapping for live data from sheet and parse dates
                let normalizedActionType = op['סוג פעולה'] ? op['סוג פעולה'].trim() : '';
                if (normalizedActionType === 'הורדה') {
                    normalizedActionType = 'הצבה';
                } else if (normalizedActionType === 'העלאה') {
                    normalizedActionType = 'הוצאה';
                }
                op['סוג פעולה'] = normalizedActionType; // Update the operation object

                // Parse dates into Date objects
                op['תאריך הזמנה'] = formatDate(op['תאריך הזמנה']);
                op['תאריך סיום צפוי'] = formatDate(op['תאריך סיום צפוי']);
                op['תאריך סגירה'] = formatDate(op['תאריך סגירה']);

                // Calculate derived fields (daysInRental, isOverdue)
                op['ימים שעברו'] = op['תאריך הזמנה'] ? daysSince(op['תאריך הזמנה']) : 0;
                op['isOverdue'] = op['סטטוס'] !== 'סגור' && op['ימים שעברו'] >= 10;

                mergedMap.set(docId, op);
            });

            // Add historical data if not already present in live data
            staticOps.forEach(op => {
                const docId = String(op['תעודה']);
                if (!mergedMap.has(docId)) {
                    mergedMap.set(docId, op); // Static data already has parsed dates and calculated fields
                }
            });

            // Convert map back to array and sort by date (descending)
            return Array.from(mergedMap.values()).sort((a, b) => {
                const dateA = a['תאריך הזמנה'] ? a['תאריך הזמנה'].getTime() : 0;
                const dateB = b['תאריך הזמנה'] ? b['תאריך הזמנה'].getTime() : 0;
                return dateB - dateA;
            });
        };


        /**
         * Fetches data from the Google Sheet with exponential backoff for retries.
         * @async
         */
        const fetchDataFromGoogleSheet = async () => {
            isLoadingData = true;
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader

            let liveData = [];
            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=getData`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();

                    if (result.success && Array.isArray(result.data)) {
                        liveData = result.data;
                        console.log("Fetched live data from Google Sheet:", liveData);
                        break; // Exit retry loop on success
                    } else {
                        console.error("Received data is not an array or success is false:", result);
                        showStatusMessage("שגיאה: הנתונים שהתקבלו מגיליון גוגל אינם בפורמט צפוי או שהייתה שגיאה בשרת: " + (result.message || 'אין הודעה ספציפית'), 'error');
                        // No break here, allow retry for server errors potentially
                    }
                } catch (error) {
                    console.error("Error fetching data from Google Sheet:", error);
                    showStatusMessage("שגיאה בטעינת הנתונים מגיליון גוגל: " + error.message, 'error');
                }

                if (retries < maxRetries - 1) { // Don't delay after the last retry attempt
                    const delay = baseDelay * Math.pow(2, retries);
                    // console.warn(`API rate limit hit or network error. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                retries++;
            }

            // Merge historical static data with live data
            allOperations = mergeData(historicalOperations, liveData);
            console.log("Merged operations data:", allOperations);

            // Build the container ledger after all operations are merged
            buildContainerLedger();

            renderDashboard();
            renderInventory();
            renderTreatmentBoard();
            renderTopOverdueCustomers(); // Render new KPI cards

            isLoadingData = false;
            document.getElementById('global-loader').classList.add('hidden'); // Hide loader
        };

        /**
         * Adds a new order to the Google Sheet via Apps Script.
         * @param {Object} orderData - The order data to send.
         * @async
         */
        const addNewOrderToSheet = async (orderData) => {
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=addOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('ההזמנה נוספה בהצלחה לגיליון!', 'success');
                    await fetchDataFromGoogleSheet(); // Re-fetch all data to ensure local state is updated
                } else {
                    showStatusMessage('שגיאה בהוספת ההזמנה: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding order to sheet:', error);
                showStatusMessage('שגיאה בתקשורת עם השרת בעת הוספת הזמנה.', 'error');
            } finally {
                document.getElementById('global-loader').classList.add('hidden'); // Hide loader
            }
        };

        /**
         * Updates an existing order in the Google Sheet via Apps Script.
         * @param {string} originalDocId - The original document ID of the order to update.
         * @param {Object} updatedOrderDat�
