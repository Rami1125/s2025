<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª - ××©×•×“×¨×’</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Assistant for a clean Hebrew font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        /* Navigation tab button styling */
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            position: relative;
            overflow: hidden;
            flex-grow: 1; /* Make buttons take equal width */
            text-align: center;
        }
        /* Active navigation tab button styling */
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        /* Hover effect for inactive navigation tab buttons */
        .nav-tab-btn:not(.active):hover {
            color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            background-color: rgba(139, 92, 246, 0.05);
            border-radius: 0.5rem;
        }

        /* KPI card styling */
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
            cursor: pointer; /* Make KPI cards clickable */
        }
        /* Hover effect for KPI cards */
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            filter: brightness(1.03); /* Subtle brightness boost on hover */
        }

        /* Modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
            z-index: 50;
            backdrop-filter: blur(8px); /* More blur */
            animation: fadeIn 0.3s ease-out;
        }
        /* Modal content styling */
        .modal-content {
            max-height: 95vh; /* Slightly larger modals */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); /* Deeper shadow */
            animation: slideInFromTop 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother animation */
            transform-origin: top;
            overflow-y: auto; /* Allow scrolling within modal */
            position: relative;
        }
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        /* Kanban column styling (unused for now, keep for future if needed) */
        .kanban-column {
            min-height: 200px;
        }
        /* Status badge styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        /* Specific status badge colors */
        .status-green { background-color: #dcfce7; color: #166534; } /* ×”×¦×‘×” (Placement) */
        .status-yellow { background-color: #fef9c3; color: #854d0e; } /* ×”×—×œ×¤×” (Exchange) */
        .status-red { background-color: #fee2e2; color: #991b1b; } /* ×”×•×¦××” (Removal) */
        .status-gray { background-color: #f3f4f6; color: #4b5563; } /* ×¡×’×•×¨ (Closed) */
        .status-overdue { background-color: #fde2e2; color: #cc0000; font-weight: bold; } /* ×—×¨×™×’×” (Overdue) */


        /* Custom styles for larger and bolder table text */
        .table-large-text td {
            font-size: 1.1rem;
            font-weight: 700;
        }
        /* Typing effect cursor styling */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        /* Keyframe animation for blinking cursor */
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }

        /* Animations for modals */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-50px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* Loading spinner styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #6d28d9; /* Violet */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sparkle effect for buttons */
        .sparkle-button {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .sparkle-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease-out, height 0.4s ease-out;
            z-index: -1;
        }
        .sparkle-button:hover::before {
            width: 200px;
            height: 200px;
            opacity: 0;
        }

        /* Conditional row styling for table */
        .row-placement { background-color: #effcf1; /* Light Green */ }
        .row-exchange { background-color: #fffbe6; /* Light Yellow */ }
        .row-removal { background-color: #fff0f0; /* Light Red */ }
        .row-closed { background-color: #f7f7f7; text-decoration: line-through; color: #888; }
        .row-overdue { background-color: #fcdbdc; border-right: 4px solid #dc2626; } /* Stronger red for overdue rows */

        /* Table header input styling */
        .table-header-input {
            width: 100%;
            padding: 0.3rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            transition: all 0.2s;
        }
        .table-header-input:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 bg-gradient-to-r from-violet-600 to-indigo-600 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
            <div class="absolute inset-0 bg-pattern opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=\'20\' height=\'20\' viewBox=\'0 0 20 20\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'0.2\' fill-rule=\'evenodd\'%3E%3Ccircle cx=\'3\' cy=\'3\' r=\'3\'/%3E%3Ccircle cx=\'13\' cy=\'13\' r=\'3\'/%3E%3C/g%3E%3C/svg%3E');"></div>
            <div class="flex items-center mb-4 sm:mb-0">
                <img src="https://placehold.co/60x60/8b5cf6/ffffff?text=LOGO" alt="Company Logo" class="w-16 h-16 rounded-full border-2 border-white shadow-md mr-4">
                <h1 class="text-4xl font-extrabold text-white leading-tight">××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</h1>
            </div>
            <div class="text-center sm:text-right">
                <p id="current-time" class="text-2xl font-bold mb-1"></p>
                <p id="current-date" class="text-lg"></p>
                <div class="mt-2 text-sm text-white">
                    <span id="user-display" class="font-semibold"></span>
                    <button onclick="changeUser()" class="bg-violet-700 hover:bg-violet-800 text-white text-xs font-bold py-1 px-2 rounded-full transition-colors ml-2">×”×—×œ×£ ××©×ª××©</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-gray-200 mb-8 rounded-lg shadow-sm">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3 rounded-t-lg sparkle-button" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>×œ×•×— ×‘×§×¨×”
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg sparkle-button" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg sparkle-button" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>×œ×•×— ×˜×™×¤×•×œ ×‘×—×¨×™×’×•×ª
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
                    <button onclick="openNewOrderModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition-all flex items-center justify-center sparkle-button">
                        <i class="fas fa-plus-circle mr-2 text-lg"></i>×”×–×× ×” ×—×“×©×”
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card" onclick="openKPIDetailModal('activeContainers')">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª ×‘××ª×¨×™×</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card" onclick="openKPIDetailModal('overdueCustomers')">
                        <h3 class="text-gray-500 font-semibold">×œ×§×•×—×•×ª ×‘×—×¨×™×’×” <span class="text-xs">(××¢×œ 10 ×™××™×)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card" onclick="openKPIDetailModal('availableContainers')">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤× ×•×™×•×ª ×‘××œ××™</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card" onclick="openKPIDetailModal('totalOperations')">
                        <h3 class="text-gray-500 font-semibold">×¡×”"×› ×¤×¢×•×œ×•×ª (×›×œ ×”×–×× ×™×)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card col-span-full">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×™×œ×•×ª ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”</h3>
                        <div class="chart-container">
                            <canvas id="actionTypeChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card col-span-full">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª ×œ××•×¨×š ×–××Ÿ</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">×›×œ×œ ×”×¤×¢×•×œ×•×ª</h2>
                    <div class="mb-4 flex flex-col sm:flex-row gap-4">
                        <select id="main-table-filter" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-violet-300 focus:border-violet-500 transition-all flex-grow" onchange="renderAllOperationsTable()">
                            <option value="all">×›×œ ×”×”×–×× ×•×ª</option>
                            <option value="open_overdue">×¤×ª×•×— ×•×—×•×¨×’ ×‘×œ×‘×“</option>
                            <option value="closed">×¡×’×•×¨ ×‘×œ×‘×“</option>
                        </select>
                        <input type="text" id="global-table-search" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" placeholder="×—×™×¤×•×© ×›×œ×œ×™ ×‘×˜×‘×œ×”..." onkeyup="debounce(renderAllOperationsTable, 300)()">
                    </div>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-600">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200 rounded-tr-lg">
                                        ×ª××¨×™×š ğŸ“…
                                        <input type="text" data-column="×ª××¨×™×š ×”×–×× ×”" placeholder="×—×¤×© ×ª××¨×™×š..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×ª×¢×•×“×” ğŸ“„
                                        <input type="text" data-column="×ª×¢×•×“×”" placeholder="×—×¤×© ×ª×¢×•×“×”..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×©× ×œ×§×•×— ğŸ‘¤
                                        <input type="text" data-column="×©× ×œ×§×•×—" placeholder="×—×¤×© ×œ×§×•×—..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×©× ×¡×•×›×Ÿ ğŸ‘·
                                        <input type="text" data-column="×©× ×¡×•×›×Ÿ" placeholder="×—×¤×© ×¡×•×›×Ÿ..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×¡×•×’ ×¤×¢×•×œ×” ğŸ“¦
                                        <input type="text" data-column="×¡×•×’ ×¤×¢×•×œ×”" placeholder="×—×¤×© ×¤×¢×•×œ×”..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×™××™× ×‘×©×›×™×¨×•×ª â³
                                        <input type="text" data-column="×™××™× ×©×¢×‘×¨×•" placeholder="×—×¤×© ×™××™×..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">
                                        ×¡×˜×˜×•×¡ âœ…
                                        <input type="text" data-column="×¡×˜×˜×•×¡" placeholder="×—×¤×© ×¡×˜×˜×•×¡..." class="table-header-input">
                                    </th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200 rounded-tl-lg">×¤×¢×•×œ×•×ª ğŸ› ï¸</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                    <div id="no-filtered-results-message" class="text-center text-gray-600 mt-8 p-4 bg-white rounded-lg shadow-md hidden">
                        <p class="text-xl font-semibold mb-2">××™×Ÿ ×ª×•×¦××•×ª ×¢×‘×•×¨ ×”×—×™×¤×•×©/×¡×™× ×•×Ÿ ×”× ×•×›×—×™. ğŸ˜•</p>
                        <p>× ×¡×” ×œ×©× ×•×ª ××ª ×¤×¨××˜×¨×™ ×”×—×™×¤×•×© ××• ×”×¡×™× ×•×Ÿ.</p>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×‘×©×™××•×© ×¤×¢×™×œ</h2>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-600">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">××¡×¤×¨ ××›×•×œ×” ğŸ”¢</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×œ×§×•×— × ×•×›×—×™ ğŸ‘¤</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×ª××¨×™×š ×”×¦×‘×” ğŸ—“ï¸</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×™××™× ×‘××ª×¨ â³</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×”×™×¡×˜×•×¨×™×” ğŸ“œ</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h2>
                     <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-600">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">××¡×¤×¨ ××›×•×œ×” ğŸ”¢</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×ª××¨×™×š ×—×–×¨×” ×œ××œ××™ ğŸ—“ï¸</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×œ×§×•×— ××—×¨×•×Ÿ ğŸ‘¤</th>
                                    <th class="py-3 px-4 text-right font-bold border-b border-gray-200">×”×™×¡×˜×•×¨×™×” ğŸ“œ</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">×œ×•×— ×˜×™×¤×•×œ ×‘×œ×§×•×—×•×ª ×—×•×¨×’×™×</h2>
                <p class="text-gray-600 mb-6">×›××Ÿ ××¨×•×›×–×•×ª ×›×œ ×”××›×•×œ×•×ª ×©× ××¦××•×ª ××¦×œ ×œ×§×•×—×•×ª ××¢×œ 10 ×™××™ ×¢×‘×•×“×” ×•×“×•×¨×©×•×ª ×˜×™×¤×•×œ (×”×—×œ×¤×” ××• ×”×•×¦××”).</p>
                <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                </div>
                <div id="no-overdue-message" class="text-center text-gray-600 col-span-full hidden mt-8 p-4 bg-white rounded-lg shadow-md">
                    <p class="text-xl font-semibold mb-2">××™×Ÿ ×œ×§×•×—×•×ª ×‘×—×¨×™×’×” ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</p>
                    <p>×”×¦×•×•×ª ×¢×•×‘×“ × ×”×“×¨!</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="loader"></div>
        <p class="text-gray-700 text-lg mt-4 mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-4xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold" id="modal-customer-name"></h2>
                <button onclick="closeModal('customer-history-modal')" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">×¡×™×›×•× ×¤×¢×™×œ×•×ª</h3>
                <div id="modal-customer-summary" class="bg-gray-100 p-4 rounded-lg mb-4 text-gray-600 text-center"></div>
                <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200 text-gray-700">
                            <tr>
                                <th class="py-2 px-3 text-right">×ª××¨×™×š ğŸ—“ï¸</th>
                                <th class="py-2 px-3 text-right">×ª×¢×•×“×” ğŸ“„</th>
                                <th class="py-2 px-3 text-right">×¡×•×’ ×¤×¢×•×œ×” ğŸ“¦</th>
                                <th class="py-2 px-3 text-right">×¡×˜×˜×•×¡ âœ…</th>
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="divide-y divide-gray-200">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”</h2>
                <button onclick="closeModal('new-order-modal')" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <form id="new-order-form" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="new-order-customer-name" class="block text-sm font-medium text-gray-700">×©× ×œ×§×•×—</label>
                        <input type="text" id="new-order-customer-name" name="customerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                    </div>
                    <div>
                        <label for="new-order-agent-name" class="block text-sm font-medium text-gray-700">×©× ×¡×•×›×Ÿ</label>
                        <input type="text" id="new-order-agent-name" name="agentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                    </div>
                </div>
                <div>
                    <label for="new-order-container-number" class="block text-sm font-medium text-gray-700">××¡×¤×¨ ××›×•×œ×”</label>
                    <input type="text" id="new-order-container-number" name="containerNumber" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                </div>
                <div>
                    <label for="new-order-type" class="block text-sm font-medium text-gray-700">×¡×•×’ ×¤×¢×•×œ×”</label>
                    <select id="new-order-type" name="operationType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                        <option value="×”×¦×‘×”">×”×¦×‘×”</option>
                        <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                        <option value="×”×•×¦××”">×”×•×¦××”</option>
                    </select>
                </div>
                <div>
                    <label for="new-order-document" class="block text-sm font-medium text-gray-700">×ª×¢×•×“×”</label>
                    <input type="text" id="new-order-document" name="document" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500">
                </div>
                <div id="new-order-message-container" class="mt-4 p-4 rounded-lg text-sm hidden"></div>
                <div class="flex justify-end">
                    <button type="button" onclick="closeModal('new-order-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:bg-gray-300 transition-all mr-2">×‘×™×˜×•×œ</button>
                    <button type="submit" class="px-6 py-2 bg-violet-600 text-white rounded-lg shadow-md hover:bg-violet-700 transition-all">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-sm">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-xl font-bold" id="confirmation-modal-title"></h2>
                <button onclick="closeModal('confirmation-modal')" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <p id="confirmation-modal-message" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end">
                    <button id="confirmation-cancel-btn" onclick="closeModal('confirmation-modal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg shadow-sm hover:bg-gray-300 transition-all mr-2">×‘×™×˜×•×œ</button>
                    <button id="confirmation-confirm-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-all">××™×©×•×¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // This is the corrected way to access the global variable.
        let initialAuthToken = null;
        if (typeof __initial_auth_token !== 'undefined') {
            initialAuthToken = __initial_auth_token;
        }

        let app, db, auth;
        let isAuthReady = false;
        let userId = 'anonymous';

        // Globals for application state
        let allOperations = [];
        let containers = [];
        let allCustomers = new Map();
        let activeCharts = {};
        const DEBOUNCE_DELAY = 300;
        const MIN_OVERDUE_DAYS = 10;

        // Debounce function to limit expensive operations
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // Show/hide loading spinner
        function showLoader(message = '×˜×•×¢×Ÿ × ×ª×•× ×™×...') {
            document.getElementById('global-loader').classList.remove('hidden');
            document.getElementById('global-loader').classList.add('flex');
            document.getElementById('global-loader').querySelector('p').innerText = message;
        }

        function hideLoader() {
            document.getElementById('global-loader').classList.add('hidden');
            document.getElementById('global-loader').classList.remove('flex');
        }

        // Initialize Firebase and auth
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-display').innerText = `××—×•×‘×¨ ×›××©×ª××©: ${userId}`;
                            console.log(`User signed in: ${userId}`);
                            await fetchDataAndRender();
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                } else {
                    console.error("Firebase config is not available. Running in demo mode.");
                    userId = 'demo-user-1';
                    document.getElementById('user-display').innerText = `××—×•×‘×¨ ×›××©×ª××©: ${userId} (×“××•)`;
                    // If no Firebase, use mock data and set auth ready
                    isAuthReady = true;
                    await fetchDataAndRender();
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('user-display').innerText = `×©×’×™××ª ×—×™×‘×•×¨: ${error.message}`;
            }
        }
        
        async function changeUser() {
            showLoader("××—×œ×™×£ ××©×ª××©...");
            // In a real app, this would be a more complex sign-out/sign-in flow.
            // For this demo, we just switch the user ID to a different one.
            const newUserId = userId === 'demo-user-1' ? 'demo-user-2' : 'demo-user-1';
            userId = newUserId;
            document.getElementById('user-display').innerText = `××—×•×‘×¨ ×›××©×ª××©: ${userId} (×“××•)`;
            
            // Re-fetch data for the new user
            await fetchDataAndRender();
        }

        // Function to fetch data from Firestore and update all UI
        async function fetchDataAndRender() {
            showLoader();
            try {
                if (!db || !userId) {
                    console.warn("Firestore not initialized or userId not set. Cannot fetch data.");
                    return;
                }

                // Reference to the user's data collection
                const operationsCollection = collection(db, `artifacts/${appId}/users/${userId}/operations`);
                const containersCollection = collection(db, `artifacts/${appId}/users/${userId}/containers`);

                // Listen for real-time updates to the operations collection
                onSnapshot(operationsCollection, (snapshot) => {
                    allOperations = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        '×ª××¨×™×š ×”×–×× ×”': doc.data()['×ª××¨×™×š ×”×–×× ×”'] ? new Date(doc.data()['×ª××¨×™×š ×”×–×× ×”']) : null,
                        '×™××™× ×©×¢×‘×¨×•': calculateDays(doc.data()['×ª××¨×™×š ×”×–×× ×”']),
                        'isOverdue': calculateOverdue(doc.data()['×ª××¨×™×š ×”×–×× ×”'])
                    }));
                    allOperations.sort((a, b) => b['×ª××¨×™×š ×”×–×× ×”'] - a['×ª××¨×™×š ×”×–×× ×”']);
                    updateUI();
                });

                // Listen for real-time updates to the containers collection
                onSnapshot(containersCollection, (snapshot) => {
                    containers = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        '×ª××¨×™×š ×”×¦×‘×”': doc.data()['×ª××¨×™×š ×”×¦×‘×”'] ? new Date(doc.data()['×ª××¨×™×š ×”×¦×‘×”']) : null,
                        '×™××™× ×‘××ª×¨': doc.data()['×ª××¨×™×š ×”×¦×‘×”'] ? calculateDays(doc.data()['×ª××¨×™×š ×”×¦×‘×”']) : null
                    }));
                    updateUI();
                });
                
            } catch (e) {
                console.error("Error fetching documents:", e);
                hideLoader();
                showMessageModal('×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘.');
            }
        }

        // Helper functions
        function calculateDays(date) {
            if (!date) return 0;
            const diffTime = Math.abs(new Date() - new Date(date));
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function calculateOverdue(date) {
            if (!date) return false;
            return calculateDays(date) > MIN_OVERDUE_DAYS;
        }

        function showMessageModal(title, message) {
            document.getElementById('confirmation-modal-title').innerText = title;
            document.getElementById('confirmation-modal-message').innerText = message;
            document.getElementById('confirmation-confirm-btn').classList.add('hidden');
            document.getElementById('confirmation-cancel-btn').innerText = '×¡×’×•×¨';
            openModal('confirmation-modal');
        }

        // Main function to update all UI elements
        function updateUI() {
            renderKPIs();
            renderAllOperationsTable();
            renderInventoryTables();
            renderTreatmentBoard();
            renderCharts();
            hideLoader();
        }

        // Show/hide pages
        function showPage(pageId) {
            const pages = document.querySelectorAll('main section');
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');

            const navButtons = document.querySelectorAll('.nav-tab-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');

            if (pageId === 'inventory') {
                renderInventoryTables();
            }
            if (pageId === 'treatment') {
                renderTreatmentBoard();
            }
        }

        // Render KPI cards
        function renderKPIs() {
            const activeContainersCount = allOperations.filter(op => op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ').length;
            const overdueCustomersCount = new Set(allOperations.filter(op => op.isOverdue && op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ').map(op => op['×©× ×œ×§×•×—'])).size;
            const availableContainersCount = containers.filter(c => c['×¡×˜×˜×•×¡'] === '×¤× ×•×™').length;
            const totalOperationsCount = allOperations.length;

            document.getElementById('kpi-active-containers').innerText = activeContainersCount;
            document.getElementById('kpi-overdue-customers').innerText = overdueCustomersCount;
            document.getElementById('kpi-available-containers').innerText = availableContainersCount;
            document.getElementById('kpi-total-operations').innerText = totalOperationsCount;
        }

        // Render main operations table
        function renderAllOperationsTable() {
            const tableBody = document.getElementById('all-operations-table');
            const noResultsMessage = document.getElementById('no-filtered-results-message');
            tableBody.innerHTML = '';
            
            const globalSearchTerm = document.getElementById('global-table-search').value.toLowerCase().trim();
            const filterOption = document.getElementById('main-table-filter').value;

            // Get column filter terms
            const columnFilters = {};
            document.querySelectorAll('.table-header-input').forEach(input => {
                const column = input.dataset.column;
                const value = input.value.toLowerCase().trim();
                if (value) {
                    columnFilters[column] = value;
                }
            });

            const filteredOperations = allOperations.filter(op => {
                // Apply global search
                const matchesGlobal = globalSearchTerm === '' ||
                    Object.values(op).some(value => {
                        const stringValue = String(value).toLowerCase();
                        return stringValue.includes(globalSearchTerm);
                    });

                // Apply filter dropdown
                const matchesFilter = filterOption === 'all' ||
                    (filterOption === 'open_overdue' && op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ' && op.isOverdue) ||
                    (filterOption === 'closed' && op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨');

                // Apply column filters
                const matchesColumns = Object.keys(columnFilters).every(column => {
                    const value = op[column];
                    if (value instanceof Date) {
                        return value.toLocaleDateString('he-IL').includes(columnFilters[column]);
                    }
                    return String(value).toLowerCase().includes(columnFilters[column]);
                });

                return matchesGlobal && matchesFilter && matchesColumns;
            });
            
            if (filteredOperations.length === 0) {
                noResultsMessage.classList.remove('hidden');
                return;
            } else {
                noResultsMessage.classList.add('hidden');
            }

            filteredOperations.forEach(op => {
                const row = document.createElement('tr');
                let rowClass = '';
                if (op.isOverdue && op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ') {
                    rowClass = 'row-overdue';
                } else if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    rowClass = 'row-closed';
                } else if (op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”') {
                    rowClass = 'row-placement';
                } else if (op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×—×œ×¤×”') {
                    rowClass = 'row-exchange';
                } else if (op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¦××”') {
                    rowClass = 'row-removal';
                }
                
                row.className = rowClass;

                const statusText = op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨' ? '×¡×’×•×¨' : (op.isOverdue ? '×—×¨×™×’×”' : '×¤×¢×™×œ');
                const statusClass = op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨' ? 'status-gray' : (op.isOverdue ? 'status-red' : 'status-green');

                row.innerHTML = `
                    <td class="py-2 px-4 whitespace-nowrap">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['×ª×¢×•×“×”']}</td>
                    <td class="py-2 px-4 whitespace-nowrap"><button onclick="openCustomerHistoryModal('${op['×©× ×œ×§×•×—']}')" class="text-blue-600 hover:text-blue-800 font-semibold underline">${op['×©× ×œ×§×•×—']}</button></td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['×©× ×¡×•×›×Ÿ']}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                    <td class="py-2 px-4 whitespace-nowrap">${op['×™××™× ×©×¢×‘×¨×•']}</td>
                    <td class="py-2 px-4 whitespace-nowrap"><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="py-2 px-4 whitespace-nowrap">
                        <button onclick="editOperation('${op.id}')" class="text-blue-500 hover:text-blue-700 mx-1" title="×¢×¨×•×š"><i class="fas fa-edit"></i></button>
                        <button onclick="confirmDeleteOperation('${op.id}')" class="text-red-500 hover:text-red-700 mx-1" title="××—×§"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Render inventory tables
        function renderInventoryTables() {
            const inUseTable = document.getElementById('in-use-containers-table');
            const availableTable = document.getElementById('available-containers-table');
            inUseTable.innerHTML = '';
            availableTable.innerHTML = '';

            const activeContainers = containers.filter(c => c['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ');
            const availableContainers = containers.filter(c => c['×¡×˜×˜×•×¡'] === '×¤× ×•×™');

            activeContainers.forEach(c => {
                const row = document.createElement('tr');
                row.className = c['×™××™× ×‘××ª×¨'] > 90 ? 'bg-red-50' : '';
                row.innerHTML = `
                    <td class="py-2 px-4">${c['××¡×¤×¨ ××›×•×œ×”']}</td>
                    <td class="py-2 px-4"><button onclick="openCustomerHistoryModal('${c['×œ×§×•×— × ×•×›×—×™']}')" class="text-blue-600 hover:text-blue-800 font-semibold underline">${c['×œ×§×•×— × ×•×›×—×™']}</button></td>
                    <td class="py-2 px-4">${c['×ª××¨×™×š ×”×¦×‘×”'] ? c['×ª××¨×™×š ×”×¦×‘×”'].toLocaleDateString('he-IL') : 'N/A'}</td>
                    <td class="py-2 px-4">${c['×™××™× ×‘××ª×¨']}</td>
                    <td class="py-2 px-4"><button onclick="openContainerHistoryModal('${c['××¡×¤×¨ ××›×•×œ×”']}')" class="text-gray-600 hover:text-gray-800"><i class="fas fa-history"></i></button></td>
                `;
                inUseTable.appendChild(row);
            });

            availableContainers.forEach(c => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4">${c['××¡×¤×¨ ××›×•×œ×”']}</td>
                    <td class="py-2 px-4">${c['×ª××¨×™×š ×—×–×¨×” ×œ××œ××™'] ? new Date(c['×ª××¨×™×š ×—×–×¨×” ×œ××œ××™']).toLocaleDateString('he-IL') : 'N/A'}</td>
                    <td class="py-2 px-4">${c['×œ×§×•×— ××—×¨×•×Ÿ'] || 'N/A'}</td>
                    <td class="py-2 px-4"><button onclick="openContainerHistoryModal('${c['××¡×¤×¨ ××›×•×œ×”']}')" class="text-gray-600 hover:text-gray-800"><i class="fas fa-history"></i></button></td>
                `;
                availableTable.appendChild(row);
            });
        }

        // Render treatment board
        function renderTreatmentBoard() {
            const board = document.getElementById('treatment-board');
            const noOverdueMessage = document.getElementById('no-overdue-message');
            board.innerHTML = '';
            const overdueOperations = allOperations.filter(op => op.isOverdue && op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ');
            
            if (overdueOperations.length === 0) {
                noOverdueMessage.classList.remove('hidden');
                board.classList.add('hidden');
            } else {
                noOverdueMessage.classList.add('hidden');
                board.classList.remove('hidden');

                const customers = {};
                overdueOperations.forEach(op => {
                    const customerName = op['×©× ×œ×§×•×—'];
                    if (!customers[customerName]) {
                        customers[customerName] = [];
                    }
                    customers[customerName].push(op);
                });

                for (const customer in customers) {
                    const customerCard = document.createElement('div');
                    customerCard.className = 'p-6 bg-white rounded-lg shadow-md border-r-4 border-red-500';
                    const opsList = customers[customer].map(op => `
                        <li class="mt-2 text-gray-600">
                            <span class="font-bold">××›×•×œ×” #${op['××¡×¤×¨ ××›×•×œ×”']}:</span> ×‘××§×•×
                            <span class="font-bold text-red-600">${op['×™××™× ×©×¢×‘×¨×•']} ×™××™×</span>.
                            <button onclick="handleTreatment('${op.id}')" class="float-left text-sm text-blue-500 hover:text-blue-700 underline">×˜×¤×œ</button>
                        </li>
                    `).join('');
                    customerCard.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-700 mb-2">${customer}</h3>
                        <p class="text-sm text-red-500 mb-4">×—×¨×™×’×” ×©×œ ${customers[customer].length} ××›×•×œ×•×ª</p>
                        <ul class="list-disc pr-5">
                            ${opsList}
                        </ul>
                    `;
                    board.appendChild(customerCard);
                }
            }
        }

        // Handle treatment logic
        function handleTreatment(operationId) {
            const operation = allOperations.find(op => op.id === operationId);
            if (!operation) return;
            const message = `××™×–×• ×¤×¢×•×œ×” ×ª×¨×¦×” ×œ×‘×¦×¢ ×¢×‘×•×¨ ×”××›×•×œ×” ×©×œ ×”×œ×§×•×— ${operation['×©× ×œ×§×•×—']} (××›×•×œ×” #${operation['××¡×¤×¨ ××›×•×œ×”']})?`;
            
            document.getElementById('confirmation-modal-title').innerText = '×˜×™×¤×•×œ ×‘×—×¨×™×’×”';
            document.getElementById('confirmation-modal-message').innerText = message;
            
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            const cancelBtn = document.getElementById('confirmation-cancel-btn');
            
            confirmBtn.classList.remove('hidden');
            cancelBtn.innerText = '×”×—×œ×¤×”';
            confirmBtn.innerText = '×”×•×¦××”';
            
            confirmBtn.onclick = async () => {
                await updateOperationStatus(operationId, '×”×•×¦××”');
                closeModal('confirmation-modal');
            };
            cancelBtn.onclick = async () => {
                await updateOperationStatus(operationId, '×”×—×œ×¤×”');
                closeModal('confirmation-modal');
            };

            openModal('confirmation-modal');
        }

        // Update operation status
        async function updateOperationStatus(opId, newType) {
            if (!db || !userId) return;
            try {
                const opRef = doc(db, `artifacts/${appId}/users/${userId}/operations`, opId);
                await updateDoc(opRef, {
                    '×¡×•×’ ×¤×¢×•×œ×”': newType,
                    '×¡×˜×˜×•×¡': '×¡×’×•×¨'
                });
                showMessageModal('×”×¦×œ×—×”', '×¡×˜×˜×•×¡ ×”×¤×¢×•×œ×” ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessageModal('×©×’×™××”', `×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¤×¢×•×œ×”: ${e.message}`);
            }
            hideLoader();
        }
        
        // Render Charts
        function renderCharts() {
            // Destroy existing charts to prevent duplication
            for (const chartId in activeCharts) {
                if (activeCharts[chartId]) {
                    activeCharts[chartId].destroy();
                }
            }
            activeCharts = {};

            // Chart 1: Activity by Action Type
            const actionTypeCtx = document.getElementById('actionTypeChart');
            const actionTypeCounts = allOperations.reduce((acc, op) => {
                acc[op['×¡×•×’ ×¤×¢×•×œ×”']] = (acc[op['×¡×•×’ ×¤×¢×•×œ×”']] || 0) + 1;
                return acc;
            }, {});
            activeCharts.actionTypeChart = new Chart(actionTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(actionTypeCounts),
                    datasets: [{
                        label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                        data: Object.values(actionTypeCounts),
                        backgroundColor: ['#4ade80', '#facc15', '#ef4444'], // Green, Yellow, Red
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: {
                            display: false,
                            text: '×¤×¢×™×œ×•×ª ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×”'
                        }
                    }
                }
            });

            // Chart 2: Operations over time
            const operationsTimelineCtx = document.getElementById('operationsTimelineChart');
            const monthlyOperations = allOperations.reduce((acc, op) => {
                if (op['×ª××¨×™×š ×”×–×× ×”']) {
                    const month = op['×ª××¨×™×š ×”×–×× ×”'].toISOString().substring(0, 7); // YYYY-MM format
                    acc[month] = (acc[month] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedMonths = Object.keys(monthlyOperations).sort();
            activeCharts.operationsTimelineChart = new Chart(operationsTimelineCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                        data: sortedMonths.map(month => monthlyOperations[month]),
                        borderColor: '#6d28d9',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Open/close modals
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Handle new order submission
        async function handleNewOrderForm(event) {
            event.preventDefault();
            if (!db || !userId) {
                showMessageModal('×©×’×™××”', '×©×’×™××ª ×—×™×‘×•×¨. ×× × ×¨×¢× ×Ÿ ××ª ×”×¢××•×“.');
                return;
            }
            showLoader("×©×•××¨ × ×ª×•× ×™×...");

            const form = event.target;
            const newOrder = {
                '×©× ×œ×§×•×—': form.elements['customerName'].value,
                '×©× ×¡×•×›×Ÿ': form.elements['agentName'].value,
                '××¡×¤×¨ ××›×•×œ×”': form.elements['containerNumber'].value,
                '×¡×•×’ ×¤×¢×•×œ×”': form.elements['operationType'].value,
                '×ª×¢×•×“×”': form.elements['document'].value,
                '×ª××¨×™×š ×”×–×× ×”': new Date().toISOString(),
                '×¡×˜×˜×•×¡': '×¤×¢×™×œ'
            };

            const isPlacement = newOrder['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”';
            const isRemoval = newOrder['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¦××”';

            try {
                // Check if container exists
                const containerRef = doc(db, `artifacts/${appId}/users/${userId}/containers`, newOrder['××¡×¤×¨ ××›×•×œ×”']);
                const containerSnap = await getDoc(containerRef);

                if (isPlacement) {
                    if (containerSnap.exists() && containerSnap.data()['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ') {
                         showMessageModal('×©×’×™××”', `××›×•×œ×” #${newOrder['××¡×¤×¨ ××›×•×œ×”']} ×›×‘×¨ × ××¦××ª ×‘×©×™××•×© ×¤×¢×™×œ.`);
                         hideLoader();
                         return;
                    }
                    // Add/update container as active
                    await updateDoc(containerRef, {
                        '××¡×¤×¨ ××›×•×œ×”': newOrder['××¡×¤×¨ ××›×•×œ×”'],
                        '×œ×§×•×— × ×•×›×—×™': newOrder['×©× ×œ×§×•×—'],
                        '×ª××¨×™×š ×”×¦×‘×”': newOrder['×ª××¨×™×š ×”×–×× ×”'],
                        '×¡×˜×˜×•×¡': '×¤×¢×™×œ'
                    }, { merge: true });

                } else if (isRemoval) {
                    if (!containerSnap.exists() || containerSnap.data()['×¡×˜×˜×•×¡'] === '×¤× ×•×™') {
                        showMessageModal('×©×’×™××”', `××›×•×œ×” #${newOrder['××¡×¤×¨ ××›×•×œ×”']} ×›×‘×¨ ×¤× ×•×™×” ××• ×œ× ×§×™×™××ª.`);
                        hideLoader();
                        return;
                    }
                    // Update container as available
                    await updateDoc(containerRef, {
                        '×¡×˜×˜×•×¡': '×¤× ×•×™',
                        '×ª××¨×™×š ×—×–×¨×” ×œ××œ××™': newOrder['×ª××¨×™×š ×”×–×× ×”'],
                        '×œ×§×•×— ××—×¨×•×Ÿ': newOrder['×©× ×œ×§×•×—'],
                        '×œ×§×•×— × ×•×›×—×™': null,
                        '×ª××¨×™×š ×”×¦×‘×”': null
                    }, { merge: true });
                }

                // Add the new operation
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/operations`), newOrder);

                form.reset();
                closeModal('new-order-modal');
                showMessageModal('×”×¦×œ×—×”', '×”×”×–×× ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!');
            } catch (e) {
                console.error("Error adding document:", e);
                showMessageModal('×©×’×™××”', `×©×’×™××” ×‘×”×•×¡×¤×ª ×”×”×–×× ×”: ${e.message}`);
            }
            hideLoader();
        }

        // Open new order modal
        function openNewOrderModal() {
            openModal('new-order-modal');
        }

        // Confirm delete operation
        function confirmDeleteOperation(opId) {
            document.getElementById('confirmation-modal-title').innerText = '××™×©×•×¨ ××—×™×§×”';
            document.getElementById('confirmation-modal-message').innerText = '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¢×•×œ×” ×–×•?';
            const confirmBtn = document.getElementById('confirmation-confirm-btn');
            confirmBtn.classList.remove('hidden');
            confirmBtn.innerText = '××—×§';
            confirmBtn.onclick = () => deleteOperation(opId);
            document.getElementById('confirmation-cancel-btn').innerText = '×‘×™×˜×•×œ';
            openModal('confirmation-modal');
        }
        
        // Delete operation
        async function deleteOperation(opId) {
            if (!db || !userId) return;
            try {
                showLoader("××•×—×§ ×¤×¢×•×œ×”...");
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/operations`, opId));
                closeModal('confirmation-modal');
                showMessageModal('×”×¦×œ×—×”', '×”×¤×¢×•×œ×” × ××—×§×” ×‘×”×¦×œ×—×”!');
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessageModal('×©×’×™××”', `×©×’×™××” ×‘××—×™×§×ª ×”×¤×¢×•×œ×”: ${e.message}`);
            }
            hideLoader();
        }

        // Open customer history modal
        function openCustomerHistoryModal(customerName) {
            const customerOps = allOperations.filter(op => op['×©× ×œ×§×•×—'] === customerName);
            document.getElementById('modal-customer-name').innerText = `×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª ×©×œ ${customerName}`;
            
            const totalOps = customerOps.length;
            const openOps = customerOps.filter(op => op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ').length;
            const overdueOps = customerOps.filter(op => op.isOverdue && op['×¡×˜×˜×•×¡'] === '×¤×¢×™×œ').length;

            let summaryText = `×¡×”"×› ×¤×¢×•×œ×•×ª: ${totalOps}`;
            if (openOps > 0) {
                summaryText += `, ××ª×•×›×Ÿ ${openOps} ×¤×ª×•×—×•×ª`;
            }
            if (overdueOps > 0) {
                summaryText += `, ×•- ${overdueOps} ×‘×—×¨×™×’×”.`;
            } else {
                summaryText += `. ××™×Ÿ ×—×¨×™×’×•×ª ×›×¨×’×¢.`;
            }

            document.getElementById('modal-customer-summary').innerText = summaryText;

            const historyTable = document.getElementById('modal-customer-history-table');
            historyTable.innerHTML = '';
            customerOps.forEach(op => {
                const days = op['×™××™× ×©×¢×‘×¨×•'];
                let displayStatusText, displayStatusClass;
                if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    displayStatusText = '×¡×’×•×¨'; displayStatusClass = 'status-gray';
                } else if (op.isOverdue) {
                    displayStatusText = '×—×¨×™×’×”'; displayStatusClass = 'status-red';
                } else {
                    displayStatusText = '×¤×¢×™×œ'; displayStatusClass = 'status-green';
                }
                const row = `
                    <tr>
                        <td class="py-2 px-3">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-2 px-3">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-2 px-3">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-2 px-3"><span class="status-badge ${displayStatusClass}">${displayStatusText}</span></td>
                    </tr>`;
                historyTable.innerHTML += row;
            });

            openModal('customer-history-modal');
        }

        // Initialize application
        window.onload = function() {
            initializeFirebase();
            setInterval(updateTime, 1000);
            showPage('dashboard');
            document.getElementById('new-order-form').addEventListener('submit', handleNewOrderForm);
        };

        function updateTime() {
            const now = new Date();
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-time').innerText = now.toLocaleTimeString('he-IL', timeOptions);
            document.getElementById('current-date').innerText = now.toLocaleDateString('he-IL', dateOptions);
        }

        window.showPage = showPage;
        window.openNewOrderModal = openNewOrderModal;
        window.openCustomerHistoryModal = openCustomerHistoryModal;
        window.confirmDeleteOperation = confirmDeleteOperation;
        window.closeModal = closeModal;
        window.debounce = debounce;
        window.changeUser = changeUser;
        window.renderAllOperationsTable = debounce(renderAllOperationsTable, DEBOUNCE_DELAY);

    </script>
</body>
</html>
