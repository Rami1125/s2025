<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Assistant for a clean Hebrew font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        /* Navigation tab button styling */
        .nav-tab-btn {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            position: relative;
            overflow: hidden;
            flex-grow: 1; /* Make buttons take equal width */
            text-align: center;
        }
        /* Active navigation tab button styling */
        .nav-tab-btn.active {
            border-bottom-color: #8b5cf6; /* violet-500 */
            color: #6d28d9; /* violet-700 */
        }
        /* Hover effect for inactive navigation tab buttons */
        .nav-tab-btn:not(.active):hover {
            color: #6d28d9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
            background-color: rgba(139, 92, 246, 0.05);
            border-radius: 0.5rem;
        }

        /* KPI card styling */
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        /* Hover effect for KPI cards */
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Modal overlay styling */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            backdrop-filter: blur(5px); /* Blurred background for modal */
            animation: fadeIn 0.3s ease-out;
        }
        /* Modal content styling */
        .modal-content {
            max-height: 90vh;
            animation: slideInFromTop 0.3s ease-out;
            transform-origin: top;
        }
        /* Chart container styling for responsiveness */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 400px;
        }
        /* Kanban column styling */
        .kanban-column {
            min-height: 200px;
        }
        /* Status badge styling */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        /* Specific status badge colors */
        .status-green { background-color: #dcfce7; color: #166534; }
        .status-yellow { background-color: #fef9c3; color: #854d0e; }
        .status-red { background-color: #fee2e2; color: #991b1b; }
        .status-gray { background-color: #f3f4f6; color: #4b5563; }

        /* Custom styles for larger and bolder table text */
        .table-large-text td { 
            font-size: 1.1rem; 
            font-weight: 700;
        }
        /* Typing effect cursor styling */
        .typing-effect-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: black;
            animation: blink-caret 0.75s step-end infinite;
            vertical-align: middle;
        }
        /* Keyframe animation for blinking cursor */
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: black }
        }

        /* Animations for modals */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading spinner styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #6d28d9; /* Violet */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">××¢×¨×›×ª × ×™×”×•×œ ××›×•×œ×•×ª</h1>
            <p class="text-lg text-gray-600">×œ×•×— ×‘×§×¨×” ××¨×›×–×™ ×œ× ×™×”×•×œ, ××¢×§×‘ ×•× ×™×ª×•×— ×¤×¢×™×œ×•×ª</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-gray-200 mb-8 rounded-lg shadow-sm">
            <button id="nav-dashboard" class="nav-tab-btn active text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt mr-2"></i>×œ×•×— ×‘×§×¨×”
            </button>
            <button id="nav-inventory" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('inventory')">
                <i class="fas fa-boxes-stacked mr-2"></i>××œ××™ ××›×•×œ×•×ª
            </button>
            <button id="nav-treatment" class="nav-tab-btn text-lg font-semibold px-6 py-3 rounded-t-lg" onclick="showPage('treatment')">
                <i class="fas fa-clipboard-check mr-2"></i>×œ×•×— ×˜×™×¤×•×œ ×‘×—×¨×™×’×•×ª
            </button>
        </nav>

        <!-- Page Content -->
        <main>
            <!-- Dashboard Page -->
            <section id="page-dashboard" class="space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">×¡×§×™×¨×” ×›×œ×œ×™×ª</h2>
                    <button onclick="openNewOrderModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>×”×–×× ×” ×—×“×©×”
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª ×‘××ª×¨×™×</h3>
                        <p id="kpi-active-containers" class="text-4xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">×œ×§×•×—×•×ª ×‘×—×¨×™×’×” <span class="text-xs">(××¢×œ 10 ×™××™×)</span></h3>
                        <p id="kpi-overdue-customers" class="text-4xl font-bold text-red-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">××›×•×œ×•×ª ×¤× ×•×™×•×ª ×‘××œ××™</h3>
                        <p id="kpi-available-containers" class="text-4xl font-bold text-green-600 mt-2">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-gray-500 font-semibold">×¡×”"×› ×¤×¢×•×œ×•×ª (×›×œ ×”×–×× ×™×)</h3>
                        <p id="kpi-total-operations" class="text-4xl font-bold text-gray-700 mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×™×œ×•×ª ×œ×¤×™ ×¡×•×›×Ÿ</h3>
                        <div class="chart-container">
                            <canvas id="agentActivityChart"></canvas>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">×¤×¢×•×œ×•×ª ×œ××•×¨×š ×–××Ÿ</h3>
                         <div class="chart-container">
                            <canvas id="operationsTimelineChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">×›×œ×œ ×”×¤×¢×•×œ×•×ª</h2>
                     <div class="flex items-center mb-4">
                        <i class="fas fa-search text-gray-400 mr-3"></i>
                        <input type="text" id="main-search" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" placeholder="×—×¤×© ×œ×¤×™ ×©× ×œ×§×•×—, ×ª×¢×•×“×”, ×©× ×¡×•×›×Ÿ...">
                    </div>
                    <div class="overflow-x-auto rounded-lg shadow-sm">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×ª××¨×™×š ğŸ“…</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×ª×¢×•×“×” ğŸ“„</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×©× ×œ×§×•×— ğŸ‘¤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×©× ×¡×•×›×Ÿ ğŸ‘·</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×¡×•×’ ×¤×¢×•×œ×” ğŸ“¦</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×™××™× ×‘×©×›×™×¨×•×ª â³</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×¡×˜×˜×•×¡ âœ…</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×¤×¢×•×œ×•×ª ğŸ› ï¸</th>
                                </tr>
                            </thead>
                            <tbody id="all-operations-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="page-inventory" class="hidden space-y-8">
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×‘×©×™××•×© ×¤×¢×™×œ</h2>
                    <div class="overflow-x-auto rounded-lg shadow-sm">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">××¡×¤×¨ ××›×•×œ×” ğŸ”¢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×œ×§×•×— × ×•×›×—×™ ğŸ‘¤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×ª××¨×™×š ×”×¦×‘×” ğŸ—“ï¸</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×™××™× ×‘××ª×¨ â³</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×”×™×¡×˜×•×¨×™×” ğŸ“œ</th>
                                </tr>
                            </thead>
                            <tbody id="in-use-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="kpi-card">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">××›×•×œ×•×ª ×¤× ×•×™×•×ª</h2>
                     <div class="overflow-x-auto rounded-lg shadow-sm">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">××¡×¤×¨ ××›×•×œ×” ğŸ”¢</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×ª××¨×™×š ×—×–×¨×” ×œ××œ××™ ğŸ—“ï¸</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×œ×§×•×— ××—×¨×•×Ÿ ğŸ‘¤</th>
                                    <th class="py-3 px-4 text-right font-bold text-gray-600">×”×™×¡×˜×•×¨×™×” ğŸ“œ</th>
                                </tr>
                            </thead>
                            <tbody id="available-containers-table" class="table-large-text divide-y divide-gray-200">
                                <!-- Data will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Treatment Page -->
            <section id="page-treatment" class="hidden">
                 <h2 class="text-2xl font-bold text-gray-700 mb-4">×œ×•×— ×˜×™×¤×•×œ ×‘×œ×§×•×—×•×ª ×—×•×¨×’×™×</h2>
                 <p class="text-gray-600 mb-6">×›××Ÿ ××¨×•×›×–×•×ª ×›×œ ×”××›×•×œ×•×ª ×©× ××¦××•×ª ××¦×œ ×œ×§×•×—×•×ª ××¢×œ 10 ×™××™ ×¢×‘×•×“×” ×•×“×•×¨×©×•×ª ×˜×™×¤×•×œ (×”×—×œ×¤×” ××• ×”×•×¦××”).</p>
                 <div id="treatment-board" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Kanban columns will be populated by JS -->
                 </div>
                 <div id="no-overdue-message" class="text-center text-gray-600 col-span-full hidden mt-8 p-4 bg-white rounded-lg shadow-md">
                     <p class="text-xl font-semibold mb-2">××™×Ÿ ×œ×§×•×—×•×ª ×‘×—×¨×™×’×” ×›×¨×’×¢. ×›×œ ×”×›×‘×•×“! ğŸ‰</p>
                     <p>×”×¦×•×•×ª ×¢×•×‘×“ × ×”×“×¨!</p>
                 </div>
            </section>
        </main>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center hidden z-[100]">
        <div class="loader"></div>
        <p class="text-gray-700 text-lg mt-4 mr-4">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
    </div>

    <!-- Customer History Modal -->
    <div id="customer-history-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-4xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold" id="modal-customer-name"></h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">×¡×™×›×•× ×¤×¢×™×œ×•×ª</h3>
                <div id="modal-customer-summary" class="grid grid-cols-3 gap-4 mb-6 bg-blue-50 p-4 rounded-md text-blue-800 font-medium"></div>
                 <h3 class="text-lg font-semibold mb-2 text-gray-700">××›×•×œ×•×ª ×©×©×•×™×›×• ×œ×œ×§×•×—</h3>
                <div id="modal-customer-containers" class="mb-6 p-3 bg-gray-50 rounded-md text-gray-700">
                    <p id="customer-container-list" class="font-mono text-sm"></p>
                </div>
                <h3 class="text-lg font-semibold mb-2 text-gray-700">×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×•×œ×•×ª</h3>
                <div class="overflow-y-auto max-h-96 rounded-md border border-gray-200">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="py-2 px-3 text-right text-gray-600">×ª××¨×™×š ğŸ“…</th>
                                <th class="py-2 px-3 text-right text-gray-600">×ª×¢×•×“×” ğŸ“„</th>
                                <th class="py-2 px-3 text-right text-gray-600">×¤×¢×•×œ×” ğŸ“¦</th>
                                <th class="py-2 px-3 text-right text-gray-600">×¡×˜×˜×•×¡ âœ…</th>
                            </tr>
                        </thead>
                        <tbody id="modal-customer-history-table" class="table-large-text divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-left rounded-b-lg">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Modal -->
    <div id="whatsapp-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-xl">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">×©×œ×™×—×ª ×”×•×“×¢×ª WhatsApp</h2>
                <button onclick="closeModalWhatsApp()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="whatsapp-phone-input" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ×˜×œ×¤×•×Ÿ:</label>
                    <input type="text" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" placeholder="9725XXXXXXXX">
                    <p id="phone-error" class="text-red-500 text-sm mt-1 hidden">××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××™× ×• ×ª×§×™×Ÿ.</p>
                </div>
                 <div class="mb-4">
                    <button onclick="toggleMessageOptions()" class="w-full text-right bg-gray-100 p-3 rounded-md font-semibold text-gray-700 flex justify-between items-center hover:bg-gray-200 transition-colors">
                        <span>×‘×—×¨ ×”×•×“×¢×” ××•×‘× ×™×ª</span>
                        <i id="message-options-toggle-icon" class="fas fa-chevron-down transform transition-transform"></i>
                    </button>
                    <div id="whatsapp-message-options-container" class="hidden mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto bg-white shadow-inner">
                        <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200 sticky top-0 bg-white" placeholder="×—×¤×© ×”×•×“×¢×”..." onkeyup="filterMessageOptions()">
                        <div id="message-options-list"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="whatsapp-message-textarea" class="block text-sm font-semibold text-gray-700 mb-1">×ª×•×›×Ÿ ×”×”×•×“×¢×”:</label>
                     <div class="border border-gray-300 rounded-md p-3 min-h-[100px] bg-gray-50 mb-2 overflow-y-auto max-h-48 relative">
                        <span id="typing-effect-display" class="whitespace-pre-wrap text-gray-800"></span><span class="typing-effect-cursor">|</span>
                    </div>
                    <textarea id="whatsapp-message-textarea" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-300 focus:border-green-500 transition-all" rows="5" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×•×“×¢×” ××™×©×™×ª..."></textarea>
                </div>
                <input type="hidden" id="whatsapp-doc-id">
                <div class="flex justify-end">
                    <button onclick="sendWhatsAppMessage()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors flex items-center">
                        <i class="fab fa-whatsapp mr-2"></i>×©×œ×— ×”×•×“×¢×”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Order Modal -->
    <div id="new-order-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-2xl font-bold">×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”</h2>
                <button onclick="closeNewOrderModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-light leading-none">&times;</button>
            </div>
            <div class="p-6">
                <form id="new-order-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label for="new-order-date" class="block text-sm font-semibold text-gray-700 mb-1">×ª××¨×™×š ×”×–×× ×” <span class="text-red-500">*</span></label>
                        <input type="date" id="new-order-date" name="×ª××¨×™×š ×”×–×× ×”" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-docid" class="block text-sm font-semibold text-gray-700 mb-1">×ª×¢×•×“×” <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-docid" name="×ª×¢×•×“×”" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                        <p id="docid-error" class="text-red-500 text-sm mt-1 hidden">××¡×¤×¨ ×ª×¢×•×“×” ×–×” ×›×‘×¨ ×§×™×™×.</p>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-agent" class="block text-sm font-semibold text-gray-700 mb-1">×©× ×¡×•×›×Ÿ</label>
                        <input type="text" id="new-order-agent" name="×©× ×¡×•×›×Ÿ" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-customer-name" class="block text-sm font-semibold text-gray-700 mb-1">×©× ×œ×§×•×— <span class="text-red-500">*</span></label>
                        <input type="text" id="new-order-customer-name" name="×©× ×œ×§×•×—" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-address" class="block text-sm font-semibold text-gray-700 mb-1">×›×ª×•×‘×ª</label>
                        <input type="text" id="new-order-address" name="×›×ª×•×‘×ª" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-action-type" class="block text-sm font-semibold text-gray-700 mb-1">×¡×•×’ ×¤×¢×•×œ×” <span class="text-red-500">*</span></label>
                        <select id="new-order-action-type" name="×¡×•×’ ×¤×¢×•×œ×”" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="">×‘×—×¨ ×¤×¢×•×œ×”</option>
                            <option value="×”×¦×‘×”">×”×¦×‘×”</option>
                            <option value="×”×—×œ×¤×”">×”×—×œ×¤×”</option>
                            <option value="×”×•×¦××”">×”×•×¦××”</option>
                            <option value="×”×–×–×”">×”×–×–×”</option>
                            <option value="×¤×™× ×•×™ ×‘××§×•×">×¤×™× ×•×™ ×‘××§×•×</option>
                            <option value="×’×™×©×” ×œ×œ× ×¤×¢×•×œ×”">×’×™×©×” ×œ×œ× ×¤×¢×•×œ×”</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-status" class="block text-sm font-semibold text-gray-700 mb-1">×¡×˜×˜×•×¡ <span class="text-red-500">*</span></label>
                        <select id="new-order-status" name="×¡×˜×˜×•×¡" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" required>
                            <option value="×¤×ª×•×—">×¤×ª×•×—</option>
                            <option value="×—×•×¨×’">×—×•×¨×’</option>
                            <option value="×¡×’×•×¨">×¡×’×•×¨</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-dropped" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”</label>
                        <input type="text" id="new-order-container-dropped" name="××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-container-lifted" class="block text-sm font-semibold text-gray-700 mb-1">××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”</label>
                        <input type="text" id="new-order-container-lifted" name="××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-expected-end-date" class="block text-sm font-semibold text-gray-700 mb-1">×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™</label>
                        <input type="date" id="new-order-expected-end-date" name="×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-1">
                        <label for="new-order-phone" class="block text-sm font-semibold text-gray-700 mb-1">×˜×œ×¤×•×Ÿ ×œ×§×•×—</label>
                        <input type="tel" id="new-order-phone" name="×˜×œ×¤×•×Ÿ ×œ×§×•×—" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all">
                    </div>
                    <div class="col-span-2">
                        <label for="new-order-notes" class="block text-sm font-semibold text-gray-700 mb-1">×”×¢×¨×•×ª</label>
                        <textarea id="new-order-notes" name="×”×¢×¨×•×ª" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-violet-300 focus:border-violet-500 transition-all" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="p-4 bg-gray-50 text-left flex justify-end gap-2 rounded-b-lg">
                <button onclick="closeNewOrderModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">×‘×™×˜×•×œ</button>
                <button onclick="submitNewOrder()" class="px-4 py-2 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600 transition-colors">×”×•×¡×£ ×”×–×× ×”</button>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        // Global state variables
        let allOperations = []; // Stores all operations, with dates parsed as Date objects
        let historicalOperations = []; // Static historical data (from rawDataString)
        let charts = {}; // Stores Chart.js instances
        let isLoadingData = false; // Flag to indicate data loading state
        let typingInterval; // Interval for typing effect
        let currentMessageFullText = ''; // Full text for typing effect
        let typingIndex = 0; // Current index for typing effect

        // Utility functions
        /**
         * Parses a date string into a Date object. Handles 'YYYY-MM-DD' and 'DD/MM/YYYY'.
         * @param {string} dateStr - The date string to parse.
         * @returns {Date|null} A Date object if successful, otherwise null.
         */
        const formatDate = (dateStr) => {
            if (!dateStr) return null;
            // Handle YYYY-MM-DD format
            if (dateStr.includes('-') && dateStr.split('-').length === 3) {
                const date = new Date(dateStr);
                return isNaN(date.getTime()) ? null : date;
            }
            // Handle DD/MM/YYYY format
            if (dateStr.includes('/') && dateStr.split('/').length === 3) {
                const parts = dateStr.split('/');
                const date = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // Assumes DD/MM/YYYY
                return isNaN(date.getTime()) ? null : date;
            }
            return null;
        };

        /**
         * Formats a Date object into a 'YYYY-MM-DD' string.
         * @param {Date|null} dateObj - The Date object to format.
         * @returns {string} The formatted date string, or empty string if invalid.
         */
        const formatISODate = (dateObj) => {
            if (!dateObj || isNaN(dateObj.getTime())) return '';
            return dateObj.toISOString().split('T')[0];
        };

        /**
         * Calculates the number of days between a given date and today.
         * @param {Date|null} date - The reference Date object.
         * @returns {number} The number of full days passed, or 0 if date is invalid.
         */
        const daysSince = (date) => {
            if (!date || isNaN(date.getTime())) return 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today to start of day
            const opDate = new Date(date);
            opDate.setHours(0, 0, 0, 0); // Normalize opDate to start of day

            const diff = today.getTime() - opDate.getTime();
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };

        /**
         * Debounces a function call.
         * @param {Function} func - The function to debounce.
         * @param {number} delay - The delay in milliseconds.
         * @returns {Function} The debounced function.
         */
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // Global functions for HTML onclick attributes
        /**
         * Shows the specified page (tab) and updates navigation button active state.
         * @param {string} pageId - The ID of the page to show ('dashboard', 'inventory', 'treatment').
         */
        const showPage = (pageId) => {
            ['dashboard', 'inventory', 'treatment'].forEach(id => {
                document.getElementById(`page-${id}`).classList.add('hidden');
                document.getElementById(`nav-${id}`).classList.remove('active');
            });
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            document.getElementById(`nav-${pageId}`).classList.add('active');

            // Hide the 'no overdue' message if not on the treatment page
            if (pageId !== 'treatment') {
                document.getElementById('no-overdue-message').classList.add('hidden');
            }
        };

        /**
         * Attempts to extract an Israeli city name from an address string.
         * @param {string} address - The address string.
         * @returns {string|null} The city name if found, otherwise null.
         */
        const getCityFromAddress = (address) => {
            if (!address) return null;
            const israeliCities = [
                "×ª×œ ××‘×™×‘", "×™×¨×•×©×œ×™×", "×—×™×¤×”", "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ", "×¤×ª×— ×ª×§×•×•×”", "××©×“×•×“", "×‘××¨ ×©×‘×¢",
                "× ×ª× ×™×”", "×‘× ×™ ×‘×¨×§", "×—×•×œ×•×Ÿ", "×¨××ª ×’×Ÿ", "×¨×—×•×‘×•×ª", "××©×§×œ×•×Ÿ", "×‘×ª ×™×", "×”×¨×¦×œ×™×”",
                "×›×¤×¨ ×¡×‘×", "×—×“×¨×”", "×‘×™×ª ×©××©", "××•×“×™×¢×™×Ÿ-××›×‘×™×-×¨×¢×•×ª", "×œ×•×“", "×¨××œ×”", "×¨×¢× × ×”",
                "× ×”×¨×™×”", "×§×¨×™×™×ª ×’×ª", "××™×œ×ª", "×¢×›×•", "×¦×¤×ª", "×˜×‘×¨×™×”", "× ×¦×¨×ª", "××•× ××œ-×¤××—×",
                "×‘× ×™ ×¦×™×•×Ÿ", "××‘×Ÿ ×™×”×•×“×”", "××•×¨ ×™×”×•×“×”", "××•×¨ ×¢×§×™×‘×", "××¨×™××œ", "××©×§×œ×•×Ÿ", "×‘××§×” ××œ-×’×¨×‘×™×™×”",
                "×’×‘×¢×ª×™×™×", "×“×™××•× ×”", "×”×•×“ ×”×©×¨×•×Ÿ", "×–×›×¨×•×Ÿ ×™×¢×§×‘", "×™×‘× ×”", "×™×”×•×“-××•× ×•×¡×•×Ÿ", "×™×•×§× ×¢× ×¢×™×œ×™×ª",
                "×›×•×›×‘ ×™××™×¨", "×›×¤×¨ ×™×•× ×”", "×›×¤×¨ ×§××¡×", "×›×¨××™××œ", "××’×“×œ ×”×¢××§", "××›×‘×™×", "××¢×œ×” ××“×•××™×",
                "××¦×¤×” ×¨××•×Ÿ", "× ×”×¨×™×”", "× ×¡ ×¦×™×•× ×”", "× ×©×¨", "×¢×¤×•×œ×”", "×¢×¨×“", "×¤×¨×“×¡ ×—× ×”-×›×¨×›×•×¨",
                "×§×¨×™×™×ª ××•× ×•", "×§×¨×™×™×ª ×‘×™××œ×™×§", "×§×¨×™×™×ª ×™×", "×§×¨×™×™×ª ××•×¦×§×™×Ÿ", "×§×¨×™×™×ª ×©××•× ×”",
                "×©×•×”×", "×©×“×¨×•×ª", "×¨××ª ×”×©×¨×•×Ÿ"
            ].sort((a,b) => b.length - a.length); // Sort by length descending for better matching

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            return null;
        };

        // Predefined WhatsApp messages and city guidelines
        const whatsappMessages = [
            { id: 'new_customer_welcome', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n×ª×•×“×” ×©×‘×—×¨×ª ×œ×”×ª×—×™×œ ×©×›×™×¨×•×ª ××›×•×œ×” ××¦×œ× ×•! ğŸ‘‹ ×œ×›×œ ×¤× ×™×”, ×‘×§×©×ª ×”×—×œ×¤×” ××• ×”×•×¦××” ×©×œ ×”××›×•×œ×”, ××ª×” ××•×–××Ÿ ×œ×™×¦×•×¨ ×§×©×¨.\n\nğŸ“ ××¡×¤×¨ ×•×•×˜×¡××¤ ×œ×”×–×× ×•×ª: **[××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**\nâ˜ï¸ ×˜×œ×¤×•×Ÿ ××—×œ×§×ª ×”×–×× ×•×ª: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ‘‹' },
            { id: 'approaching_due_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×–×›×™×¨ ×œ×š ×›×™ ×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×‘×¢×•×“ **7 ×™××™×** ğŸ—“ï¸. ×–×” ×”×–××Ÿ ×œ× ×§×•×˜ ×¤×¢×•×œ×”!\n\n×”×× ×ª×¨×¦×” ×œ×”××¨×™×š ××ª ×ª×§×•×¤×ª ×”×©×›×™×¨×•×ª, ×œ×”×—×œ×™×£ ××ª ×”××›×•×œ×”, ××• ×œ×”×–××™×Ÿ ××™×¡×•×£? â™»ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â°' },
            { id: 'approaching_due_3_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×§×•×¤×ª ×©×›×™×¨×•×ª ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¡×ª×™×™××ª ×××© ×‘×§×¨×•×‘, ×‘×¢×•×“ **3 ×™××™×** âš ï¸. ×× × ×˜×¤×œ ×‘× ×•×©× ×›×“×™ ×œ×× ×•×¢ ×—×¨×™×’×•×ª.\n\n×× ×• ×œ×¨×©×•×ª×š ×œ×›×œ ×¢×–×¨×”! ğŸ™', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'â³' },
            { id: 'overdue_7_days', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×‘×¨×¦×•× × ×• ×œ×”×•×“×™×¢ ×œ×š ×¢×œ ×—×¨×™×’×” ×‘×™××™ ×©×›×™×¨×•×ª ×©×œ ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×** ğŸš¨. × × ×œ×™×¦×•×¨ ×§×©×¨ ×¢× ××—×œ×§×ª ×”×–×× ×•×ª **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]** ××• ×œ×”×©×™×‘ ×œ×”×•×“×¢×” ×–×• ××” ×ª×¨×¦×” ×©× ×‘×¦×¢ (×”×—×œ×¤×”/×”×•×¦××”).', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'â—ï¸' },
            { id: 'overdue_30_days', text: '**×”×ª×¨××” ×—××•×¨×”, [×©× ×œ×§×•×—]:**\n\n×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ×©×‘×©×™××•×©×š ×—×•×¨×’×ª ×‘-**[×™××™× ×©×¢×‘×¨×•] ×™××™×**! ×™×© ×œ×˜×¤×œ ×‘× ×•×©× ×‘×“×—×™×¤×•×ª ×›×“×™ ×œ×× ×•×¢ ×—×™×•×‘×™× × ×•×¡×¤×™× ×•×¡×™×‘×•×›×™× ××©×¤×˜×™×™×. âš–ï¸\n\n**×¦×•×¨ ×§×©×¨ ××™×™×“×™×ª: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”´' },
            { id: 'overdue_long', text: '**×œ×›×‘×•×“: [×©× ×œ×§×•×—]**\n\n**×”× ×“×•×Ÿ: ×—×•×‘ ×‘×’×™×Ÿ ×©×›×™×¨×•×ª ××›×•×œ×” ×—×•×¨×’×ª**\n\n×× ×• ×¤×•× ×™× ××œ×™×š ×‘×”×ª×™×™×—×¡ ×œ×—×©×‘×•× ×š, ×”× ××¦× ×‘×—×¨×™×’×” ××©××¢×•×ª×™×ª ×©×œ [**×™××™× ×©×¢×‘×¨×•**] ×™××™× ×¢×‘×•×¨ ××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]).\n\n×‘×”×™×¢×“×¨ ×”×¡×“×¨×” ××™×™×“×™×ª, ×× ×• × ××œ×¦×™× ×œ× ×§×•×˜ ×‘×¦×¢×“×™× ××©×¤×˜×™×™× ×œ×’×‘×™×™×”. ×× ×• ×§×•×¨××™× ×œ×š ×œ×™×¦×•×¨ ×§×©×¨ ×“×—×•×£ ×œ×”×¡×“×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '××©×¤×˜×™', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×™××™× ×©×¢×‘×¨×•', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: '' },
            { id: 'general_inquiry', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n××™×š ×× ×—× ×• ×™×›×•×œ×™× ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ¤” ×× ×™×© ×œ×š ×©××œ×•×ª, ×‘×§×©×•×ª ××• ×ª×–×›×•×¨×•×ª, ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª ××œ×™× ×•. ×× ×—× ×• ×›××Ÿ ×‘×©×‘×™×œ×š! âœ¨', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ’¬' },
            { id: 'payment_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×™×“×™×“×•×ª×™×ª ×œ×’×‘×™ ×ª×©×œ×•× ×—×©×‘×•× ×™×ª ××¡×¤×¨ **[×ª×¢×•×“×”]** ğŸ’°. ×× ×• ××•×“×™× ×œ×š ×¢×œ ×ª×©×•××ª ×”×œ×‘ ×”××”×™×¨×” ×•×¢×œ ×”××©×š ×©×™×ª×•×£ ×”×¤×¢×•×œ×”.', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ’²' },
            { id: 'service_feedback', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×• ××§×•×•×™× ×©×©×™×¨×•×ª×™× ×• ×¢×•× ×™× ×¢×œ ×¦×™×¤×™×•×ª×™×š. × ×©××— ×œ×§×‘×œ ××©×•×‘ ×¢×œ ×”×—×•×•×™×” ×©×œ×š ×¢× ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×›×“×™ ×©× ×•×›×œ ×œ×”×©×ª×¤×¨ ×•×œ×”×¢× ×™×§ ×œ×š ×©×™×¨×•×ª ×˜×•×‘ ×™×•×ª×¨. â­', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ“' },
            { id: 'holiday_greetings', text: '×—×’ ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×•×œ××©×¤×—×ª×š ×—×’ ×©××—, ××œ× ×©×œ×•×•×”, ×‘×¨×™××•×ª ×•×”××•×Ÿ ×©××—×”! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ' },
            { id: 'special_offer', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×™×© ×œ× ×• ×—×“×©×•×ª ××¨×’×©×•×ª! ğŸ ××‘×¦×¢ ××™×•×—×“ ×œ××›×•×œ×•×ª ×—×“×©×•×ª/× ×•×¡×¤×•×ª ×¢×‘×•×¨×š. ××œ ×ª×—××™×¥! ×œ×¤×¨×˜×™× × ×•×¡×¤×™×, ×”×©×‘ ×œ×”×•×“×¢×” ×–×• ××• ×”×ª×§×©×¨: **[×˜×œ×¤×•×Ÿ ×—×‘×¨×”]**.', category: '×©×™×•×•×§', placeholders: ['×©× ×œ×§×•×—', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'âœ¨' },
            { id: 'follow_up_issue', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×× ×—× ×• ×—×•×–×¨×™× ××œ×™×š ×œ×’×‘×™ ×”× ×•×©× ×©×“×™×•×•×—×ª ×¢×œ×™×• ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ğŸ› ï¸. ×”×× ×”×‘×¢×™×” × ×¤×ª×¨×” ×œ×©×‘×™×¢×•×ª ×¨×¦×•× ×š? ×× ×œ×, ×× × ×”×•×“×¢ ×œ× ×• ×›×“×™ ×©× ×•×›×œ ×œ×”××©×™×š ×œ×˜×¤×œ.', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'âœ…' },
            { id: 'document_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×ª×–×›×•×¨×ª ×œ×©×œ×™×—×ª ×”××¡××›×™× ×”×—×¡×¨×™× ×¢×‘×•×¨ ×”×–×× ×” **[×ª×¢×•×“×”]** ğŸ“„. ×× × ×©×œ×— ××•×ª× ×‘×”×§×“× ×›×“×™ ×©× ×•×›×œ ×œ×”×©×œ×™× ××ª ×”×˜×™×¤×•×œ ×‘×”×–×× ×”.\n\n×ª×•×“×” ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸ“Œ' },
            { id: 'service_confirmation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×”×©×™×¨×•×ª ×©×”×•×–××Ÿ (×ª×¢×•×“×” **[×ª×¢×•×“×”]**) ××•×©×¨ ×•×™×ª×‘×¦×¢ ×‘-**[×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™]** âœ…. ×ª×•×“×” ×©×‘×—×¨×ª ×‘× ×• ×•×©×™×”×™×” ×™×•× × ×¤×œ×!', category: '××™×©×•×¨', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'], emoji: 'ğŸ‘' },
            { id: 'service_delay', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×¢×§×‘ × ×¡×™×‘×•×ª ×‘×œ×ª×™ ×¦×¤×•×™×•×ª, ×™×™×ª×›×Ÿ ×©×™×”×™×” ×¢×™×›×•×‘ ×§×œ ×‘×˜×™×¤×•×œ ×‘×”×–×× ×” **[×ª×¢×•×“×”]** â±ï¸. ×× ×• ××ª× ×¦×œ×™× ×¢×œ ××™ ×”× ×•×—×•×ª ×•× ×¤×¢×œ ×œ×¤×ª×•×¨ ×–××ª ×‘××”×™×¨×•×ª ×”××¤×©×¨×™×ª.\n\n× ×•×“×™×¢ ×œ×š ×¢×œ ×›×œ ×¢×“×›×•×Ÿ! ğŸ”œ', category: '××™×“×¢', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”'], emoji: 'ğŸš§' },
            { id: 'location_update_request', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×›×“×™ ×©× ×•×›×œ ×œ×ª×× ××ª ×”×©×™×¨×•×ª ×‘×¦×•×¨×” ×”×˜×•×‘×” ×‘×™×•×ª×¨, ×× × ×•×•×“× ×©××™×§×•× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]) ××¢×•×“×›×Ÿ ×•××“×•×™×§ ğŸ“. ×–×” ×—×©×•×‘ ×œ×”×’×¢×” ×™×¢×™×œ×”!', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”'], emoji: 'ğŸ—ºï¸' },
            { id: 'happy_birthday', text: '×™×•× ×”×•×œ×“×ª ×©××—, **[×©× ×œ×§×•×—]**! ğŸ‰ğŸ‚\n\n×¦×•×•×ª [×©× ×”×—×‘×¨×”] ×××—×œ ×œ×š ×™×•× ××œ× ×‘×©××—×”, ×‘×¨×™××•×ª, ×”×’×©××” ×•×”×¨×‘×” ×¨×’×¢×™× ××ª×•×§×™×! ğŸ¥³', category: '×¢×•× ×ª×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸˆ' },
            { id: 'review_invitation', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n× ×”× ×™×ª ××”×©×™×¨×•×ª ×©×œ× ×•? âœ¨ × ×©××— ×× ×ª×•×›×œ ×œ×”×§×“×™×© ×¨×’×¢ ×•×œ×›×ª×•×‘ ×œ× ×• ×‘×™×§×•×¨×ª ×§×¦×¨×” ×›××Ÿ: [**×œ×™× ×§ ×œ×‘×™×§×•×¨×ª**]. ×ª×•×“×” ××¨××© ×¢×œ ×¢×–×¨×ª×š ×œ×”×©×ª×¤×¨! ğŸ™', category: '××©×•×‘', placeholders: ['×©× ×œ×§×•×—', '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª'], emoji: 'ğŸŒŸ' },
            { id: 'tech_support_contact', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×œ×›×œ ×‘×¢×™×” ×˜×›× ×™×ª ××• ×ª×¤×¢×•×œ×™×ª ×¢× ×”××›×•×œ×” ([**××¡×¤×¨ ××›×•×œ×”**]), ××—×œ×§×ª ×”×ª××™×›×” ×©×œ× ×• ×–××™× ×” ×¢×‘×•×¨×š ğŸ§‘â€ğŸ”§.\n\n**×¦×•×¨ ×§×©×¨: [×˜×œ×¤×•×Ÿ ×—×‘×¨×”].**', category: '×ª××™×›×”', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×˜×œ×¤×•×Ÿ ×—×‘×¨×”'], emoji: 'ğŸ”§' },
            { id: 'general_thanks', text: '×ª×•×“×” ×¨×‘×” ×œ×š, **[×©× ×œ×§×•×—]**, ×¢×œ ×©×™×ª×•×£ ×”×¤×¢×•×œ×” ×•×”×××•×Ÿ ×‘[×©× ×”×—×‘×¨×”]! ğŸ™\n\n×× ×• ××¢×¨×™×›×™× ××ª ×‘×—×™×¨×ª×š ×‘× ×• ×•××§×•×•×™× ×œ×”××©×™×š ×œ×©×¨×ª ××•×ª×š × ××× ×”. ğŸ’–', category: '×›×œ×œ×™', placeholders: ['×©× ×œ×§×•×—', '×©× ×”×—×‘×¨×”'], emoji: 'ğŸ˜Š' },
            { id: 'multi_container_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n×©×× ×• ×œ×‘ ×©×‘×¨×©×•×ª×š **××¡×¤×¨ ××›×•×œ×•×ª ×¤×¢×™×œ×•×ª** ğŸ—ï¸. ×× ×• ×›××Ÿ ×›×“×™ ×œ×•×•×“× ×©×›×œ ×”×¦×¨×›×™× ×©×œ×š ××¡×•×¤×§×™×.\n\n×”×× ×™×© ××©×”×• ×©× ×•×›×œ ×œ×¢×–×•×¨ ×‘×• ×‘× ×•×’×¢ ×œ××›×•×œ×•×ª ×©×œ×š? ××œ ×ª×”×¡×¡ ×œ×¤× ×•×ª! ğŸ¤', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—'], emoji: 'ğŸ“¦' },
            { id: 'container_mismatch', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×”×ª×¨××”:** ××›×•×œ×” ××¡×¤×¨ **[××¡×¤×¨ ××›×•×œ×”]** ×™×¨×“×” ××¦×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ×‘×ª×¢×•×“×” **[×ª×¢×•×“×”]** ×œ×¤× ×™ **[×™××™× ×©×¢×‘×¨×•]** ×™××™× ×•×˜×¨× ×”×•×—×–×¨×”/× ×¡×’×¨×”! ğŸš¨', category: '×—×¨×™×’×•×ª', placeholders: ['×©× ×œ×§×•×—', '××¡×¤×¨ ××›×•×œ×”', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'ğŸš¨' },
            { id: 'pending_order_reminder', text: '×©×œ×•× **[×©× ×œ×§×•×—]**,\n\n**×‘×˜×™×¤×•×œ:** ×”×–×× ×” **[×ª×¢×•×“×”]** ×©×œ ×œ×§×•×— **[×©× ×œ×§×•×—]** ××¡×•×× ×ª "×‘×˜×™×¤×•×œ" ×•×œ× ×¢×•×“×›× ×” **[×™××™× ×©×¢×‘×¨×•]** ×™××™×. ×“×•×¨×© ×‘×“×™×§×”! âš ï¸', category: '×ª×–×›×•×¨×•×ª', placeholders: ['×©× ×œ×§×•×—', '×ª×¢×•×“×”', '×™××™× ×©×¢×‘×¨×•'], emoji: 'âš ï¸' }
        ];

        // City-specific guidelines for WhatsApp messages
        const cityGuidelines = {
            '×”×¨×¦×œ×™×”': {
                id: 'herzliya_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×”×¨×¦×œ×™×”:\n×›×“×™ ×œ×”×¦×™×‘ ××›×•×œ×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘×¨×—×•×‘ ×‘×”×¨×¦×œ×™×”, ×™×© ×œ×”×’×™×© ×‘×§×©×” ××¨××© ×œ××’×£ ×”×¤×™×§×•×— ×”×¢×™×¨×•× ×™. ×”×‘×§×©×” ×›×¨×•×›×” ×‘×ª×©×œ×•× ××’×¨×” ×•× ×“×¨×© ××™×©×•×¨ ×‘×›×ª×‘. ××•××œ×¥ ×œ×•×•×“× ××ª ×›×œ ×”×¤×¨×˜×™× ×‘××ª×¨ ×”×¢×™×¨×™×™×” ××• ×‘×˜×œ×¤×•×Ÿ.\n\n×§×™×©×•×¨ ×œ××™×“×¢: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ“'
            },
            '×¨×¢× × ×”': {
                id: 'raanana_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×¨×¢× × ×”:\n×‘×¨×¢× × ×”, ×—×œ ××™×¡×•×¨ ××•×—×œ×˜ ×œ×”×©××™×¨ ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×‘××§×•× ×¦×™×‘×•×¨×™ (×‘×¨×—×•×‘) ×‘×¡×•×¤×™ ×©×‘×•×¢ ×•×‘×—×’×™×. ×™×© ×œ×“××•×’ ×œ×”×–××™×Ÿ ×¤×™× ×•×™ ×œ×¤× ×™ ×›× ×™×¡×ª ×”×©×‘×ª/×—×’. ×§× ×¡×•×ª ×™×™× ×ª× ×• ×œ××¤×¨×™×. ×× × ×”×§×¤×“ ×¢×œ ×”× ×—×™×•×ª ××œ×•.\n\n××™×“×¢ × ×•×¡×£: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9A',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸš«'
            },
            '×ª×œ ××‘×™×‘': {
                id: 'telaviv_permit',
                text: '×”× ×—×™×” ×—×©×•×‘×” ×œ×ª×•×©×‘×™ ×ª×œ ××‘×™×‘:\n×‘×ª×œ ××‘×™×‘, ×”×¦×‘×ª ××›×•×œ×•×ª ×¤×¡×•×œ×ª ×‘×¨×—×•×‘ ××—×™×™×‘×ª ×§×‘×œ×ª ×”×™×ª×¨ ××”×¢×™×¨×™×™×”. ×™×© ×œ×”×’×™×© ×‘×§×©×” ××§×•×•× ×ª ×•×œ×¦×¨×£ ××ª ×›×œ ×”××¡××›×™× ×”× ×“×¨×©×™×. ×©×™××• ×œ×‘ ×œ×”× ×—×™×•×ª ×”××“×•×™×§×•×ª ×œ×’×‘×™ ×¡×™××•×Ÿ ×”××›×•×œ×” ×•××©×š ×”×”×¦×‘×”.\n\n×œ××™×“×¢ ×•×”×’×©×ª ×‘×§×©×”: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                placeholders: [],
                emoji: 'ğŸ›ï¸'
            }
        };

        // Company information for placeholders
        const companyInfo = {
            phoneNumber: '972508860896', // Example WhatsApp number
            companyPhone: '097602010', // Example company phone
            companyName: '×—.×¡×‘×Ÿ' // Example company name
        };

        // Google Apps Script Web App URL for data interaction
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzk03pVBEBzHIWkFj1OzqM0T5buH5cfNjD8njGza8AoKWulO1sPtiBrOpUZZItOd_gi/exec';

        // Helper to generate consistent phone numbers for customers for static data
        const customerPhones = {};
        let nextPhoneNumber = 972501000000;
        const getCustomerPhone = (customerName) => {
            if (!customerPhones[customerName]) {
                customerPhones[customerName] = `97250${nextPhoneNumber++}`;
            }
            return customerPhones[customerName];
        };

        // Helper to generate container numbers (very basic simulation for static data)
        const containerCounter = {
            placed: 100, // For ×”×¦×‘×” (placement)
            lifted: 500, // For ×”×•×¦××” (removal)
            replaced: 1000 // For ×”×—×œ×¤×” (exchange)
        };

        const generateContainerNumbers = (actionType) => {
            let dropped = '';
            let lifted = '';
            let all = '';

            if (actionType === '×”×¦×‘×”') {
                dropped = String(containerCounter.placed++);
                all = dropped;
            } else if (actionType === '×”×•×¦××”') {
                lifted = String(containerCounter.lifted++);
                all = lifted;
            } else if (actionType === '×”×—×œ×¤×”') {
                dropped = String(containerCounter.replaced++);
                lifted = String(containerCounter.replaced + 1); // Get another number for lifted
                containerCounter.replaced += 2;
                all = `${dropped},${lifted}`;
            }
            return { dropped, lifted, all };
        };

        // Raw data from the provided "×˜×‘×œ×ª ×¤×¢×•×œ×•×ª ×××•×—×“×ª" (CSV format parsed to array of objects)
        const rawDataString = `
×ª××¨×™×š,×ª×¢×•×“×”,×©× ×œ×§×•×—,×©× ×¡×•×›×Ÿ,×¡×•×’ ×¤×¢×•×œ×”,×›×ª×•×‘×ª
2025-06-01,6712645,×‘×Ÿ ×¢× ×‘×¨-×‘×™"×¡ ×œ×™×™×“×™ ×“,×¨××™/×©××¨×§,×”×—×œ×¤×”,×¨×—×•×‘ ×©×§×“ 15, ×›×¤×¨ ×¡×‘×
2025-08-18,6714067,×‘×•×§×˜×•×¡ ××™×œ×Ÿ-×›×œ×œ×™,××•×—××“/×©××¨×§,×”×•×¦××”,×¨×—×•×‘ ×”×¡×‘×™×•×Ÿ 6, ×¢×›×•
`.trim();

        /**
         * Parses a CSV string into an array of objects.
         * @param {string} csvString - The CSV data as a string.
         * @returns {Array<Object>} An array of objects representing the CSV data.
         */
        const parseCSVString = (csvString) => {
            const lines = csvString.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let inQuote = false;
                let currentValue = '';
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim()); // Push the last value

                const rowObject = {};
                for (let k = 0; k < headers.length; k++) {
                    rowObject[headers[k]] = values[k] !== undefined ? values[k] : '';
                }
                data.push(rowObject);
            }
            return data;
        };

        const rawParsedData = parseCSVString(rawDataString);

        // Process raw static data into the desired structured format for historical operations
        historicalOperations = rawParsedData.map(row => {
            let actionType = row['×¡×•×’ ×¤×¢×•×œ×”'].trim();
            // Normalize action types
            if (actionType === '×”×•×¨×“×”') {
                actionType = '×”×¦×‘×”';
            } else if (actionType === '×”×¢×œ××”') {
                actionType = '×”×•×¦××”';
            } else if (actionType === '×”×—al×¤×”') { // Handle possible typo in static data
                actionType = '×”×—×œ×¤×”';
            }

            const containerNums = generateContainerNumbers(actionType); // These are simulated for static data
            const customerPhone = getCustomerPhone(row['×©× ×œ×§×•×—']); // Simulated phone numbers
            const orderDate = formatDate(row['×ª××¨×™×š']); // Parse date immediately

            let status = '×¤×ª×•×—';
            if (actionType === '×”×•×¦××”' || actionType === '×¤×™× ×•×™ ×‘××§×•×') {
                status = '×¡×’×•×¨';
            }

            // Calculate daysInRental and isOverdue for pre-computation
            const daysInRental = orderDate ? daysSince(orderDate) : 0;
            const isOverdue = status === '×¤×ª×•×—' && daysInRental >= 10;

            // Generate expected end date for open orders (e.g., 14 days from order date)
            const expectedEndDate = orderDate ? new Date(orderDate.getTime() + 14 * 24 * 60 * 60 * 1000) : null;
            const expectedEndDateFormatted = expectedEndDate ? formatISODate(expectedEndDate) : '';

            // Ensure all headers expected by the Google Sheet are present, even if empty
            // This structure mirrors the `sheetHeaders` in submitNewOrder for consistency.
            const completeOrder = {
                '×ª××¨×™×š ×”×–×× ×”': orderDate,
                '×ª×¢×•×“×”': row['×ª×¢×•×“×”'],
                '×©× ×¡×•×›×Ÿ': row['×©× ×¡×•×›×Ÿ'],
                '×©× ×œ×§×•×—': row['×©× ×œ×§×•×—'],
                '×›×ª×•×‘×ª': row['×›×ª×•×‘×ª'] || `${row['×©× ×œ×§×•×—'].split('/')[0]} ×¨×—×•×‘ ×œ×“×•×’××”, ×¢×™×¨ ×›×œ×©×”×™`, // Use provided address, or fallback
                '×¡×•×’ ×¤×¢×•×œ×”': actionType,
                '×™××™× ×©×¢×‘×¨×•': daysInRental, // Pre-calculated
                '××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”': containerNums.dropped,
                '××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”': containerNums.lifted,
                '××¡×¤×¨×™ ××›×•×œ×•×ª': containerNums.all,
                '×¡×˜×˜×•×¡': status,
                '×”×¢×¨×•×ª': '',
                '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDate,
                '×”×¢×¨×•×ª ×¡×™×•×': '',
                '×ª××¨×™×š ×¡×’×™×¨×”': status === '×¡×’×•×¨' ? orderDate : null, // Set closing date if status is closed
                '×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)': '', // Not calculated for static data
                '×˜×œ×¤×•×Ÿ ×œ×§×•×—': customerPhone,
                'isOverdue': isOverdue // Pre-calculated
            };
            return completeOrder;
        });
        console.log("Loaded static historical data:", historicalOperations);


        /**
         * Merges historical static data with live data fetched from Google Sheet.
         * Prioritizes live data for documents with matching '×ª×¢×•×“×”'.
         * Converts date strings from live data to Date objects.
         * @param {Array<Object>} staticOps - Array of historical operation objects.
         * @param {Array<Object>} liveOps - Array of live operation objects from Google Sheet.
         * @returns {Array<Object>} Merged and sorted array of operations.
         */
        const mergeData = (staticOps, liveOps) => {
            const mergedMap = new Map();

            // Add live data, prioritizing it
            liveOps.forEach(op => {
                const docId = String(op['×ª×¢×•×“×”']);
                // Apply the user's mapping for live data from sheet and parse dates
                let normalizedActionType = op['×¡×•×’ ×¤×¢×•×œ×”'] ? op['×¡×•×’ ×¤×¢×•×œ×”'].trim() : '';
                if (normalizedActionType === '×”×•×¨×“×”') {
                    normalizedActionType = '×”×¦×‘×”';
                } else if (normalizedActionType === '×”×¢×œ××”') {
                    normalizedActionType = '×”×•×¦××”';
                }
                op['×¡×•×’ ×¤×¢×•×œ×”'] = normalizedActionType; // Update the operation object

                // Parse dates into Date objects
                op['×ª××¨×™×š ×”×–×× ×”'] = formatDate(op['×ª××¨×™×š ×”×–×× ×”']);
                op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] = formatDate(op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™']);
                op['×ª××¨×™×š ×¡×’×™×¨×”'] = formatDate(op['×ª××¨×™×š ×¡×’×™×¨×”']);

                // Calculate derived fields (daysInRental, isOverdue)
                op['×™××™× ×©×¢×‘×¨×•'] = op['×ª××¨×™×š ×”×–×× ×”'] ? daysSince(op['×ª××¨×™×š ×”×–×× ×”']) : 0;
                op['isOverdue'] = op['×¡×˜×˜×•×¡'] !== '×¡×’×•×¨' && op['×™××™× ×©×¢×‘×¨×•'] >= 10;

                mergedMap.set(docId, op);
            });

            // Add historical data if not already present in live data
            staticOps.forEach(op => {
                const docId = String(op['×ª×¢×•×“×”']);
                if (!mergedMap.has(docId)) {
                    mergedMap.set(docId, op); // Static data already has parsed dates and calculated fields
                }
            });

            // Convert map back to array and sort by date (descending)
            return Array.from(mergedMap.values()).sort((a, b) => {
                const dateA = a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                const dateB = b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                return dateB - dateA;
            });
        };


        /**
         * Fetches data from the Google Sheet with exponential backoff for retries.
         * @async
         */
        const fetchDataFromGoogleSheet = async () => {
            isLoadingData = true;
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader

            let liveData = [];
            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=getData`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();

                    if (result.success && Array.isArray(result.data)) {
                        liveData = result.data;
                        console.log("Fetched live data from Google Sheet:", liveData);
                        break; // Exit retry loop on success
                    } else {
                        console.error("Received data is not an array or success is false:", result);
                        showStatusMessage("×©×’×™××”: ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××’×™×œ×™×•×Ÿ ×’×•×’×œ ××™× × ×‘×¤×•×¨××˜ ×¦×¤×•×™ ××• ×©×”×™×™×ª×” ×©×’×™××” ×‘×©×¨×ª: " + (result.message || '××™×Ÿ ×”×•×“×¢×” ×¡×¤×¦×™×¤×™×ª'), 'error');
                        // No break here, allow retry for server errors potentially
                    }
                } catch (error) {
                    console.error("Error fetching data from Google Sheet:", error);
                    showStatusMessage("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× ××’×™×œ×™×•×Ÿ ×’×•×’×œ: " + error.message, 'error');
                }

                if (retries < maxRetries - 1) { // Don't delay after the last retry attempt
                    const delay = baseDelay * Math.pow(2, retries);
                    // console.warn(`API rate limit hit or network error. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                retries++;
            }

            // Merge historical static data with live data
            allOperations = mergeData(historicalOperations, liveData);
            console.log("Merged operations data:", allOperations);

            renderDashboard();
            renderInventory();
            renderTreatmentBoard();

            isLoadingData = false;
            document.getElementById('global-loader').classList.add('hidden'); // Hide loader
        };

        /**
         * Adds a new order to the Google Sheet via Apps Script.
         * @param {Object} orderData - The order data to send.
         * @async
         */
        const addNewOrderToSheet = async (orderData) => {
            document.getElementById('global-loader').classList.remove('hidden'); // Show loader
            try {
                const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=addOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();
                if (result.success) {
                    showStatusMessage('×”×”×–×× ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×” ×œ×’×™×œ×™×•×Ÿ!', 'success');
                    await fetchDataFromGoogleSheet(); // Re-fetch all data to ensure local state is updated
                } else {
                    showStatusMessage('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×”×–×× ×”: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding order to sheet:', error);
                showStatusMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª ×‘×¢×ª ×”×•×¡×¤×ª ×”×–×× ×”.', 'error');
            } finally {
                document.getElementById('global-loader').classList.add('hidden'); // Hide loader
            }
        };

        /**
         * Displays a custom status message (success/error/info).
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - The type of message.
         */
        const showStatusMessage = (message, type) => {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed bottom-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-all transform opacity-0 scale-95`;
            let iconHtml = '';
            if (type === 'success') {
                statusDiv.classList.add('bg-green-600');
                iconHtml = '<i class="fas fa-check-circle ml-2"></i>';
            } else if (type === 'error') {
                statusDiv.classList.add('bg-red-600');
                iconHtml = '<i class="fas fa-times-circle ml-2"></i>';
            } else if (type === 'warning') {
                statusDiv.classList.add('bg-orange-500');
                iconHtml = '<i class="fas fa-exclamation-triangle ml-2"></i>';
            } else {
                statusDiv.classList.add('bg-gray-700');
                iconHtml = '<i class="fas fa-info-circle ml-2"></i>';
            }
            statusDiv.innerHTML = `${message} ${iconHtml}`;
            document.body.appendChild(statusDiv);

            // Animate in
            setTimeout(() => {
                statusDiv.classList.remove('opacity-0', 'scale-95');
                statusDiv.classList.add('opacity-100', 'scale-100');
            }, 10); // Small delay for transition to apply

            setTimeout(() => {
                // Animate out
                statusDiv.classList.remove('opacity-100', 'scale-100');
                statusDiv.classList.add('opacity-0', 'scale-95');
                statusDiv.addEventListener('transitionend', () => statusDiv.remove());
            }, 5000); // Message disappears after 5 seconds
        };

        // Event listener for DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData(); // Initial data load and rendering
            document.getElementById('main-search').addEventListener('input', debounce(renderAllOperationsTable, 300)); // Debounce search input
        });

        /**
         * Initiates the data loading process.
         * @async
         */
        const loadAllData = async () => {
            await fetchDataFromGoogleSheet(); // This function handles merging and rendering
        };

        /**
         * Calculates and returns Key Performance Indicators (KPIs).
         * @returns {Object} An object containing activeContainers, overdueCustomers, availableContainers, totalOperations.
         */
        const getKPIs = () => {
            let totalOverdueCustomerNames = new Set();
            let currentActiveContainers = new Set();
            let currentAvailableContainers = new Set();

            const containerHistoryForStatus = {};

            // Process all operations in chronological order to determine the latest status of each container
            allOperations.slice().sort((a, b) => {
                const dateA = a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                const dateB = b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                return dateA - dateB; // Sort ascending by operation date
            }).forEach(op => {
                const containersDropped = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersLifted = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                // If a container was dropped, it's now 'in_use'
                containersDropped.forEach(containerNum => {
                    containerHistoryForStatus[containerNum] = {
                        status: 'in_use',
                        customerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: op['×ª××¨×™×š ×”×–×× ×”'],
                        latestOperationDocId: op['×ª×¢×•×“×”']
                    };
                });

                // If a container was lifted, it's now 'available'
                containersLifted.forEach(containerNum => {
                    containerHistoryForStatus[containerNum] = {
                        status: 'available',
                        lastCustomerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: op['×ª××¨×™×š ×”×–×× ×”'],
                        latestOperationDocId: op['×ª×¢×•×“×”']
                    };
                });
            });

            // Iterate through the current status of each container to populate KPIs
            for (const containerNum in containerHistoryForStatus) {
                const info = containerHistoryForStatus[containerNum];
                if (info.status === 'in_use') {
                    currentActiveContainers.add(containerNum);
                    const daysInRental = daysSince(info.lastActionDate);
                    if (daysInRental >= 10) {
                        totalOverdueCustomerNames.add(info.customerName);
                    }
                } else if (info.status === 'available') {
                    currentAvailableContainers.add(containerNum);
                }
            }

            return {
                activeContainers: currentActiveContainers.size,
                overdueCustomers: totalOverdueCustomerNames.size,
                availableContainers: currentAvailableContainers.size,
                totalOperations: allOperations.length,
            };
        };

        /**
         * Renders the dashboard page with updated KPIs, tables, and charts.
         */
        const renderDashboard = () => {
            const { activeContainers, overdueCustomers, availableContainers, totalOperations } = getKPIs();
            document.getElementById('kpi-active-containers').textContent = activeContainers;
            document.getElementById('kpi-overdue-customers').textContent = overdueCustomers;
            document.getElementById('kpi-available-containers').textContent = availableContainers;
            document.getElementById('kpi-total-operations').textContent = totalOperations;

            renderAllOperationsTable();
            renderCharts();
        };

        /**
         * Renders the main operations table, applying search filters.
         */
        const renderAllOperationsTable = () => {
            const searchTerm = document.getElementById('main-search').value.toLowerCase();
            const tableBody = document.getElementById('all-operations-table');
            tableBody.innerHTML = '';

            const filteredOps = allOperations.filter(op =>
                (op['×©× ×œ×§×•×—'] && op['×©× ×œ×§×•×—'].toLowerCase().includes(searchTerm)) ||
                (op['×ª×¢×•×“×”'] && String(op['×ª×¢×•×“×”']).toLowerCase().includes(searchTerm)) ||
                (op['×©× ×¡×•×›×Ÿ'] && op['×©× ×¡×•×›×Ÿ'].toLowerCase().includes(searchTerm)) ||
                (String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').toLowerCase().includes(searchTerm)) ||
                (String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').toLowerCase().includes(searchTerm))
            );

            // Limit to top 100 results for display performance, if needed. Can be adjusted.
            filteredOps.slice(0, 100).forEach(op => {
                const days = op['×™××™× ×©×¢×‘×¨×•']; // Pre-calculated days
                let displayStatusText, displayStatusClass;

                // Determine status dynamically for display
                if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    displayStatusText = '×¡×’×•×¨';
                    displayStatusClass = 'status-gray';
                } else if (op['isOverdue']) { // Use pre-calculated overdue status
                    displayStatusText = '×—×¨×™×’×”';
                    displayStatusClass = 'status-red';
                } else {
                    displayStatusText = '×¤×¢×™×œ';
                    displayStatusClass = 'status-green';
                }

                const row = `
                    <tr class="hover:bg-gray-50 cursor-pointer">
                        <td class="py-3 px-4">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-3 px-4">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-3 px-4 font-semibold text-gray-700">${op['×©× ×œ×§×•×—']}</td>
                        <td class="py-3 px-4">${op['×©× ×¡×•×›×Ÿ']}</td>
                        <td class="py-3 px-4">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-3 px-4">${days}</td>
                        <td class="py-3 px-4"><span class="status-badge ${displayStatusClass}">${displayStatusText}</span></td>
                        <td class="py-3 px-4 flex items-center">
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || ''}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none p-1 rounded-full hover:bg-green-100 transition-colors">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </button>
                            <button onclick="openModal('${op['×ª×¢×•×“×”']}')" class="text-blue-600 hover:text-blue-700 ml-2 focus:outline-none p-1 rounded-full hover:bg-blue-100 transition-colors">
                                <i class="fas fa-eye text-xl"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        };

        /**
         * Renders the agent activity and operations timeline charts.
         */
        const renderCharts = () => {
            // Agent Activity Chart
            const agentCounts = allOperations.reduce((acc, op) => {
                const agent = op['×©× ×¡×•×›×Ÿ'] || '×œ× ×™×“×•×¢';
                acc[agent] = (acc[agent] || 0) + 1;
                return acc;
            }, {});
            if (charts.agent) charts.agent.destroy(); // Destroy existing chart before re-rendering
            charts.agent = new Chart(document.getElementById('agentActivityChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(agentCounts).map(label => {
                        // Split long labels into multiple lines for readability
                        if (label.length > 16) {
                            return label.match(/.{1,8}/g).join('\n');
                        }
                        return label;
                    }),
                    datasets: [{
                        label: '××¡×¤×¨ ×¤×¢×•×œ×•×ª',
                        data: Object.values(agentCounts),
                        backgroundColor: '#8b5cf6', // violet-500
                        borderRadius: 4, // Rounded bars
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label.replace(/\n/g, ' '); // Combine split labels for tooltip
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Ensure whole numbers for counts
                            }
                        },
                        x: {
                            grid: {
                                display: false // Remove vertical grid lines
                            }
                        }
                    }
                }
            });

            // Operations Timeline Chart
            const timelineCounts = allOperations.reduce((acc, op) => {
                if (op['×ª××¨×™×š ×”×–×× ×”'] && !isNaN(op['×ª××¨×™×š ×”×–×× ×”'].getTime())) {
                    const month = op['×ª××¨×™×š ×”×–×× ×”'].toISOString().slice(0, 7); // YYYY-MM format
                    acc[month] = (acc[month] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedTimeline = Object.entries(timelineCounts).sort((a, b) => a[0].localeCompare(b[0])); // Sort by month
            if (charts.timeline) charts.timeline.destroy(); // Destroy existing chart before re-rendering
            charts.timeline = new Chart(document.getElementById('operationsTimelineChart'), {
                type: 'line',
                data: {
                    labels: sortedTimeline.map(e => e[0]),
                    datasets: [{
                        label: '×›××•×ª ×¤×¢×•×œ×•×ª ×—×•×“×©×™×ª',
                        data: sortedTimeline.map(e => e[1]),
                        borderColor: '#6d28d9', // violet-700
                        tension: 0.3, // Smoother line
                        fill: true, // Fill area under the line
                        backgroundColor: 'rgba(109, 40, 217, 0.1)', // Light violet fill
                        pointBackgroundColor: '#6d28d9',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#6d28d9',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    }
                }
            });
        };

        /**
         * Renders the container inventory tables (in use and available).
         */
        const renderInventory = () => {
            const inUseBody = document.getElementById('in-use-containers-table');
            const availableBody = document.getElementById('available-containers-table');
            inUseBody.innerHTML = '';
            availableBody.innerHTML = '';

            const containerCurrentStatus = {}; // { containerNum: { status, customerName, lastActionDate, latestOperationDocId, lastCustomerName } }

            // Determine the latest status for each container based on all operations
            // This is crucial for correctly categorizing containers as 'in_use' or 'available'
            allOperations.slice().sort((a, b) => {
                const dateA = a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                const dateB = b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                return dateA - dateB; // Sort ascending to ensure we get the *latest* state
            }).forEach(op => {
                const containersDropped = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersLifted = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);

                // If a container was dropped, its status is now 'in_use'
                containersDropped.forEach(containerNum => {
                    containerCurrentStatus[containerNum] = {
                        status: 'in_use',
                        customerName: op['×©× ×œ×§×•×—'],
                        lastActionDate: op['×ª××¨×™×š ×”×–×× ×”'],
                        latestOperationDocId: op['×ª×¢×•×“×”']
                    };
                });

                // If a container was lifted, its status is now 'available'
                containersLifted.forEach(containerNum => {
                    containerCurrentStatus[containerNum] = {
                        status: 'available',
                        lastCustomerName: op['×©× ×œ×§×•×—'], // The customer it was removed from
                        lastActionDate: op['×ª××¨×™×š ×”×–×× ×”'],
                        latestOperationDocId: op['×ª×¢×•×“×”']
                    };
                });
            });

            const uniqueContainersSorted = Object.keys(containerCurrentStatus).sort((a,b) => parseInt(a) - parseInt(b));

            uniqueContainersSorted.forEach(containerNum => {
                const statusData = containerCurrentStatus[containerNum];
                if (statusData.status === 'in_use') {
                    const days = daysSince(statusData.lastActionDate);
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4 font-semibold">${statusData.customerName}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4 ${days >= 10 ? 'text-red-600 font-bold' : ''}">${days}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline transition-colors" onclick="openModal('${statusData.latestOperationDocId}')">×¦×¤×”</button></td>
                        </tr>`;
                    inUseBody.innerHTML += row;
                } else if (statusData.status === 'available') {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${containerNum}</td>
                            <td class="py-3 px-4">${statusData.lastActionDate ? statusData.lastActionDate.toLocaleDateString('he-IL') : ''}</td>
                            <td class="py-3 px-4">${statusData.lastCustomerName || '×œ× ×™×“×•×¢'}</td>
                            <td class="py-3 px-4"><button class="text-blue-600 hover:underline transition-colors" onclick="openModal('${statusData.latestOperationDocId}')">×¦×¤×”</button></td>
                        </tr>`;
                    availableBody.innerHTML += row;
                }
            });

            // Update KPI cards on Inventory page
            document.getElementById('kpi-active-containers').textContent = inUseBody.rows.length;
            document.getElementById('kpi-available-containers').textContent = availableBody.rows.length;
        };

        /**
         * Renders the treatment board with overdue customers.
         */
        const renderTreatmentBoard = () => {
            const board = document.getElementById('treatment-board');
            const noOverdueMessage = document.getElementById('no-overdue-message');
            board.innerHTML = '';

            // Filter operations that are '×¤×ª×•×—' (active) AND overdue (>= 10 days)
            const overdueOperations = allOperations.filter(op => op['isOverdue']);

            if (overdueOperations.length === 0) {
                noOverdueMessage.classList.remove('hidden');
                return;
            } else {
                noOverdueMessage.classList.add('hidden');
            }

            overdueOperations.forEach(op => {
                const days = op['×™××™× ×©×¢×‘×¨×•']; // Pre-calculated days
                const containersDropped = String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                const containersLifted = String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean);
                // Changed from 'const' to 'let' to allow reassignment.
                let containerDisplay = containersDropped.length > 0 ? `×™×¨×“×”: ${containersDropped.join(', ')}` : '';
                if (containersLifted.length > 0) {
                    containerDisplay += (containerDisplay ? ', ' : '') + `×¢×œ×ª×”: ${containersLifted.join(', ')}`;
                }
                const containerNumbersForMsg = [...containersDropped, ...containersLifted].filter(Boolean).join(', ');


                const card = `
                    <div class="kpi-card bg-white border-l-4 border-red-500 hover:shadow-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-lg text-gray-800">${op['×©× ×œ×§×•×—']}</h4>
                                <p class="text-sm text-gray-500">×ª×¢×•×“×”: ${op['×ª×¢×•×“×”']}</p>
                                <p class="text-sm text-gray-500">××›×•×œ×”: ${containerDisplay || '×œ× ×¦×•×™×Ÿ'}</p>
                            </div>
                            <span class="font-bold text-xl text-red-600">${days} ×™××™× ×—×¨×™×’×”</span>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button class="px-3 py-1 bg-violet-600 text-white rounded-lg hover:bg-violet-700 text-sm transition-colors shadow-sm" onclick="openModal('${op['×ª×¢×•×“×”']}')">×¤×¨×˜×™ ×œ×§×•×—</button>
                            <button onclick="openWhatsAppModal(event, '${op['×˜×œ×¤×•×Ÿ ×œ×§×•×—']}', '${op['×©× ×œ×§×•×—']}', '${op['×ª×¢×•×“×”']}', ${days}, '${containerNumbersForMsg}', '${op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] ? op['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].toLocaleDateString('he-IL') : ''}', '${op['×›×ª×•×‘×ª']}')" class="text-green-500 hover:text-green-600 focus:outline-none p-1 rounded-full hover:bg-green-100 transition-colors">
                                <i class="fab fa-whatsapp text-2xl"></i>
                            </button>
                        </div>
                    </div>
                `;
                board.innerHTML += card;
            });
        };

        /**
         * Opens the customer history modal for a given document ID.
         * @param {string} docId - The document ID of the operation to display.
         */
        const openModal = (docId) => {
            const customerOp = allOperations.find(op => String(op['×ª×¢×•×“×”']) === String(docId));
            if (!customerOp) {
                showStatusMessage('×œ× × ××¦××” ×”×–×× ×” ×¢×‘×•×¨ ×ª×¢×•×“×” ×–×•.', 'error');
                return;
            }

            // Find all operations for this customer name
            const customerOps = allOperations.filter(op => op['×©× ×œ×§×•×—'] === customerOp['×©× ×œ×§×•×—'])
                                            .sort((a, b) => {
                                                const dateA = a['×ª××¨×™×š ×”×–×× ×”'] ? a['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                                                const dateB = b['×ª××¨×™×š ×”×–×× ×”'] ? b['×ª××¨×™×š ×”×–×× ×”'].getTime() : 0;
                                                return dateB - dateA; // Sort descending for latest at top
                                            });

            document.getElementById('modal-customer-name').textContent = customerOp['×©× ×œ×§×•×—'];

            const totalOps = customerOps.length;
            const totalPlacements = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”').length;
            const totalRemovals = customerOps.filter(op => op['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×•×¦××”').length;

            document.getElementById('modal-customer-summary').innerHTML = `
                <div class="text-center"><p class="text-2xl font-bold">${totalOps}</p><p class="text-sm text-blue-700">×¡×”"×› ×¤×¢×•×œ×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalPlacements}</p><p class="text-sm text-blue-700">×”×¦×‘×•×ª</p></div>
                <div class="text-center"><p class="text-2xl font-bold">${totalRemovals}</p><p class="text-sm text-blue-700">×”×•×¦××•×ª</p></div>
            `;

            // Collect unique container numbers for this customer
            const uniqueContainersForCustomer = new Set();
            customerOps.forEach(op => {
                String(op['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(num => uniqueContainersForCustomer.add(num));
                String(op['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '').split(',').map(c => c.trim()).filter(Boolean).forEach(num => uniqueContainersForCustomer.add(num));
            });
            document.getElementById('customer-container-list').textContent =
                uniqueContainersForCustomer.size > 0 ? Array.from(uniqueContainersForCustomer).sort((a,b) => parseInt(a) - parseInt(b)).join(', ') : '××™×Ÿ ××›×•×œ×•×ª ××©×•×™×›×•×ª ×œ×œ×§×•×— ×–×”.';


            const historyTable = document.getElementById('modal-customer-history-table');
            historyTable.innerHTML = '';
            customerOps.forEach(op => {
                 const days = op['×™××™× ×©×¢×‘×¨×•']; // Use pre-calculated days
                 let displayStatusText, displayStatusClass;
                 if (op['×¡×˜×˜×•×¡'] === '×¡×’×•×¨') {
                    displayStatusText = '×¡×’×•×¨'; displayStatusClass = 'status-gray';
                 } else if (op['isOverdue']) { // Use pre-calculated overdue status
                    displayStatusText = '×—×¨×™×’×”'; displayStatusClass = 'status-red';
                 } else {
                    displayStatusText = '×¤×¢×™×œ'; displayStatusClass = 'status-green';
                 }
                const row = `
                    <tr>
                        <td class="py-2 px-3">${op['×ª××¨×™×š ×”×–×× ×”'] ? op['×ª××¨×™×š ×”×–×× ×”'].toLocaleDateString('he-IL') : ''}</td>
                        <td class="py-2 px-3">${op['×ª×¢×•×“×”']}</td>
                        <td class="py-2 px-3">${op['×¡×•×’ ×¤×¢×•×œ×”']}</td>
                        <td class="py-2 px-3"><span class="status-badge ${displayStatusClass}">${displayStatusText}</span></td>
                    </tr>`;
                historyTable.innerHTML += row;
            });

            document.getElementById('customer-history-modal').classList.remove('hidden');
            document.getElementById('customer-history-modal').classList.add('flex');
        };

        /**
         * Closes the customer history modal.
         */
        const closeModal = () => {
            document.getElementById('customer-history-modal').classList.add('hidden');
            document.getElementById('customer-history-modal').classList.remove('flex');
        };

        /**
         * Determines the most relevant suggested WhatsApp message ID for a given order.
         * @param {Object} order - The order object.
         * @returns {string} The ID of the suggested message.
         */
        const getSuggestedMessageIdForOrder = (order) => {
            const daysInRental = order['×™××™× ×©×¢×‘×¨×•']; // Use pre-calculated days
            const isOverdue = order['isOverdue']; // Use pre-calculated overdue status

            // Check for overdue status
            if (isOverdue) {
                if (daysInRental >= 10 && daysInRental <= 30) return 'overdue_30_days'; // More specific than 7 days
                if (daysInRental > 30) return 'overdue_long';
                return 'overdue_7_days'; // Default overdue if not covered by more specific thresholds
            }

            // Check for approaching due date for open orders with an expected end date
            if (order['×¡×˜×˜×•×¡'] === '×¤×ª×•×—' && order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'] && !isNaN(order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'].getTime())) {
                const expectedEndDate = order['×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™'];
                const today = new Date();
                today.setHours(0,0,0,0);
                const daysUntilDue = Math.ceil((expectedEndDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24)); // Use ceil to include partial days

                if (daysUntilDue >= 0 && daysUntilDue <= 3) return 'approaching_due_3_days';
                if (daysUntilDue > 3 && daysUntilDue <= 7) return 'approaching_due_7_days';
            }

            // Check if it's a relatively new placement for a new customer
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×¦×‘×”' && daysInRental <= 7) {
                const customerOrders = allOperations.filter(op => op['×©× ×œ×§×•×—'] === order['×©× ×œ×§×•×—']);
                // Check if this is truly one of the first few orders for this customer
                const isNewCustomerFirstOrder = customerOrders.length <= 2 && String(customerOrders[0]['×ª×¢×•×“×”']) === String(order['×ª×¢×•×“×”']);
                if (isNewCustomerFirstOrder) {
                    return 'new_customer_welcome';
                }
            }

            // Check for city-specific guidelines
            const customerCity = getCityFromAddress(order['×›×ª×•×‘×ª']);
            if (customerCity && cityGuidelines[customerCity]) {
                return cityGuidelines[customerCity].id;
            }

            return 'general_inquiry';
        };

        /**
         * Opens the WhatsApp message modal, pre-filling data and suggesting a message.
         * @param {Event} event - The click event.
         * @param {string} phoneNumber - The customer's phone number.
         * @param {string} customerName - The customer's name.
         * @param {string} docId - The document ID of the operation.
         * @param {number} daysOverdue - The number of days overdue (if applicable).
         * @param {string} containerNum - The container number(s).
         * @param {string} expectedEndDateFormatted - Formatted expected end date.
         * @param {string} customerAddress - The customer's address.
         */
        const openWhatsAppModal = (event, phoneNumber, customerName, docId, daysOverdue, containerNum, expectedEndDateFormatted, customerAddress) => {
            event.stopPropagation();
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const whatsappDocIdInput = document.getElementById('whatsapp-doc-id');
            const messageOptionsListDiv = document.getElementById('message-options-list');

            phoneInput.value = phoneNumber.startsWith('972') ? phoneNumber : `972${phoneNumber.substring(1)}`;
            whatsappDocIdInput.value = docId;

            // Find the full operation object to pass to getSuggestedMessageIdForOrder
            const fullOrderOp = allOperations.find(op => String(op['×ª×¢×•×“×”']) === String(docId));

            // Use the full order object which already has pre-calculated '×™××™× ×©×¢×‘×¨×•' and 'isOverdue'
            const suggestedMessageId = getSuggestedMessageIdForOrder(fullOrderOp);

            messageOptionsListDiv.innerHTML = '';

            // Combine predefined messages and city guidelines messages
            const allMsgs = [...whatsappMessages];
            const customerCity = getCityFromAddress(customerAddress);
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                allMsgs.unshift({ // Add city guideline to the beginning for prominence
                    id: guideline.id,
                    text: `**×”× ×—×™×™×ª ×¢×™×¨×™×™×ª ${customerCity}:**\n${guideline.text}\n\n×œ××™×“×¢ ×•×˜×¤×¡×™× × ×•×¡×¤×™×: ${guideline.link}`,
                    category: '×”×™×ª×¨×™× ×¢×™×¨×•× ×™×™×',
                    placeholders: [],
                    emoji: guideline.emoji
                });
            }

            allMsgs.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item p-3 rounded-md cursor-pointer hover:bg-gray-100 border border-transparent transition-colors`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-300'); // Highlight suggested message
                }
                const displayEmoji = msg.category === '××©×¤×˜×™' ? '' : (msg.emoji || '');
                optionDiv.innerHTML = `<strong class="text-sm text-gray-700">${displayEmoji} ${msg.category}:</strong><br><span class="text-sm text-gray-600">${msg.text.replace(/\[.*?\]/g, '...').substring(0, 70)}...</span>`;
                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('bg-blue-100', 'text-blue-800', 'border-blue-300'));
                    optionDiv.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-300');
                    const placeholders = {
                        '×©× ×œ×§×•×—': customerName,
                        '×™××™× ×©×¢×‘×¨×•': daysOverdue,
                        '××¡×¤×¨ ××›×•×œ×”': containerNum,
                        '×ª×¢×•×“×”': docId,
                        '×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™': expectedEndDateFormatted,
                        '××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.phoneNumber,
                        '×˜×œ×¤×•×Ÿ ×—×‘×¨×”': companyInfo.companyPhone,
                        '×©× ×”×—×‘×¨×”': companyInfo.companyName,
                        '×œ×™× ×§ ×œ×‘×™×§×•×¨×ª': 'https://example.com/review' // Placeholder link
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                    // Hide options after selection
                    document.getElementById('whatsapp-message-options-container').classList.add('hidden');
                    document.getElementById('message-options-toggle-icon').classList.remove('rotate-180');
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            // Automatically click the suggested message if one is found, otherwise click the first one
            const defaultSelection = messageOptionsListDiv.querySelector('.message-option-item.bg-blue-100');
            if (defaultSelection) {
                defaultSelection.click();
            } else if (allMsgs.length > 0) {
                allMsgs[0].id && messageOptionsListDiv.children[0].click(); // Check if first message has an id to prevent errors
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        /**
         * Closes the WhatsApp message modal and stops the typing effect.
         */
        const closeModalWhatsApp = () => {
            document.getElementById('whatsapp-modal').classList.add('hidden');
            document.getElementById('whatsapp-modal').classList.remove('flex');
            clearInterval(typingInterval);
            document.getElementById('phone-error').classList.add('hidden'); // Hide phone error
        };

        /**
         * Selects a message and simulates typing its content into the display and textarea.
         * @param {string} messageId - The ID of the message to select.
         * @param {Object} placeholders - Key-value pairs for message placeholders.
         */
        const selectAndTypeMessage = (messageId, placeholders = {}) => {
            clearInterval(typingInterval); // Clear any existing typing interval
            const allMessagesWithGuidelines = [ // Combine all possible messages
                ...whatsappMessages,
                ...Object.values(cityGuidelines)
            ];
            const message = allMessagesWithGuidelines.find(msg => msg.id === messageId);
            const typingDisplay = document.getElementById('typing-effect-display');
            const whatsappMessageTextarea = document.getElementById('whatsapp-message-textarea');

            if (message) {
                currentMessageFullText = message.text;
                for (const key in placeholders) {
                    // Replace both **[PLACEHOLDER]** and [PLACEHOLDER] formats
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[\\*\\*${key}\\*\\*\\]|\\[${key}\\]`, 'g'), placeholders[key]);
                }

                typingIndex = 0;
                typingDisplay.textContent = ''; // Clear display
                whatsappMessageTextarea.value = ''; // Clear textarea

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        whatsappMessageTextarea.value = currentMessageFullText; // Set full text to textarea
                        typingDisplay.textContent = ''; // Clear typing display after completion
                    }
                }, 30); // Typing speed
            }
        };

        /**
         * Sends the WhatsApp message by opening a new window and logs the action.
         * @async
         */
        const sendWhatsAppMessage = async () => {
            const phoneNumber = document.getElementById('whatsapp-phone-input').value.trim().replace(/\D/g, '');
            const message = document.getElementById('whatsapp-message-textarea').value.trim();
            const docId = document.getElementById('whatsapp-doc-id').value;
            const phoneError = document.getElementById('phone-error');

            // Basic phone number validation
            if (!phoneNumber || !/^\d{9,15}$/.test(phoneNumber)) { // Basic validation for 9-15 digits
                phoneError.classList.remove('hidden');
                showStatusMessage('×× × ×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×ª×§×™×Ÿ.', 'error');
                return;
            } else {
                phoneError.classList.add('hidden');
            }

            if (!message) {
                showStatusMessage('×ª×•×›×Ÿ ×”×”×•×“×¢×” ×œ× ×™×›×•×œ ×œ×”×™×•×ª ×¨×™×§.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            closeModalWhatsApp();

            // Log to Google Sheet via Apps Script with exponential backoff
            if (docId) {
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(`${SCRIPT_WEB_APP_URL}?action=logWhatsAppMessage&docId=${encodeURIComponent(docId)}&message=${encodeURIComponent(message)}`);
                        const data = await response.json();
                        if (data.success) {
                            showStatusMessage('×”×”×•×“×¢×” × ×©×œ×—×” ×•×ª×•×¢×“×” ×‘×”×¦×œ×—×”!', 'success');
                            return;
                        } else if (data.message && data.message.includes('Service invoked too many times')) {
                            const delay = baseDelay * Math.pow(2, retries);
                            // console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else {
                            showStatusMessage('×©×’×™××” ×‘×ª×™×¢×•×“ ×”×”×•×“×¢×”: ' + data.message, 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Fetch error:', error);
                        showStatusMessage('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ' + error.message, 'error');
                        return;
                    }
                }
                showStatusMessage('× ×›×©×œ ×ª×™×¢×•×“ ×”×”×•×“×¢×” ×œ××—×¨ ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×—×•×–×¨×™×.', 'error');
            } else {
                showStatusMessage('×”×”×•×“×¢×” × ×©×œ×—×”, ××š ×œ× ×©×•×™×›×” ×œ××¡××š (×—×¡×¨ ××¡×¤×¨ ×ª×¢×•×“×”).', 'warning');
            }
        };

        /**
         * Filters the list of WhatsApp message options based on user input.
         */
        const filterMessageOptions = () => {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        };

        /**
         * Toggles the visibility of WhatsApp message options.
         */
        const toggleMessageOptions = () => {
            const container = document.getElementById('whatsapp-message-options-container');
            const icon = document.getElementById('message-options-toggle-icon');
            container.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        };

        // New Order Modal Functions
        /**
         * Opens the new order modal, pre-filling the current date and default status.
         */
        const openNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.remove('hidden');
            document.getElementById('new-order-modal').classList.add('flex');
            // Pre-fill some fields if desired, e.g., current date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('new-order-date').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('new-order-status').value = '×¤×ª×•×—'; // Default status
            document.getElementById('docid-error').classList.add('hidden'); // Hide any previous error
            document.getElementById('new-order-form').reset(); // Clear form inputs
        };

        /**
         * Closes the new order modal and clears the form.
         */
        const closeNewOrderModal = () => {
            document.getElementById('new-order-modal').classList.add('hidden');
            document.getElementById('new-order-modal').classList.remove('flex');
            document.getElementById('new-order-form').reset(); // Clear form inputs
            document.getElementById('docid-error').classList.add('hidden'); // Hide any previous error
        };

        /**
         * Submits a new order, including validation and interaction with Google Sheet.
         * @async
         */
        const submitNewOrder = async () => {
            const form = document.getElementById('new-order-form');
            const docIdInput = document.getElementById('new-order-docid');
            const docIdError = document.getElementById('docid-error');

            // Client-side form validation
            if (!form.checkValidity()) {
                form.reportValidity(); // Standard browser validation feedback
                showStatusMessage('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×.', 'error');
                return;
            }

            // Check for duplicate document ID
            if (allOperations.some(op => String(op['×ª×¢×•×“×”']) === docIdInput.value.trim())) {
                docIdError.classList.remove('hidden');
                showStatusMessage('××¡×¤×¨ ×ª×¢×•×“×” ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ ××¡×¤×¨ ××—×¨.', 'error');
                return;
            } else {
                docIdError.classList.add('hidden');
            }

            const formData = new FormData(form);
            const order = {};
            // Collect all form data
            formData.forEach((value, key) => {
                order[key] = value;
            });

            // Ensure action type is clean (remove typo if any)
            if (order['×¡×•×’ ×¤×¢×•×œ×”'] === '×”×—al×¤×”') {
                order['×¡×•×’ ×¤×¢×•×œ×”'] = '×”×—×œ×¤×”';
            }

            // Calculate '×™××™× ×©×¢×‘×¨×•' if '×ª××¨×™×š ×”×–×× ×”' is provided
            const orderDateObj = order['×ª××¨×™×š ×”×–×× ×”'] ? formatDate(order['×ª××¨×™×š ×”×–×× ×”']) : null;
            order['×™××™× ×©×¢×‘×¨×•'] = orderDateObj && !isNaN(orderDateObj.getTime()) ? daysSince(orderDateObj) : '';

            // Combine container numbers for '××¡×¤×¨×™ ××›×•×œ×•×ª' if not explicitly provided
            const containerDropped = order['××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”'] || '';
            const containerLifted = order['××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”'] || '';
            if (containerDropped && containerLifted) {
                order['××¡×¤×¨×™ ××›×•×œ×•×ª'] = `${containerDropped},${containerLifted}`;
            } else {
                order['××¡×¤×¨×™ ××›×•×œ×•×ª'] = containerDropped || containerLifted || '';
            }

            // Prepare the order object for sending to Google Sheet (all fields must be strings)
            const sheetHeaders = [
                "×ª××¨×™×š ×”×–×× ×”", "×ª×¢×•×“×”", "×©× ×¡×•×›×Ÿ", "×©× ×œ×§×•×—", "×›×ª×•×‘×ª", "×¡×•×’ ×¤×¢×•×œ×”",
                "×™××™× ×©×¢×‘×¨×•", "××¡×¤×¨ ××›×•×œ×” ×™×¨×“×”", "××¡×¤×¨ ××›×•×œ×” ×¢×œ×ª×”", "××¡×¤×¨×™ ××›×•×œ×•×ª",
                "×¡×˜×˜×•×¡", "×”×¢×¨×•×ª", "×ª××¨×™×š ×¡×™×•× ×¦×¤×•×™", "×”×¢×¨×•×ª ×¡×™×•×", "×ª××¨×™×š ×¡×’×™×¨×”",
                "×™××™× ×©×¢×‘×¨×• (×¢×œ×ª×”)", "×˜×œ×¤×•×Ÿ ×œ×§×•×—"
            ];
            const completeOrderForSheet = {};
            sheetHeaders.forEach(header => {
                let value = order[header];
                if (value instanceof Date) {
                    value = formatISODate(value); // Convert Date objects to YYYY-MM-DD string
                } else if (value === null || value === undefined) {
                    value = ''; // Ensure all empty fields are empty strings
                }
                completeOrderForSheet[header] = String(value); // Ensure all values are strings for the sheet
            });

            await addNewOrderToSheet(completeOrderForSheet);

            closeNewOrderModal();
        };

    </script>
</body>
</html>
