<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת CRM - לוח בקרה משודרג</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js CDN for charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for Inter and Heebo -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        /* Define color palette as CSS variables for easy theming */
        :root {
            /* Light Theme Palette */
            --primary-brand: #6D28D9; /* Deep Purple */
            --secondary-brand: #8B5CF6; /* Lighter Purple */
            --accent-color: #3B82F6; /* Blue Accent */
            --background-light: #F8FAFC; /* Lightest Background */
            --surface-light: #FFFFFF; /* Card/Modal Surface */
            --text-dark: #1F2937; /* Dark text */
            --text-medium: #4B5563; /* Medium text */
            --border-light: #E5E7EB; /* Light border */
            --notification-error: #EF4444; /* Red for errors */
            --notification-warning: #F59E0B; /* Orange for warnings */
            --notification-info: #3B82F6; /* Blue for info */

            /* Dark Theme Palette */
            --dark-primary-brand: #A78BFA;
            --dark-secondary-brand: #8B5CF6;
            --dark-accent-color: #60A5FA;
            --dark-background-dark: #1F2937;
            --dark-surface-dark: #374151;
            --dark-text-light: #F8FAFC;
            --dark-text-medium: #D1D5DB;
            --dark-border-dark: #4B5563;
            --dark-notification-error: #DC2626;
            --dark-notification-warning: #D97706;
            --dark-notification-info: #2563EB;

            /* New Floating/Subtle Colors */
            --floating-bg-start: #E0F2F7;   /* Very Light Blue */
            --floating-bg-end: #FFFBEB;     /* Very Light Gold */
            --floating-surface-opacity: 0.9; /* Slightly more opaque cards */
            --floating-shadow-color: rgba(0, 0, 0, 0.15); /* Stronger, diffused shadow */
            --floating-shadow-color-dark: rgba(0, 0, 0, 0.4);

            /* New Notification Specific Colors */
            --note-bg-light: #F0F9FF; /* Light blue for notes in light mode */
            --note-text-light: #1F2937; /* Dark text for notes in light mode */
            --note-border-light: #BFDBFE; /* Light border for notes in light mode */

            --note-bg-dark: #2F3C4C; /* Darker blue for notes in dark mode */
            --note-text-dark: #E0F2F7; /* Lighter text for notes in dark mode */
            --note-border-dark: #4A5B6D; /* Darker border for notes in dark mode */
        }

        body {
            font-family: 'Heebo', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--floating-bg-start) 0%, var(--floating-bg-end) 100%);
            color: var(--text-dark);
            transition: background-color 0.3s ease, color 0.3s ease, background 0.5s ease;
            min-height: 100vh;
        }
        body.dark {
            background: linear-gradient(135deg, var(--dark-background-dark) 0%, #303F50 100%);
            color: var(--dark-text-light);
        }
        .container-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: rgba(255, 255, 255, var(--floating-surface-opacity));
            border-radius: 16px;
            box-shadow: 0 8px 25px var(--floating-shadow-color);
            padding: 1.5rem;
            transition: all 0.3s ease-in-out;
            border: 1px solid rgba(229, 231, 235, 0.6);
            transform: translateZ(0);
            perspective: 1000px;
        }
        body.dark .card {
            background-color: rgba(55, 65, 81, var(--floating-surface-opacity));
            box-shadow: 0 8px 25px var(--floating-shadow-color-dark);
            border-color: rgba(75, 85, 99, 0.6);
        }
        .card:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        .btn-metric {
            @apply flex flex-col items-center justify-center p-6 rounded-2xl shadow-xl transition-transform transform hover:scale-105 active:scale-95 text-white font-bold text-center cursor-pointer;
            min-height: 130px;
            border: none;
            outline: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
            background: linear-gradient(135deg, var(--primary-brand), var(--secondary-brand));
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3),
                        inset 0 0 20px rgba(255, 255, 255, 0.2);
        }
        .btn-metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.15);
            filter: blur(15px);
            z-index: -1;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        .btn-metric:hover::before {
            opacity: 1;
        }
        
        /* LED Effect for text */
        .btn-metric .metric-value, .btn-metric .metric-label {
            color: #fff;
            text-shadow: 
                0 0 8px #fff,
                0 0 16px #fff,
                0 0 24px #fff,
                0 0 32px #fff;
            animation: glow 1.8s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                text-shadow: 
                    0 0 6px #fff,
                    0 0 12px #fff,
                    0 0 18px #fff;
            }
            to {
                text-shadow: 
                    0 0 12px #fff,
                    0 0 24px #fff,
                    0 0 36px #fff,
                    0 0 48px #fff;
            }
        }

        .btn-metric .metric-value {
            font-size: 2.8rem;
            line-height: 1;
            margin-bottom: 0.75rem;
        }
        .btn-metric .metric-label {
            font-size: 1.2rem;
            line-height: 1.3;
        }

        /* Notification Board Styling - ENHANCED */
        #notification-board {
            background: linear-gradient(145deg, rgba(254, 242, 242, 0.9), rgba(254, 226, 226, 0.9));
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.25);
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            border: 1px solid rgba(252, 165, 165, 0.7);
            position: relative;
        }
        body.dark #notification-board {
            background: linear-gradient(145deg, rgba(55, 65, 81, 0.9), rgba(75, 85, 99, 0.9));
            border-color: rgba(75, 85, 99, 0.7);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        #notification-board h2 {
            color: #B91C1C;
        }
        body.dark #notification-board h2 {
            color: #EF4444;
        }

        #notifications-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted min-width for smaller cubes */
            gap: 1.5rem;
        }
        .notification-item {
            /* Removed direct background-color for dynamic gradients */
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border: 1px solid transparent; /* Set a default transparent border */
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            color: var(--text-dark); /* Default text color, overridden by specific types */
            transform: translateZ(0);
            perspective: 1000px;
            overflow: hidden; /* Ensure content stays within rounded corners */
            text-align: right; /* Ensure text aligns to right in RTL */
        }
        body.dark .notification-item {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: var(--dark-text-light);
        }
        
        /* Specific color gradients and borders for notification types */
        .notification-item.error { 
            background: linear-gradient(135deg, #EF4444, #FCA5A5); 
            color: white; 
            border-color: #DC2626; 
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }
        .notification-item.warning { 
            background: linear-gradient(135deg, #F59E0B, #FCD34D); 
            color: white; 
            border-color: #D97706; 
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }
        .notification-item.info { 
            background: linear-gradient(135deg, #3B82F6, #93C5FD); 
            color: white; 
            border-color: #2563EB; 
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        body.dark .notification-item.error { background: linear-gradient(135deg, #DC2626, #EF4444); border-color: #B91C1C; }
        body.dark .notification-item.warning { background: linear-gradient(135deg, #D97706, #F59E0B); border-color: #B45309; }
        body.dark .notification-item.info { background: linear-gradient(135deg, #2563EB, #3B82F6); border-color: #1D4ED8; }


        .notification-item:hover {
            transform: translateY(-5px) translateZ(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .notification-item.handled {
            opacity: 0.6;
            text-decoration: line-through;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.7), rgba(229, 231, 235, 0.7)); /* Faint light gradient for handled */
            color: var(--text-medium);
            border-color: rgba(209, 213, 219, 0.7);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        body.dark .notification-item.handled {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.7), rgba(55, 65, 81, 0.7)); /* Faint dark gradient for handled */
            color: var(--dark-text-medium);
            border-color: rgba(75, 85, 99, 0.7);
        }
        .notification-item.handled .notification-icon,
        .notification-item.handled .notification-header,
        .notification-item.handled .notification-details,
        .notification-item.handled .notification-last-note,
        .notification-item.handled .dvid-blinking-text {
            color: var(--text-medium); /* Desaturate all text when handled */
        }
        body.dark .notification-item.handled .notification-icon,
        body.dark .notification-item.handled .notification-header,
        body.dark .notification-item.handled .notification-details,
        body.dark .notification-item.handled .notification-last-note,
        body.dark .notification-item.handled .dvid-blinking-text {
            color: var(--dark-text-medium);
        }

        .notification-item .pin-icon {
            top: 0.75rem;
            right: 0.75rem;
            font-size: 1.1rem;
            color: inherit;
            text-shadow: 0 0 5px rgba(0,0,0,0.2);
            z-index: 1; /* Ensure pin icon is above content */
        }
        .notification-item .pin-icon:hover {
            color: rgba(255, 255, 255, 0.9); /* White on hover for contrast */
            transform: scale(1.1);
        }
        .notification-item.handled .pin-icon {
            color: #10B981;
            text-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }
        
        .notification-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            align-self: center;
            color: white; /* Icons should be white against the colored background */
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
        }
        .notification-header {
            font-size: 1.3rem; /* Larger title */
            font-weight: 800; /* Extra bold */
            color: white; /* Header text white on colored background */
            margin-bottom: 0.5rem;
            text-align: center;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.1); /* Subtle dark background for title */
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            word-break: break-word; /* Prevent long words from overflowing */
        }
        .notification-details {
            font-size: 1rem;
            color: white; /* Details text white on colored background */
            margin-bottom: 0.75rem;
            line-height: 1.4;
            width: 100%;
            text-align: right;
            padding-right: 0.5rem; /* Padding for RTL */
        }
        .notification-details .days-overdue-value {
            font-weight: 700; /* Bold the days value */
            text-shadow: 0 0 3px rgba(255,255,255,0.5);
        }

        .notification-last-note {
            background-color: var(--note-bg-light); /* Different color for note */
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--note-text-light); /* Dark text on light background */
            width: 100%;
            border: 1px solid var(--note-border-light);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Inner shadow for depth */
        }
        body.dark .notification-last-note {
            background-color: var(--note-bg-dark);
            color: var(--note-text-dark);
            border-color: var(--note-border-dark);
            box-shadow: inset 0 0 5px rgba(255,255,255,0.05);
        }

        /* Blinking Text for DVID */
        @keyframes blink-black {
            0%, 100% { color: black; text-shadow: 0 0 2px rgba(0,0,0,0.5); }
            50% { color: rgba(0, 0, 0, 0.4); text-shadow: none; }
        }
        .notification-item.error .dvid-blinking-text,
        .notification-item.warning .dvid-blinking-text,
        .notification-item.info .dvid-blinking-text {
            color: black; /* Force black for these types */
            animation: blink-black 1.5s step-end infinite;
            font-weight: 900; /* Extra bold */
            font-size: 1.1em; /* Slightly larger than surrounding text */
            text-shadow: 0 0 5px rgba(0,0,0,0.3); /* Stronger shadow */
        }
        /* Ensure blinking text is visible on dark mode backgrounds too */
        body.dark .notification-item.error .dvid-blinking-text,
        body.dark .notification-item.warning .dvid-blinking-text,
        body.dark .notification-item.info .dvid-blinking-text {
            color: black; /* Still black in dark mode for contrast */
            text-shadow: 0 0 5px rgba(255,255,255,0.5); /* White shadow on dark background */
        }


        /* WhatsApp button in notifications - Redesigned to match WhatsApp brand */
        .whatsapp-icon-btn {
            background-color: #25D366; /* WhatsApp green */
            color: white;
            border-radius: 50%;
            width: 48px; /* Slightly larger button */
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; /* Larger icon */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 3px solid rgba(255, 255, 255, 0.7); /* Thicker white border */
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            z-index: 10; /* Ensure it's on top */
        }
        .whatsapp-icon-btn:hover {
            background-color: #1DA851;
            transform: scale(1.08) rotate(5deg);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }
        body.dark .whatsapp-icon-btn {
             border: 3px solid rgba(0, 0, 0, 0.4);
        }


        /* Chart Styling - Subtly updated */
        .chart-container-crm {
            background-color: rgba(255, 255, 255, var(--floating-surface-opacity));
            border-radius: 16px;
            box-shadow: 0 8px 25px var(--floating-shadow-color);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(229, 231, 235, 0.6);
            position: relative;
            transform: translateZ(0);
            perspective: 1000px;
        }
        body.dark .chart-container-crm {
            background-color: rgba(55, 65, 81, var(--floating-surface-opacity));
            border-color: rgba(75, 85, 99, 0.6);
            box-shadow: 0 8px 25px var(--floating-shadow-color-dark);
        }
        .chart-container-crm:hover {
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }
        .chart-container-crm h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }
        body.dark .chart-container-crm h3 {
            color: var(--dark-text-light);
        }
        .chart-svg-container {
            width: 100%;
            height: 350px;
        }
        .chart-bar {
            fill: var(--primary-brand);
            transition: fill 0.3s ease;
        }
        body.dark .chart-bar {
            fill: var(--dark-primary-brand);
        }
        .chart-bar:hover {
            fill: var(--secondary-brand);
        }
        body.dark .chart-bar:hover {
            fill: var(--dark-secondary-brand);
        }
        .pie-slice path {
            transition: opacity 0.3s ease;
        }
        .pie-slice:hover path {
            opacity: 0.8;
        }
        .chart-text, .axis-text, .legend-text {
            fill: var(--text-medium);
            font-size: 0.9rem;
        }
        body.dark .chart-text, body.dark .axis-text, body.dark .legend-text {
            fill: var(--dark-text-medium);
        }
        .axis path, .axis line {
            stroke: var(--border-light);
            stroke-width: 1px;
        }
        body.dark .axis path, body.dark .axis line {
            stroke: var(--dark-border-dark);
        }

        /* Table Styling */
        .table-container {
            background-color: rgba(255, 255, 255, var(--floating-surface-opacity));
            border-radius: 16px;
            box-shadow: 0 8px 25px var(--floating-shadow-color);
            border: 1px solid rgba(229, 231, 235, 0.6);
            transform: translateZ(0);
            perspective: 1000px;
        }
        body.dark .table-container {
            background-color: rgba(55, 65, 81, var(--floating-surface-opacity));
            border-color: rgba(75, 85, 99, 0.6);
            box-shadow: 0 8px 25px var(--floating-shadow-color-dark);
        }
        .table-container:hover {
            transform: translateY(-3px) translateZ(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }
        th, td {
            padding: 1rem 1.2rem;
            font-size: 1.05rem;
        }
        th {
            background-color: rgba(248, 250, 252, 0.7);
        }
        body.dark th {
            background-color: rgba(31, 41, 55, 0.7);
        }
        tr:hover {
            background-color: rgba(248, 250, 252, 0.5);
        }
        body.dark tr:hover {
            background-color: rgba(31, 41, 55, 0.5);
        }
        
        /* Modal specific styles - ENHANCED for full page on desktop */
        .modal-overlay {
            position: fixed; /* Ensure it stays fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* High z-index */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--surface-light);
            padding: 3rem;
            border-radius: 20px;
            max-width: 90vw;
            width: 90%; /* Default width for content */
            max-height: 90vh;
            position: relative;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.35);
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        body.dark .modal-content {
            background-color: var(--dark-surface-dark);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
        }
        .modal-full-width {
            max-width: 95vw;
            width: 95%; /* Wider for tables/charts */
            max-height: 95vh;
        }
        /* Mobile Drawer for modals */
        .modal-overlay.mobile-drawer .modal-content {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            border-radius: 0;
            padding: 2rem;
            transform: translateX(100%);
            opacity: 1; /* Already visible if active */
            transition: transform 0.3s ease;
        }
        .modal-overlay.active.mobile-drawer .modal-content {
            transform: translateX(0);
        }

        /* WhatsApp Modal specific styles - ENHANCED */
        #whatsapp-modal .modal-content {
            background: linear-gradient(145deg, #E0F7FA, #E8F5E9);
            border: 1px solid #B2EBF2;
            box-shadow: 0 15px 40px rgba(0, 150, 136, 0.2);
            color: #263238;
            padding: 3rem;
            border-radius: 20px;
            max-width: 700px;
            width: 95%;
        }
        body.dark #whatsapp-modal .modal-content {
            background: linear-gradient(145deg, #263238, #3E4A56);
            border: 1px solid #4DB6AC;
            color: #CFD8DC;
            box-shadow: 0 15px 40px rgba(0, 150, 136, 0.3);
        }
        #whatsapp-modal .modal-close-btn {
            color: #263238;
        }
        body.dark #whatsapp-modal .modal-close-btn {
            color: #CFD8DC;
        }
        #whatsapp-modal .text-gray-700 {
            color: #263238;
        }
        body.dark #whatsapp-modal .text-gray-700 {
            color: #CFD8DC;
        }
        #whatsapp-message-textarea {
            min-height: 180px;
            font-size: 1.05rem;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.1);
            border-color: #B0BEC5;
        }
        body.dark #whatsapp-message-textarea {
            box-shadow: inset 0 1px 5px rgba(255,255,255,0.05);
            border-color: #607D8B;
        }

        #whatsapp-message-options {
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(229, 231, 235, 0.7);
        }
        body.dark #whatsapp-message-options {
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-color: rgba(75, 85, 99, 0.7);
        }
        .message-option-header {
            padding: 1.25rem;
            font-size: 1.2rem;
            border-bottom-color: rgba(229, 231, 235, 0.7);
        }
        body.dark .message-option-header {
            border-bottom-color: rgba(75, 85, 99, 0.7);
        }
        .message-option-list-container.expanded {
            max-height: 400px;
        }

        .message-option-item {
            padding: 0.9rem 1.2rem;
            font-size: 0.95rem;
            border-radius: 8px;
        }
        .message-option-item.selected {
            background-color: #BBDEFB;
            color: #1976D2;
            font-weight: 700;
        }
        body.dark .message-option-item.selected {
            background-color: #1565C0;
            color: #BBDEFB;
        }

        .typing-effect-container {
            min-height: 150px;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px dashed rgba(156, 163, 175, 0.4);
            background-color: rgba(248, 250, 252, 0.7);
            box-shadow: inset 0 1px 5px rgba(0,0,0,0.05);
            font-size: 1.05rem;
        }
        body.dark .typing-effect-container {
            background-color: rgba(31, 41, 55, 0.7);
            border-color: rgba(107, 114, 128, 0.4);
            box-shadow: inset 0 1px 5px rgba(255,255,255,0.02);
        }
        .typing-effect-cursor {
            background-color: var(--accent-color);
        }

        /* Back to Top Button */
        #back-to-top-btn {
            background-color: var(--primary-brand);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        #back-to-top-btn:hover {
            background-color: var(--secondary-brand);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loader Spinner -->
    <div id="loader-overlay" class="loader-overlay hidden active">
        <div class="loader"></div>
    </div>

    <!-- Container for Alerts (Toasts) -->
    <div id="alert-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Modals -->
    <div id="order-details-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="details-modal-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeOrderDetailsModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="details-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700">פרטי הזמנה</h2>
            <div class="modal-body">
                <div id="current-order-card" class="order-card-detail">
                    <!-- Current order details/customer history will be loaded here -->
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeOrderDetailsModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <div id="container-history-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="container-history-modal-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeContainerHistoryModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="container-history-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700">היסטוריית מכולה: <span id="history-container-number"></span></h2>
            <div class="modal-body table-container">
                <table id="container-history-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>תאריך הזמנה</th>
                            <th>תעודה</th>
                            <th>שם לקוח</th>
                            <th>סוג פעולה</th>
                            <th>מספר מכולה ירדה</th>
                            <th>מספר מכולה עלתה</th>
                            <th>סטטוס הזמנה</th>
                            <th>תאריך סיום צפוי</th>
                            <th>WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-container-history" class="text-center text-gray-500 mt-4 hidden">אין היסטוריית שינויים עבור מכולה זו.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeContainerHistoryModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <div id="top-moving-containers-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="top-moving-containers-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeTopMovingContainersModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="top-moving-containers-title" class="text-2xl font-bold mb-6 text-center text-gray-700">מכולות מובילות בתזוזה</h2>
            <div class="flex justify-end gap-3 mb-4">
                <button class="btn btn-secondary" onclick="printReport('top-moving-containers-table')">
                    <i class="fas fa-print ml-2"></i> הדפס
                </button>
            </div>
            <div class="modal-body table-container">
                <table id="top-moving-containers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>מכולה</th>
                            <th>מספר תזוזות</th>
                            <th>הצג היסטוריה</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-top-moving-containers" class="text-center text-gray-500 mt-4 hidden">אין מכולות עם תזוזות רבות כרגע.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeTopMovingContainersModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <div id="returning-customers-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="returning-customers-title">
        <div class="modal-content modal-full-width">
            <button class="modal-close-btn" onclick="closeReturningCustomersModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="returning-customers-title" class="text-2xl font-bold mb-6 text-center text-gray-700">לקוחות חוזרים (בעלי הזמנות רבות)</h2>
            <div class="flex justify-end gap-3 mb-4">
                <button class="btn btn-secondary" onclick="printReport('returning-customers-table')">
                    <i class="fas fa-print ml-2"></i> הדפס
                </button>
            </div>
            <div class="modal-body table-container">
                <table id="returning-customers-table" class="min-w-full">
                    <thead>
                        <tr>
                            <th>שם לקוח</th>
                            <th>כתובת</th>
                            <th>כמות הזמנות</th>
                            <th>מכולות פעילות</th>
                            <th>היסטוריה חריגה</th>
                            <th>WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <p id="no-returning-customers" class="text-center text-gray-500 mt-4 hidden">אין לקוחות חוזרים כרגע.</p>
            </div>
            <div class="flex justify-end mt-4">
                <button class="btn btn-secondary" onclick="closeReturningCustomersModal()" aria-label="סגור">סגור</button>
            </div>
        </div>
    </div>

    <div id="whatsapp-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="whatsapp-modal-title">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeWhatsAppModal()" aria-label="סגור חלון"><i class="fas fa-times"></i></button>
            <h2 id="whatsapp-modal-title" class="text-2xl font-bold mb-6 text-center text-gray-700">
                <i class="fab fa-whatsapp text-green-500 ml-2"></i> שליחת הודעת WhatsApp
            </h2>
            <div class="mb-4">
                <label for="whatsapp-phone-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">מספר טלפון (פורמט בינלאומי ללא +):</label>
                <input type="tel" id="whatsapp-phone-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-bold tracking-wider dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="דוגמה: 972501234567">
            </div>

            <div class="mb-4">
                <div class="message-option-header" onclick="toggleMessageOptions()">
                    <label class="font-semibold text-lg cursor-pointer">בחר הודעה מובנית:</label>
                    <i class="fas fa-chevron-down transform transition-transform duration-200"></i>
                </div>
                <div id="whatsapp-message-options" class="message-option-list-container">
                    <input type="text" id="message-filter-input" class="w-full p-2 border-b border-gray-200 dark:border-gray-600 focus:outline-none focus:border-blue-500 dark:bg-gray-800 dark:text-gray-100" placeholder="חפש הודעה..." onkeyup="filterMessageOptions()">
                    <div id="message-options-list" class="py-2">
                        <!-- Message options will be populated here by JS -->
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label for="whatsapp-message-textarea" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">תוכן ההודעה:</label>
                <div class="typing-effect-container">
                    <span id="typing-effect-display"></span><span class="typing-effect-cursor"></span>
                </div>
                <textarea id="whatsapp-message-textarea" class="w-full text-base font-medium" rows="6"></textarea>
            </div>

            <input type="hidden" id="whatsapp-current-order-sheet-row">

            <div class="flex justify-end gap-3 mt-6">
                <button class="btn btn-secondary" onclick="closeWhatsAppModal()">ביטול</button>
                <button class="whatsapp-share-btn" onclick="sendWhatsAppMessage()">
                    <i class="fab fa-whatsapp ml-2"></i> שלח הודעה
                </button>
            </div>
        </div>
    </div>


    <!-- Main CRM Dashboard Structure -->
    <div class="min-h-screen flex flex-col container-wrapper">
        <header class="mb-8 text-center flex flex-col items-center justify-center">
            <div class="flex items-center justify-center mb-4">
                <img src="https://i.postimg.cc/jqBVzJsq/1.png" alt="Company Logo" class="h-20 w-20 rounded-full shadow-lg border-2 border-purple-350 mr-4" aria-label="לוגו החברה">
                <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100 m-0">לוח בקרה למנהל CRM</h1>
            </div>
            <p class="text-lg text-gray-600 dark:text-gray-300 mb-2">תובנות עמוקות וניהול חכם של המערכת</p>
            <div class="text-sm text-gray-500 dark:text-gray-400 font-mono tracking-wide">
                <span id="current-date-crm" class="mr-2 text-purple-600 font-semibold"></span> |
                <span id="current-time-crm" class="ml-2 text-blue-600 font-semibold animate-pulse"></span>
            </div>
            <!-- Dark/Light Mode Toggle -->
            <button id="theme-toggle-crm" class="mt-4 px-4 py-2 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 transition-colors flex items-center gap-2" aria-label="החלף מצב כהה/בהיר">
                <i class="fas fa-sun" id="sun-icon-crm"></i><i class="fas fa-moon hidden" id="moon-icon-crm"></i>
                <span>מצב בהיר</span>
            </button>
        </header>

        <!-- Notification Board -->
        <section id="notification-board" class="mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">
                <i class="fas fa-bullhorn ml-2"></i> לוח מודעות והתראות קריטיות
            </h2>
            <div id="notifications-list" class="space-y-3">
                <!-- Notifications will be loaded here by JavaScript -->
            </div>
            <p id="no-notifications-msg" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין התראות חדשות. כל הכבוד! 🎉</p>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">
        
        <!-- Order Status Filter -->
        <div class="flex justify-center mb-6">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-4 flex items-center gap-4">
                <label for="order-status-filter" class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                    <i class="fas fa-filter ml-2"></i> סנן לפי סטטוס הזמנה:
                </label>
                <select id="order-status-filter" onchange="applyOrderStatusFilter()" 
                        class="px-4 py-2 border border-gray-300 rounded-md bg-white dark:bg-gray-800 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="all">כל ההזמנות</option>
                    <option value="open">פתוח</option>
                    <option value="closed">סגור</option>
                    <option value="overdue">חורג</option>
                </select>
            </div>
        </div>

        <!-- Report Buttons -->
        <section id="report-buttons" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <button class="btn-metric bg-blue" onclick="showReportTable('orders-per-customer-table')">
                <span class="metric-value" id="total-orders-count">0</span>
                <span class="metric-label">סה"כ הזמנות</span>
            </button>
            <button class="btn-metric bg-green" onclick="showReportTable('action-type-counts-table')">
                <span class="metric-value" id="unique-action-types-count">0</span>
                <span class="metric-label">סוגי פעולות ייחודיים</span>
            </button>
            <button class="btn-metric bg-purple" onclick="showReportTable('customers-multiple-containers-table')">
                <span class="metric-value" id="customers-multiple-count">0</span>
                <span class="metric-label">לקוחות עם מכולות מרובות</span>
            </button>
        </section>

        <!-- New Custom Report Buttons -->
        <section id="custom-report-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <button class="btn-metric bg-yellow-500" onclick="openTopMovingContainersModal()">
                <span class="metric-value" id="top-moving-container-display">
                    📦 <span id="top-moving-container-number">אין</span> (<span id="top-moving-container-count">0</span>)
                </span>
                <span class="metric-label">מספר מכולה מוביל בתזוזה</span>
            </button>
            <button class="btn-metric bg-indigo-500" onclick="openReturningCustomersModal()">
                <span class="metric-value" id="returning-customers-display">
                    <i class="fas fa-redo-alt"></i> <span id="returning-customers-count">0</span>
                </span>
                <span class="metric-label">לקוחות חוזרים</span>
            </button>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">

        <!-- Charts Section -->
        <section id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div id="chart-orders-per-customer" class="chart-container-crm">
                <h3>כמות הזמנות לכל לקוח (הכי פעילים)</h3>
                <div class="chart-svg-container" id="svg-orders-per-customer"></div>
                <p id="no-data-orders-per-customer" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
            <div id="chart-action-type-distribution" class="chart-container-crm">
                <h3>חלוקת סוגי פעולות</h3>
                <div class="chart-svg-container" id="svg-action-type-distribution"></div>
                <p id="no-data-action-type" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
            <div id="chart-monthly-orders" class="chart-container-crm">
                <h3>הזמנות לפי חודש</h3>
                <div class="chart-svg-container" id="svg-monthly-orders"></div>
                <p id="no-data-monthly-orders" class="text-center text-gray-500 dark:text-gray-400 hidden">אין נתונים להצגה.</p>
            </div>
        </section>
        <hr class="my-8 border-gray-200 dark:border-gray-700">

        <!-- Reports & Tables Section -->
        <section id="reports-tables-section" class="space-y-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100 text-center">
                <i class="fas fa-file-invoice-dollar text-green-500 ml-2"></i> דוחות מפורטים
            </h2>

            <!-- Orders Per Customer Table -->
            <div id="orders-per-customer-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-users-cog ml-2"></i> דוח: כמות הזמנות לכל לקוח
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('orders-per-customer-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('orders-per-customer-table-data', 'orders_per_customer')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('orders-per-customer-table')">
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="orders-per-customer-table-data" class="min-w-full">
                        <thead>
                            <tr>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>כמות הזמנות</th>
                                <th>כמות מכולות פעילות</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-orders-per-customer-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

            <!-- Action Type Counts Table -->
            <div id="action-type-counts-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-cogs ml-2"></i> דוח: כמות סוגי פעולות
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('action-type-counts-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('action-type-counts-table-data', 'action_type_counts')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('action-type-counts-table')">
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="action-type-counts-table-data" class="min-w-full">
                        <thead>
                            <tr>
                                <th>סוג פעולה</th>
                                <th>כמות</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                 <p id="no-data-action-type-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

            <!-- Customers with Multiple Containers Table -->
            <div id="customers-multiple-containers-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-cubes ml-2"></i> דוח: לקוחות עם יותר ממכולה אחת
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('customers-multiple-containers-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('customers-multiple-containers-table-data', 'customers_multiple_containers')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('customers-multiple-containers-table')">
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="customers-multiple-containers-table-data" class="min-w-full">
                        <thead>
                            <tr>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>כמות מכולות פעילות</th>
                                <th>מספרי מכולות</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-customers-multiple-containers-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>

             <!-- Overdue Summary Table (Detailed view for the button) -->
            <div id="overdue-summary-table" class="report-table-section card p-6 hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-calendar-times ml-2"></i> דוח: סיכום הזמנות חורגות
                </h3>
                <div class="flex justify-end gap-3 mb-4">
                    <button class="whatsapp-share-btn" onclick="shareReportToWhatsApp('overdue-summary-table')">
                        <i class="fab fa-whatsapp ml-2"></i> שתף לווצאפ
                    </button>
                    <button class="btn btn-secondary" onclick="exportTableToExcel('overdue-summary-table-data', 'overdue_orders_summary')">
                        <i class="fas fa-file-excel ml-2"></i> יצא לאקסל
                    </button>
                    <button class="btn btn-secondary" onclick="printReport('overdue-summary-table')">
                        <i class="fas fa-print ml-2"></i> הדפס
                    </button>
                </div>
                <div class="table-container">
                    <table id="overdue-summary-table-data" class="min-w-full">
                        <thead>
                            <tr>
                                <th>תעודה</th>
                                <th>שם לקוח</th>
                                <th>כתובת</th>
                                <th>סוג פעולה</th>
                                <th>ימים שעברו</th>
                                <th>מכולות קשורות</th>
                                <th>הערות</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="no-data-overdue-summary-table" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">אין נתונים להצגה.</p>
            </div>


        </section>

        <footer class="mt-12 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>&copy; 2025 מערכת CRM למכולות. כל הזכויות שמורות.</p>
        </footer>
    </div>

    <!-- Floating Back to Top Button -->
    <button id="back-to-top-btn" title="חזרה למעלה">
        <i class="fas fa-arrow-up"></i>
    </button>


    <script>
        // Define Google Apps Script URL (replace with your actual deployment URL)
        const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec'; 

        let allOrders = []; // Raw data of all orders (unfiltered)
        let filteredOrders = []; // Data filtered by selected status
        let notifications = []; // Store active notifications
        let currentOrderFilter = 'all'; // Default filter: 'all', 'open', 'closed', 'overdue'

        const WHATSAPP_PHONE_NUMBER = '972508860896'; // WhatsApp number for main shares, not for individual customers

        // Utility Functions
        function showLoader() { document.getElementById('loader-overlay').classList.add('active'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.remove('active'); }

        /**
         * Determines if the current device is mobile based on screen width.
         * @returns {boolean} True if mobile, false if desktop.
         */
        function isMobile() {
            return window.innerWidth <= 768; // Tailwind's 'md' breakpoint
        }

        /**
         * Toggles between Dark Mode and Light Mode for this specific page.
         */
        function toggleThemeCrm() {
            const isDarkMode = document.body.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeToggleButtonCrm(isDarkMode);
        }

        /**
         * Updates the theme toggle button icon and text for this page.
         * @param {boolean} isDarkMode - True if dark mode is active, false otherwise.
         */
        function updateThemeToggleButtonCrm(isDarkMode) {
            const themeToggle = document.getElementById('theme-toggle-crm');
            const sunIcon = document.getElementById('sun-icon-crm');
            const moonIcon = document.getElementById('moon-icon-crm');

            if (isDarkMode) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeToggle.querySelector('span').textContent = 'מצב כהה';
                themeToggle.setAttribute('aria-label', 'החלף למצב בהיר');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggle.querySelector('span').textContent = 'מצב בהיר';
                themeToggle.setAttribute('aria-label', 'החלף למצב כהה');
            }
        }

        /**
         * Initializes the theme based on system preferences or local storage for this page.
         */
        function initializeThemeCrm() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (savedTheme === null && prefersDark)) {
                document.body.classList.add('dark');
                updateThemeToggleButtonCrm(true);
            } else {
                document.body.classList.remove('dark');
                updateThemeToggleButtonCrm(false);
            }

            document.getElementById('theme-toggle-crm').addEventListener('click', toggleThemeCrm);
        }

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'warning'|'info'} type - Type of notification.
         * @param {number} duration - Duration in milliseconds (default 5000).
         */
        function showAlert(message, type = 'info', duration = 5000) {
            const container = document.getElementById('alert-container');
            const alertItem = document.createElement('div');
            alertItem.className = `alert-item alert-${type} flex items-center gap-2`;
            alertItem.setAttribute('role', 'alert');
            alertItem.innerHTML = `
                ${type === 'success' ? '<i class="fas fa-check-circle text-green-600" aria-hidden="true"></i>' : ''}
                ${type === 'error' ? '<i class="fas fa-times-circle text-red-600" aria-hidden="true"></i>' : ''}
                ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-orange-600" aria-hidden="true"></i>' : ''}
                ${type === 'info' ? '<i class="fas fa-info-circle text-blue-600" aria-hidden="true"></i>' : ''}
                <p class="text-sm font-medium text-gray-800 flex-grow">${message}</p>
                <button class="close-alert-btn" onclick="this.closest('.alert-item').remove()" aria-label="סגור התראה"><i class="fas fa-times" aria-hidden="true"></i></button>
            `;
            container.appendChild(alertItem);

            setTimeout(() => {
                alertItem.style.opacity = '0';
                alertItem.style.transform = 'translateX(-100%)';
                setTimeout(() => alertItem.remove(), 300);
            }, duration);
        }

        /**
         * Sends a Fetch request to Google Apps Script with retry logic.
         * @param {string} action The action to perform in the script.
         * @param {Object} params Additional parameters for the request.
         * @param {number} retries Current retry attempt (default 0).
         * @returns {Promise<Object>} Response object from the server.
         */
        async function fetchData(action, params = {}, retries = 0) {
            showLoader();
            const urlParams = new URLSearchParams({ action, ...params });
            const url = `${SCRIPT_WEB_APP_URL}?${urlParams.toString()}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                hideLoader();
                if (!data.success) {
                    if (data.message && data.message.includes('Service invoked too many times')) {
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`API rate limit hit. Retrying in ${delay / 1000} seconds... (attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (retries < 5) {
                            return fetchData(action, params, retries + 1);
                        } else {
                            showAlert('הגענו למגבלת הקריאות לשרת. אנא נסה שוב מאוחר יותר.', 'error');
                        }
                    } else {
                        showAlert(data.message || 'שגיאה בביצוע הפעולה.', 'error');
                    }
                }
                return data;
            } catch (error) {
                hideLoader();
                console.error('Fetch error:', error);
                showAlert('שגיאה בתקשורת עם השרת: ' + error.message, 'error');
                return { success: false, message: 'שגיאה בתקשורת עם השרת: ' + error.message };
            }
        }

        /**
         * Loads all orders from the sheet and updates all UI components.
         * This function now loads all data and then applies the filter.
         */
        async function loadAllData() {
            const response = await fetchData('list', { status: 'all' });
            if (response.success) {
                allOrders = response.data; // Keep all orders in `allOrders`
                applyOrderStatusFilter(); // Apply initial filter and render
            }
        }

        /**
         * Applies the selected order status filter and updates all UI elements.
         */
        function applyOrderStatusFilter() {
            currentOrderFilter = document.getElementById('order-status-filter').value;
            console.log(`Applying filter: ${currentOrderFilter}`);
            
            if (currentOrderFilter === 'all') {
                filteredOrders = [...allOrders];
            } else if (currentOrderFilter === 'open') {
                // 'פתוח' and 'ממתין/לא תקין' are considered open
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'פתוח' || o['סטטוס'] === 'ממתין/לא תקין');
            } else if (currentOrderFilter === 'closed') {
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'סגור');
            } else if (currentOrderFilter === 'overdue') {
                filteredOrders = allOrders.filter(o => o['סטטוס'] === 'חורג');
            }

            processDataForDashboard();
            updateReportButtons();
            drawCharts();
            generateAndRenderNotifications(); // Re-render notifications based on new filter
            // Hide all report tables initially after filter change, user can click to reveal
            document.querySelectorAll('.report-table-section').forEach(section => section.classList.add('hidden'));
        }

        /**
         * Processes data to populate dashboard metrics based on filtered orders.
         */
        function processDataForDashboard() {
            document.getElementById('total-orders-count').textContent = filteredOrders.length;
            
            const topContainer = getTopMovingContainer(filteredOrders); // Pass filtered orders
            document.getElementById('top-moving-container-number').textContent = topContainer.container || 'אין';
            document.getElementById('top-moving-container-count').textContent = topContainer.count;

            document.getElementById('returning-customers-count').textContent = getReturningCustomers(filteredOrders).length; // Pass filtered orders
        }

        /**
         * Formats date for display.
         * @param {Date|string} dateInput Date or date string.
         * @returns {string} Date in DD/MM/YYYY format.
         */
        function formatDate(dateInput) {
            if (!dateInput) return '';
            const date = new Date(dateInput);
            if (isNaN(date.getTime())) return dateInput;
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Formats a date and time string for display.
         * @param {string} dateTimeString - Date and time in YYYY-MM-DDTHH:mm format.
         * @returns {string} Formatted date and time.
         */
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            if (isNaN(date.getTime())) return dateTimeString;
            const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleString('he-IL', options);
        }

        /**
         * Updates current date and time in the header.
         */
        function updateDateTimeCrm() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };

            document.getElementById('current-date-crm').textContent = now.toLocaleDateString('he-IL', dateOptions);
            document.getElementById('current-time-crm').textContent = now.toLocaleTimeString('he-IL', timeOptions);
        }

        // --- Notifications Logic ---
        /**
         * Generates and renders notifications based on current data and filter.
         */
        function generateAndRenderNotifications() {
            notifications = []; // Clear existing notifications
            
            let ordersForNotifications = [];
            if (currentOrderFilter === 'all') {
                ordersForNotifications = allOrders; 
            } else if (currentOrderFilter === 'overdue') {
                ordersForNotifications = allOrders.filter(o => o['סטטוס'] === 'חורג' || o['סטטוס'] === 'ממתין/לא תקין');
            } else if (currentOrderFilter === 'open') {
                ordersForNotifications = allOrders.filter(o => o['סטטוס'] === 'פתוח' || o['סטטוס'] === 'ממתין/לא תקין');
            } else if (currentOrderFilter === 'closed') {
                ordersForNotifications = []; 
            }

            const activeOrdersForNotif = ordersForNotifications.filter(o => o['סטטוס'] !== 'סגור');
            
            const containerStatus = {}; 
            const sortedOrders = [...ordersForNotifications].sort((a, b) => new Date(a['תאריך הזמנה']) - new Date(b['תאריך הזמנה']));

            sortedOrders.forEach(order => {
                const orderDate = new Date(order['תאריך הזמנה']);

                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(containerNum => {
                    const current = containerStatus[containerNum] || { action: null, order: null, date: new Date(0) };
                    if (orderDate >= current.date) {
                         containerStatus[containerNum] = { action: 'taken', order: order, date: orderDate };
                    }
                });

                containersBrought.forEach(containerNum => {
                    const current = containerStatus[containerNum] || { action: null, order: null, date: new Date(0) };
                    if (orderDate >= current.date) {
                        containerStatus[containerNum] = { action: 'returned', order: order, date: orderDate };
                    }
                });
            });

            for (const containerNum in containerStatus) {
                const status = containerStatus[containerNum];
                if (status.action === 'taken' && status.order['סטטוס'] !== 'סגור') {
                    const daysPassed = status.order['ימים שעברו'];
                    if (daysPassed && parseInt(daysPassed) > 120) {
                        notifications.push({
                            id: `container-mismatch-${containerNum}-${status.order.sheetRow}`,
                            type: 'error',
                            isHandled: false,
                            order: status.order
                        });
                    }
                }
            }
            
            activeOrdersForNotif.filter(o => o['סטטוס'] === 'ממתין/לא תקין').forEach(order => {
                const lastNoteUpdate = order['תאריך וזמן עדכון הערה'] ? new Date(order['תאריך וזמן עדכון הערה']) : new Date(order['תאריך הזמנה']);
                const daysSinceLastUpdate = Math.floor((new Date() - lastNoteUpdate) / (1000 * 60 * 60 * 24));
                if (daysSinceLastUpdate > 30) {
                    notifications.push({
                        id: `pending-no-update-${order.sheetRow}`,
                        type: 'warning',
                        isHandled: false,
                        order: order
                    });
                }
            });

            if (currentOrderFilter === 'all' || currentOrderFilter === 'overdue') {
                ordersForNotifications.filter(o => o['סטטוס'] === 'חורג').forEach(order => { 
                    notifications.push({
                        id: `overdue-order-${order.sheetRow}`,
                        type: 'warning',
                        isHandled: false,
                        order: order
                    });
                });
            }

            renderNotifications();
        }

        /**
         * Renders the current list of notifications in the UI.
         */
        function renderNotifications() {
            const notificationsListDiv = document.getElementById('notifications-list');
            const noNotificationsMsg = document.getElementById('no-notifications-msg'); 

            notificationsListDiv.innerHTML = ''; 

            if (notifications.length === 0) {
                noNotificationsMsg.classList.remove('hidden'); 
            } else {
                noNotificationsMsg.classList.add('hidden'); 
                notifications.forEach(notif => {
                    const notifItem = document.createElement('div');
                    notifItem.id = `notif-${notif.id}`;
                    notifItem.className = `notification-item ${notif.type} ${notif.isHandled ? 'handled' : ''}`;
                    notifItem.setAttribute('role', 'alert');

                    const lastNote = getLastLogEntry(notif.order['הערות'] || 'אין הערות קודמות.');
                    const daysOverdueDisplay = notif.order['ימים שעברו'] !== undefined ? 
                        `<span class="days-overdue-value">${notif.order['ימים שעברו']}</span> ימים` : 'N/A';

                    notifItem.innerHTML = `
                        <i class="fas ${getNotificationIcon(notif.type)} notification-icon" aria-hidden="true" title="${getNotificationEmoji(notif.type)}"></i>
                        <h3 class="notification-header">
                            <span class="header-text">${getNotificationEmoji(notif.type)} ${notif.order['שם לקוח'] || 'לקוח לא ידוע'} - <span class="dvid-blinking-text">${notif.order['תעודה'] || 'אין תעודה'}</span></span>
                        </h3>
                        <p class="notification-details">
                            <i class="fas fa-calendar-alt ml-1"></i> ${daysOverdueDisplay}
                        </p>
                        <div class="notification-last-note">
                            <strong>הערה אחרונה:</strong> ${lastNote}
                        </div>
                        <button class="whatsapp-icon-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModalFromNotification('${notif.id}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <i class="fas fa-thumbtack pin-icon" onclick="event.stopPropagation(); markNotificationAsHandled('${notif.id}')" aria-label="סמן כטופל"></i>
                    `;
                    
                    notifItem.addEventListener('click', () => {
                        const customerName = notif.order['שם לקוח'];
                        const customerAddress = notif.order['כתובת'];
                        if (customerName && customerAddress) {
                            const tempCustomerData = {
                                customerName: customerName,
                                address: customerAddress,
                                orderCount: allOrders.filter(o => o['שם לקוח'] === customerName && o['כתובת'] === customerAddress).length,
                                overdueOrders: allOrders.filter(o => o['שם לקוח'] === customerName && o['כתובת'] === customerAddress && o['סטטוס'] === 'חורג')
                            };
                            showCustomerAnomalyHistory(tempCustomerData);
                        } else {
                            showAlert('חסר מידע על הלקוח להצגת היסטוריה מפורטת.', 'warning');
                        }
                    });

                    notificationsListDiv.appendChild(notifItem);
                });
            }
        }

        /**
         * Extracts the last log entry from a potentially multi-line notes string.
         * @param {string} notesString - The full notes string.
         * @returns {string} The last log entry or the original string if no log format found.
         */
        function getLastLogEntry(notesString) {
            if (!notesString) return 'אין הערות.';
            const lines = notesString.split('\n').filter(line => line.trim() !== '');
            if (lines.length > 0) {
                for (let i = lines.length - 1; i >= 0; i--) {
                    if (lines[i].trim().startsWith('[') && lines[i].trim().includes(']')) {
                        return lines[i].trim();
                    }
                }
                return lines[lines.length - 1].trim();
            }
            return 'אין הערות.';
        }


        /**
         * Opens WhatsApp modal directly from a notification item.
         * @param {string} notificationId - The ID of the notification.
         */
        function openWhatsAppModalFromNotification(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification && notification.order) {
                const order = notification.order;
                const suggestedMessageId = getSuggestedMessageIdForOrder(order);
                openWhatsAppModal(
                    order['טלפון לקוח'], 
                    suggestedMessageId, 
                    order.sheetRow, 
                    order['שם לקוח'], 
                    order['ימים שעברו'], 
                    order['מספר מכולה ירדה'] || order['מספר מכולה עלתה'] || '',
                    order['תעודה'], 
                    formatDate(order['תאריך סיום צפוי']), 
                    order['כתובת']
                );
            } else {
                showAlert('לא ניתן לשלוח הודעה: חסר מספר טלפון או פרטי הזמנה בהתראה.', 'warning');
            }
        }

        /**
         * Gets the suggested message ID based on notification type and data.
         * @param {string} type - 'error', 'warning', 'info'.
         * @returns {string} Emoji character.
         */
        function getNotificationEmoji(type) {
            switch (type) {
                case 'error': return '🚨';
                case 'warning': return '⚠️';
                case 'info': return 'ℹ️';
                default: return '🔔';
            }
        }

        /**
         * Returns the appropriate Font Awesome icon class for a notification type.
         * @param {string} type - 'error', 'warning', 'info'.
         * @returns {string} Icon class.
         */
        function getNotificationIcon(type) {
            switch (type) {
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
        }

        /**
         * Marks a notification as handled, visually updating it.
         * @param {string} notificationId - The ID of the notification to mark.
         */
        function markNotificationAsHandled(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.isHandled = !notification.isHandled;
                renderNotifications(); 
                showAlert(`ההתראה סומנה כ${notification.isHandled ? 'טופלה' : 'לא טופלה'}.`, 'success', 3000);
            }
        }

        // --- Report Buttons Logic ---

        /**
         * Updates the values on the report metric buttons.
         * Now based on `filteredOrders`.
         */
        function updateReportButtons() {
            document.getElementById('total-orders-count').textContent = filteredOrders.length;
            
            const actionTypes = new Set(filteredOrders.map(order => order['סוג פעולה']).filter(Boolean));
            document.getElementById('unique-action-types-count').textContent = actionTypes.size;

            const customersWithMultipleContainersCount = calculateCustomersWithMultipleContainers(filteredOrders).length;
            document.getElementById('customers-multiple-count').textContent = customersWithMultipleContainersCount;
        }

        /**
         * Shows the selected report table and hides others.
         * @param {string} tableId - The ID of the report table section to show.
         */
        function showReportTable(tableId) {
            document.querySelectorAll('.report-table-section').forEach(section => {
                section.classList.add('hidden');
            });
            const targetSection = document.getElementById(tableId);
            targetSection.classList.remove('hidden');

            if (tableId === 'orders-per-customer-table') {
                renderOrdersPerCustomerTable(filteredOrders);
            } else if (tableId === 'action-type-counts-table') {
                renderActionTypeCountsTable(filteredOrders);
            } else if (tableId === 'customers-multiple-containers-table') {
                renderCustomersWithMultipleContainersTable(filteredOrders);
            } else if (tableId === 'overdue-summary-table') {
                renderOverdueSummaryTable(allOrders.filter(o => o['סטטוס'] === 'חורג')); 
            }

            setTimeout(() => {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100); 
        }

        /**
         * Helper function to get the current primary brand color dynamically based on the active theme.
         * @returns {string} The computed color string.
         */
        function getCurrentChartFillColor() {
            if (document.body.classList.contains('dark')) {
                return getComputedStyle(document.body).getPropertyValue('--dark-primary-brand').trim();
            }
            return getComputedStyle(document.body).getPropertyValue('--primary-brand').trim();
        }

        // --- Charts Logic ---

        /**
         * Draws all charts for the dashboard based on `filteredOrders`.
         */
        function drawCharts() {
            drawOrdersPerCustomerChart(filteredOrders);
            drawActionTypeDistributionChart(filteredOrders);
            drawMonthlyOrdersChart(filteredOrders);
        }

        /**
         * Draws the "Orders Per Customer" bar chart.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawOrdersPerCustomerChart(dataToUse) {
            const chartDiv = d3.select("#svg-orders-per-customer");
            chartDiv.select("svg").remove();

            const customerOrderCounts = {};
            dataToUse.forEach(order => {
                const customer = order['שם לקוח'];
                if (customer) {
                    customerOrderCounts[customer] = (customerOrderCounts[customer] || 0) + 1;
                }
            });

            const data = Object.entries(customerOrderCounts)
                .map(([customer, count]) => ({ customer, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10); 

            const noDataMsg = document.getElementById('no-data-orders-per-customer');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const margin = { top: 20, right: 30, bottom: 80, left: 60 };
            const bounds = chartDiv.node().getBoundingClientRect();
            const width = bounds.width - margin.left - margin.right;
            const height = bounds.height - margin.top - margin.bottom;

            const svg = chartDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.customer))
                .padding(0.2);

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.count) * 1.1]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.85em")
                .attr("class", "axis-text");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(Math.max(3, d3.max(data, d => d.count))))
                .selectAll("text")
                .style("font-size", "0.85em")
                .attr("class", "axis-text");

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", "bar chart-bar")
                .attr("x", d => x(d.customer))
                .attr("width", x.bandwidth())
                .attr("y", height)
                .attr("height", 0)
                .transition()
                .duration(800)
                .delay((d, i) => i * 50)
                .attr("y", d => y(d.count))
                .attr("height", d => height - y(d.count));

            svg.selectAll(".text")
                .data(data)
                .enter().append("text")
                .attr("class", "chart-text")
                .attr("x", d => x(d.customer) + x.bandwidth() / 2)
                .attr("y", d => y(d.count) - 5)
                .attr("text-anchor", "middle")
                .text(d => d.count);
        }

        /**
         * Draws the "Action Type Distribution" pie chart.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawActionTypeDistributionChart(dataToUse) {
            const chartDiv = d3.select("#svg-action-type-distribution");
            chartDiv.select("svg").remove();

            const actionTypeCounts = {};
            dataToUse.forEach(order => {
                const actionType = order['סוג פעולה'];
                if (actionType) {
                    actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
                }
            });

            const data = Object.entries(actionTypeCounts).map(([type, count]) => ({ type, count }));

            const noDataMsg = document.getElementById('no-data-action-type');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const bounds = chartDiv.node().getBoundingClientRect();
            const outerRadius = Math.min(bounds.width, bounds.height) / 2 - 40;
            const innerRadius = outerRadius * 0.5;

            const svg = chartDiv.append("svg")
                .attr("width", bounds.width)
                .attr("height", bounds.height)
                .append("g")
                .attr("transform", `translate(${bounds.width / 2},${bounds.height / 2})`);

            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.type))
                .range(d3.schemeCategory10);

            const pie = d3.pie()
                .value(d => d.count)
                .sort(null);

            const arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);
            
            const outerArc = d3.arc()
                .innerRadius(outerRadius * 0.9)
                .outerRadius(outerRadius * 0.9);

            const arcs = svg.selectAll("arc")
                .data(pie(data))
                .enter()
                .append("g")
                .attr("class", "arc pie-slice");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.type))
                .each(function(d) { this._current = d; })
                .transition()
                .duration(750)
                .attrTween("d", function(d) {
                    const i = d3.interpolate(d.startAngle + 0.1, d.endAngle);
                    return function(t) {
                        d.endAngle = i(t);
                        return arc(d);
                    };
                });

            arcs.append("text")
                .attr("transform", d => {
                    const centroid = outerArc.centroid(d);
                    return `translate(${centroid[0]},${centroid[1]})`;
                })
                .attr("dy", ".35em")
                .attr("class", "pie-label chart-text")
                .text(d => `${d.data.type} (${((d.data.count / d3.sum(data, d => d.count)) * 100).toFixed(1)}%)`);

            const legend = svg.selectAll(".legend")
                .data(color.domain())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(${outerRadius + 20},${-outerRadius + i * 25})`);

            legend.append("rect")
                .attr("x", 0)
                .attr("width", 18)
                .attr("height", 18)
                .attr("rx", 4)
                .attr("ry", 4)
                .style("fill", color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .attr("class", "legend-text chart-text")
                .text(d => d);
        }

        /**
         * Draws the "Monthly Orders" line chart.
         * @param {Array<Object>} dataToUse - The array of orders to use for the chart.
         */
        function drawMonthlyOrdersChart(dataToUse) {
            const chartDiv = d3.select("#svg-monthly-orders");
            chartDiv.select("svg").remove();

            const monthlyCounts = {};
            dataToUse.forEach(order => {
                const orderDate = new Date(order['תאריך הזמנה']);
                if (!isNaN(orderDate.getTime())) {
                    const monthKey = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
                }
            });

            const data = Object.entries(monthlyCounts)
                .map(([month, count]) => ({ month: month, date: new Date(month + '-01'), count: count }))
                .sort((a, b) => a.date - b.date);

            const noDataMsg = document.getElementById('no-data-monthly-orders');
            if (data.length === 0) {
                noDataMsg.classList.remove('hidden');
                return;
            } else {
                noDataMsg.classList.add('hidden');
            }

            const margin = { top: 20, right: 30, bottom: 80, left: 60 };
            const bounds = chartDiv.node().getBoundingClientRect();
            const width = bounds.width - margin.left - margin.right;
            const height = bounds.height - margin.top - margin.bottom;

            const svg = chartDiv.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleTime()
                .range([0, width])
                .domain(d3.extent(data, d => d.date));

            const y = d3.scaleLinear()
                .range([height, 0])
                .domain([0, d3.max(data, d => d.count) * 1.1]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(d3.timeMonth.every(1)).tickFormat(d3.timeFormat("%b %Y")))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "0.85em")
                .attr("class", "axis-text");

            svg.append("g")
                .call(d3.axisLeft(y).ticks(Math.max(3, d3.max(data, d => d.count))))
                .selectAll("text")
                .style("font-size", "0.85em")
                .attr("class", "axis-text");

            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.count));

            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", getCurrentChartFillColor())
                .attr("stroke-width", 2)
                .attr("d", line);

            svg.selectAll(".dot")
                .data(data)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => x(d.date))
                .attr("cy", d => y(d.count))
                .attr("r", 4)
                .attr("fill", getCurrentChartFillColor());
        }

        // --- Report Table Data Calculation & Rendering ---

        /**
         * Calculates and renders the "Orders Per Customer" table based on `dataToUse`.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderOrdersPerCustomerTable(dataToUse) {
            const tableBody = document.querySelector('#orders-per-customer-table-data tbody');
            tableBody.innerHTML = '';
            const noDataMsg = document.getElementById('no-data-orders-per-customer-table');
            noDataMsg.classList.add('hidden');

            const customerData = {}; 

            dataToUse.forEach(order => {
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const phone = order['טלפון לקוח'] || ''; 
                const key = `${customerName}|${address}`;

                if (!customerData[key]) {
                    customerData[key] = {
                        customerName: customerName,
                        address: address,
                        ordersCount: 0,
                        activeContainers: new Set(),
                        phone: phone,
                        lastOrderDate: new Date(0), 
                        firstOrderDate: new Date() 
                    };
                }
                customerData[key].ordersCount++;

                const currentOrderDate = new Date(order['תאריך הזמנה']);
                if (currentOrderDate > customerData[key].lastOrderDate) {
                    customerData[key].lastOrderDate = currentOrderDate;
                }
                if (currentOrderDate < customerData[key].firstOrderDate) {
                    customerData[key].firstOrderDate = currentOrderDate;
                }


                if (order['סטטוס'] !== 'סגור') {
                    if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                        const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersTaken.forEach(c => customerData[key].activeContainers.add(c));
                    }
                     if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                        const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersBrought.forEach(c => customerData[key].activeContainers.delete(c)); 
                    }
                }
            });

            const sortedCustomers = Object.values(customerData).sort((a, b) => b.ordersCount - a.ordersCount);

            if (sortedCustomers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedCustomers.forEach(data => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = data.customerName;
                    row.insertCell().textContent = data.address;
                    row.insertCell().textContent = data.ordersCount;
                    const containersCell = row.insertCell();
                    if (data.activeContainers.size > 0) {
                        containersCell.innerHTML = Array.from(data.activeContainers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ');
                    } else {
                        containersCell.textContent = 'אין';
                    }
                    const whatsappCell = row.insertCell();
                    if (data.phone) {
                        const suggestedMsgId = data.ordersCount === 1 && (new Date() - data.firstOrderDate) / (1000 * 60 * 60 * 24) < 30 ? 'new_customer_welcome' : 'general_inquiry'; 
                        whatsappCell.innerHTML = `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${data.phone}', '${suggestedMsgId}', null, '${data.customerName}', null, null, null, null, '${data.address}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    } else {
                        whatsappCell.textContent = 'אין טלפון';
                    }
                });
            }
        }

        /**
         * Calculates and renders the "Action Type Counts" table based on `dataToUse`.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderActionTypeCountsTable(dataToUse) {
            const tableBody = document.querySelector('#action-type-counts-table-data tbody');
            tableBody.innerHTML = '';
            const noDataMsg = document.getElementById('no-data-action-type-table');
            noDataMsg.classList.add('hidden');

            const actionTypeCounts = {};
            dataToUse.forEach(order => {
                const actionType = order['סוג פעולה'] || 'לא ידוע';
                actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
            });

            const sortedActionTypes = Object.entries(actionTypeCounts).sort((a, b) => b[1] - a[1]);

            if (sortedActionTypes.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedActionTypes.forEach(([type, count]) => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = type;
                    row.insertCell().textContent = count;
                });
            }
        }

        /**
         * Calculates and renders the "Customers with Multiple Containers" table based on `dataToUse`.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table.
         */
        function renderCustomersWithMultipleContainersTable(dataToUse) {
            const tableBody = document.querySelector('#customers-multiple-containers-table-data tbody');
            tableBody.innerHTML = '';
            const noDataMsg = document.getElementById('no-data-customers-multiple-containers-table');
            noDataMsg.classList.add('hidden');

            const customersWithMultiple = calculateCustomersWithMultipleContainers(dataToUse);

            if (customersWithMultiple.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                customersWithMultiple.forEach(data => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = data.customerName;
                    row.insertCell().textContent = data.address;
                    row.insertCell().textContent = data.containerCount;
                    const containersCell = row.insertCell();
                     containersCell.innerHTML = Array.from(data.containers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ');
                    const whatsappCell = row.insertCell();
                    const customerOrder = allOrders.find(o => o['שם לקוח'] === data.customerName && o['כתובת'] === data.address && o['טלפון לקוח']);
                    if (customerOrder && customerOrder['טלפון לקוח']) {
                        whatsappCell.innerHTML = `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${customerOrder['טלפון לקוח']}', 'multi_container_reminder', null, '${data.customerName}', null, data.containers.join(', '), customerOrder['תעודה'] || '', formatDate(customerOrder['תאריך סיום צפוי']) || '', '${data.address}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    } else {
                        whatsappCell.textContent = 'אין טלפון';
                    }
                });
            }
        }

        /**
         * Helper function to calculate customers with multiple active containers.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to analyze.
         * @returns {Array<Object>} List of customers with more than one active container.
         */
        function calculateCustomersWithMultipleContainers(ordersToAnalyze) {
            const customerActiveContainers = {}; 

            ordersToAnalyze.filter(o => o['סטטוס'] !== 'סגור').forEach(order => {
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const key = `${customerName}|${address}`;

                if (!customerActiveContainers[key]) {
                    customerActiveContainers[key] = {
                        customerName: customerName,
                        address: address,
                        containers: new Set(), 
                        latestOrderDate: new Date(0) 
                    };
                }

                const orderDate = new Date(order['תאריך הזמנה']);
                if (orderDate > customerActiveContainers[key].latestOrderDate) {
                    customerActiveContainers[key].latestOrderDate = orderDate;
                }

                if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                    const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersTaken.forEach(c => customerActiveContainers[key].containers.add(c));
                }

                if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                    const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersBrought.forEach(c => {
                        if (customerActiveContainers[key].containers.has(c)) {
                            customerActiveContainers[key].containers.delete(c);
                        }
                    });
                }
            });

            const result = Object.values(customerActiveContainers)
                .filter(data => data.containers.size > 1)
                .map(data => ({
                    customerName: data.customerName,
                    address: data.address,
                    containerCount: data.containers.size,
                    containers: Array.from(data.containers)
                }))
                .sort((a, b) => b.containerCount - a.containerCount); 

            return result;
        }

        /**
         * Renders the "Overdue Summary" table based on `dataToUse`.
         * @param {Array<Object>} dataToUse - The array of orders to use for the table (expected to be already filtered for overdue).
         */
        function renderOverdueSummaryTable(dataToUse) {
            const tableBody = document.querySelector('#overdue-summary-table-data tbody');
            tableBody.innerHTML = '';
            const noDataMsg = document.getElementById('no-data-overdue-summary-table');
            noDataMsg.classList.add('hidden');

            const overdueOrders = dataToUse; 
            overdueOrders.sort((a, b) => (parseInt(b['ימים שעברו']) || 0) - (parseInt(a['ימים שעברו']) || 0));

            if (overdueOrders.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                overdueOrders.forEach(order => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = order['תעודה'] || '';
                    row.insertCell().textContent = order['שם לקוח'] || '';
                    row.insertCell().textContent = order['כתובת'] || '';
                    row.insertCell().textContent = order['סוג פעולה'] || '';
                    row.insertCell().textContent = order['ימים שעברו'] !== undefined ? order['ימים שעברו'] : '';
                    let containersText = '';
                    if (order['סוג פעולה'] === 'החלפה') {
                        const taken = String(order['מספר מכולה ירדה'] || '');
                        const brought = String(order['מספר מכולה עלתה'] || '');
                        if (taken && brought) containersText = `ירדה: ${taken}, עלתה: ${brought}`;
                        else if (taken) containersText = `ירדה: ${taken}`;
                        else if (brought) containersText = `עלתה: ${brought}`;
                    } else if (order['סוג פעולה'] === 'הורדה') {
                        containersText = String(order['מספר מכולה ירדה'] || '');
                    } else if (order['סוג פעולה'] === 'העלאה') {
                        containersText = String(order['מספר מכולה עלתה'] || '');
                    } else {
                        containersText = String(order['מספרי מכולות'] || '');
                    }
                    row.insertCell().textContent = containersText;
                    row.insertCell().textContent = order['הערות'] || '';
                    const whatsappCell = row.insertCell();
                    if (order['טלפון לקוח']) {
                        const suggestedMsgId = getSuggestedMessageIdForOrder(order);
                        whatsappCell.innerHTML = `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${suggestedMsgId}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${containersText}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    } else {
                        whatsappCell.textContent = 'אין טלפון';
                    }
                });
            }
        }

        /**
         * Calculates the top moving container.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to use for analysis.
         * @returns {Object} { container: string, count: number }
         */
        function getTopMovingContainer(ordersToAnalyze) {
            const containerMovementCounts = {}; 

            ordersToAnalyze.forEach(order => {
                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
                containersBrought.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
            });

            let topContainer = { container: 'אין', count: 0 };
            for (const c in containerMovementCounts) {
                if (containerMovementCounts[c] > topContainer.count) {
                    topContainer = { container: c, count: containerMovementCounts[c] };
                }
            }
            return topContainer;
        }

        /**
         * Opens the modal to display top moving containers.
         */
        function openTopMovingContainersModal() {
            const modal = document.getElementById('top-moving-containers-modal');
            const tableBody = document.querySelector('#top-moving-containers-table tbody');
            const noDataMsg = document.getElementById('no-top-moving-containers');
            tableBody.innerHTML = '';
            noDataMsg.classList.add('hidden');

            const containerMovementCounts = {};
            filteredOrders.forEach(order => {
                const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);

                containersTaken.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
                containersBrought.forEach(c => {
                    containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1;
                });
            });

            const sortedContainers = Object.entries(containerMovementCounts)
                .map(([container, count]) => ({ container, count }))
                .sort((a, b) => b.count - a.count);

            if (sortedContainers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                sortedContainers.forEach(data => {
                    const row = tableBody.insertRow();
                    row.insertCell().innerHTML = `📦 ${data.container}`;
                    row.insertCell().textContent = data.count;
                    const historyCell = row.insertCell();
                    const historyBtn = document.createElement('button');
                    historyBtn.className = 'btn btn-secondary btn-sm';
                    historyBtn.textContent = 'הצג היסטוריה';
                    historyBtn.onclick = (event) => {
                        event.stopPropagation();
                        openContainerHistoryModal(data.container);
                    };
                    historyCell.appendChild(historyBtn);
                });
            }

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeTopMovingContainersModal() {
            document.getElementById('top-moving-containers-modal').classList.remove('active');
        }

        /**
         * Calculates and returns a list of returning customers based on `ordersToAnalyze`.
         * @param {Array<Object>} ordersToAnalyze - The array of orders to use for analysis.
         * @returns {Array<Object>} List of returning customers with their data.
         */
        function getReturningCustomers(ordersToAnalyze) {
            const customerOrderData = {}; 

            ordersToAnalyze.forEach(order => {
                const customerName = order['שם לקוח'] || 'לא ידוע';
                const address = order['כתובת'] || 'לא ידוע';
                const phone = order['טלפון לקוח'] || '';
                const key = `${customerName}|${address}`;

                if (!customerOrderData[key]) {
                    customerOrderData[key] = {
                        customerName: customerName,
                        address: address,
                        orderCount: 0,
                        containers: new Set(), // Corrected: changed from activeContainers to containers
                        overdueOrders: [], 
                        phone: phone,
                        lastOrderDate: new Date(0), 
                        firstOrderDate: new Date() 
                    };
                }
                customerOrderData[key].orderCount++;

                const currentOrderDate = new Date(order['תאריך הזמנה']);
                if (currentOrderDate > customerOrderData[key].lastOrderDate) {
                    customerOrderData[key].lastOrderDate = currentOrderDate;
                }
                if (currentOrderDate < customerOrderData[key].firstOrderDate) {
                    customerOrderData[key].firstOrderDate = currentOrderDate;
                }

                if (order['סטטוס'] !== 'סגור') {
                    if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                        const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersTaken.forEach(c => customerOrderData[key].containers.add(c));
                    }
                     if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                        const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                        containersBrought.forEach(c => {
                            if (customerOrderData[key].containers.has(c)) {
                                customerOrderData[key].containers.delete(c);
                            }
                        });
                    }
                }
                const fullOrder = allOrders.find(o => o.sheetRow === order.sheetRow); 
                if (fullOrder && fullOrder['סטטוס'] === 'חורג') {
                    customerOrderData[key].overdueOrders.push(fullOrder);
                }
            });

            const returningCustomers = Object.values(customerOrderData)
                .filter(data => data.orderCount > 1)
                .sort((a, b) => b.orderCount - a.orderCount);

            return returningCustomers;
        }

        /**
         * Opens the modal to display returning customers.
         */
        function openReturningCustomersModal() {
            const modal = document.getElementById('returning-customers-modal');
            const tableBody = document.querySelector('#returning-customers-table tbody');
            const noDataMsg = document.getElementById('no-returning-customers');
            tableBody.innerHTML = '';
            noDataMsg.classList.add('hidden');

            const returningCustomers = getReturningCustomers(filteredOrders); 

            if (returningCustomers.length === 0) {
                noDataMsg.classList.remove('hidden');
            } else {
                returningCustomers.forEach(customer => {
                    const row = tableBody.insertRow();
                    row.style.cursor = 'pointer'; 
                    row.insertCell().textContent = customer.customerName;
                    row.insertCell().textContent = customer.address;
                    row.insertCell().textContent = customer.orderCount;
                    const containersCell = row.insertCell();
                    if (customer.containers.size > 0) { // Corrected: use .containers
                        containersCell.innerHTML = Array.from(customer.containers).map(c => 
                            `<span class="container-pill" onclick="event.stopPropagation(); openContainerHistoryModal('${c}')">${c}</span>`
                        ).join(' ');
                    } else {
                        containersCell.textContent = 'אין';
                    }
                    const statusCell = row.insertCell();
                    if (customer.overdueOrders.length > 0) {
                        statusCell.innerHTML = `<span class="text-red-600 font-bold">חורג (${customer.overdueOrders.length})</span>`;
                    } else {
                        statusCell.textContent = 'תקין';
                    }
                    const whatsappCell = row.insertCell();
                    if (customer.phone) {
                        const suggestedMsgId = 'general_inquiry'; 
                        whatsappCell.innerHTML = `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${customer.phone}', '${suggestedMsgId}', null, '${customer.customerName}', null, customer.containers.join(', ') || '', null, null, '${customer.address}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    } else {
                        whatsappCell.textContent = 'אין טלפון';
                    }

                    row.addEventListener('click', () => {
                        showCustomerAnomalyHistory(customer);
                    });
                });
            }

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeReturningCustomersModal() {
            document.getElementById('returning-customers-modal').classList.remove('active');
        }

        /**
         * Shows a detailed history/anomaly report for a specific customer in the order-details-modal.
         * @param {Object} customerData - Data for the selected customer.
         */
        function showCustomerAnomalyHistory(customerData) {
            const modal = document.getElementById('order-details-modal');
            const orderCard = document.getElementById('current-order-card');
            
            let htmlContent = `
                <h3 class="text-xl font-bold mb-4 text-gray-700 dark:text-gray-200">
                    היסטוריית לקוח: ${customerData.customerName} - ${customerData.address}
                </h3>
                <p class="mb-2"><strong>סה"כ הזמנות:</strong> ${customerData.orderCount}</p>
            `;

            if (customerData.overdueOrders && customerData.overdueOrders.length > 0) {
                htmlContent += `<p class="text-red-600 font-bold mb-4">
                    <i class="fas fa-exclamation-triangle ml-1"></i> הזמנות חורגות בעבר / בהווה (${customerData.overdueOrders.length}):
                </p>`;
                customerData.overdueOrders.forEach(order => {
                    htmlContent += `
                        <div class="card p-3 mb-2 border border-red-300 dark:border-red-600">
                            <p><strong>תעודה:</strong> ${order['תעודה']}</p>
                            <p><strong>תאריך הזמנה:</strong> ${formatDate(order['תאריך הזמנה'])}</p>
                            <p><strong>סוג פעולה:</strong> ${order['סוג פעולה']}</p>
                            <p><strong>ימים שעברו:</strong> ${order['ימים שעברו']}</p>
                            <p><strong>הערות:</strong> ${order['הערות'] || 'אין'}</p>
                        </div>
                    `;
                });
            } else {
                htmlContent += `<p class="text-green-600 font-bold mb-4">
                    <i class="fas fa-check-circle ml-1"></i> אין היסטוריה חריגה ידועה ללקוח זה. לקוח פוטנציאלי טוב!
                </p>`;
            }

            htmlContent += `
                <h4 class="text-lg font-bold mt-6 mb-3 text-gray-700 dark:text-gray-200">
                    כל ההזמנות של הלקוח:
                </h4>
                <div class="table-container">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>תעודה</th>
                                <th>פעולה</th>
                                <th>סטטוס</th>
                                <th>מכולה ירדה</th>
                                <th>מכולה עלתה</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allOrders.filter(o => o['שם לקוח'] === customerData.customerName && o['כתובת'] === customerData.address)
                                .sort((a,b) => new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה']))
                                .map(order => `
                                    <tr>
                                        <td>${formatDate(order['תאריך הזמנה'])}</td>
                                        <td>${order['תעודה']}</td>
                                        <td>${order['סוג פעולה']}</td>
                                        <td><span class="${order['סטטוס'] === 'פתוח' ? 'status-open' : order['סטטוס'] === 'חורג' ? 'status-overdue' : 'status-closed'}">${order['סטטוס']}</span></td>
                                        <td>${order['מספר מכולה ירדה'] || ''}</td>
                                        <td>${order['מספר מכולה עלתה'] || ''}</td>
                                        <td>
                                            ${order['טלפון לקוח'] ? `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${getSuggestedMessageIdForOrder(order)}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${order['מספר מכולה ירדה'] || order['מספר מכולה עלתה'] || ''}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>` : 'אין טלפון'}
                                        </td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            orderCard.innerHTML = htmlContent;
            document.getElementById('details-modal-title').textContent = 'פרטי היסטוריית לקוח';

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeOrderDetailsModal() {
            document.getElementById('order-details-modal').classList.remove('active');
        }

        // --- Export, Print, Share Logic ---

        /**
         * Exports displayed table data to an Excel (CSV) file.
         * @param {string} tableId - The ID of the table HTML element.
         * @param {string} filename - The desired filename for the export.
         */
        function exportTableToExcel(tableId, filename = 'report') {
            const table = document.getElementById(tableId);
            if (!table) {
                showAlert('טבלה לייצוא לא נמצאה.', 'error');
                return;
            }
            const rows = Array.from(table.querySelectorAll('tr'));

            if (rows.length <= 1) { 
                showAlert('אין נתונים לייצוא בטבלה זו.', 'warning');
                return;
            }

            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 

            csvContent += headers.join(',') + '\n';

            for (let i = 1; i < rows.length; i++) {
                const rowCells = Array.from(rows[i].querySelectorAll('td'));
                const rowData = rowCells.map(cell => {
                    let value = cell.textContent.trim();
                    value = value.replace(/"/g, '""');
                    if (value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvContent += rowData.join(',') + '\n';
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${filename}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showAlert('הנתונים יוצאו לאקסל בהצלחה!', 'success');
        }

        /**
         * Helper function to get structured data for printing for each report type.
         * @param {string} reportType - The identifier for the type of report (e.g., 'orders-per-customer-table').
         * @returns {Object} An object containing headers (Array<string>), rows (Array<Array<string>>), and title (string).
         */
        function getReportDataForPrinting(reportType) {
            let headers = [];
            let rows = [];
            let title = '';
            let dataToProcess = filteredOrders; 

            if (reportType === 'orders-per-customer-table') {
                title = 'דוח: כמות הזמנות לכל לקוח';
                headers = ['שם לקוח', 'כתובת', 'כמות הזמנות', 'כמות מכולות פעילות'];
                const customerData = {}; 
                dataToProcess.forEach(order => { 
                    const customerName = order['שם לקוח'] || 'לא ידוע';
                    const address = order['כתובת'] || 'לא ידוע';
                    const key = `${customerName}|${address}`;
                    if (!customerData[key]) {
                        customerData[key] = { customerName: customerName, address: address, ordersCount: 0, activeContainers: new Set() };
                    }
                    customerData[key].ordersCount++;
                    if (order['סטטוס'] !== 'סגור') {
                        if (order['סוג פעולה'] === 'הורדה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה ירדה'])) {
                            const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                            containersTaken.forEach(c => customerData[key].activeContainers.add(c));
                        }
                        if (order['סוג פעולה'] === 'העלאה' || (order['סוג פעולה'] === 'החלפה' && order['מספר מכולה עלתה'])) {
                            const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                            containersBrought.forEach(c => customerData[key].activeContainers.delete(c));
                        }
                    }
                });
                const sortedCustomers = Object.values(customerData).sort((a, b) => b.ordersCount - a.ordersCount);
                rows = sortedCustomers.map(data => [
                    data.customerName,
                    data.address,
                    data.ordersCount,
                    Array.from(data.activeContainers).join(', ') || 'אין'
                ]);
            } else if (reportType === 'action-type-counts-table') {
                title = 'דוח: כמות סוגי פעולות';
                headers = ['סוג פעולה', 'כמות'];
                const actionTypeCounts = {};
                dataToProcess.forEach(order => { 
                    const actionType = order['סוג פעולה'] || 'לא ידוע';
                    actionTypeCounts[actionType] = (actionTypeCounts[actionType] || 0) + 1;
                });
                const sortedActionTypes = Object.entries(actionTypeCounts).sort((a, b) => b[1] - a[1]);
                rows = sortedActionTypes; 
            } else if (reportType === 'customers-multiple-containers-table') {
                title = 'דוח: לקוחות עם יותר ממכולה אחת';
                headers = ['שם לקוח', 'כתובת', 'כמות מכולות פעילות', 'מספרי מכולות'];
                const customersWithMultiple = calculateCustomersWithMultipleContainers(dataToProcess); 
                rows = customersWithMultiple.map(data => [
                    data.customerName,
                    data.address,
                    data.containerCount,
                    data.containers.join(', ')
                ]);
            } else if (reportType === 'overdue-summary-table') {
                title = 'דוח: סיכום הזמנות חורגות';
                headers = ['תעודה', 'שם לקוח', 'כתובת', 'סוג פעולה', 'ימים שעברו', 'מכולות קשורות', 'הערות'];
                const overdueOrders = allOrders.filter(o => o['סטטוס'] === 'חורג'); 
                overdueOrders.sort((a, b) => (parseInt(b['ימים שעברו']) || 0) - (parseInt(a['ימים שעברו']) || 0));
                rows = overdueOrders.map(order => {
                    let containersText = '';
                    if (order['סוג פעולה'] === 'החלפה') {
                        const taken = String(order['מספר מכולה ירדה'] || '');
                        const brought = String(order['מספר מכולה עלתה'] || '');
                        if (taken && brought) containersText = `ירדה: ${taken}, עלתה: ${brought}`;
                        else if (taken) containersText = `ירדה: ${taken}`;
                        else if (brought) containersText = `עלתה: ${brought}`;
                    } else if (order['סוג פעולה'] === 'הורדה') {
                        containersText = String(order['מספר מכולה ירדה'] || '');
                    } else if (order['סוג פעולה'] === 'העלאה') {
                        containersText = String(order['מספר מכולה עלתה'] || '');
                    } else {
                        containersText = String(order['מספרי מכולות'] || '');
                    }
                    return [
                        order['תעודה'] || '',
                        order['שם לקוח'] || '',
                        order['כתובת'] || '',
                        order['סוג פעולה'] || '',
                        order['ימים שעברו'] !== undefined ? order['ימים שעברו'] : '',
                        containersText,
                        order['הערות'] || ''
                    ];
                });
            } else if (reportType === 'top-moving-containers-table') {
                title = 'מכולות מובילות בתזוזה';
                headers = ['מכולה', 'מספר תזוזות'];
                const containerMovementCounts = {};
                dataToProcess.forEach(order => { 
                    const containersTaken = (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    const containersBrought = (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).filter(c => c);
                    containersTaken.forEach(c => { containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1; });
                    containersBrought.forEach(c => { containerMovementCounts[c] = (containerMovementCounts[c] || 0) + 1; });
                });
                const sortedContainers = Object.entries(containerMovementCounts)
                    .map(([container, count]) => ({ container, count }))
                    .sort((a, b) => b.count - a.count);
                rows = sortedContainers.map(d => [d.container, d.count]);
            } else if (reportType === 'returning-customers-table') {
                title = 'לקוחות חוזרים (בעלי הזמנות רבות)';
                headers = ['שם לקוח', 'כתובת', 'כמות הזמנות', 'מכולות פעילות', 'היסטוריה חריגה'];
                const returningCustomers = getReturningCustomers(dataToProcess); 
                rows = returningCustomers.map(customer => [
                    customer.customerName,
                    customer.address,
                    customer.orderCount,
                    Array.from(customer.containers).join(', ') || 'אין', // Corrected: use .containers
                    customer.overdueOrders && customer.overdueOrders.length > 0 ? `חורג (${customer.overdueOrders.length})` : 'תקין'
                ]);
            }

            return { headers, rows, title };
        }

        /**
         * Prints the content of a specific report table using a generated HTML structure.
         * @param {string} reportType - The identifier for the type of report to print.
         */
        function printReport(reportType) {
            const { headers, rows, title } = getReportDataForPrinting(reportType);

            if (rows.length === 0) {
                showAlert('אין נתונים להדפסה בדוח זה.', 'warning');
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr>
                            ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${cell}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>הדפסת דוח</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Heebo', 'Inter', sans-serif; direction: rtl; text-align: right; margin: 20px; }
                h1 { text-align: center; margin-bottom: 20px; color: #1f2937; }
                @media print {
                    body { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                    thead { display: table-header-group; }
                    tfoot { display: table-footer-group; }
                }
            `);
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(`<h1>${title}</h1>`);
            printWindow.document.write(tableHtml); 
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print(); 
            showAlert('הדוח נשלח להדפסה.', 'success', 3000);
        }

        /**
         * Shares the content of a specific report table to WhatsApp.
         * @param {string} tableId - The ID of the table HTML element.
         */
        function shareReportToWhatsApp(tableId) {
            const table = document.getElementById(tableId);
            if (!table) {
                showAlert('טבלה לשיתוף לא נמצאה.', 'error');
                return;
            }

            const rows = Array.from(table.querySelectorAll('tr'));
            if (rows.length <= 1) {
                showAlert('אין נתונים לשיתוף בטבלה זו.', 'warning');
                return;
            }

            const reportTitle = document.querySelector(`#${tableId}`).previousElementSibling.textContent.replace('דוח:', '').trim();
            let message = `*${reportTitle}*\n\n`;

            const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
            
            for (let i = 1; i < rows.length; i++) {
                const rowCells = Array.from(rows[i].querySelectorAll('td'));
                const rowData = rowCells.map(cell => cell.textContent.trim());
                message += `${headers[0]}: ${rowData[0]}, ${headers[1]}: ${rowData[1]}`;
                if (rowData[2]) message += `, ${headers[2]}: ${rowData[2]}`;
                if (rowData[3]) message += `, ${headers[3]}: ${rowData[3]}`;
                message += '\n';
            }

            const whatsappUrl = `https://wa.me/${WHATSAPP_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('הדוח נשלח לווצאפ.', 'success', 3000);
        }

        // --- Container History Modal (reused/adapted from script.js) ---
        function openContainerHistoryModal(containerNum) {
            const modal = document.getElementById('container-history-modal');
            const tableBody = document.querySelector('#container-history-table tbody');
            const noHistoryMsg = document.getElementById('no-container-history');
            document.getElementById('history-container-number').textContent = containerNum;
            tableBody.innerHTML = '';
            noHistoryMsg.classList.add('hidden');

            const containerHistory = allOrders.filter(order => 
                (String(order['מספר מכולה ירדה'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['מספר מכולה עלתה'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim()) ||
                (String(order['מספרי מכולות'] || '')).split(',').map(c => c.trim()).includes(containerNum.trim())
            ).sort((a, b) => new Date(a['תאריך הזמנה']) - new Date(b['תאריך הזמנה']));

            if (containerHistory.length === 0) {
                noHistoryMsg.classList.remove('hidden');
            } else {
                containerHistory.forEach(order => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = formatDate(order['תאריך הזמנה']);
                    row.insertCell().textContent = order['תעודה'] || '';
                    row.insertCell().textContent = order['שם לקוח'] || '';
                    row.insertCell().textContent = order['סוג פעולה'] || '';
                    row.insertCell().textContent = String(order['מספר מכולה ירדה'] || order['מספרי מכולות'] || '');
                    row.insertCell().textContent = String(order['מספר מכולה עלתה'] || '');
                    let statusClass = '';
                    switch (order['סטטוס']) {
                        case 'פתוח': statusClass = 'status-open'; break;
                        case 'סגור': statusClass = 'status-closed'; break;
                        case 'חורג': statusClass = 'status-overdue'; break;
                        case 'ממתין/לא תקין': statusClass = 'status-pending'; break;
                        default: statusClass = 'status-warning'; break;
                    }
                    row.insertCell().innerHTML = `<span class="${statusClass}">${order['סטטוס'] || ''}</span>`;
                    row.insertCell().textContent = formatDate(order['תאריך סיום צפוי']);
                    const whatsappCell = row.insertCell();
                    if (order['טלפון לקוח']) {
                        const suggestedMsgId = getSuggestedMessageIdForOrder(order);
                        whatsappCell.innerHTML = `<button class="whatsapp-icon-btn whatsapp-in-table-btn" title="שלח WhatsApp" onclick="event.stopPropagation(); openWhatsAppModal('${order['טלפון לקוח']}', '${suggestedMsgId}', ${order.sheetRow}, '${order['שם לקוח']}', ${order['ימים שעברו']}, '${order['מספר מכולה ירדה'] || order['מספר מכולה עלתה'] || ''}', '${order['תעודה'] || ''}', '${formatDate(order['תאריך סיום צפוי']) || ''}', '${order['כתובת'] || ''}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>`;
                    } else {
                        whatsappCell.textContent = 'אין טלפון';
                    }
                });
            }
             if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeContainerHistoryModal() {
            document.getElementById('container-history-modal').classList.remove('active');
        }

        function showOrderDetails(orderData) {
            const modal = document.getElementById('order-details-modal');
            const orderCard = document.getElementById('current-order-card');
            
            let containersDisplay = '';
            if (orderData['סוג פעולה'] === 'הורדה') {
                containersDisplay = String(orderData['מספר מכולה ירדה'] || orderData['מספרי מכולות'] || '');
            } else if (orderData['סוג פעולה'] === 'העלאה') {
                containersDisplay = String(orderData['מספר מכולה עלתה'] || orderData['מספרי מכולות'] || '');
            } else if (orderData['סוג פעולה'] === 'החלפה') {
                const taken = String(orderData['מספר מכולה ירדה'] || '');
                const brought = String(orderData['מספר מכולה עלתה'] || '');
                if (taken && brought) {
                    containersDisplay = `ירדה: ${taken}, עלתה: ${brought}`;
                } else if (taken) {
                    containersDisplay = `ירדה: ${taken}`;
                } else if (brought) {
                    containersDisplay = `עלתה: ${brought}`;
                }
            } else {
                containersDisplay = String(orderData['מספרי מכולות'] || '');
            }

            orderCard.innerHTML = `
                <p><i class="fas fa-id-card icon" aria-hidden="true"></i> <strong>תעודה:</strong> ${orderData['תעודה'] || ''}</p>
                <p><i class="fas fa-calendar-alt icon" aria-hidden="true"></i> <strong>תאריך הזמנה:</strong> ${formatDate(orderData['תאריך הזמנה'])}</p>
                <p><i class="fas fa-user-tie icon" aria-hidden="true"></i> <strong>שם סוכן:</strong> ${orderData['שם סוכן'] || ''}</p>
                <p><i class="fas fa-user-circle icon" aria-hidden="true"></i> <strong>שם לקוח:</strong> ${orderData['שם לקוח'] || ''}</p>
                <p><i class="fas fa-map-marker-alt icon" aria-hidden="true"></i> <strong>כתובת:</strong> ${orderData['כתובת'] || ''}</p>
                <p><i class="fas fa-exchange-alt icon" aria-hidden="true"></i> <strong>סוג פעולה:</strong> ${orderData['סוג פעולה'] || ''}</p>
                <p><i class="fas fa-boxes icon" aria-hidden="true"></i> <strong>מכולות קשורות:</strong> ${containersDisplay}</p>
                <p><i class="fas fa-info-circle icon" aria-hidden="true"></i> <strong>סטטוס:</strong> <span class="${orderData['סטטוס'] === 'פתוח' ? 'status-open' : orderData['סטטוס'] === 'חורג' ? 'status-overdue' : 'status-closed'}">${orderData['סטטוס'] || ''}</span></p>
                <p><i class="fas fa-hourglass-half icon" aria-hidden="true"></i> <strong>ימים שעברו:</strong> ${orderData['ימים שעברו'] !== undefined ? orderData['ימים שעברו'] : ''}</p>
                <p><i class="fas fa-calendar-check icon" aria-hidden="true"></i> <strong>תאריך סיום צפוי:</strong> ${formatDate(orderData['תאריך סיום צפוי'])}</p>
                <p><i class="fas fa-comment-dots icon" aria-hidden="true"></i> <strong>הערות:</strong> <span class="note-text">${orderData['הערות'] || 'אין הערות'}</span></p>
                <p><i class="fas fa-calendar-times icon" aria-hidden="true"></i> <strong>תאריך סגירה:</strong> ${formatDate(orderData['תאריך סגירה'])}</p>
                <p><i class="fas fa-clock icon" aria-hidden="true"></i> <strong>עדכון הערה אחרון:</strong> ${formatDateTime(orderData['תאריך וזמן עדכון הערה'])}</p>
            `;

            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeOrderDetailsModal() {
            document.getElementById('order-details-modal').classList.remove('active');
        }

        // --- WhatsApp Messaging Logic ---

        const whatsappMessages = [
            { id: 'new_customer_welcome', text: 'שלום **[שם לקוח]**,\nתודה שבחרת להתחיל שכירות מכולה אצלנו! 🥳 לכל פניה, בקשת החלפה או הוצאה של המכולה, אתה מוזמן ליצור קשר.\n\n📞 מספר ווטסאפ להזמנות: **972508860896**\n☎️ טלפון מחלקת הזמנות: **097602010**', category: 'כללי', placeholders: ['שם לקוח'], emoji: '👋' },
            { id: 'approaching_due_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להזכיר לך כי תקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת בעוד **7 ימים** 🗓️. זה הזמן לנקוט פעולה!\n\nהאם תרצה להאריך את תקופת השכירות, להחליף את המכולה, או להזמין איסוף? ♻️', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏰' },
            { id: 'approaching_due_3_days', text: 'שלום **[שם לקוח]**,\n\nתקופת שכירות המכולה ([**מספר מכולה**]) מסתיימת ממש בקרוב, בעוד **3 ימים** ⚠️. אנא טפל בנושא כדי למנוע חריגות.\n\nאנו לרשותך לכל עזרה! 🙏', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '⏳' },
            { id: 'overdue_7_days', text: 'שלום **[שם לקוח]**,\n\nברצוננו להודיע לך על חריגה בימי שכירות של המכולה ([**מספר מכולה**]) ב-**[ימים שעברו] ימים** 🚨. נא ליצור קשר עם מחלקת הזמנות **097602010** או להשיב להודעה זו מה תרצה שנבצע (החלפה/הוצאה).', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '❗️' },
            { id: 'overdue_30_days', text: '**התראה חמורה, [שם לקוח]:**\n\nהמכולה ([**מספר מכולה**]) שבשימושך חורגת ב-**[ימים שעברו] ימים**! יש לטפל בנושא בדחיפות כדי למנוע חיובים נוספים וסיבוכים משפטיים. ⚖️\n\n**צור קשר מיידית: 097602010.**', category: 'חריגות', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '🔴' },
            { id: 'overdue_long', text: '**לכבוד: [שם לקוח]**\n\n**הנדון: חוב בגין שכירות מכולה חורגת**\n\nאנו פונים אליך בהתייחס לחשבונך, הנמצא בחריגה משמעותית של [**ימים שעברו**] ימים עבור מכולה ([**מספר מכולה**]).\n\nבהיעדר הסדרה מיידית, אנו נאלצים לנקוט בצעדים משפטיים לגבייה. אנו קוראים לך ליצור קשר דחוף להסדר: **097602010**.', category: 'משפטי', placeholders: ['שם לקוח', 'מספר מכולה', 'ימים שעברו'], emoji: '📜' },
            { id: 'general_inquiry', text: 'שלום **[שם לקוח]**,\n\nאיך אנחנו יכולים לעזור לך היום? 🤔 אם יש לך שאלות, בקשות או תזכורות, אל תהסס לפנות אלינו. אנחנו כאן בשבילך! ✨', category: 'כללי', placeholders: ['שם לקוח'], emoji: '💬' },
            { id: 'payment_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת ידידותית לגבי תשלום חשבונית מספר **[תעודה]** 💰. אנו מודים לך על תשומת הלב המהירה ועל המשך שיתוף הפעולה.', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '💲' },
            { id: 'service_feedback', text: 'שלום **[שם לקוח]**,\n\nאנו מקווים ששירותינו עונים על ציפיותיך. נשמח לקבל משוב על החוויה שלך עם מכולה מספר **[מספר מכולה]** כדי שנוכל להשתפר ולהעניק לך שירות טוב יותר. ⭐', category: 'משוב', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '📝' },
            { id: 'holiday_greetings', text: 'חג שמח, **[שם לקוח]**! 🎉\n\nצוות [שם החברה] מאחל לך ולמשפחתך חג שמח, מלא שלווה, בריאות והמון שמחה! 🥳', category: 'עונתי', placeholders: ['שם לקוח'], emoji: '🎁' },
            { id: 'special_offer', text: 'שלום **[שם לקוח]**,\n\nיש לנו חדשות מרגשות! 🎁 מבצע מיוחד למכולות חדשות/נוספות עבורך. אל תחמיץ! לפרטים נוספים, השב להודעה זו או התקשר: **097602010**.', category: 'שיווק', placeholders: ['שם לקוח'], emoji: '✨' },
            { id: 'follow_up_issue', text: 'שלום **[שם לקוח]**,\n\nאנחנו חוזרים אליך לגבי הנושא שדיווחת עליו בתעודה **[תעודה]** 🛠️. האם הבעיה נפתרה לשביעות רצונך? אם לא, אנא הודע לנו כדי שנוכל להמשיך לטפל.', category: 'תמיכה', placeholders: ['שם לקוח', 'תעודה'], emoji: '✅' },
            { id: 'document_reminder', text: 'שלום **[שם לקוח]**,\n\nתזכורת לשליחת המסמכים החסרים עבור הזמנה **[תעודה]** 📄. אנא שלח אותם בהקדם כדי שנוכל להשלים את הטיפול בהזמנה.\n\nתודה על שיתוף הפעולה!', category: 'תזכורות', placeholders: ['שם לקוח', 'תעודה'], emoji: '📌' },
            { id: 'service_confirmation', text: 'שלום **[שם לקוח]**,\n\nהשירות שהוזמן (תעודה **[תעודה]**) אושר ויתבצע ב-**[תאריך סיום צפוי]** ✅. תודה שבחרת בנו ושיהיה יום נפלא!', category: 'אישור', placeholders: ['שם לקוח', 'תעודה', 'תאריך סיום צפוי'], emoji: '👍' },
            { id: 'service_delay', text: 'שלום **[שם לקוח]**,\n\nעקב נסיבות בלתי צפויות, ייתכן שיהיה עיכוב קל בטיפול בהזמנה **[תעודה]** ⏱️. אנו מתנצלים על אי הנוחות ונפעל לפתור זאת במהירות האפשרית.\n\nנודיע לך על כל עדכון! 🔜', category: 'מידע', placeholders: ['שם לקוח', 'תעודה'], emoji: '🚧' },
            { id: 'location_update_request', text: 'שלום **[שם לקוח]**,\n\nכדי שנוכל לתאם את השירות בצורה הטובה ביותר, אנא וודא שמיקום המכולה ([**מספר מכולה**]) מעודכן ומדויק 📍. זה חשוב להגעה יעילה!', category: 'תזכורות', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🗺️' },
            { id: 'happy_birthday', text: 'יום הולדת שמח, **[שם לקוח]**! 🎉🎂\n\nצוות [שם החברה] מאחל לך יום מלא בשמחה, בריאות, הגשמה והרבה רגעים מתוקים! 🥳', category: 'עונתי', placeholders: ['שם לקוח'], emoji: '🎈' },
            { id: 'review_invitation', text: 'שלום **[שם לקוח]**,\n\nנהנית מהשירות שלנו? ✨ נשמח אם תוכל להקדיש רגע ולכתוב לנו ביקורת קצרה כאן: [**לינק לביקורת**]. תודה מראש על עזרתך להשתפר! 🙏', category: 'משוב', placeholders: ['שם לקוח', 'לינק לביקורת'], emoji: '🌟' },
            { id: 'tech_support_contact', text: 'שלום **[שם לקוח]**,\n\nלכל בעיה טכנית או תפעולית עם המכולה ([**מספר מכולה**]), מחלקת התמיכה שלנו זמינה עבורך 🧑‍🔧.\n\n**צור קשר: 097602010.**', category: 'תמיכה', placeholders: ['שם לקוח', 'מספר מכולה'], emoji: '🔧' },
            { id: 'general_thanks', text: 'תודה רבה לך, **[שם לקוח]**, על שיתוף הפעולה והאמון ב[שם החברה]! 🙏\n\nאנו מעריכים את בחירתך בנו ומקווים להמשיך לשרת אותך נאמנה. 💖', category: 'כללי', placeholders: ['שם לקוח'], emoji: '😊' },
            { id: 'multi_container_reminder', text: 'שלום **[שם לקוח]**,\n\nשמנו לב שברשותך **מספר מכולות פעילות** 🏗️. אנו כאן כדי לוודא שכל הצרכים שלך מסופקים.\n\nהאם יש משהו שנוכל לעזור בו בנוגע למכולות שלך? אל תהסס לפנות! 🤝', category: 'תזכורות', placeholders: ['שם לקוח'], emoji: '📦' }
        ];

        // Simulated city guidelines data (in a real app, this would come from a database)
        const cityGuidelines = {
            'הרצליה': {
                id: 'herzliya_permit',
                text: 'הנחיה חשובה לתושבי הרצליה:\nכדי להציב מכולת פסולת בניין ברחוב בהרצליה, יש להגיש בקשה מראש לאגף הפיקוח העירוני. הבקשה כרוכה בתשלום אגרה ונדרש אישור בכתב. מומלץ לוודא את כל הפרטים באתר העירייה או בטלפון.\n\nקישור למידע: https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                link: 'https://www.herzliya.muni.il/pages/%D7%90%D7%92%D7%A8%D7%95%D7%AA%20%D7%95%D7%94%D7%99%D7%AA%D7%A8%D7%99%D7%9D',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '📝'
            },
            'רעננה': {
                id: 'raanana_permit',
                text: 'הנחיה חשובה לתושבי רעננה:\nברעננה, חל איסור מוחלט להשאיר מכולות פסולת בניין במקום ציבורי (ברחוב) בסופי שבוע ובחגים. יש לדאוג להזמין פינוי לפני כניסת השבת/חג. קנסות יינתנו למפרים. אנא הקפד על הנחיות אלו.\n\nמידע נוסף: https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                link: 'https://www.raanana.muni.il/pages/%D7%A4%D7%A1%D7%95%D7%9C%D7%AA-%D7%91%D7%A0%D7%99%D7%99%D7%9F',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🚫'
            },
            'תל אביב': {
                id: 'telaviv_permit',
                text: 'הנחיה חשובה לתושבי תל אביב:\nבתל אביב, הצבת מכולות פסולת ברחוב מחייבת קבלת היתר מהעירייה. יש להגיש בקשה מקוונת ולצרף את כל המסמכים הנדרשים. שימו לב להנחיות המדויקות לגבי סימון המכולה ומשך ההצבה.\n\nלמידע והגשת בקשה: https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                link: 'https://www.tel-aviv.muni.il/Bussiness/Construction/Pages/WasteContainers.aspx',
                category: 'היתרים עירוניים',
                placeholders: [],
                emoji: '🏛️'
            }
        };


        let typingInterval;
        let currentMessageFullText = '';
        let typingIndex = 0;

        /**
         * Selects a message and displays it with a typing effect.
         * @param {string} messageId - The ID of the message to display.
         * @param {Object} placeholders - Object with placeholder values.
         */
        function selectAndTypeMessage(messageId, placeholders = {}) {
            clearInterval(typingInterval);
            const message = whatsappMessages.find(msg => msg.id === messageId);
            const textarea = document.getElementById('whatsapp-message-textarea');
            const typingDisplay = document.getElementById('typing-effect-display');

            if (message) {
                currentMessageFullText = message.text;
                for (const key in placeholders) {
                    currentMessageFullText = currentMessageFullText.replace(new RegExp(`\\[${key}\\]`, 'g'), placeholders[key]);
                }
                
                typingIndex = 0;
                typingDisplay.textContent = '';
                textarea.value = ''; 

                typingInterval = setInterval(() => {
                    if (typingIndex < currentMessageFullText.length) {
                        typingDisplay.textContent += currentMessageFullText.charAt(typingIndex);
                        typingIndex++;
                    } else {
                        clearInterval(typingInterval);
                        textarea.value = currentMessageFullText; 
                        typingDisplay.textContent = ''; 
                    }
                }, 30); 
            }
        }

        /**
         * Extracts city name from a given address string.
         * @param {string} address - The full address string.
         * @returns {string|null} The extracted city name or null if not found.
         */
        function getCityFromAddress(address) {
            if (!address) return null;
            const parts = address.split(',').map(s => s.trim());
            const israeliCities = [
                "תל אביב", "ירושלים", "חיפה", "ראשון לציון", "פתח תקווה", "אשדוד", "באר שבע",
                "נתניה", "בני ברק", "חולון", "רמת גן", "רחובות", "אשקלון", "בת ים", "הרצליה",
                "כפר סבא", "חדרה", "בית שמש", "מודיעין-מכבים-רעות", "לוד", "רמלה", "רעננה",
                "נהריה", "קריית גת", "אילת", "עכו", "צפת", "טבריה", "נצרת", "אום אל-פאחם",
                "בני ציון", "אבן יהודה", "אור יהודה", "אור עקיבא", "אריאל", "אשקלון", "באקה אל-גרבייה",
                "גבעתיים", "דימונה", "הוד השרון", "זכרון יעקב", "יבנה", "יהוד-מונוסון", "יוקנעם עילית",
                "כוכב יאיר", "כפר יונה", "כפר קאסם", "כרמיאל", "מגדל העמק", "מכבים", "מעלה אדומים",
                "מצפה רמון", "נהריה", "נס ציונה", "נשר", "עפולה", "ערד", "פרדס חנה-כרכור",
                "קריית אונו", "קריית ביאליק", "קריית ים", "קריית מוצקין", "קריית שמונה",
                "שוהם", "שדרות", "רמת השרון"
            ].sort((a,b) => b.length - a.length); 

            for (const city of israeliCities) {
                if (address.includes(city)) {
                    return city;
                }
            }
            if (parts.length > 0) {
                return parts[parts.length - 1];
            }
            return null;
        }


        /**
         * Populates message options and opens the WhatsApp modal.
         * @param {string} phoneNumber - The customer's phone number.
         * @param {string} suggestedMessageId - The ID of the message to pre-select.
         * @param {number|null} orderSheetRow - The sheet row of the order, for logging.
         * @param {string} customerName - The customer's name for placeholders.
         * @param {number|null} daysOverdue - Days overdue for overdue messages.
         * @param {string} containerNum - Container number for relevant messages.
         * @param {string|null} docId - Document ID (תעודה) for messages.
         * @param {string|null} expectedEndDate - Expected end date for messages.
         * @param {string|null} customerAddress - Customer's full address to derive city for guidelines.
         * @param {string|null} reviewLink - Link for review requests.
         */
        function openWhatsAppModal(phoneNumber, suggestedMessageId = 'general_inquiry', orderSheetRow = null, customerName = 'לקוח יקר', daysOverdue = 0, containerNum = '', docId = '', expectedEndDate = '', customerAddress = '', reviewLink = 'https://example.com/review') {
            const modal = document.getElementById('whatsapp-modal');
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageOptionsListDiv = document.getElementById('message-options-list');
            const currentOrderSheetRowInput = document.getElementById('whatsapp-current-order-sheet-row');
            
            const phoneString = String(phoneNumber);
            phoneInput.value = phoneString.startsWith('972') ? phoneString : `972${phoneString.substring(1)}`; 
            currentOrderSheetRowInput.value = orderSheetRow !== null ? orderSheetRow : '';

            const customerCity = getCityFromAddress(customerAddress);
            let dynamicMessages = [];
            if (customerCity && cityGuidelines[customerCity]) {
                const guideline = cityGuidelines[customerCity];
                dynamicMessages.push({
                    id: `city_guideline_${customerCity}`,
                    text: `**הנחיית עיריית ${customerCity}:**\n${guideline.text}\n\nלמידע וטפסים נוספים: ${guideline.link}`,
                    category: 'היתרים עירוניים',
                    placeholders: [],
                    emoji: guideline.emoji 
                });
            }

            const allAvailableMessages = [...whatsappMessages];
            if (dynamicMessages.length > 0) {
                allAvailableMessages.unshift(...dynamicMessages);
            }

            messageOptionsListDiv.innerHTML = ''; 
            allAvailableMessages.forEach(msg => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `message-option-item`;
                if (msg.id === suggestedMessageId) {
                    optionDiv.classList.add('selected');
                }
                const displayEmoji = msg.category === 'משפטי' ? '' : (msg.emoji || '');
                const displayMsg = `**${displayEmoji} ${msg.category}:** ${msg.text.replace(/\[.*?\]/g, '...').substring(0, 60)}...`;
                optionDiv.innerHTML = displayMsg; 

                optionDiv.onclick = () => {
                    document.querySelectorAll('.message-option-item').forEach(item => item.classList.remove('selected'));
                    optionDiv.classList.add('selected');
                    const placeholders = {
                        'שם לקוח': customerName,
                        'ימים שעברו': daysOverdue,
                        'מספר מכולה': containerNum,
                        'תעודה': docId,
                        'תאריך סיום צפוי': expectedEndDate,
                        'לינק לביקורת': reviewLink
                    };
                    selectAndTypeMessage(msg.id, placeholders);
                };
                messageOptionsListDiv.appendChild(optionDiv);
            });

            const defaultSelectedOption = messageOptionsListDiv.querySelector(`.message-option-item.selected`);
            if (defaultSelectedOption) {
                defaultSelectedOption.click();
            } else if (allAvailableMessages.length > 0) {
                messageOptionsListDiv.querySelector('.message-option-item').click();
            }

            const messageOptionsContainer = document.getElementById('whatsapp-message-options');
            messageOptionsContainer.classList.add('expanded');
            messageOptionsContainer.style.maxHeight = messageOptionsContainer.scrollHeight + "px";
            document.querySelector('.message-option-header').classList.remove('collapsed');


            if (isMobile()) {
                modal.classList.add('mobile-drawer');
            } else {
                modal.classList.remove('mobile-drawer');
            }
            modal.classList.add('active');
        }

        function closeWhatsAppModal() {
            document.getElementById('whatsapp-modal').classList.remove('active');
            clearInterval(typingInterval); 
        }

        /**
         * Toggles the visibility of the message options accordion.
         */
        function toggleMessageOptions() {
            const container = document.getElementById('whatsapp-message-options');
            const header = document.querySelector('.message-option-header');
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                container.style.maxHeight = null;
                header.classList.add('collapsed');
            } else {
                container.classList.add('expanded');
                container.style.maxHeight = container.scrollHeight + "px";
                header.classList.remove('collapsed');
            }
        }

        /**
         * Filters the message options based on user input.
         */
        function filterMessageOptions() {
            const input = document.getElementById('message-filter-input');
            const filter = input.value.toLowerCase();
            const messageItems = document.querySelectorAll('#message-options-list .message-option-item');

            messageItems.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
            const container = document.getElementById('whatsapp-message-options');
            if (container.classList.contains('expanded')) {
                container.style.maxHeight = container.scrollHeight + "px";
            }
        }


        /**
         * Sends the WhatsApp message to the entered number.
         */
        function sendWhatsAppMessage() {
            const phoneInput = document.getElementById('whatsapp-phone-input');
            const messageTextarea = document.getElementById('whatsapp-message-textarea');
            const orderSheetRow = document.getElementById('whatsapp-current-order-sheet-row').value;

            const phoneNumber = phoneInput.value.trim().replace(/\D/g, ''); 
            const message = messageTextarea.value.trim();

            if (!phoneNumber) {
                showAlert('אנא הזן מספר טלפון תקין.', 'error');
                return;
            }
            if (!message) {
                showAlert('תוכן ההודעה לא יכול להיות ריק.', 'error');
                return;
            }

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            showAlert('ההודעה נשלחה ל-WhatsApp (נפתח חלון חדש).', 'success', 5000);
            closeWhatsAppModal();

            if (orderSheetRow) {
                logWhatsAppMessage(parseInt(orderSheetRow), message);
            }
        }

        /**
         * Logs the sent WhatsApp message to the order's notes in the backend.
         * @param {number} sheetRow - The row number of the order in the Google Sheet.
         * @param {string} message - The message text that was sent.
         */
        async function logWhatsAppMessage(sheetRow, message) {
            const timestamp = new Date().toLocaleString('he-IL', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const noteToLog = `[נשלח וואטסאפ: ${timestamp}] ${message}`;

            const orderIndex = allOrders.findIndex(order => order.sheetRow === sheetRow);
            if (orderIndex !== -1) {
                const currentNotes = allOrders[orderIndex]['הערות'] || '';
                allOrders[orderIndex]['הערות'] = currentNotes ? `${currentNotes}\n${noteToLog}` : noteToLog;
            }

            const response = await fetchData('updateOrderNote', { sheetRow: sheetRow, note: noteToLog });
            if (response.success) {
                console.log('WhatsApp message logged to backend successfully.');
            } else {
                console.error('Failed to log WhatsApp message to backend:', response.message);
                showAlert('שגיאה בתיעוד ההודעה במערכת.', 'error');
            }
        }

        /**
         * Determines the most appropriate WhatsApp message ID for a given order.
         * @param {Object} order - The order object.
         * @returns {string} The ID of the suggested message.
         */
        function getSuggestedMessageIdForOrder(order) {
            const daysOverdue = parseInt(order['ימים שעברו']) || 0;
            const orderDate = new Date(order['תאריך הזמנה']);
            const today = new Date();
            const daysSinceOrder = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));

            if (order['סטטוס'] === 'חורג') {
                if (daysOverdue <= 7) return 'overdue_7_days';
                if (daysOverdue <= 30) return 'overdue_30_days';
                return 'overdue_long'; 
            }
            
            if (order['סטטוס'] === 'פתוח' && order['תאריך סיום צפוי']) {
                const expectedEndDate = new Date(order['תאריך סיום צפוי']);
                const daysUntilDue = Math.floor((expectedEndDate - today) / (1000 * 60 * 60 * 24));
                if (daysUntilDue <= 3 && daysUntilDue >= 0) return 'approaching_due_3_days';
                if (daysUntilDue <= 7 && daysUntilDue > 3) return 'approaching_due_7_days';
            }

            if (daysSinceOrder <= 30 && order['מספר מכולה ירדה'] && order['סוג פעולה'] === 'הורדה') {
                const customerOrders = allOrders.filter(o => o['שם לקוח'] === order['שם לקוח'] && o['כתובת'] === order['כתובת']);
                if (customerOrders.length === 1) { 
                    return 'new_customer_welcome';
                }
            }
            
            const customerCity = getCityFromAddress(order['כתובת']);
            if (customerCity && cityGuidelines[customerCity]) {
                return `city_guideline_${customerCity}`; 
            }

            return 'general_inquiry';
        }


        // --- Back to Top Button Logic ---
        const backToTopBtn = document.getElementById("back-to-top-btn");

        window.onscroll = function() { scrollFunction() };

        function scrollFunction() {
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                backToTopBtn.style.display = "block";
            } else {
                backToTopBtn.style.display = "none";
            }
        }

        backToTopBtn.addEventListener('click', topFunction);

        function topFunction() {
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }


        // Initial Load and Event Listeners
        window.onload = () => {
            initializeThemeCrm(); 
            loadAllData(); 
            updateDateTimeCrm();
            setInterval(updateDateTimeCrm, 1000);
            
            window.addEventListener('resize', () => {
                drawCharts();
            });
        };
    </script>
</body>
</html>
